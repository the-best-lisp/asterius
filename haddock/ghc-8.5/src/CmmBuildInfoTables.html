<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, GADTs #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CmmBuildInfoTables</span><span>
</span><a name="line-4"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#cafAnal"><span class="hs-identifier hs-var">cafAnal</span></a><span>
</span><a name="line-5"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#doSRTs"><span class="hs-identifier hs-var">doSRTs</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier hs-var">emptySRT</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#isEmptySRT"><span class="hs-identifier hs-var">isEmptySRT</span></a><span class="hs-special">,</span><span> </span><a href="CmmBuildInfoTables.html#srtToData"><span class="hs-identifier hs-var">srtToData</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-6"></a><span class="hs-keyword">where</span><span>
</span><a name="line-7"></a><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Enum.html#succ"><span class="hs-identifier hs-var">succ</span></a><span class="hs-special">)</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Block.html"><span class="hs-identifier">Hoopl</span><span class="hs-operator">.</span><span class="hs-identifier">Block</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Graph.html"><span class="hs-identifier">Hoopl</span><span class="hs-operator">.</span><span class="hs-identifier">Graph</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Label.html"><span class="hs-identifier">Hoopl</span><span class="hs-operator">.</span><span class="hs-identifier">Label</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Collections.html"><span class="hs-identifier">Hoopl</span><span class="hs-operator">.</span><span class="hs-identifier">Collections</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Hoopl.Dataflow.html"><span class="hs-identifier">Hoopl</span><span class="hs-operator">.</span><span class="hs-identifier">Dataflow</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Digraph.html"><span class="hs-identifier">Digraph</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Bitmap.html"><span class="hs-identifier">Bitmap</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="CLabel.html"><span class="hs-identifier">CLabel</span></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmmDecl.html"><span class="hs-identifier">PprCmmDecl</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="Cmm.html"><span class="hs-identifier">Cmm</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CmmUtils.html"><span class="hs-identifier">CmmUtils</span></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="CmmInfo.html"><span class="hs-identifier">CmmInfo</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="SMRep.html"><span class="hs-identifier">SMRep</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSupply.html"><span class="hs-identifier">UniqSupply</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="PprCmm.html"><span class="hs-identifier">PprCmm</span></a><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Set</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-identifier">foldSet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041085"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041086"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041086"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041086"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a><span> </span><a href="#local-6989586621680041085"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041086"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-38"></a><a name="foldSet"><a href="CmmBuildInfoTables.html#foldSet"><span class="hs-identifier">foldSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#foldr"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">foldr</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span class="hs-comment">-----------------------------------------------------------------------</span><span>
</span><a name="line-41"></a><span class="hs-comment">-- SRTs</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-comment">{- EXAMPLE

f = \x. ... g ...
  where
    g = \y. ... h ... c1 ...
    h = \z. ... c2 ...

c1 &amp; c2 are CAFs

g and h are local functions, but they have no static closures.  When
we generate code for f, we start with a CmmGroup of four CmmDecls:

   [ f_closure, f_entry, g_entry, h_entry ]

we process each CmmDecl separately in cpsTop, giving us a list of
CmmDecls. e.g. for f_entry, we might end up with

   [ f_entry, f1_ret, f2_proc ]

where f1_ret is a return point, and f2_proc is a proc-point.  We have
a CAFSet for each of these CmmDecls, let's suppose they are

   [ f_entry{g_closure}, f1_ret{g_closure}, f2_proc{} ]
   [ g_entry{h_closure, c1_closure} ]
   [ h_entry{c2_closure} ]

Now, note that we cannot use g_closure and h_closure in an SRT,
because there are no static closures corresponding to these functions.
So we have to flatten out the structure, replacing g_closure and
h_closure with their contents:

   [ f_entry{c2_closure, c1_closure}, f1_ret{c2_closure,c1_closure}, f2_proc{} ]
   [ g_entry{c2_closure, c1_closure} ]
   [ h_entry{c2_closure} ]

This is what flattenCAFSets is doing.

-}</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">-----------------------------------------------------------------------</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- Finding the CAFs used by a procedure</span><span>
</span><a name="line-84"></a><span>
</span><a name="line-85"></a><span class="hs-keyword">type</span><span> </span><a name="CAFSet"><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier">CAFSet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-86"></a><span class="hs-keyword">type</span><span> </span><a name="CAFEnv"><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier">CAFEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-identifier">cafLattice</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Dataflow.html#DataflowLattice"><span class="hs-identifier hs-type">DataflowLattice</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-89"></a><a name="cafLattice"><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier">cafLattice</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#DataflowLattice"><span class="hs-identifier hs-var">DataflowLattice</span></a><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="#local-6989586621680041087"><span class="hs-identifier hs-var">add</span></a><span>
</span><a name="line-90"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-91"></a><span>    </span><a name="local-6989586621680041087"><a href="#local-6989586621680041087"><span class="hs-identifier">add</span></a></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Dataflow.html#OldFact"><span class="hs-identifier hs-var">OldFact</span></a><span> </span><a name="local-6989586621680041088"><a href="#local-6989586621680041088"><span class="hs-identifier">old</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Dataflow.html#NewFact"><span class="hs-identifier hs-var">NewFact</span></a><span> </span><a name="local-6989586621680041089"><a href="#local-6989586621680041089"><span class="hs-identifier">new</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-92"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680041090"><a href="#local-6989586621680041090"><span class="hs-identifier">new'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041088"><span class="hs-identifier hs-var">old</span></a><span> </span><span class="hs-special">`</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#union"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">union</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680041089"><span class="hs-identifier hs-var">new</span></a><span>
</span><a name="line-93"></a><span>        </span><span class="hs-keyword">in</span><span> </span><a href="Hoopl.Dataflow.html#changedIf"><span class="hs-identifier hs-var">changedIf</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#size"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621680041090"><span class="hs-identifier hs-var">new'</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#size"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">size</span></a><span> </span><a href="#local-6989586621680041088"><span class="hs-identifier hs-var">old</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041090"><span class="hs-identifier hs-var">new'</span></a><span>
</span><a name="line-94"></a><span>
</span><a name="line-95"></a><span class="hs-identifier">cafTransfers</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Dataflow.html#TransferFun"><span class="hs-identifier hs-type">TransferFun</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-96"></a><a name="cafTransfers"><a href="CmmBuildInfoTables.html#cafTransfers"><span class="hs-identifier">cafTransfers</span></a></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Block.html#BlockCC"><span class="hs-identifier hs-var">BlockCC</span></a><span> </span><a name="local-6989586621680041091"><a href="#local-6989586621680041091"><span class="hs-identifier">eNode</span></a></a><span> </span><a name="local-6989586621680041092"><a href="#local-6989586621680041092"><span class="hs-identifier">middle</span></a></a><span> </span><a name="local-6989586621680041093"><a href="#local-6989586621680041093"><span class="hs-identifier">xNode</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680041094"><a href="#local-6989586621680041094"><span class="hs-identifier">fBase</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-97"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680041095"><a href="#local-6989586621680041095"><span class="hs-identifier">joined</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#cafsInNode"><span class="hs-identifier hs-var">cafsInNode</span></a><span> </span><a href="#local-6989586621680041093"><span class="hs-identifier hs-var">xNode</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a><span> </span><a href="Hoopl.Dataflow.html#joinOutFacts"><span class="hs-identifier hs-var">joinOutFacts</span></a><span> </span><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier hs-var">cafLattice</span></a><span> </span><a href="#local-6989586621680041093"><span class="hs-identifier hs-var">xNode</span></a><span> </span><a href="#local-6989586621680041094"><span class="hs-identifier hs-var">fBase</span></a><span>
</span><a name="line-98"></a><span>        </span><span class="hs-glyph">!</span><a name="local-6989586621680041096"><a href="#local-6989586621680041096"><span class="hs-identifier">result</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#foldNodesBwdOO"><span class="hs-identifier hs-var">foldNodesBwdOO</span></a><span> </span><a href="CmmBuildInfoTables.html#cafsInNode"><span class="hs-identifier hs-var">cafsInNode</span></a><span> </span><a href="#local-6989586621680041092"><span class="hs-identifier hs-var">middle</span></a><span> </span><a href="#local-6989586621680041095"><span class="hs-identifier hs-var">joined</span></a><span>
</span><a name="line-99"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="Hoopl.Collections.html#mapSingleton"><span class="hs-identifier hs-var">mapSingleton</span></a><span> </span><span class="hs-special">(</span><a href="Hoopl.Graph.html#entryLabel"><span class="hs-identifier hs-var">entryLabel</span></a><span> </span><a href="#local-6989586621680041091"><span class="hs-identifier hs-var">eNode</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041096"><span class="hs-identifier hs-var">result</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-identifier">cafsInNode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmNode.html#CmmNode"><span class="hs-identifier hs-type">CmmNode</span></a><span> </span><a href="#local-6989586621680041083"><span class="hs-identifier hs-type">e</span></a><span> </span><a href="#local-6989586621680041084"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-102"></a><a name="cafsInNode"><a href="CmmBuildInfoTables.html#cafsInNode"><span class="hs-identifier">cafsInNode</span></a></a><span> </span><a name="local-6989586621680041097"><a href="#local-6989586621680041097"><span class="hs-identifier">node</span></a></a><span> </span><a name="local-6989586621680041098"><a href="#local-6989586621680041098"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmNode.html#foldExpDeep"><span class="hs-identifier hs-var">foldExpDeep</span></a><span> </span><a href="#local-6989586621680041099"><span class="hs-identifier hs-var">addCaf</span></a><span> </span><a href="#local-6989586621680041097"><span class="hs-identifier hs-var">node</span></a><span> </span><a href="#local-6989586621680041098"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-103"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-104"></a><span>    </span><a name="local-6989586621680041099"><a href="#local-6989586621680041099"><span class="hs-identifier">addCaf</span></a></a><span> </span><a name="local-6989586621680041101"><a href="#local-6989586621680041101"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680041102"><a href="#local-6989586621680041102"><span class="hs-identifier">set</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-105"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680041101"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-106"></a><span>            </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span> </span><a name="local-6989586621680041103"><a href="#local-6989586621680041103"><span class="hs-identifier">c</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041100"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680041103"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621680041102"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-107"></a><span>            </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabelOff"><span class="hs-identifier hs-var">CmmLabelOff</span></a><span> </span><a name="local-6989586621680041104"><a href="#local-6989586621680041104"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041100"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680041104"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621680041102"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-108"></a><span>            </span><a href="CmmExpr.html#CmmLit"><span class="hs-identifier hs-var">CmmLit</span></a><span> </span><span class="hs-special">(</span><a href="CmmExpr.html#CmmLabelDiffOff"><span class="hs-identifier hs-var">CmmLabelDiffOff</span></a><span> </span><a name="local-6989586621680041105"><a href="#local-6989586621680041105"><span class="hs-identifier">c1</span></a></a><span> </span><a name="local-6989586621680041106"><a href="#local-6989586621680041106"><span class="hs-identifier">c2</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041100"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680041105"><span class="hs-identifier hs-var">c1</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a><span> </span><a href="#local-6989586621680041100"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680041106"><span class="hs-identifier hs-var">c2</span></a><span> </span><a href="#local-6989586621680041102"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-109"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041102"><span class="hs-identifier hs-var">set</span></a><span>
</span><a name="line-110"></a><span>    </span><a name="local-6989586621680041100"><a href="#local-6989586621680041100"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621680041107"><a href="#local-6989586621680041107"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680041108"><a href="#local-6989586621680041108"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CLabel.html#hasCAF"><span class="hs-identifier hs-var">hasCAF</span></a><span> </span><a href="#local-6989586621680041107"><span class="hs-identifier hs-var">l</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#insert"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#toClosureLbl"><span class="hs-identifier hs-var">toClosureLbl</span></a><span> </span><a href="#local-6989586621680041107"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041108"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-111"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041108"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-112"></a><span>
</span><a name="line-113"></a><span class="hs-comment">-- | An analysis to find live CAFs.</span><span>
</span><a name="line-114"></a><span class="hs-identifier">cafAnal</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-type">CmmGraph</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span>
</span><a name="line-115"></a><a name="cafAnal"><a href="CmmBuildInfoTables.html#cafAnal"><span class="hs-identifier">cafAnal</span></a></a><span> </span><a name="local-6989586621680041109"><a href="#local-6989586621680041109"><span class="hs-identifier">cmmGraph</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Dataflow.html#analyzeCmmBwd"><span class="hs-identifier hs-var">analyzeCmmBwd</span></a><span> </span><a href="CmmBuildInfoTables.html#cafLattice"><span class="hs-identifier hs-var">cafLattice</span></a><span> </span><a href="CmmBuildInfoTables.html#cafTransfers"><span class="hs-identifier hs-var">cafTransfers</span></a><span> </span><a href="#local-6989586621680041109"><span class="hs-identifier hs-var">cmmGraph</span></a><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-comment">-----------------------------------------------------------------------</span><span>
</span><a name="line-118"></a><span class="hs-comment">-- Building the SRTs</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-comment">-- Description of the SRT for a given module.</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- Note that this SRT may grow as we greedily add new CAFs to it.</span><span>
</span><a name="line-122"></a><span class="hs-keyword">data</span><span> </span><a name="TopSRT"><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier">TopSRT</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TopSRT"><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier">TopSRT</span></a></a><span>
</span><a name="line-123"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="lbl"><a href="CmmBuildInfoTables.html#lbl"><span class="hs-identifier">lbl</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span>
</span><a name="line-124"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="next_elt"><a href="CmmBuildInfoTables.html#next_elt"><span class="hs-identifier">next_elt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK #-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- the next entry in the table</span><span>
</span><a name="line-125"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="rev_elts"><a href="CmmBuildInfoTables.html#rev_elts"><span class="hs-identifier">rev_elts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="elt_map"><a href="CmmBuildInfoTables.html#elt_map"><span class="hs-identifier">elt_map</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- CLabel -&gt; its last entry in the table</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>  </span><a name="local-8214565720323909174"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-var">TopSRT</span></a><span> </span><a name="local-6989586621680041078"><a href="#local-6989586621680041078"><span class="hs-identifier">lbl</span></a></a><span> </span><a name="local-6989586621680041079"><a href="#local-6989586621680041079"><span class="hs-identifier">next</span></a></a><span> </span><a name="local-6989586621680041080"><a href="#local-6989586621680041080"><span class="hs-identifier">elts</span></a></a><span> </span><a name="local-6989586621680041081"><a href="#local-6989586621680041081"><span class="hs-identifier">eltmap</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;TopSRT:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680041078"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-132"></a><span>                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680041079"><span class="hs-identifier hs-var">next</span></a><span>
</span><a name="line-133"></a><span>                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680041080"><span class="hs-identifier hs-var">elts</span></a><span>
</span><a name="line-134"></a><span>                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680041081"><span class="hs-identifier hs-var">eltmap</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">emptySRT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqSupply.html#MonadUnique"><span class="hs-identifier hs-type">MonadUnique</span></a><span> </span><a href="#local-6989586621680041082"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680041082"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span>
</span><a name="line-137"></a><a name="emptySRT"><a href="CmmBuildInfoTables.html#emptySRT"><span class="hs-identifier">emptySRT</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-138"></a><span>  </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680041111"><a href="#local-6989586621680041111"><span class="hs-identifier">top_lbl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqSupply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680041110"><a href="#local-6989586621680041110"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="CLabel.html#mkTopSRTLabel"><span class="hs-identifier hs-var">mkTopSRTLabel</span></a><span> </span><a href="#local-6989586621680041110"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-139"></a><span>     </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-var">TopSRT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">lbl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041111"><span class="hs-identifier hs-var">top_lbl</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">next_elt</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rev_elts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">elt_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-140"></a><span>
</span><a name="line-141"></a><span class="hs-identifier">isEmptySRT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-142"></a><a name="isEmptySRT"><a href="CmmBuildInfoTables.html#isEmptySRT"><span class="hs-identifier">isEmptySRT</span></a></a><span> </span><a name="local-6989586621680041112"><a href="#local-6989586621680041112"><span class="hs-identifier">srt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rev_elts</span><span> </span><a href="#local-6989586621680041112"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-identifier">cafMember</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-145"></a><a name="cafMember"><a href="CmmBuildInfoTables.html#cafMember"><span class="hs-identifier">cafMember</span></a></a><span> </span><a name="local-6989586621680041113"><a href="#local-6989586621680041113"><span class="hs-identifier">srt</span></a></a><span> </span><a name="local-6989586621680041114"><a href="#local-6989586621680041114"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span></a><span> </span><a href="#local-6989586621680041114"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">elt_map</span><span> </span><a href="#local-6989586621680041113"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span class="hs-identifier">cafOffset</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-148"></a><a name="cafOffset"><a href="CmmBuildInfoTables.html#cafOffset"><span class="hs-identifier">cafOffset</span></a></a><span> </span><a name="local-6989586621680041115"><a href="#local-6989586621680041115"><span class="hs-identifier">srt</span></a></a><span> </span><a name="local-6989586621680041116"><a href="#local-6989586621680041116"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041116"><span class="hs-identifier hs-var">lbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">elt_map</span><span> </span><a href="#local-6989586621680041115"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">addCAF</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span>
</span><a name="line-151"></a><a name="addCAF"><a href="CmmBuildInfoTables.html#addCAF"><span class="hs-identifier">addCAF</span></a></a><span> </span><a name="local-6989586621680041117"><a href="#local-6989586621680041117"><span class="hs-identifier">caf</span></a></a><span> </span><a name="local-6989586621680041118"><a href="#local-6989586621680041118"><span class="hs-identifier">srt</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-152"></a><span>  </span><a href="#local-6989586621680041118"><span class="hs-identifier hs-var">srt</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">next_elt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041119"><span class="hs-identifier hs-var">last</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-153"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rev_elts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041117"><span class="hs-identifier hs-var">caf</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">rev_elts</span><span> </span><a href="#local-6989586621680041118"><span class="hs-identifier hs-var">srt</span></a><span>
</span><a name="line-154"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">elt_map</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680041117"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041119"><span class="hs-identifier hs-var">last</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">elt_map</span><span> </span><a href="#local-6989586621680041118"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-155"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680041119"><a href="#local-6989586621680041119"><span class="hs-identifier">last</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">next_elt</span><span> </span><a href="#local-6989586621680041118"><span class="hs-identifier hs-var">srt</span></a><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-identifier">srtToData</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmGroup"><span class="hs-identifier hs-type">CmmGroup</span></a><span>
</span><a name="line-158"></a><a name="srtToData"><a href="CmmBuildInfoTables.html#srtToData"><span class="hs-identifier">srtToData</span></a></a><span> </span><a name="local-6989586621680041120"><a href="#local-6989586621680041120"><span class="hs-identifier">srt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a href="#local-6989586621680041122"><span class="hs-identifier hs-var">sec</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#Statics"><span class="hs-identifier hs-var">Statics</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">lbl</span><span> </span><a href="#local-6989586621680041120"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041121"><span class="hs-identifier hs-var">tbl</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680041121"><a href="#local-6989586621680041121"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmStaticLit"><span class="hs-identifier hs-var">CmmStaticLit</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="CmmExpr.html#CmmLabel"><span class="hs-identifier hs-var">CmmLabel</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">rev_elts</span><span> </span><a href="#local-6989586621680041120"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>          </span><a name="local-6989586621680041122"><a href="#local-6989586621680041122"><span class="hs-identifier">sec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#Section"><span class="hs-identifier hs-var">Section</span></a><span> </span><a href="Cmm.html#RelocatableReadOnlyData"><span class="hs-identifier hs-var">RelocatableReadOnlyData</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">lbl</span><span> </span><a href="#local-6989586621680041120"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- Once we have found the CAFs, we need to do two things:</span><span>
</span><a name="line-163"></a><span class="hs-comment">-- 1. Build a table of all the CAFs used in the procedure.</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- 2. Compute the C_SRT describing the subset of CAFs live at each procpoint.</span><span>
</span><a name="line-165"></a><span class="hs-comment">--</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- When building the local view of the SRT, we first make sure that all the CAFs are</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- in the SRT. Then, if the number of CAFs is small enough to fit in a bitmap,</span><span>
</span><a name="line-168"></a><span class="hs-comment">-- we make sure they're all close enough to the bottom of the table that the</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- bitmap will be able to cover all of them.</span><span>
</span><a name="line-170"></a><span class="hs-identifier">buildSRT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-type">C_SRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-171"></a><a name="buildSRT"><a href="CmmBuildInfoTables.html#buildSRT"><span class="hs-identifier">buildSRT</span></a></a><span> </span><a name="local-6989586621680041123"><a href="#local-6989586621680041123"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680041124"><a href="#local-6989586621680041124"><span class="hs-identifier">topSRT</span></a></a><span> </span><a name="local-6989586621680041125"><a href="#local-6989586621680041125"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-172"></a><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-173"></a><span>         </span><span class="hs-comment">-- For each label referring to a function f without a static closure,</span><span>
</span><a name="line-174"></a><span>         </span><span class="hs-comment">-- replace it with the CAFs that are reachable from f.</span><span>
</span><a name="line-175"></a><span>         </span><a name="local-6989586621680041126"><a href="#local-6989586621680041126"><span class="hs-identifier">sub_srt</span></a></a><span> </span><a name="local-6989586621680041129"><a href="#local-6989586621680041129"><span class="hs-identifier">topSRT</span></a></a><span> </span><a name="local-6989586621680041130"><a href="#local-6989586621680041130"><span class="hs-identifier">localCafs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-176"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680041131"><a href="#local-6989586621680041131"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#elems"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span></a><span> </span><a href="#local-6989586621680041130"><span class="hs-identifier hs-var">localCafs</span></a><span>
</span><a name="line-177"></a><span>               </span><a name="local-6989586621680041132"><a href="#local-6989586621680041132"><span class="hs-identifier">mkSRT</span></a></a><span> </span><a name="local-6989586621680041133"><a href="#local-6989586621680041133"><span class="hs-identifier">topSRT</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-178"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680041134"><a href="#local-6989586621680041134"><span class="hs-identifier">localSRTs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#procpointSRT"><span class="hs-identifier hs-var">procpointSRT</span></a><span> </span><a href="#local-6989586621680041123"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">lbl</span><span> </span><a href="#local-6989586621680041133"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">elt_map</span><span> </span><a href="#local-6989586621680041133"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041131"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-179"></a><span>                    </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041133"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041134"><span class="hs-identifier hs-var">localSRTs</span></a><span class="hs-special">)</span><span>
</span><a name="line-180"></a><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680041131"><span class="hs-identifier hs-var">cafs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthExceeds"><span class="hs-identifier hs-var">lengthExceeds</span></a><span class="hs-special">`</span><span> </span><a href="CmmBuildInfoTables.html#maxBmpSize"><span class="hs-identifier hs-var">maxBmpSize</span></a><span> </span><a href="#local-6989586621680041123"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-181"></a><span>                </span><a href="#local-6989586621680041132"><span class="hs-identifier hs-var">mkSRT</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span> </span><a href="#local-6989586621680041127"><span class="hs-identifier hs-var">add_if_missing</span></a><span> </span><a href="#local-6989586621680041129"><span class="hs-identifier hs-var">topSRT</span></a><span> </span><a href="#local-6989586621680041131"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- make sure all the cafs are near the bottom of the srt</span><span>
</span><a name="line-183"></a><span>                </span><a href="#local-6989586621680041132"><span class="hs-identifier hs-var">mkSRT</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041128"><span class="hs-identifier hs-var">add_if_too_far</span></a><span> </span><a href="#local-6989586621680041129"><span class="hs-identifier hs-var">topSRT</span></a><span> </span><a href="#local-6989586621680041131"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span>         </span><a name="local-6989586621680041127"><a href="#local-6989586621680041127"><span class="hs-identifier">add_if_missing</span></a></a><span> </span><a name="local-6989586621680041135"><a href="#local-6989586621680041135"><span class="hs-identifier">srt</span></a></a><span> </span><a name="local-6989586621680041136"><a href="#local-6989586621680041136"><span class="hs-identifier">caf</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-185"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="CmmBuildInfoTables.html#cafMember"><span class="hs-identifier hs-var">cafMember</span></a><span> </span><a href="#local-6989586621680041135"><span class="hs-identifier hs-var">srt</span></a><span> </span><a href="#local-6989586621680041136"><span class="hs-identifier hs-var">caf</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621680041135"><span class="hs-identifier hs-var">srt</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="CmmBuildInfoTables.html#addCAF"><span class="hs-identifier hs-var">addCAF</span></a><span> </span><a href="#local-6989586621680041136"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041135"><span class="hs-identifier hs-var">srt</span></a><span>
</span><a name="line-186"></a><span>         </span><span class="hs-comment">-- If a CAF is more than maxBmpSize entries from the young end of the</span><span>
</span><a name="line-187"></a><span>         </span><span class="hs-comment">-- SRT, then we add it to the SRT again.</span><span>
</span><a name="line-188"></a><span>         </span><span class="hs-comment">-- (Note: Not in the SRT =&gt; infinitely far.)</span><span>
</span><a name="line-189"></a><span>         </span><a name="local-6989586621680041128"><a href="#local-6989586621680041128"><span class="hs-identifier">add_if_too_far</span></a></a><span> </span><a name="local-6989586621680041137"><a href="#local-6989586621680041137"><span class="hs-identifier">srt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-var">TopSRT</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">elt_map</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680041138"><a href="#local-6989586621680041138"><span class="hs-identifier">m</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680041139"><a href="#local-6989586621680041139"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-190"></a><span>           </span><a href="#local-6989586621680041141"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621680041137"><span class="hs-identifier hs-var">srt</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a><span> </span><a href="#local-6989586621680041140"><span class="hs-identifier hs-var">farthestFst</span></a><span> </span><a href="#local-6989586621680041139"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>             </span><span class="hs-keyword">where</span><span>
</span><a name="line-192"></a><span>               </span><a name="local-6989586621680041140"><a href="#local-6989586621680041140"><span class="hs-identifier">farthestFst</span></a></a><span> </span><a name="local-6989586621680041142"><a href="#local-6989586621680041142"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621680041143"><a href="#local-6989586621680041143"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041142"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621680041138"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041143"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621680041138"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-193"></a><span>                                   </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-194"></a><span>                                   </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-195"></a><span>                                   </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span>  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-196"></a><span>                                   </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041144"><a href="#local-6989586621680041144"><span class="hs-identifier">d</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041145"><a href="#local-6989586621680041145"><span class="hs-identifier">d'</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621680041145"><span class="hs-identifier hs-var">d'</span></a><span> </span><a href="#local-6989586621680041144"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-197"></a><span>               </span><a name="local-6989586621680041141"><a href="#local-6989586621680041141"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621680041146"><a href="#local-6989586621680041146"><span class="hs-identifier">srt</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041146"><span class="hs-identifier hs-var">srt</span></a><span>
</span><a name="line-198"></a><span>               </span><span class="hs-identifier">add</span><span> </span><a name="local-6989586621680041147"><a href="#local-6989586621680041147"><span class="hs-identifier">srt</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-var">TopSRT</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">next_elt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680041148"><a href="#local-6989586621680041148"><span class="hs-identifier">next</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041149"><a href="#local-6989586621680041149"><span class="hs-identifier">caf</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680041150"><a href="#local-6989586621680041150"><span class="hs-identifier">rst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-199"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="CmmBuildInfoTables.html#cafOffset"><span class="hs-identifier hs-var">cafOffset</span></a><span> </span><a href="#local-6989586621680041147"><span class="hs-identifier hs-var">srt</span></a><span> </span><a href="#local-6989586621680041149"><span class="hs-identifier hs-var">caf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-200"></a><span>                   </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041151"><a href="#local-6989586621680041151"><span class="hs-identifier">ix</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621680041148"><span class="hs-identifier hs-var">next</span></a><span> </span><span class="hs-glyph">-</span><span> </span><a href="#local-6989586621680041151"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="CmmBuildInfoTables.html#maxBmpSize"><span class="hs-identifier hs-var">maxBmpSize</span></a><span> </span><a href="#local-6989586621680041123"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">then</span><span>
</span><a name="line-201"></a><span>                                </span><a href="#local-6989586621680041141"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#addCAF"><span class="hs-identifier hs-var">addCAF</span></a><span> </span><a href="#local-6989586621680041149"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041147"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041150"><span class="hs-identifier hs-var">rst</span></a><span>
</span><a name="line-202"></a><span>                              </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621680041147"><span class="hs-identifier hs-var">srt</span></a><span>
</span><a name="line-203"></a><span>                   </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680041141"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#addCAF"><span class="hs-identifier hs-var">addCAF</span></a><span> </span><a href="#local-6989586621680041149"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041147"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041150"><span class="hs-identifier hs-var">rst</span></a><span>
</span><a name="line-204"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621680041152"><a href="#local-6989586621680041152"><span class="hs-identifier">topSRT</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041153"><a href="#local-6989586621680041153"><span class="hs-identifier">subSRTs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041126"><span class="hs-identifier hs-var">sub_srt</span></a><span> </span><a href="#local-6989586621680041124"><span class="hs-identifier hs-var">topSRT</span></a><span> </span><a href="#local-6989586621680041125"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-205"></a><span>     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041154"><a href="#local-6989586621680041154"><span class="hs-identifier">sub_tbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041155"><a href="#local-6989586621680041155"><span class="hs-identifier">blockSRTs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041153"><span class="hs-identifier hs-var">subSRTs</span></a><span>
</span><a name="line-206"></a><span>     </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041152"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041154"><span class="hs-identifier hs-var">sub_tbls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041155"><span class="hs-identifier hs-var">blockSRTs</span></a><span class="hs-special">)</span><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- Construct an SRT bitmap.</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- Adapted from simpleStg/SRT.hs, which expects Id's.</span><span>
</span><a name="line-210"></a><span class="hs-identifier">procpointSRT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-211"></a><span>                </span><a href="UniqSupply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-type">C_SRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><a name="procpointSRT"><a href="CmmBuildInfoTables.html#procpointSRT"><span class="hs-identifier">procpointSRT</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-213"></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#NoC_SRT"><span class="hs-identifier hs-var">NoC_SRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span class="hs-identifier">procpointSRT</span><span> </span><a name="local-6989586621680041156"><a href="#local-6989586621680041156"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680041157"><a href="#local-6989586621680041157"><span class="hs-identifier">top_srt</span></a></a><span> </span><a name="local-6989586621680041158"><a href="#local-6989586621680041158"><span class="hs-identifier">top_table</span></a></a><span> </span><a name="local-6989586621680041159"><a href="#local-6989586621680041159"><span class="hs-identifier">entries</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-215"></a><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041166"><a href="#local-6989586621680041166"><span class="hs-identifier">top</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041167"><a href="#local-6989586621680041167"><span class="hs-identifier">srt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041165"><span class="hs-identifier hs-var">bitmap</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="CmmBuildInfoTables.html#to_SRT"><span class="hs-identifier hs-var">to_SRT</span></a><span> </span><a href="#local-6989586621680041156"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680041157"><span class="hs-identifier hs-var">top_srt</span></a><span> </span><a href="#local-6989586621680041162"><span class="hs-identifier hs-var">offset</span></a><span> </span><a href="#local-6989586621680041164"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680041165"><span class="hs-identifier hs-var">bitmap</span></a><span>
</span><a name="line-216"></a><span>    </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041166"><span class="hs-identifier hs-var">top</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041167"><span class="hs-identifier hs-var">srt</span></a><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-218"></a><span>    </span><a name="local-6989586621680041160"><a href="#local-6989586621680041160"><span class="hs-identifier">ints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;constructSRT&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041158"><span class="hs-identifier hs-var">top_table</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041159"><span class="hs-identifier hs-var">entries</span></a><span>
</span><a name="line-219"></a><span>    </span><a name="local-6989586621680041161"><a href="#local-6989586621680041161"><span class="hs-identifier">sorted_ints</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#sort"><span class="hs-identifier hs-var">sort</span></a><span> </span><a href="#local-6989586621680041160"><span class="hs-identifier hs-var">ints</span></a><span>
</span><a name="line-220"></a><span>    </span><a name="local-6989586621680041162"><a href="#local-6989586621680041162"><span class="hs-identifier">offset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621680041161"><span class="hs-identifier hs-var">sorted_ints</span></a><span>
</span><a name="line-221"></a><span>    </span><a name="local-6989586621680041163"><a href="#local-6989586621680041163"><span class="hs-identifier">bitmap_entries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#subtract"><span class="hs-identifier hs-var">subtract</span></a><span> </span><a href="#local-6989586621680041162"><span class="hs-identifier hs-var">offset</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041161"><span class="hs-identifier hs-var">sorted_ints</span></a><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621680041164"><a href="#local-6989586621680041164"><span class="hs-identifier">len</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#last"><span class="hs-identifier hs-var">GhcPrelude</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">last</span></a><span> </span><a href="#local-6989586621680041163"><span class="hs-identifier hs-var">bitmap_entries</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-223"></a><span>    </span><a name="local-6989586621680041165"><a href="#local-6989586621680041165"><span class="hs-identifier">bitmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Bitmap.html#intsToBitmap"><span class="hs-identifier hs-var">intsToBitmap</span></a><span> </span><a href="#local-6989586621680041156"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680041164"><span class="hs-identifier hs-var">len</span></a><span> </span><a href="#local-6989586621680041163"><span class="hs-identifier hs-var">bitmap_entries</span></a><span>
</span><a name="line-224"></a><span>
</span><a name="line-225"></a><span class="hs-identifier">maxBmpSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-226"></a><a name="maxBmpSize"><a href="CmmBuildInfoTables.html#maxBmpSize"><span class="hs-identifier">maxBmpSize</span></a></a><span> </span><a name="local-6989586621680041168"><a href="#local-6989586621680041168"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmType.html#widthInBits"><span class="hs-identifier hs-var">widthInBits</span></a><span> </span><span class="hs-special">(</span><a href="CmmType.html#wordWidth"><span class="hs-identifier hs-var">wordWidth</span></a><span> </span><a href="#local-6989586621680041168"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Real.html#div"><span class="hs-identifier hs-var">div</span></a><span class="hs-special">`</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- Adapted from codeGen/StgCmmUtils, which converts from SRT to C_SRT.</span><span>
</span><a name="line-229"></a><span class="hs-identifier">to_SRT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Bitmap.html#Bitmap"><span class="hs-identifier hs-type">Bitmap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-type">C_SRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-230"></a><a name="to_SRT"><a href="CmmBuildInfoTables.html#to_SRT"><span class="hs-identifier">to_SRT</span></a></a><span> </span><a name="local-6989586621680041169"><a href="#local-6989586621680041169"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680041170"><a href="#local-6989586621680041170"><span class="hs-identifier">top_srt</span></a></a><span> </span><a name="local-6989586621680041171"><a href="#local-6989586621680041171"><span class="hs-identifier">off</span></a></a><span> </span><a name="local-6989586621680041172"><a href="#local-6989586621680041172"><span class="hs-identifier">len</span></a></a><span> </span><a name="local-6989586621680041173"><a href="#local-6989586621680041173"><span class="hs-identifier">bmp</span></a></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680041172"><span class="hs-identifier hs-var">len</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="CmmBuildInfoTables.html#maxBmpSize"><span class="hs-identifier hs-var">maxBmpSize</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680041173"><span class="hs-identifier hs-var">bmp</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-special">[</span><a href="SMRep.html#toStgWord"><span class="hs-identifier hs-var">toStgWord</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#fromStgHalfWord"><span class="hs-identifier hs-var">fromStgHalfWord</span></a><span> </span><span class="hs-special">(</span><a href="CmmInfo.html#srtEscape"><span class="hs-identifier hs-var">srtEscape</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621680041174"><a href="#local-6989586621680041174"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqSupply.html#getUniqueM"><span class="hs-identifier hs-var">getUniqueM</span></a><span>
</span><a name="line-233"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680041175"><a href="#local-6989586621680041175"><span class="hs-identifier">srt_desc_lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CLabel.html#mkLargeSRTLabel"><span class="hs-identifier hs-var">mkLargeSRTLabel</span></a><span> </span><a href="#local-6989586621680041174"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-234"></a><span>           </span><a name="local-6989586621680041176"><a href="#local-6989586621680041176"><span class="hs-identifier">section</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#Section"><span class="hs-identifier hs-var">Section</span></a><span> </span><a href="Cmm.html#RelocatableReadOnlyData"><span class="hs-identifier hs-var">RelocatableReadOnlyData</span></a><span> </span><a href="#local-6989586621680041175"><span class="hs-identifier hs-var">srt_desc_lbl</span></a><span>
</span><a name="line-235"></a><span>           </span><a name="local-6989586621680041177"><a href="#local-6989586621680041177"><span class="hs-identifier">tbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><a href="#local-6989586621680041176"><span class="hs-identifier hs-var">section</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-236"></a><span>                   </span><a href="Cmm.html#Statics"><span class="hs-identifier hs-var">Statics</span></a><span> </span><a href="#local-6989586621680041175"><span class="hs-identifier hs-var">srt_desc_lbl</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Cmm.html#CmmStaticLit"><span class="hs-identifier hs-var">CmmStaticLit</span></a><span>
</span><a name="line-237"></a><span>                     </span><span class="hs-special">(</span><span> </span><a href="CmmUtils.html#cmmLabelOffW"><span class="hs-identifier hs-var">cmmLabelOffW</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680041170"><span class="hs-identifier hs-var">top_srt</span></a><span> </span><a href="#local-6989586621680041171"><span class="hs-identifier hs-var">off</span></a><span>
</span><a name="line-238"></a><span>                     </span><span class="hs-glyph">:</span><span> </span><a href="CmmUtils.html#mkWordCLit"><span class="hs-identifier hs-var">mkWordCLit</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a><span> </span><a href="#local-6989586621680041172"><span class="hs-identifier hs-var">len</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>                     </span><span class="hs-glyph">:</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="CmmUtils.html#mkStgWordCLit"><span class="hs-identifier hs-var">mkStgWordCLit</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041173"><span class="hs-identifier hs-var">bmp</span></a><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>       </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680041177"><span class="hs-identifier hs-var">tbl</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-var">C_SRT</span></a><span> </span><a href="#local-6989586621680041175"><span class="hs-identifier hs-var">srt_desc_lbl</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-special">(</span><a href="CmmInfo.html#srtEscape"><span class="hs-identifier hs-var">srtEscape</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-241"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-242"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-var">C_SRT</span></a><span> </span><a href="#local-6989586621680041170"><span class="hs-identifier hs-var">top_srt</span></a><span> </span><a href="#local-6989586621680041171"><span class="hs-identifier hs-var">off</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#toStgHalfWord"><span class="hs-identifier hs-var">toStgHalfWord</span></a><span> </span><a href="#local-6989586621680041169"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="SMRep.html#fromStgWord"><span class="hs-identifier hs-var">fromStgWord</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621680041173"><span class="hs-identifier hs-var">bmp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>        </span><span class="hs-comment">-- The fromIntegral converts to StgHalfWord</span><span>
</span><a name="line-244"></a><span>
</span><a name="line-245"></a><span class="hs-comment">-- Gather CAF info for a procedure, but only if the procedure</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- doesn't have a static closure.</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- (If it has a static closure, it will already have an SRT to</span><span>
</span><a name="line-248"></a><span class="hs-comment">--  keep its CAFs live.)</span><span>
</span><a name="line-249"></a><span class="hs-comment">-- Any procedure referring to a non-static CAF c must keep live</span><span>
</span><a name="line-250"></a><span class="hs-comment">-- any CAF that is reachable from c.</span><span>
</span><a name="line-251"></a><span class="hs-identifier">localCAFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-252"></a><a name="localCAFInfo"><a href="CmmBuildInfoTables.html#localCAFInfo"><span class="hs-identifier">localCAFInfo</span></a></a><span> </span><span class="hs-identifier">_</span><span>      </span><span class="hs-special">(</span><a href="Cmm.html#CmmData"><span class="hs-identifier hs-var">CmmData</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-253"></a><span class="hs-identifier">localCAFInfo</span><span> </span><a name="local-6989586621680041178"><a href="#local-6989586621680041178"><span class="hs-identifier">cafEnv</span></a></a><span> </span><a name="local-6989586621680041179"><a href="#local-6989586621680041179"><span class="hs-identifier">proc</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680041180"><a href="#local-6989586621680041180"><span class="hs-identifier">top_l</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmGraph"><span class="hs-identifier hs-var">CmmGraph</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">g_entry</span><span class="hs-glyph">=</span><a name="local-6989586621680041181"><a href="#local-6989586621680041181"><span class="hs-identifier">entry</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="Cmm.html#topInfoTable"><span class="hs-identifier hs-var">topInfoTable</span></a><span> </span><a href="#local-6989586621680041179"><span class="hs-identifier hs-var">proc</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-255"></a><span>    </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmInfoTable"><span class="hs-identifier hs-var">CmmInfoTable</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_rep</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680041183"><a href="#local-6989586621680041183"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#isStaticRep"><span class="hs-identifier hs-var">isStaticRep</span></a><span> </span><a href="#local-6989586621680041183"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="SMRep.html#isStackRep"><span class="hs-identifier hs-var">isStackRep</span></a><span> </span><a href="#local-6989586621680041183"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041182"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="CLabel.html#toClosureLbl"><span class="hs-identifier hs-var">toClosureLbl</span></a><span> </span><a href="#local-6989586621680041180"><span class="hs-identifier hs-var">top_l</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>    </span><a name="local-6989586621680041184"><a href="#local-6989586621680041184"><span class="hs-identifier">_other</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041182"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-260"></a><span>    </span><a name="local-6989586621680041182"><a href="#local-6989586621680041182"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;maybeBindCAFs&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680041181"><span class="hs-identifier hs-var">entry</span></a><span> </span><a href="#local-6989586621680041178"><span class="hs-identifier hs-var">cafEnv</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- Once we have the local CAF sets for some (possibly) mutually</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- recursive functions, we can create an environment mapping</span><span>
</span><a name="line-264"></a><span class="hs-comment">-- each function to its set of CAFs. Note that a CAF may</span><span>
</span><a name="line-265"></a><span class="hs-comment">-- be a reference to a function. If that function f does not have</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- a static closure, then we need to refer specifically</span><span>
</span><a name="line-267"></a><span class="hs-comment">-- to the set of CAFs used by f. Of course, the set of CAFs</span><span>
</span><a name="line-268"></a><span class="hs-comment">-- used by f must be included in the local CAF sets that are input to</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- this function. To minimize lookup time later, we return</span><span>
</span><a name="line-270"></a><span class="hs-comment">-- the environment with every reference to f replaced by its set of CAFs.</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- To do this replacement efficiently, we gather strongly connected</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- components, then we sort the components in topological order.</span><span>
</span><a name="line-273"></a><span class="hs-identifier">mkTopCAFInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-274"></a><a name="mkTopCAFInfo"><a href="CmmBuildInfoTables.html#mkTopCAFInfo"><span class="hs-identifier">mkTopCAFInfo</span></a></a><span> </span><a name="local-6989586621680041185"><a href="#local-6989586621680041185"><span class="hs-identifier">localCAFs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span> </span><a href="#local-6989586621680041186"><span class="hs-identifier hs-var">addToTop</span></a><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="#local-6989586621680041187"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-275"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-276"></a><span>        </span><a name="local-6989586621680041186"><a href="#local-6989586621680041186"><span class="hs-identifier">addToTop</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680041188"><a href="#local-6989586621680041188"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Graph.html#AcyclicSCC"><span class="hs-identifier hs-var">AcyclicSCC</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680041189"><a href="#local-6989586621680041189"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041190"><a href="#local-6989586621680041190"><span class="hs-identifier">cafset</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-277"></a><span>          </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680041189"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621680041188"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680041190"><span class="hs-identifier hs-var">cafset</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041188"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-278"></a><span>        </span><span class="hs-identifier">addToTop</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621680041191"><a href="#local-6989586621680041191"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Graph.html#CyclicSCC"><span class="hs-identifier hs-var">CyclicSCC</span></a><span> </span><a name="local-6989586621680041192"><a href="#local-6989586621680041192"><span class="hs-identifier">nodes</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-279"></a><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041193"><a href="#local-6989586621680041193"><span class="hs-identifier">lbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041194"><a href="#local-6989586621680041194"><span class="hs-identifier">cafsets</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-6989586621680041192"><span class="hs-identifier hs-var">nodes</span></a><span>
</span><a name="line-280"></a><span>              </span><a name="local-6989586621680041195"><a href="#local-6989586621680041195"><span class="hs-identifier">cafset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#unions"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">unions</span></a><span> </span><a href="#local-6989586621680041194"><span class="hs-identifier hs-var">cafsets</span></a><span> </span><span class="hs-special">`</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#difference"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">difference</span></a><span class="hs-special">`</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fromList</span></a><span> </span><a href="#local-6989586621680041193"><span class="hs-identifier hs-var">lbls</span></a><span>
</span><a name="line-281"></a><span>          </span><span class="hs-keyword">in</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680041196"><a href="#local-6989586621680041196"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680041197"><a href="#local-6989586621680041197"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680041197"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621680041196"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680041195"><span class="hs-identifier hs-var">cafset</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041196"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041191"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680041193"><span class="hs-identifier hs-var">lbls</span></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span>        </span><a name="local-6989586621680041187"><a href="#local-6989586621680041187"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Digraph.html#stronglyConnCompFromEdgedVerticesOrd"><span class="hs-identifier hs-var">stronglyConnCompFromEdgedVerticesOrd</span></a><span>
</span><a name="line-284"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Digraph.html#DigraphNode"><span class="hs-identifier hs-var">DigraphNode</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041199"><span class="hs-identifier hs-var">l</span></a><span class="hs-special">,</span><a href="#local-6989586621680041198"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041199"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-special">(</span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#elems"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">elems</span></a><span> </span><a href="#local-6989586621680041198"><span class="hs-identifier hs-var">cafs</span></a><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041198"><a href="#local-6989586621680041198"><span class="hs-identifier">cafs</span></a></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041199"><a href="#local-6989586621680041199"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041185"><span class="hs-identifier hs-var">localCAFs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-identifier">flatten</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-288"></a><a name="flatten"><a href="CmmBuildInfoTables.html#flatten"><span class="hs-identifier">flatten</span></a></a><span> </span><a name="local-6989586621680041200"><a href="#local-6989586621680041200"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680041201"><a href="#local-6989586621680041201"><span class="hs-identifier">cafset</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#foldSet"><span class="hs-identifier hs-var">foldSet</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041202"><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041200"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="#local-6989586621680041201"><span class="hs-identifier hs-var">cafset</span></a><span>
</span><a name="line-289"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-290"></a><span>      </span><a name="local-6989586621680041202"><a href="#local-6989586621680041202"><span class="hs-identifier">lookup</span></a></a><span> </span><a name="local-6989586621680041203"><a href="#local-6989586621680041203"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680041204"><a href="#local-6989586621680041204"><span class="hs-identifier">caf</span></a></a><span> </span><a name="local-6989586621680041205"><a href="#local-6989586621680041205"><span class="hs-identifier">cafset'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-291"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041204"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041203"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-292"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041206"><a href="#local-6989586621680041206"><span class="hs-identifier">cafs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#foldSet"><span class="hs-identifier hs-var">foldSet</span></a><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#insert"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680041205"><span class="hs-identifier hs-var">cafset'</span></a><span> </span><a href="#local-6989586621680041206"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-293"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#insert"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span></a><span> </span><a href="#local-6989586621680041204"><span class="hs-identifier hs-var">caf</span></a><span> </span><a href="#local-6989586621680041205"><span class="hs-identifier hs-var">cafset'</span></a><span>
</span><a name="line-294"></a><span>
</span><a name="line-295"></a><span class="hs-identifier">bundle</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-296"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CLabel.html#CLabel"><span class="hs-identifier hs-type">CLabel</span></a><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><a name="bundle"><a href="CmmBuildInfoTables.html#bundle"><span class="hs-identifier">bundle</span></a></a><span> </span><a name="local-6989586621680041207"><a href="#local-6989586621680041207"><span class="hs-identifier">flatmap</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680041208"><a href="#local-6989586621680041208"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041209"><a href="#local-6989586621680041209"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680041210"><a href="#local-6989586621680041210"><span class="hs-identifier">infos</span></a></a><span> </span><a name="local-6989586621680041211"><a href="#local-6989586621680041211"><span class="hs-identifier">_lbl</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680041212"><a href="#local-6989586621680041212"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041213"><a href="#local-6989586621680041213"><span class="hs-identifier">closure_cafs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041214"><a href="#local-6989586621680041214"><span class="hs-identifier">mb_lbl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Collections.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a><span> </span><a href="#local-6989586621680041217"><span class="hs-identifier hs-var">get_cafs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680041210"><span class="hs-identifier hs-var">infos</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041209"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-302"></a><span>  </span><a name="local-6989586621680041215"><a href="#local-6989586621680041215"><span class="hs-identifier">entry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">g_entry</span><span> </span><a href="#local-6989586621680041212"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>  </span><a name="local-6989586621680041216"><a href="#local-6989586621680041216"><span class="hs-identifier">entry_cafs</span></a></a><span>
</span><a name="line-305"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041218"><a href="#local-6989586621680041218"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041214"><span class="hs-identifier hs-var">mb_lbl</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;bundle&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span></a><span> </span><a href="#local-6989586621680041218"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680041207"><span class="hs-identifier hs-var">flatmap</span></a><span>
</span><a name="line-306"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621680041207"><span class="hs-identifier hs-var">flatmap</span></a><span> </span><a href="#local-6989586621680041213"><span class="hs-identifier hs-var">closure_cafs</span></a><span>
</span><a name="line-307"></a><span>
</span><a name="line-308"></a><span>  </span><a name="local-6989586621680041217"><a href="#local-6989586621680041217"><span class="hs-identifier">get_cafs</span></a></a><span> </span><a name="local-6989586621680041219"><a href="#local-6989586621680041219"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-309"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680041219"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680041215"><span class="hs-identifier hs-var">entry</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041216"><span class="hs-identifier hs-var">entry_cafs</span></a><span>
</span><a name="line-310"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680041220"><a href="#local-6989586621680041220"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680041219"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680041208"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><a href="#local-6989586621680041207"><span class="hs-identifier hs-var">flatmap</span></a><span> </span><a href="#local-6989586621680041220"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-311"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../containers-0.5.11.0/src/%{MODULE/./-}.html#%{NAME}/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-312"></a><span>    </span><span class="hs-comment">-- the label might not be in the env if the code corresponding to</span><span>
</span><a name="line-313"></a><span>    </span><span class="hs-comment">-- this info table was optimised away (perhaps because it was</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-comment">-- unreachable).  In this case it doesn't matter what SRT we</span><span>
</span><a name="line-315"></a><span>    </span><span class="hs-comment">-- infer, since the info table will not appear in the generated</span><span>
</span><a name="line-316"></a><span>    </span><span class="hs-comment">-- code.  See #9329.</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-identifier">bundle</span><span> </span><a name="local-6989586621680041221"><a href="#local-6989586621680041221"><span class="hs-identifier">_flatmap</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680041222"><a href="#local-6989586621680041222"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041222"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-identifier">flattenCAFSets</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span class="hs-special">,</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-323"></a><a name="flattenCAFSets"><a href="CmmBuildInfoTables.html#flattenCAFSets"><span class="hs-identifier">flattenCAFSets</span></a></a><span> </span><a name="local-6989586621680041223"><a href="#local-6989586621680041223"><span class="hs-identifier">cpsdecls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zipWith"><span class="hs-identifier hs-var">zipWith</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#bundle"><span class="hs-identifier hs-var">bundle</span></a><span> </span><a href="#local-6989586621680041226"><span class="hs-identifier hs-var">flatmap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041224"><span class="hs-identifier hs-var">zipped</span></a><span> </span><a href="#local-6989586621680041225"><span class="hs-identifier hs-var">localCAFs</span></a><span>
</span><a name="line-324"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-325"></a><span>     </span><a name="local-6989586621680041224"><a href="#local-6989586621680041224"><span class="hs-identifier">zipped</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041227"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><a href="#local-6989586621680041229"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041227"><a href="#local-6989586621680041227"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><a name="local-6989586621680041228"><a href="#local-6989586621680041228"><span class="hs-identifier">decls</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041223"><span class="hs-identifier hs-var">cpsdecls</span></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041229"><a href="#local-6989586621680041229"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680041228"><span class="hs-identifier hs-var">decls</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-326"></a><span>     </span><a name="local-6989586621680041225"><a href="#local-6989586621680041225"><span class="hs-identifier">localCAFs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#unzipWith"><span class="hs-identifier hs-var">unzipWith</span></a><span> </span><a href="CmmBuildInfoTables.html#localCAFInfo"><span class="hs-identifier hs-var">localCAFInfo</span></a><span> </span><a href="#local-6989586621680041224"><span class="hs-identifier hs-var">zipped</span></a><span>
</span><a name="line-327"></a><span>     </span><a name="local-6989586621680041226"><a href="#local-6989586621680041226"><span class="hs-identifier">flatmap</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#mkTopCAFInfo"><span class="hs-identifier hs-var">mkTopCAFInfo</span></a><span> </span><a href="#local-6989586621680041225"><span class="hs-identifier hs-var">localCAFs</span></a><span> </span><span class="hs-comment">-- transitive closure of localCAFs</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">doSRTs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-330"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span>
</span><a name="line-331"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#CAFEnv"><span class="hs-identifier hs-type">CAFEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-332"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><a name="doSRTs"><a href="CmmBuildInfoTables.html#doSRTs"><span class="hs-identifier">doSRTs</span></a></a><span> </span><a name="local-6989586621680041230"><a href="#local-6989586621680041230"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680041231"><a href="#local-6989586621680041231"><span class="hs-identifier">topSRT</span></a></a><span> </span><a name="local-6989586621680041232"><a href="#local-6989586621680041232"><span class="hs-identifier">tops</span></a></a><span>
</span><a name="line-335"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-336"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680041245"><a href="#local-6989586621680041245"><span class="hs-identifier">caf_decls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#flattenCAFSets"><span class="hs-identifier hs-var">flattenCAFSets</span></a><span> </span><a href="#local-6989586621680041232"><span class="hs-identifier hs-var">tops</span></a><span>
</span><a name="line-337"></a><span>     </span><a name="local-6989586621680041246"><a href="#local-6989586621680041246"><span class="hs-identifier">us</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqSupply.html#mkSplitUniqSupply"><span class="hs-identifier hs-var">mkSplitUniqSupply</span></a><span> </span><span class="hs-char">'u'</span><span>
</span><a name="line-338"></a><span>     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041247"><a href="#local-6989586621680041247"><span class="hs-identifier">topSRT'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041248"><a href="#local-6989586621680041248"><span class="hs-identifier">gs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqSupply.html#initUs_"><span class="hs-identifier hs-var">initUs_</span></a><span> </span><a href="#local-6989586621680041246"><span class="hs-identifier hs-var">us</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#foldM"><span class="hs-identifier hs-var">foldM</span></a><span> </span><a href="#local-6989586621680041233"><span class="hs-identifier hs-var">setSRT</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041231"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041245"><span class="hs-identifier hs-var">caf_decls</span></a><span>
</span><a name="line-339"></a><span>     </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041247"><span class="hs-identifier hs-var">topSRT'</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-6989586621680041248"><span class="hs-identifier hs-var">gs'</span></a><span> </span><span class="hs-comment">{- Note [reverse gs] -}</span><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-341"></a><span>    </span><a name="local-6989586621680041233"><a href="#local-6989586621680041233"><span class="hs-identifier">setSRT</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680041234"><a href="#local-6989586621680041234"><span class="hs-identifier">topSRT</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041235"><a href="#local-6989586621680041235"><span class="hs-identifier">rst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041236"><a href="#local-6989586621680041236"><span class="hs-identifier">caf_map</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041237"><a href="#local-6989586621680041237"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-342"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621680041238"><a href="#local-6989586621680041238"><span class="hs-identifier">topSRT</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041239"><a href="#local-6989586621680041239"><span class="hs-identifier">srt_tables</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041240"><a href="#local-6989586621680041240"><span class="hs-identifier">srt_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#buildSRTs"><span class="hs-identifier hs-var">buildSRTs</span></a><span> </span><a href="#local-6989586621680041230"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680041234"><span class="hs-identifier hs-var">topSRT</span></a><span> </span><a href="#local-6989586621680041236"><span class="hs-identifier hs-var">caf_map</span></a><span>
</span><a name="line-343"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680041241"><a href="#local-6989586621680041241"><span class="hs-identifier">decl'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CmmBuildInfoTables.html#updInfoSRTs"><span class="hs-identifier hs-var">updInfoSRTs</span></a><span> </span><a href="#local-6989586621680041240"><span class="hs-identifier hs-var">srt_env</span></a><span> </span><a href="#local-6989586621680041237"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-344"></a><span>       </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041238"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041241"><span class="hs-identifier hs-var">decl'</span></a><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680041239"><span class="hs-identifier hs-var">srt_tables</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680041235"><span class="hs-identifier hs-var">rst</span></a><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span>    </span><span class="hs-identifier">setSRT</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041242"><a href="#local-6989586621680041242"><span class="hs-identifier">topSRT</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041243"><a href="#local-6989586621680041243"><span class="hs-identifier">rst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680041244"><a href="#local-6989586621680041244"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-346"></a><span>      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041242"><span class="hs-identifier hs-var">topSRT</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680041244"><span class="hs-identifier hs-var">decl</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680041243"><span class="hs-identifier hs-var">rst</span></a><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span class="hs-identifier">buildSRTs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="CmmBuildInfoTables.html#CAFSet"><span class="hs-identifier hs-type">CAFSet</span></a><span>
</span><a name="line-349"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSM"><span class="hs-identifier hs-type">UniqSM</span></a><span> </span><span class="hs-special">(</span><a href="CmmBuildInfoTables.html#TopSRT"><span class="hs-identifier hs-type">TopSRT</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-type">C_SRT</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><a name="buildSRTs"><a href="CmmBuildInfoTables.html#buildSRTs"><span class="hs-identifier">buildSRTs</span></a></a><span> </span><a name="local-6989586621680041249"><a href="#local-6989586621680041249"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680041250"><a href="#local-6989586621680041250"><span class="hs-identifier">top_srt</span></a></a><span> </span><a name="local-6989586621680041251"><a href="#local-6989586621680041251"><span class="hs-identifier">caf_map</span></a></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#foldM"><span class="hs-identifier hs-var">foldM</span></a><span> </span><a href="#local-6989586621680041252"><span class="hs-identifier hs-var">doOne</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041250"><span class="hs-identifier hs-var">top_srt</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapEmpty"><span class="hs-identifier hs-var">mapEmpty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Hoopl.Collections.html#mapToList"><span class="hs-identifier hs-var">mapToList</span></a><span> </span><a href="#local-6989586621680041251"><span class="hs-identifier hs-var">caf_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-353"></a><span>  </span><a name="local-6989586621680041252"><a href="#local-6989586621680041252"><span class="hs-identifier">doOne</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680041253"><a href="#local-6989586621680041253"><span class="hs-identifier">top_srt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041254"><a href="#local-6989586621680041254"><span class="hs-identifier">decls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041255"><a href="#local-6989586621680041255"><span class="hs-identifier">srt_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041256"><a href="#local-6989586621680041256"><span class="hs-identifier">l</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041257"><a href="#local-6989586621680041257"><span class="hs-identifier">cafs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-354"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680041258"><a href="#local-6989586621680041258"><span class="hs-identifier">top_srt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041259"><a href="#local-6989586621680041259"><span class="hs-identifier">mb_decl</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680041260"><a href="#local-6989586621680041260"><span class="hs-identifier">srt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CmmBuildInfoTables.html#buildSRT"><span class="hs-identifier hs-var">buildSRT</span></a><span> </span><a href="#local-6989586621680041249"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680041253"><span class="hs-identifier hs-var">top_srt</span></a><span> </span><a href="#local-6989586621680041257"><span class="hs-identifier hs-var">cafs</span></a><span>
</span><a name="line-355"></a><span>         </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680041258"><span class="hs-identifier hs-var">top_srt</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#maybeToList"><span class="hs-identifier hs-var">maybeToList</span></a><span> </span><a href="#local-6989586621680041259"><span class="hs-identifier hs-var">mb_decl</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680041254"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-356"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Hoopl.Collections.html#mapInsert"><span class="hs-identifier hs-var">mapInsert</span></a><span> </span><a href="#local-6989586621680041256"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680041260"><span class="hs-identifier hs-var">srt</span></a><span> </span><a href="#local-6989586621680041255"><span class="hs-identifier hs-var">srt_env</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span class="hs-comment">{-
- In each CmmDecl there is a mapping from BlockId -&gt; CmmInfoTable
- The one corresponding to g_entry is the closure info table, the
  rest are continuations.
- Each one needs an SRT.
- We get the CAFSet for each one from the CAFEnv
- flatten gives us
    [(LabelMap CAFSet, CmmDecl)]
-
-}</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>
</span><a name="line-370"></a><span class="hs-comment">{- Note [reverse gs]

   It is important to keep the code blocks in the same order,
   otherwise binary sizes get slightly bigger.  I'm not completely
   sure why this is, perhaps the assembler generates bigger jump
   instructions for forward refs.  --SDM
-}</span><span>
</span><a name="line-377"></a><span>
</span><a name="line-378"></a><span class="hs-identifier">updInfoSRTs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hoopl.Label.html#LabelMap"><span class="hs-identifier hs-type">LabelMap</span></a><span> </span><a href="Cmm.html#C_SRT"><span class="hs-identifier hs-type">C_SRT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Cmm.html#CmmDecl"><span class="hs-identifier hs-type">CmmDecl</span></a><span>
</span><a name="line-379"></a><a name="updInfoSRTs"><a href="CmmBuildInfoTables.html#updInfoSRTs"><span class="hs-identifier">updInfoSRTs</span></a></a><span> </span><a name="local-6989586621680041261"><a href="#local-6989586621680041261"><span class="hs-identifier">srt_env</span></a></a><span> </span><span class="hs-special">(</span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><a name="local-6989586621680041262"><a href="#local-6989586621680041262"><span class="hs-identifier">top_info</span></a></a><span> </span><a name="local-6989586621680041263"><a href="#local-6989586621680041263"><span class="hs-identifier">top_l</span></a></a><span> </span><a name="local-6989586621680041264"><a href="#local-6989586621680041264"><span class="hs-identifier">live</span></a></a><span> </span><a name="local-6989586621680041265"><a href="#local-6989586621680041265"><span class="hs-identifier">g</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-380"></a><span>  </span><a href="Cmm.html#CmmProc"><span class="hs-identifier hs-var">CmmProc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680041262"><span class="hs-identifier hs-var">top_info</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">info_tbls</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hoopl.Collections.html#mapMapWithKey"><span class="hs-identifier hs-var">mapMapWithKey</span></a><span> </span><a href="#local-6989586621680041266"><span class="hs-identifier hs-var">updInfoTbl</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">info_tbls</span><span> </span><a href="#local-6989586621680041262"><span class="hs-identifier hs-var">top_info</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680041263"><span class="hs-identifier hs-var">top_l</span></a><span> </span><a href="#local-6989586621680041264"><span class="hs-identifier hs-var">live</span></a><span> </span><a href="#local-6989586621680041265"><span class="hs-identifier hs-var">g</span></a><span>
</span><a name="line-381"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680041266"><a href="#local-6989586621680041266"><span class="hs-identifier">updInfoTbl</span></a></a><span> </span><a name="local-6989586621680041267"><a href="#local-6989586621680041267"><span class="hs-identifier">l</span></a></a><span> </span><a name="local-6989586621680041268"><a href="#local-6989586621680041268"><span class="hs-identifier">info_tbl</span></a></a><span>
</span><a name="line-382"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041268"><span class="hs-identifier hs-var">info_tbl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">cit_srt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;updInfo&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Hoopl.Collections.html#mapLookup"><span class="hs-identifier hs-var">mapLookup</span></a><span> </span><a href="#local-6989586621680041267"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="#local-6989586621680041261"><span class="hs-identifier hs-var">srt_env</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-383"></a><span class="hs-identifier">updInfoSRTs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680041269"><a href="#local-6989586621680041269"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680041269"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-384"></a></pre></body></html>