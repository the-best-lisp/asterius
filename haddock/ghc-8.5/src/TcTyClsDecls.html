<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The AQUA Project, Glasgow University, 1996-1998


TcTyClsDecls: Typecheck type and class declarations
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP, TupleSections, MultiWayIf #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TcTyClsDecls</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>        </span><a href="TcTyClsDecls.html#tcTyAndClassDecls"><span class="hs-identifier hs-var">tcTyAndClassDecls</span></a><span class="hs-special">,</span><span> </span><a href="TcTyDecls.html#tcAddImplicits"><span class="hs-identifier hs-var">tcAddImplicits</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>        </span><span class="hs-comment">-- Functions used by TcInstDcls to check</span><span>
</span><a name="line-16"></a><span>        </span><span class="hs-comment">-- data/type family instance declarations</span><span>
</span><a name="line-17"></a><span>        </span><a href="TcTyClsDecls.html#kcDataDefn"><span class="hs-identifier hs-var">kcDataDefn</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#tcConDecls"><span class="hs-identifier hs-var">tcConDecls</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#dataDeclChecks"><span class="hs-identifier hs-var">dataDeclChecks</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#checkValidTyCon"><span class="hs-identifier hs-var">checkValidTyCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="TcTyClsDecls.html#tcFamTyPats"><span class="hs-identifier hs-var">tcFamTyPats</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#tcTyFamInstEqn"><span class="hs-identifier hs-var">tcTyFamInstEqn</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="TcTyClsDecls.html#tcAddTyFamInstCtxt"><span class="hs-identifier hs-var">tcAddTyFamInstCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#tcMkDataFamInstCtxt"><span class="hs-identifier hs-var">tcMkDataFamInstCtxt</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#tcAddDataFamInstCtxt"><span class="hs-identifier hs-var">tcAddDataFamInstCtxt</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="TcTyClsDecls.html#wrongKindOfFamily"><span class="hs-identifier hs-var">wrongKindOfFamily</span></a><span class="hs-special">,</span><span> </span><a href="TcTyClsDecls.html#dataConCtxt"><span class="hs-identifier hs-var">dataConCtxt</span></a><span>
</span><a name="line-21"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="HsSyn.html"><span class="hs-identifier">HsSyn</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="HscTypes.html"><span class="hs-identifier">HscTypes</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="BuildTyCl.html"><span class="hs-identifier">BuildTyCl</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="TcRnMonad.html"><span class="hs-identifier">TcRnMonad</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="TcEnv.html"><span class="hs-identifier">TcEnv</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="TcValidity.html"><span class="hs-identifier">TcValidity</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsSyn.html"><span class="hs-identifier">TcHsSyn</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="TcTyDecls.html"><span class="hs-identifier">TcTyDecls</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="TcClassDcl.html"><span class="hs-identifier">TcClassDcl</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-pragma">{-# SOURCE #-}</span><span> </span><a href="TcInstDcls.html"><span class="hs-identifier">TcInstDcls</span></a><span class="hs-special">(</span><span> </span><a href="TcInstDcls.html#tcInstDecls1"><span class="hs-identifier hs-var">tcInstDecls1</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="TcDeriv.html"><span class="hs-identifier">TcDeriv</span></a><span> </span><span class="hs-special">(</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="TcEvidence.html"><span class="hs-identifier">TcEvidence</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="TcEvidence.html#tcCoercionKind"><span class="hs-identifier hs-var">tcCoercionKind</span></a><span class="hs-special">,</span><span> </span><a href="TcEvidence.html#isEmptyTcEvBinds"><span class="hs-identifier hs-var">isEmptyTcEvBinds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="TcUnify.html"><span class="hs-identifier">TcUnify</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="TcHsType.html"><span class="hs-identifier">TcHsType</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="TcMType.html"><span class="hs-identifier">TcMType</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TysWiredIn.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="TcType.html"><span class="hs-identifier">TcType</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="RnEnv.html"><span class="hs-identifier">RnEnv</span></a><span class="hs-special">(</span><span> </span><a href="RnEnv.html#lookupConstructorFields"><span class="hs-identifier hs-var">lookupConstructorFields</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="FamInst.html"><span class="hs-identifier">FamInst</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="FamInstEnv.html"><span class="hs-identifier">FamInstEnv</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="TyCoRep.html"><span class="hs-identifier">TyCoRep</span></a><span>   </span><span class="hs-comment">-- for checkValidRoles</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="Kind.html"><span class="hs-identifier">Kind</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Class.html"><span class="hs-identifier">Class</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="CoAxiom.html"><span class="hs-identifier">CoAxiom</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><a href="Unify.html"><span class="hs-identifier">Unify</span></a><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><a href="ListSetOps.html"><span class="hs-identifier">ListSetOps</span></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="Unique.html"><span class="hs-identifier">Unique</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="../ghc-boot-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.html"><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">LanguageExtensions</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LangExt</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html"><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.List.NonEmpty.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">NonEmpty</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Type checking for type and class declarations}
*                                                                      *
************************************************************************

Note [Grouping of type and class declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
tcTyAndClassDecls is called on a list of `TyClGroup`s. Each group is a strongly
connected component of mutually dependent types and classes. We kind check and
type check each group separately to enhance kind polymorphism. Take the
following example:

  type Id a = a
  data X = X (Id Int)

If we were to kind check the two declarations together, we would give Id the
kind * -&gt; *, since we apply it to an Int in the definition of X. But we can do
better than that, since Id really is kind polymorphic, and should get kind
forall (k::*). k -&gt; k. Since it does not depend on anything else, it can be
kind-checked by itself, hence getting the most general kind. We then kind check
X, which works fine because we then know the polymorphic kind of Id, and simply
instantiate k to *.

Note [Check role annotations in a second pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Role inference potentially depends on the types of all of the datacons declared
in a mutually recursive group. The validity of a role annotation, in turn,
depends on the result of role inference. Because the types of datacons might
be ill-formed (see #7175 and Note [Checking GADT return types]) we must check
*all* the tycons in a group for validity before checking *any* of the roles.
Thus, we take two passes over the resulting tycons, first checking for general
validity and then checking for valid role annotations.
-}</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-identifier">tcTyAndClassDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-type">TyClGroup</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Mutually-recursive groups in</span><span>
</span><a name="line-116"></a><span>                                            </span><span class="hs-comment">-- dependency order</span><span>
</span><a name="line-117"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span>         </span><span class="hs-comment">-- Input env extended by types and</span><span>
</span><a name="line-118"></a><span>                                            </span><span class="hs-comment">-- classes</span><span>
</span><a name="line-119"></a><span>                                            </span><span class="hs-comment">-- and their implicit Ids,DataCons</span><span>
</span><a name="line-120"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Source-code instance decls info</span><span>
</span><a name="line-121"></a><span>                         </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- data family deriving info</span><span>
</span><a name="line-122"></a><span>                         </span><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- Fails if there are any errors</span><span>
</span><a name="line-124"></a><a name="tcTyAndClassDecls"><a href="TcTyClsDecls.html#tcTyAndClassDecls"><span class="hs-identifier">tcTyAndClassDecls</span></a></a><span> </span><a name="local-6989586621680455914"><a href="#local-6989586621680455914"><span class="hs-identifier">tyclds_s</span></a></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-comment">-- The code recovers internally, but if anything gave rise to</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-comment">-- an error we'd better stop now, to avoid a cascade</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-comment">-- Type check each group in dependency order folding the global env</span><span>
</span><a name="line-128"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="#local-6989586621680455915"><span class="hs-identifier hs-var">fold_env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680455914"><span class="hs-identifier hs-var">tyclds_s</span></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-130"></a><span>    </span><span class="hs-identifier">fold_env</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>
</span><a name="line-131"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span>
</span><a name="line-132"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-type">TyClGroup</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>
</span><a name="line-133"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>    </span><a name="local-6989586621680455915"><a href="#local-6989586621680455915"><span class="hs-identifier">fold_env</span></a></a><span> </span><a name="local-6989586621680455916"><a href="#local-6989586621680455916"><span class="hs-identifier">inst_info</span></a></a><span> </span><a name="local-6989586621680455917"><a href="#local-6989586621680455917"><span class="hs-identifier">deriv_info</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455918"><a href="#local-6989586621680455918"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-136"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455918"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680455916"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680455917"><span class="hs-identifier hs-var">deriv_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-137"></a><span>    </span><span class="hs-identifier">fold_env</span><span> </span><a name="local-6989586621680455919"><a href="#local-6989586621680455919"><span class="hs-identifier">inst_info</span></a></a><span> </span><a name="local-6989586621680455920"><a href="#local-6989586621680455920"><span class="hs-identifier">deriv_info</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680455921"><a href="#local-6989586621680455921"><span class="hs-identifier">tyclds</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680455922"><a href="#local-6989586621680455922"><span class="hs-identifier">tyclds_s</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680455923"><a href="#local-6989586621680455923"><span class="hs-identifier">tcg_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680455924"><a href="#local-6989586621680455924"><span class="hs-identifier">inst_info'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680455925"><a href="#local-6989586621680455925"><span class="hs-identifier">deriv_info'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcTyClGroup"><span class="hs-identifier hs-var">tcTyClGroup</span></a><span> </span><a href="#local-6989586621680455921"><span class="hs-identifier hs-var">tyclds</span></a><span>
</span><a name="line-139"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621680455923"><span class="hs-identifier hs-var">tcg_env</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-140"></a><span>               </span><span class="hs-comment">-- remaining groups are typechecked in the extended global env.</span><span>
</span><a name="line-141"></a><span>             </span><a href="#local-6989586621680455915"><span class="hs-identifier hs-var">fold_env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455924"><span class="hs-identifier hs-var">inst_info'</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680455919"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span>                      </span><span class="hs-special">(</span><a href="#local-6989586621680455925"><span class="hs-identifier hs-var">deriv_info'</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680455920"><span class="hs-identifier hs-var">deriv_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>                      </span><a href="#local-6989586621680455922"><span class="hs-identifier hs-var">tyclds_s</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">tcTyClGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-type">TyClGroup</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-146"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TcGblEnv"><span class="hs-identifier hs-type">TcGblEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcEnv.html#InstInfo"><span class="hs-identifier hs-type">InstInfo</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TcDeriv.html#DerivInfo"><span class="hs-identifier hs-type">DerivInfo</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- Typecheck one strongly-connected component of type, class, and instance decls</span><span>
</span><a name="line-148"></a><span class="hs-comment">-- See Note [TyClGroups and dependency analysis] in HsDecls</span><span>
</span><a name="line-149"></a><a name="tcTyClGroup"><a href="TcTyClsDecls.html#tcTyClGroup"><span class="hs-identifier">tcTyClGroup</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#TyClGroup"><span class="hs-identifier hs-var">TyClGroup</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">group_tyclds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680455926"><a href="#local-6989586621680455926"><span class="hs-identifier">tyclds</span></a></a><span>
</span><a name="line-150"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_roles</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680455927"><a href="#local-6989586621680455927"><span class="hs-identifier">roles</span></a></a><span>
</span><a name="line-151"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">group_instds</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680455928"><a href="#local-6989586621680455928"><span class="hs-identifier">instds</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455929"><a href="#local-6989586621680455929"><span class="hs-identifier">role_annots</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#mkRoleAnnotEnv"><span class="hs-identifier hs-var">mkRoleAnnotEnv</span></a><span> </span><a href="#local-6989586621680455927"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>           </span><span class="hs-comment">-- Step 1: Typecheck the type/class declarations</span><span>
</span><a name="line-155"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- tcTyClGroup ---- {&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-156"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Decls for&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#tcdName"><span class="hs-identifier hs-var">tcdName</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455926"><span class="hs-identifier hs-var">tyclds</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455930"><a href="#local-6989586621680455930"><span class="hs-identifier">tyclss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcTyClDecls"><span class="hs-identifier hs-var">tcTyClDecls</span></a><span> </span><a href="#local-6989586621680455926"><span class="hs-identifier hs-var">tyclds</span></a><span> </span><a href="#local-6989586621680455929"><span class="hs-identifier hs-var">role_annots</span></a><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span>           </span><span class="hs-comment">-- Step 1.5: Make sure we don't have any type synonym cycles</span><span>
</span><a name="line-160"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Starting synonym cycle check&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455930"><span class="hs-identifier hs-var">tyclss</span></a><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455931"><a href="#local-6989586621680455931"><span class="hs-identifier">this_uid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="DynFlags.html#thisPackage"><span class="hs-identifier hs-var">thisPackage</span></a><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-162"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcTyDecls.html#checkSynCycles"><span class="hs-identifier hs-var">checkSynCycles</span></a><span> </span><a href="#local-6989586621680455931"><span class="hs-identifier hs-var">this_uid</span></a><span> </span><a href="#local-6989586621680455930"><span class="hs-identifier hs-var">tyclss</span></a><span> </span><a href="#local-6989586621680455926"><span class="hs-identifier hs-var">tyclds</span></a><span>
</span><a name="line-163"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Done synonym cycle check&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455930"><span class="hs-identifier hs-var">tyclss</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span>           </span><span class="hs-comment">-- Step 2: Perform the validity check on those types/classes</span><span>
</span><a name="line-166"></a><span>           </span><span class="hs-comment">-- We can do this now because we are done with the recursive knot</span><span>
</span><a name="line-167"></a><span>           </span><span class="hs-comment">-- Do it before Step 3 (adding implicit things) because the latter</span><span>
</span><a name="line-168"></a><span>           </span><span class="hs-comment">-- expects well-formed TyCons</span><span>
</span><a name="line-169"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Starting validity check&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455930"><span class="hs-identifier hs-var">tyclss</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455932"><a href="#local-6989586621680455932"><span class="hs-identifier">tyclss</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcTyClsDecls.html#checkValidTyCl"><span class="hs-identifier hs-var">checkValidTyCl</span></a><span> </span><a href="#local-6989586621680455930"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-171"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Done validity check&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455932"><span class="hs-identifier hs-var">tyclss</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcTyClsDecls.html#checkValidRoleAnnots"><span class="hs-identifier hs-var">checkValidRoleAnnots</span></a><span> </span><a href="#local-6989586621680455929"><span class="hs-identifier hs-var">role_annots</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455932"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-173"></a><span>           </span><span class="hs-comment">-- See Note [Check role annotations in a second pass]</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- end tcTyClGroup ---- }&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-176"></a><span>
</span><a name="line-177"></a><span>           </span><span class="hs-comment">-- Step 3: Add the implicit things;</span><span>
</span><a name="line-178"></a><span>           </span><span class="hs-comment">-- we want them in the environment because</span><span>
</span><a name="line-179"></a><span>           </span><span class="hs-comment">-- they may be mentioned in interface files</span><span>
</span><a name="line-180"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendTyConEnv"><span class="hs-identifier hs-var">tcExtendTyConEnv</span></a><span> </span><a href="#local-6989586621680455932"><span class="hs-identifier hs-var">tyclss</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-181"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455933"><a href="#local-6989586621680455933"><span class="hs-identifier">gbl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyDecls.html#tcAddImplicits"><span class="hs-identifier hs-var">tcAddImplicits</span></a><span> </span><a href="#local-6989586621680455932"><span class="hs-identifier hs-var">tyclss</span></a><span>
</span><a name="line-182"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#setGblEnv"><span class="hs-identifier hs-var">setGblEnv</span></a><span> </span><a href="#local-6989586621680455933"><span class="hs-identifier hs-var">gbl_env</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-184"></a><span>            </span><span class="hs-comment">-- Step 4: check instance declarations</span><span>
</span><a name="line-185"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680455934"><a href="#local-6989586621680455934"><span class="hs-identifier">gbl_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680455935"><a href="#local-6989586621680455935"><span class="hs-identifier">inst_info</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680455936"><a href="#local-6989586621680455936"><span class="hs-identifier">datafam_deriv_info</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcInstDcls.html#tcInstDecls1"><span class="hs-identifier hs-var">tcInstDecls1</span></a><span> </span><a href="#local-6989586621680455928"><span class="hs-identifier hs-var">instds</span></a><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455934"><span class="hs-identifier hs-var">gbl_env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680455935"><span class="hs-identifier hs-var">inst_info</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680455936"><span class="hs-identifier hs-var">datafam_deriv_info</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">tcTyClDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#RoleAnnotEnv"><span class="hs-identifier hs-type">RoleAnnotEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-190"></a><a name="tcTyClDecls"><a href="TcTyClsDecls.html#tcTyClDecls"><span class="hs-identifier">tcTyClDecls</span></a></a><span> </span><a name="local-6989586621680455937"><a href="#local-6989586621680455937"><span class="hs-identifier">tyclds</span></a></a><span> </span><a name="local-6989586621680455938"><a href="#local-6989586621680455938"><span class="hs-identifier">role_annots</span></a></a><span>
</span><a name="line-191"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>    </span><span class="hs-comment">-- Step 1: kind-check this group and returns the final</span><span>
</span><a name="line-192"></a><span>            </span><span class="hs-comment">-- (possibly-polymorphic) kind of each TyCon and Class</span><span>
</span><a name="line-193"></a><span>            </span><span class="hs-comment">-- See Note [Kind checking for type and class decls]</span><span>
</span><a name="line-194"></a><span>         </span><a name="local-6989586621680455941"><a href="#local-6989586621680455941"><span class="hs-identifier">tc_tycons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#kcTyClGroup"><span class="hs-identifier hs-var">kcTyClGroup</span></a><span> </span><a href="#local-6989586621680455937"><span class="hs-identifier hs-var">tyclds</span></a><span>
</span><a name="line-195"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcTyAndCl generalized kinds&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680455939"><span class="hs-identifier hs-var">ppr_tc_tycon</span></a><span> </span><a href="#local-6989586621680455941"><span class="hs-identifier hs-var">tc_tycons</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span>            </span><span class="hs-comment">-- Step 2: type-check all groups together, returning</span><span>
</span><a name="line-198"></a><span>            </span><span class="hs-comment">-- the final TyCons and Classes</span><span>
</span><a name="line-199"></a><span>            </span><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span>            </span><span class="hs-comment">-- NB: We have to be careful here to NOT eagerly unfold</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-comment">-- type synonyms, as we have not tested for type synonym</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-comment">-- loops yet and could fall into a black hole.</span><span>
</span><a name="line-203"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="IOEnv.html#fixM"><span class="hs-identifier hs-var">fixM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-glyph">~</span><a name="local-6989586621680455942"><a href="#local-6989586621680455942"><span class="hs-identifier">rec_tyclss</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-204"></a><span>           </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455943"><a href="#local-6989586621680455943"><span class="hs-identifier">tcg_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-205"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455944"><a href="#local-6989586621680455944"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyDecls.html#inferRoles"><span class="hs-identifier hs-var">inferRoles</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621680455943"><span class="hs-identifier hs-var">tcg_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455938"><span class="hs-identifier hs-var">role_annots</span></a><span> </span><a href="#local-6989586621680455942"><span class="hs-identifier hs-var">rec_tyclss</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span>                 </span><span class="hs-comment">-- Populate environment with knot-tied ATyCon for TyCons</span><span>
</span><a name="line-208"></a><span>                 </span><span class="hs-comment">-- NB: if the decls mention any ill-staged data cons</span><span>
</span><a name="line-209"></a><span>                 </span><span class="hs-comment">-- (see Note [Recursion and promoting data constructors])</span><span>
</span><a name="line-210"></a><span>                 </span><span class="hs-comment">-- we will have failed already in kcTyClGroup, so no worries here</span><span>
</span><a name="line-211"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendRecEnv"><span class="hs-identifier hs-var">tcExtendRecEnv</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#zipRecTyClss"><span class="hs-identifier hs-var">zipRecTyClss</span></a><span> </span><a href="#local-6989586621680455941"><span class="hs-identifier hs-var">tc_tycons</span></a><span> </span><a href="#local-6989586621680455942"><span class="hs-identifier hs-var">rec_tyclss</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-212"></a><span>
</span><a name="line-213"></a><span>                 </span><span class="hs-comment">-- Also extend the local type envt with bindings giving</span><span>
</span><a name="line-214"></a><span>                 </span><span class="hs-comment">-- the (polymorphic) kind of each knot-tied TyCon or Class</span><span>
</span><a name="line-215"></a><span>                 </span><span class="hs-comment">-- See Note [Type checking recursive type and class declarations]</span><span>
</span><a name="line-216"></a><span>             </span><a href="TcEnv.html#tcExtendKindEnv"><span class="hs-identifier hs-var">tcExtendKindEnv</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="TcTyClsDecls.html#extendEnvWithTcTyCon"><span class="hs-identifier hs-var">extendEnvWithTcTyCon</span></a><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="#local-6989586621680455941"><span class="hs-identifier hs-var">tc_tycons</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span>                 </span><span class="hs-comment">-- Kind and type check declarations for this group</span><span>
</span><a name="line-219"></a><span>               </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#tcTyClDecl"><span class="hs-identifier hs-var">tcTyClDecl</span></a><span> </span><a href="#local-6989586621680455944"><span class="hs-identifier hs-var">roles</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455937"><span class="hs-identifier hs-var">tyclds</span></a><span>
</span><a name="line-220"></a><span>           </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-222"></a><span>    </span><a name="local-6989586621680455939"><a href="#local-6989586621680455939"><span class="hs-identifier">ppr_tc_tycon</span></a></a><span> </span><a name="local-6989586621680455940"><a href="#local-6989586621680455940"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680455940"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span>
</span><a name="line-223"></a><span>                                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621680455940"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span>
</span><a name="line-224"></a><span>                                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621680455940"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-identifier">zipRecTyClss</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-227"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- Knot-tied</span><span>
</span><a name="line-228"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><a href="TyCoRep.html#TyThing"><span class="hs-identifier hs-type">TyThing</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-229"></a><span class="hs-comment">-- Build a name-TyThing mapping for the TyCons bound by decls</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- being careful not to look at the knot-tied [TyThing]</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- The TyThings in the result list must have a visible ATyCon,</span><span>
</span><a name="line-232"></a><span class="hs-comment">-- because typechecking types (in, say, tcTyClDecl) looks at</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- this outer constructor</span><span>
</span><a name="line-234"></a><a name="zipRecTyClss"><a href="TcTyClsDecls.html#zipRecTyClss"><span class="hs-identifier">zipRecTyClss</span></a></a><span> </span><a name="local-6989586621680455945"><a href="#local-6989586621680455945"><span class="hs-identifier">tc_tycons</span></a></a><span> </span><a name="local-6989586621680455946"><a href="#local-6989586621680455946"><span class="hs-identifier">rec_tycons</span></a></a><span>
</span><a name="line-235"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455959"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#ATyCon"><span class="hs-identifier hs-var">ATyCon</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455950"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621680455959"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680455958"><a href="#local-6989586621680455958"><span class="hs-identifier">tc_tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455945"><span class="hs-identifier hs-var">tc_tycons</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455959"><a href="#local-6989586621680455959"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680455958"><span class="hs-identifier hs-var">tc_tycon</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-236"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-237"></a><span>    </span><span class="hs-identifier">rec_tc_env</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-238"></a><span>    </span><a name="local-6989586621680455947"><a href="#local-6989586621680455947"><span class="hs-identifier">rec_tc_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="#local-6989586621680455948"><span class="hs-identifier hs-var">add_tc</span></a><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="#local-6989586621680455946"><span class="hs-identifier hs-var">rec_tycons</span></a><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span>    </span><span class="hs-identifier">add_tc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621680455948"><a href="#local-6989586621680455948"><span class="hs-identifier">add_tc</span></a></a><span> </span><a name="local-6989586621680455951"><a href="#local-6989586621680455951"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680455952"><a href="#local-6989586621680455952"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="#local-6989586621680455949"><span class="hs-identifier hs-var">add_one_tc</span></a><span> </span><a href="#local-6989586621680455952"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455951"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="TyCon.html#tyConATs"><span class="hs-identifier hs-var">tyConATs</span></a><span> </span><a href="#local-6989586621680455951"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>    </span><span class="hs-identifier">add_one_tc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-244"></a><span>    </span><a name="local-6989586621680455949"><a href="#local-6989586621680455949"><span class="hs-identifier">add_one_tc</span></a></a><span> </span><a name="local-6989586621680455953"><a href="#local-6989586621680455953"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680455954"><a href="#local-6989586621680455954"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#extendNameEnv"><span class="hs-identifier hs-var">extendNameEnv</span></a><span> </span><a href="#local-6989586621680455954"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680455953"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455953"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span>    </span><a name="local-6989586621680455950"><a href="#local-6989586621680455950"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621680455955"><a href="#local-6989586621680455955"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="NameEnv.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a><span> </span><a href="#local-6989586621680455947"><span class="hs-identifier hs-var">rec_tc_env</span></a><span> </span><a href="#local-6989586621680455955"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-247"></a><span>                 </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680455956"><a href="#local-6989586621680455956"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680455956"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-248"></a><span>                 </span><a name="local-6989586621680455957"><a href="#local-6989586621680455957"><span class="hs-identifier">other</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;zipRecTyClss&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455955"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455957"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">)</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Kind checking
*                                                                      *
************************************************************************

Note [Kind checking for type and class decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Kind checking is done thus:

   1. Make up a kind variable for each parameter of the declarations,
      and extend the kind environment (which is in the TcLclEnv)

   2. Kind check the declarations

We need to kind check all types in the mutually recursive group
before we know the kind of the type variables.  For example:

  class C a where
     op :: D b =&gt; a -&gt; b -&gt; b

  class D c where
     bop :: (Monad c) =&gt; ...

Here, the kind of the locally-polymorphic type variable &quot;b&quot;
depends on *all the uses of class D*.  For example, the use of
Monad c in bop's type signature means that D must have kind Type-&gt;Type.

Note: we don't treat type synonyms specially (we used to, in the past);
in particular, even if we have a type synonym cycle, we still kind check
it normally, and test for cycles later (checkSynCycles).  The reason
we can get away with this is because we have more systematic TYPE r
inference, which means that we can do unification between kinds that
aren't lifted (this historically was not true.)

The downside of not directly reading off the kinds off the RHS of
type synonyms in topological order is that we don't transparently
support making synonyms of types with higher-rank kinds.  But
you can always specify a CUSK directly to make this work out.
See tc269 for an example.

Open type families
~~~~~~~~~~~~~~~~~~
This treatment of type synonyms only applies to Haskell 98-style synonyms.
General type functions can be recursive, and hence, appear in `alg_decls'.

The kind of an open type family is solely determinded by its kind signature;
hence, only kind signatures participate in the construction of the initial
kind environment (as constructed by `getInitialKind'). In fact, we ignore
instances of families altogether in the following. However, we need to include
the kinds of *associated* families into the construction of the initial kind
environment. (This is handled by `allDecls').

See also Note [Kind checking recursive type and class declarations]

Note [How TcTyCons work]
~~~~~~~~~~~~~~~~~~~~~~~~
TcTyCons are used for two distinct purposes

1.  When recovering from a type error in a type declaration,
    we want to put the erroneous TyCon in the environment in a
    way that won't lead to more errors.  We use a TcTyCon for this;
    see makeRecoveryTyCon.

2.  When checking a type/class declaration (in module TcTyClsDecls), we come
    upon knowledge of the eventual tycon in bits and pieces.

      S1) First, we use getInitialKinds to look over the user-provided
          kind signature of a tycon (including, for example, the number
          of parameters written to the tycon) to get an initial shape of
          the tycon's kind.  We record that shape in a TcTyCon.

      S2) Then, using these initial kinds, we kind-check the body of the
          tycon (class methods, data constructors, etc.), filling in the
          metavariables in the tycon's initial kind.

      S3) We then generalize to get the tycon's final, fixed
          kind. Finally, once this has happened for all tycons in a
          mutually recursive group, we can desugar the lot.

    For convenience, we store partially-known tycons in TcTyCons, which
    might store meta-variables. These TcTyCons are stored in the local
    environment in TcTyClsDecls, until the real full TyCons can be created
    during desugaring. A desugared program should never have a TcTyCon.

    A challenging piece in all of this is that we end up taking three separate
    passes over every declaration:
      - one in getInitialKind (this pass look only at the head, not the body)
      - one in kcTyClDecls (to kind-check the body)
      - a final one in tcTyClDecls (to desugar)
    In the latter two passes, we need to connect the user-written type
    variables in an LHsQTyVars with the variables in the tycon's
    inferred kind. Because the tycon might not have a CUSK, this
    matching up is, in general, quite hard to do.  (Look through the
    git history between Dec 2015 and Apr 2016 for
    TcHsType.splitTelescopeTvs!) Instead of trying, we just store the
    list of type variables to bring into scope, in the
    tyConScopedTyVars field of the TcTyCon.  These tyvars are brought
    into scope in kcTyClTyVars and tcTyClTyVars, both in TcHsType.

    In a TcTyCon, everything is zonked after the kind-checking pass (S2).

Note [Check telescope again during generalisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The telescope check before kind generalisation is useful to catch something
like this:

  data T a k = MkT (Proxy (a :: k))

Clearly, the k has to come first. Checking for this problem must come before
kind generalisation, as described in Note [Bad telescopes] in
TcValidity.

However, we have to check again *after* kind generalisation, to catch something
like this:

  data SameKind :: k -&gt; k -&gt; Type  -- to force unification
  data S a (b :: a) (d :: SameKind c b)

Note that c has no explicit binding site. As such, it's quantified by kind
generalisation. (Note that kcHsTyVarBndrs does not return such variables
as binders in its returned TcTyCon.) The user-written part of this telescope
is well-ordered; no earlier variables depend on later ones. However, after
kind generalisation, we put c up front, like so:

  data S {c :: a} a (b :: a) (d :: SameKind c b)

We now have a problem. We could detect this problem just by looking at the
free vars of the kinds of the generalised variables (the kvs), but we get
such a nice error message out of checkValidTelescope that it seems like the
right thing to do.

-}</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- Note [Missed opportunity to retain higher-rank kinds]</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- In 'kcTyClGroup', there is a missed opportunity to make kind</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- inference work in a few more cases.  The idea is analogous</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- to Note [Single function non-recursive binding special-case]:</span><span>
</span><a name="line-391"></a><span class="hs-comment">--</span><span>
</span><a name="line-392"></a><span class="hs-comment">--      * If we have an SCC with a single decl, which is non-recursive,</span><span>
</span><a name="line-393"></a><span class="hs-comment">--        instead of creating a unification variable representing the</span><span>
</span><a name="line-394"></a><span class="hs-comment">--        kind of the decl and unifying it with the rhs, we can just</span><span>
</span><a name="line-395"></a><span class="hs-comment">--        read the type directly of the rhs.</span><span>
</span><a name="line-396"></a><span class="hs-comment">--</span><span>
</span><a name="line-397"></a><span class="hs-comment">--      * Furthermore, we can update our SCC analysis to ignore</span><span>
</span><a name="line-398"></a><span class="hs-comment">--        dependencies on declarations which have CUSKs: we don't</span><span>
</span><a name="line-399"></a><span class="hs-comment">--        have to kind-check these all at once, since we can use</span><span>
</span><a name="line-400"></a><span class="hs-comment">--        the CUSK to initialize the kind environment.</span><span>
</span><a name="line-401"></a><span class="hs-comment">--</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- Unfortunately this requires reworking a bit of the code in</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- 'kcLTyClDecl' so I've decided to punt unless someone shouts about it.</span><span>
</span><a name="line-404"></a><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span class="hs-identifier">kcTyClGroup</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-406"></a><span>
</span><a name="line-407"></a><span class="hs-comment">-- Kind check this group, kind generalize, and return the resulting local env</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- This binds the TyCons and Classes of the group, but not the DataCons</span><span>
</span><a name="line-409"></a><span class="hs-comment">-- See Note [Kind checking for type and class decls]</span><span>
</span><a name="line-410"></a><span class="hs-comment">-- Third return value is Nothing if the tycon be unsaturated; otherwise,</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- the arity</span><span>
</span><a name="line-412"></a><a name="kcTyClGroup"><a href="TcTyClsDecls.html#kcTyClGroup"><span class="hs-identifier">kcTyClGroup</span></a></a><span> </span><a name="local-6989586621680455960"><a href="#local-6989586621680455960"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455991"><a href="#local-6989586621680455991"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Module.html#getModule"><span class="hs-identifier hs-var">getModule</span></a><span>
</span><a name="line-414"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- kcTyClGroup ---- {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;module&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455991"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455960"><span class="hs-identifier hs-var">decls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span>          </span><span class="hs-comment">-- Kind checking;</span><span>
</span><a name="line-417"></a><span>          </span><span class="hs-comment">--    1. Bind kind variables for decls</span><span>
</span><a name="line-418"></a><span>          </span><span class="hs-comment">--    2. Kind-check decls</span><span>
</span><a name="line-419"></a><span>          </span><span class="hs-comment">--    3. Generalise the inferred kinds</span><span>
</span><a name="line-420"></a><span>          </span><span class="hs-comment">-- See Note [Kind checking for type and class decls]</span><span>
</span><a name="line-421"></a><span>
</span><a name="line-422"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455993"><a href="#local-6989586621680455993"><span class="hs-identifier">lcl_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-423"></a><span>                     </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Step 1: Bind kind variables for all decls</span><span>
</span><a name="line-424"></a><span>                          </span><a name="local-6989586621680455992"><a href="#local-6989586621680455992"><span class="hs-identifier">initial_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#getInitialKinds"><span class="hs-identifier hs-var">getInitialKinds</span></a><span> </span><a href="#local-6989586621680455960"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-425"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyClGroup: initial kinds&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-426"></a><span>                          </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455992"><span class="hs-identifier hs-var">initial_kinds</span></a><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span>                        </span><span class="hs-comment">-- Step 2: Set extended envt, kind-check the decls</span><span>
</span><a name="line-429"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="TcEnv.html#tcExtendKindEnv"><span class="hs-identifier hs-var">tcExtendKindEnv</span></a><span> </span><a href="#local-6989586621680455992"><span class="hs-identifier hs-var">initial_kinds</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-430"></a><span>                          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="TcTyClsDecls.html#kcLTyClDecl"><span class="hs-identifier hs-var">kcLTyClDecl</span></a><span> </span><a href="#local-6989586621680455960"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-431"></a><span>                             </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>        </span><span class="hs-comment">-- Step 3: generalisation</span><span>
</span><a name="line-434"></a><span>        </span><span class="hs-comment">-- Kind checking done for this group</span><span>
</span><a name="line-435"></a><span>        </span><span class="hs-comment">-- Now we have to kind generalize the flexis</span><span>
</span><a name="line-436"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455994"><a href="#local-6989586621680455994"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier hs-var">mapAndReportM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455962"><span class="hs-identifier hs-var">generaliseTCD</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621680455993"><span class="hs-identifier hs-var">lcl_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455960"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- kcTyClGroup end ---- }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680455964"><span class="hs-identifier hs-var">pp_res</span></a><span> </span><a href="#local-6989586621680455994"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-439"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680455994"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-440"></a><span>
</span><a name="line-441"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-442"></a><span>    </span><span class="hs-identifier">generalise</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span>
</span><a name="line-443"></a><span>    </span><span class="hs-comment">-- For polymorphic things this is a no-op</span><span>
</span><a name="line-444"></a><span>    </span><a name="local-6989586621680455961"><a href="#local-6989586621680455961"><span class="hs-identifier">generalise</span></a></a><span> </span><a name="local-6989586621680455965"><a href="#local-6989586621680455965"><span class="hs-identifier">kind_env</span></a></a><span> </span><a name="local-6989586621680455966"><a href="#local-6989586621680455966"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-445"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ATcTyCon"><span class="hs-identifier hs-var">ATcTyCon</span></a><span> </span><a name="local-6989586621680455967"><a href="#local-6989586621680455967"><span class="hs-identifier">tc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="NameEnv.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a><span> </span><a href="#local-6989586621680455965"><span class="hs-identifier hs-var">kind_env</span></a><span> </span><a href="#local-6989586621680455966"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-446"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-447"></a><span>        </span><a href="TcTyClsDecls.html#addTyConCtxt"><span class="hs-identifier hs-var">addTyConCtxt</span></a><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-448"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455968"><a href="#local-6989586621680455968"><span class="hs-identifier">tc_binders</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#zonkTcTyVarBinder"><span class="hs-identifier hs-var">zonkTcTyVarBinder</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-449"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455969"><a href="#local-6989586621680455969"><span class="hs-identifier">tc_res_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455970"><a href="#local-6989586621680455970"><span class="hs-identifier">scoped_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcTyConScopedTyVars</span><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-451"></a><span>                 </span><a name="local-6989586621680455971"><a href="#local-6989586621680455971"><span class="hs-identifier">user_tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcTyConUserTyVars</span><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-452"></a><span>
</span><a name="line-453"></a><span>              </span><span class="hs-comment">-- See Note [checkValidDependency]</span><span>
</span><a name="line-454"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkValidDependency"><span class="hs-identifier hs-var">checkValidDependency</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621680455969"><span class="hs-identifier hs-var">tc_res_kind</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>               </span><span class="hs-comment">-- See Note [Bad telescopes] in TcValidity</span><span>
</span><a name="line-457"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTelescope"><span class="hs-identifier hs-var">checkValidTelescope</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621680455971"><span class="hs-identifier hs-var">user_tyvars</span></a><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-458"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455972"><a href="#local-6989586621680455972"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kindGeneralize"><span class="hs-identifier hs-var">kindGeneralize</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkTyConKind"><span class="hs-identifier hs-var">mkTyConKind</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621680455969"><span class="hs-identifier hs-var">tc_res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-459"></a><span>
</span><a name="line-460"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455973"><a href="#local-6989586621680455973"><span class="hs-identifier">all_binders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#mkNamedTyConBinders"><span class="hs-identifier hs-var">mkNamedTyConBinders</span></a><span> </span><a href="Var.html#Inferred"><span class="hs-identifier hs-var">Inferred</span></a><span> </span><a href="#local-6989586621680455972"><span class="hs-identifier hs-var">kvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span>
</span><a name="line-461"></a><span>
</span><a name="line-462"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680455974"><a href="#local-6989586621680455974"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680455975"><a href="#local-6989586621680455975"><span class="hs-identifier">all_binders'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyVarBindersX"><span class="hs-identifier hs-var">zonkTyVarBindersX</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680455973"><span class="hs-identifier hs-var">all_binders</span></a><span>
</span><a name="line-463"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455976"><a href="#local-6989586621680455976"><span class="hs-identifier">tc_res_kind'</span></a></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621680455974"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680455969"><span class="hs-identifier hs-var">tc_res_kind</span></a><span>
</span><a name="line-464"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455977"><a href="#local-6989586621680455977"><span class="hs-identifier">scoped_tvs'</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkSigTyVarPairs"><span class="hs-identifier hs-var">zonkSigTyVarPairs</span></a><span> </span><a href="#local-6989586621680455970"><span class="hs-identifier hs-var">scoped_tvs</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span>             </span><span class="hs-comment">-- See Note [Check telescope again during generalisation]</span><span>
</span><a name="line-467"></a><span>           </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680455978"><a href="#local-6989586621680455978"><span class="hs-identifier">extra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;NB: Implicitly declared variables come before others.&quot;</span><span>
</span><a name="line-468"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTelescope"><span class="hs-identifier hs-var">checkValidTelescope</span></a><span> </span><a href="#local-6989586621680455973"><span class="hs-identifier hs-var">all_binders</span></a><span> </span><a href="#local-6989586621680455971"><span class="hs-identifier hs-var">user_tyvars</span></a><span> </span><a href="#local-6989586621680455978"><span class="hs-identifier hs-var">extra</span></a><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span>                      </span><span class="hs-comment">-- Make sure tc_kind' has the final, zonked kind variables</span><span>
</span><a name="line-471"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Generalise kind&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-472"></a><span>             </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455966"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkTyConKind"><span class="hs-identifier hs-var">mkTyConKind</span></a><span> </span><a href="#local-6989586621680455968"><span class="hs-identifier hs-var">tc_binders</span></a><span> </span><a href="#local-6989586621680455969"><span class="hs-identifier hs-var">tc_res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-473"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455972"><span class="hs-identifier hs-var">kvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455973"><span class="hs-identifier hs-var">all_binders</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455969"><span class="hs-identifier hs-var">tc_res_kind</span></a><span>
</span><a name="line-474"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455975"><span class="hs-identifier hs-var">all_binders'</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455976"><span class="hs-identifier hs-var">tc_res_kind'</span></a><span>
</span><a name="line-475"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455970"><span class="hs-identifier hs-var">scoped_tvs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-476"></a><span>
</span><a name="line-477"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkTcTyCon"><span class="hs-identifier hs-var">mkTcTyCon</span></a><span> </span><a href="#local-6989586621680455966"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680455971"><span class="hs-identifier hs-var">user_tyvars</span></a><span> </span><a href="#local-6989586621680455975"><span class="hs-identifier hs-var">all_binders'</span></a><span> </span><a href="#local-6989586621680455976"><span class="hs-identifier hs-var">tc_res_kind'</span></a><span>
</span><a name="line-478"></a><span>                               </span><a href="#local-6989586621680455977"><span class="hs-identifier hs-var">scoped_tvs'</span></a><span>
</span><a name="line-479"></a><span>                               </span><span class="hs-special">(</span><a href="TyCon.html#tyConFlavour"><span class="hs-identifier hs-var">tyConFlavour</span></a><span> </span><a href="#local-6989586621680455967"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-480"></a><span>
</span><a name="line-481"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-482"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;kcTyClGroup.generalise&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680455966"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>    </span><span class="hs-identifier">generaliseTCD</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-485"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-486"></a><span>    </span><a name="local-6989586621680455962"><a href="#local-6989586621680455962"><span class="hs-identifier">generaliseTCD</span></a></a><span> </span><a name="local-6989586621680455979"><a href="#local-6989586621680455979"><span class="hs-identifier">kind_env</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680455980"><a href="#local-6989586621680455980"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-487"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680455981"><a href="#local-6989586621680455981"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680455982"><a href="#local-6989586621680455982"><span class="hs-identifier">ats</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455980"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-488"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455983"><a href="#local-6989586621680455983"><span class="hs-identifier">first</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455961"><span class="hs-identifier hs-var">generalise</span></a><span> </span><a href="#local-6989586621680455979"><span class="hs-identifier hs-var">kind_env</span></a><span> </span><a href="#local-6989586621680455981"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-489"></a><span>           </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680455984"><a href="#local-6989586621680455984"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621680455963"><span class="hs-identifier hs-var">generaliseFamDecl</span></a><span> </span><a href="#local-6989586621680455979"><span class="hs-identifier hs-var">kind_env</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680455982"><span class="hs-identifier hs-var">ats</span></a><span>
</span><a name="line-490"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680455983"><span class="hs-identifier hs-var">first</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680455984"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#FamDecl"><span class="hs-identifier hs-var">FamDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdFam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680455985"><a href="#local-6989586621680455985"><span class="hs-identifier">fam</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455980"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-493"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455986"><a href="#local-6989586621680455986"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455963"><span class="hs-identifier hs-var">generaliseFamDecl</span></a><span> </span><a href="#local-6989586621680455979"><span class="hs-identifier hs-var">kind_env</span></a><span> </span><a href="#local-6989586621680455985"><span class="hs-identifier hs-var">fam</span></a><span>
</span><a name="line-494"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680455986"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-497"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680455987"><a href="#local-6989586621680455987"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680455961"><span class="hs-identifier hs-var">generalise</span></a><span> </span><a href="#local-6989586621680455979"><span class="hs-identifier hs-var">kind_env</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#tcdName"><span class="hs-identifier hs-var">tcdName</span></a><span> </span><a href="#local-6989586621680455980"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680455987"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span>    </span><span class="hs-identifier">generaliseFamDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-501"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-type">FamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span>
</span><a name="line-502"></a><span>    </span><a name="local-6989586621680455963"><a href="#local-6989586621680455963"><span class="hs-identifier">generaliseFamDecl</span></a></a><span> </span><a name="local-6989586621680455988"><a href="#local-6989586621680455988"><span class="hs-identifier">kind_env</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-var">FamilyDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680455989"><a href="#local-6989586621680455989"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680455961"><span class="hs-identifier hs-var">generalise</span></a><span> </span><a href="#local-6989586621680455988"><span class="hs-identifier hs-var">kind_env</span></a><span> </span><a href="#local-6989586621680455989"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span>    </span><a name="local-6989586621680455964"><a href="#local-6989586621680455964"><span class="hs-identifier">pp_res</span></a></a><span> </span><a name="local-6989586621680455990"><a href="#local-6989586621680455990"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680455990"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621680455990"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>
</span><a name="line-507"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-508"></a><span class="hs-identifier">mkTcTyConEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-509"></a><a name="mkTcTyConEnv"><a href="TcTyClsDecls.html#mkTcTyConEnv"><span class="hs-identifier">mkTcTyConEnv</span></a></a><span> </span><a name="local-6989586621680455995"><a href="#local-6989586621680455995"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#unitNameEnv"><span class="hs-identifier hs-var">unitNameEnv</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680455995"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ATcTyCon"><span class="hs-identifier hs-var">ATcTyCon</span></a><span> </span><a href="#local-6989586621680455995"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-identifier">extendEnvWithTcTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-512"></a><span class="hs-comment">-- Makes a binding to put in the local envt, binding</span><span>
</span><a name="line-513"></a><span class="hs-comment">-- a name to a TcTyCon</span><span>
</span><a name="line-514"></a><a name="extendEnvWithTcTyCon"><a href="TcTyClsDecls.html#extendEnvWithTcTyCon"><span class="hs-identifier">extendEnvWithTcTyCon</span></a></a><span> </span><a name="local-6989586621680455996"><a href="#local-6989586621680455996"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680455997"><a href="#local-6989586621680455997"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#extendNameEnv"><span class="hs-identifier hs-var">extendNameEnv</span></a><span> </span><a href="#local-6989586621680455996"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680455997"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#ATcTyCon"><span class="hs-identifier hs-var">ATcTyCon</span></a><span> </span><a href="#local-6989586621680455997"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-518"></a><span class="hs-identifier">mkPromotionErrorEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-519"></a><span class="hs-comment">-- Maps each tycon/datacon to a suitable promotion error</span><span>
</span><a name="line-520"></a><span class="hs-comment">--    tc :-&gt; APromotionErr TyConPE</span><span>
</span><a name="line-521"></a><span class="hs-comment">--    dc :-&gt; APromotionErr RecDataConPE</span><span>
</span><a name="line-522"></a><span class="hs-comment">--    See Note [Recursion and promoting data constructors]</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><a name="mkPromotionErrorEnv"><a href="TcTyClsDecls.html#mkPromotionErrorEnv"><span class="hs-identifier">mkPromotionErrorEnv</span></a></a><span> </span><a name="local-6989586621680455998"><a href="#local-6989586621680455998"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><span class="hs-special">(</span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TcTyClsDecls.html#mk_prom_err_env"><span class="hs-identifier hs-var">mk_prom_err_env</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>          </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="#local-6989586621680455998"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span class="hs-identifier">mk_prom_err_env</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#TyClDecl"><span class="hs-identifier hs-type">TyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-529"></a><a name="mk_prom_err_env"><a href="TcTyClsDecls.html#mk_prom_err_env"><span class="hs-identifier">mk_prom_err_env</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680455999"><a href="#local-6989586621680455999"><span class="hs-identifier">nm</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456000"><a href="#local-6989586621680456000"><span class="hs-identifier">ats</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-530"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#unitNameEnv"><span class="hs-identifier hs-var">unitNameEnv</span></a><span> </span><a href="#local-6989586621680455999"><span class="hs-identifier hs-var">nm</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#APromotionErr"><span class="hs-identifier hs-var">APromotionErr</span></a><span> </span><a href="TcRnTypes.html#ClassPE"><span class="hs-identifier hs-var">ClassPE</span></a><span class="hs-special">)</span><span>
</span><a name="line-531"></a><span>    </span><span class="hs-special">`</span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span class="hs-special">`</span><span>
</span><a name="line-532"></a><span>    </span><a href="NameEnv.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456001"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#APromotionErr"><span class="hs-identifier hs-var">APromotionErr</span></a><span> </span><a href="TcRnTypes.html#TyConPE"><span class="hs-identifier hs-var">TyConPE</span></a><span class="hs-special">)</span><span>
</span><a name="line-533"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-var">FamilyDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456001"><a href="#local-6989586621680456001"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456000"><span class="hs-identifier hs-var">ats</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-534"></a><span>
</span><a name="line-535"></a><span class="hs-identifier">mk_prom_err_env</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456002"><a href="#local-6989586621680456002"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-536"></a><span>                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456003"><a href="#local-6989586621680456003"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#unitNameEnv"><span class="hs-identifier hs-var">unitNameEnv</span></a><span> </span><a href="#local-6989586621680456002"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#APromotionErr"><span class="hs-identifier hs-var">APromotionErr</span></a><span> </span><a href="TcRnTypes.html#TyConPE"><span class="hs-identifier hs-var">TyConPE</span></a><span class="hs-special">)</span><span>
</span><a name="line-538"></a><span>    </span><span class="hs-special">`</span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span class="hs-special">`</span><span>
</span><a name="line-539"></a><span>    </span><a href="NameEnv.html#mkNameEnv"><span class="hs-identifier hs-var">mkNameEnv</span></a><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456005"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="TcRnTypes.html#APromotionErr"><span class="hs-identifier hs-var">APromotionErr</span></a><span> </span><a href="TcRnTypes.html#RecDataConPE"><span class="hs-identifier hs-var">RecDataConPE</span></a><span class="hs-special">)</span><span>
</span><a name="line-540"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456004"><a href="#local-6989586621680456004"><span class="hs-identifier">con'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456003"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456005"><a href="#local-6989586621680456005"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="HsDecls.html#getConNames"><span class="hs-identifier hs-var">getConNames</span></a><span> </span><a href="#local-6989586621680456004"><span class="hs-identifier hs-var">con'</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-identifier">mk_prom_err_env</span><span> </span><a name="local-6989586621680456006"><a href="#local-6989586621680456006"><span class="hs-identifier">decl</span></a></a><span>
</span><a name="line-543"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#unitNameEnv"><span class="hs-identifier hs-var">unitNameEnv</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#tcdName"><span class="hs-identifier hs-var">tcdName</span></a><span> </span><a href="#local-6989586621680456006"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#APromotionErr"><span class="hs-identifier hs-var">APromotionErr</span></a><span> </span><a href="TcRnTypes.html#TyConPE"><span class="hs-identifier hs-var">TyConPE</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>    </span><span class="hs-comment">-- Works for family declarations too</span><span>
</span><a name="line-545"></a><span>
</span><a name="line-546"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-547"></a><span class="hs-identifier">getInitialKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TcRnTypes.html#TcTyThing"><span class="hs-identifier hs-type">TcTyThing</span></a><span class="hs-special">)</span><span>
</span><a name="line-548"></a><span class="hs-comment">-- Maps each tycon to its initial kind,</span><span>
</span><a name="line-549"></a><span class="hs-comment">-- and each datacon to a suitable promotion error</span><span>
</span><a name="line-550"></a><span class="hs-comment">--    tc :-&gt; ATcTyCon (tc:initial_kind)</span><span>
</span><a name="line-551"></a><span class="hs-comment">--    dc :-&gt; APromotionErr RecDataConPE</span><span>
</span><a name="line-552"></a><span class="hs-comment">--    See Note [Recursion and promoting data constructors]</span><span>
</span><a name="line-553"></a><span>
</span><a name="line-554"></a><a name="getInitialKinds"><a href="TcTyClsDecls.html#getInitialKinds"><span class="hs-identifier">getInitialKinds</span></a></a><span> </span><a name="local-6989586621680456007"><a href="#local-6989586621680456007"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-555"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcEnv.html#tcExtendKindEnv"><span class="hs-identifier hs-var">tcExtendKindEnv</span></a><span> </span><a href="#local-6989586621680456008"><span class="hs-identifier hs-var">promotion_err_env</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-556"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456009"><a href="#local-6989586621680456009"><span class="hs-identifier">tc_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="TcTyClsDecls.html#getInitialKind"><span class="hs-identifier hs-var">getInitialKind</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456007"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-557"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldl"><span class="hs-identifier hs-var">foldl</span></a><span> </span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span> </span><a href="#local-6989586621680456008"><span class="hs-identifier hs-var">promotion_err_env</span></a><span> </span><a href="#local-6989586621680456009"><span class="hs-identifier hs-var">tc_kinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-558"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-559"></a><span>    </span><a name="local-6989586621680456008"><a href="#local-6989586621680456008"><span class="hs-identifier">promotion_err_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#mkPromotionErrorEnv"><span class="hs-identifier hs-var">mkPromotionErrorEnv</span></a><span> </span><a href="#local-6989586621680456007"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span class="hs-identifier">getInitialKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#TyClDecl"><span class="hs-identifier hs-type">TyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-562"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="TcRnTypes.html#TcTyThing"><span class="hs-identifier hs-type">TcTyThing</span></a><span class="hs-special">)</span><span>
</span><a name="line-563"></a><span class="hs-comment">-- Allocate a fresh kind variable for each TyCon and Class</span><span>
</span><a name="line-564"></a><span class="hs-comment">-- For each tycon, return a NameEnv with</span><span>
</span><a name="line-565"></a><span class="hs-comment">--      name :-&gt; ATcTyCon (TcCyCon with kind k))</span><span>
</span><a name="line-566"></a><span class="hs-comment">-- where k is the kind of tc, derived from the LHS</span><span>
</span><a name="line-567"></a><span class="hs-comment">--       of the definition (and probably including</span><span>
</span><a name="line-568"></a><span class="hs-comment">--       kind unification variables)</span><span>
</span><a name="line-569"></a><span class="hs-comment">--      Example: data T a b = ...</span><span>
</span><a name="line-570"></a><span class="hs-comment">--      return (T, kv1 -&gt; kv2 -&gt; kv3)</span><span>
</span><a name="line-571"></a><span class="hs-comment">--</span><span>
</span><a name="line-572"></a><span class="hs-comment">-- This pass deals with (ie incorporates into the kind it produces)</span><span>
</span><a name="line-573"></a><span class="hs-comment">--   * The kind signatures on type-variable binders</span><span>
</span><a name="line-574"></a><span class="hs-comment">--   * The result kinds signature on a TyClDecl</span><span>
</span><a name="line-575"></a><span class="hs-comment">--</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- No family instances are passed to getInitialKinds</span><span>
</span><a name="line-577"></a><span>
</span><a name="line-578"></a><a name="getInitialKind"><a href="TcTyClsDecls.html#getInitialKind"><span class="hs-identifier">getInitialKind</span></a></a><span> </span><a name="local-6989586621680456010"><a href="#local-6989586621680456010"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456011"><a href="#local-6989586621680456011"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456012"><a href="#local-6989586621680456012"><span class="hs-identifier">ktvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456013"><a href="#local-6989586621680456013"><span class="hs-identifier">ats</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456014"><a href="#local-6989586621680456014"><span class="hs-identifier">cusk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#hsDeclHasCusk"><span class="hs-identifier hs-var">hsDeclHasCusk</span></a><span> </span><a href="#local-6989586621680456010"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-580"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456016"><a href="#local-6989586621680456016"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456017"><a href="#local-6989586621680456017"><span class="hs-identifier">inner_prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-581"></a><span>           </span><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier hs-var">kcLHsQTyVars</span></a><span> </span><a href="#local-6989586621680456011"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="TyCon.html#ClassFlavour"><span class="hs-identifier hs-var">ClassFlavour</span></a><span> </span><a href="#local-6989586621680456014"><span class="hs-identifier hs-var">cusk</span></a><span> </span><a href="#local-6989586621680456012"><span class="hs-identifier hs-var">ktvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-582"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456015"><a href="#local-6989586621680456015"><span class="hs-identifier">inner_prs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#getFamDeclInitialKinds"><span class="hs-identifier hs-var">getFamDeclInitialKinds</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680456014"><span class="hs-identifier hs-var">cusk</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456013"><span class="hs-identifier hs-var">ats</span></a><span>
</span><a name="line-583"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TysWiredIn.html#constraintKind"><span class="hs-identifier hs-var">constraintKind</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456015"><span class="hs-identifier hs-var">inner_prs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-584"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#extendEnvWithTcTyCon"><span class="hs-identifier hs-var">extendEnvWithTcTyCon</span></a><span> </span><a href="#local-6989586621680456017"><span class="hs-identifier hs-var">inner_prs</span></a><span> </span><a href="#local-6989586621680456016"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-585"></a><span>
</span><a name="line-586"></a><span class="hs-identifier">getInitialKind</span><span> </span><a name="local-6989586621680456018"><a href="#local-6989586621680456018"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456019"><a href="#local-6989586621680456019"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-587"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456020"><a href="#local-6989586621680456020"><span class="hs-identifier">ktvs</span></a></a><span>
</span><a name="line-588"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_kindSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456021"><a href="#local-6989586621680456021"><span class="hs-identifier">m_sig</span></a></a><span>
</span><a name="line-589"></a><span>                                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ND</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456022"><a href="#local-6989586621680456022"><span class="hs-identifier">new_or_data</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-590"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456025"><a href="#local-6989586621680456025"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-591"></a><span>           </span><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier hs-var">kcLHsQTyVars</span></a><span> </span><a href="#local-6989586621680456019"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#newOrDataToFlavour"><span class="hs-identifier hs-var">newOrDataToFlavour</span></a><span> </span><a href="#local-6989586621680456022"><span class="hs-identifier hs-var">new_or_data</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#hsDeclHasCusk"><span class="hs-identifier hs-var">hsDeclHasCusk</span></a><span> </span><a href="#local-6989586621680456018"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456020"><span class="hs-identifier hs-var">ktvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-592"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456024"><a href="#local-6989586621680456024"><span class="hs-identifier">res_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456021"><span class="hs-identifier hs-var">m_sig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-593"></a><span>                           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456023"><a href="#local-6989586621680456023"><span class="hs-identifier">ksig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#DataKindCtxt"><span class="hs-identifier hs-var">DataKindCtxt</span></a><span> </span><a href="#local-6989586621680456019"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456023"><span class="hs-identifier hs-var">ksig</span></a><span>
</span><a name="line-594"></a><span>                           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-595"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456024"><span class="hs-identifier hs-var">res_k</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-596"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#mkTcTyConEnv"><span class="hs-identifier hs-var">mkTcTyConEnv</span></a><span> </span><a href="#local-6989586621680456025"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-597"></a><span>
</span><a name="line-598"></a><span class="hs-identifier">getInitialKind</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamDecl"><span class="hs-identifier hs-var">FamDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdFam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456026"><a href="#local-6989586621680456026"><span class="hs-identifier">decl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-599"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#getFamDeclInitialKind"><span class="hs-identifier hs-var">getFamDeclInitialKind</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456026"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-600"></a><span>
</span><a name="line-601"></a><span class="hs-identifier">getInitialKind</span><span> </span><a name="local-6989586621680456027"><a href="#local-6989586621680456027"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#SynDecl"><span class="hs-identifier hs-var">SynDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456028"><a href="#local-6989586621680456028"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-602"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456029"><a href="#local-6989586621680456029"><span class="hs-identifier">ktvs</span></a></a><span>
</span><a name="line-603"></a><span>                             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456030"><a href="#local-6989586621680456030"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456037"><a href="#local-6989586621680456037"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier hs-var">kcLHsQTyVars</span></a><span> </span><a href="#local-6989586621680456028"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="TyCon.html#TypeSynonymFlavour"><span class="hs-identifier hs-var">TypeSynonymFlavour</span></a><span>
</span><a name="line-605"></a><span>                            </span><span class="hs-special">(</span><a href="HsDecls.html#hsDeclHasCusk"><span class="hs-identifier hs-var">hsDeclHasCusk</span></a><span> </span><a href="#local-6989586621680456027"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456029"><span class="hs-identifier hs-var">ktvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-606"></a><span>            </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456036"><a href="#local-6989586621680456036"><span class="hs-identifier">res_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456031"><span class="hs-identifier hs-var">kind_annotation</span></a><span> </span><a href="#local-6989586621680456030"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-607"></a><span>                            </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-608"></a><span>                            </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456035"><a href="#local-6989586621680456035"><span class="hs-identifier">ksig</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#TySynKindCtxt"><span class="hs-identifier hs-var">TySynKindCtxt</span></a><span> </span><a href="#local-6989586621680456028"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456035"><span class="hs-identifier hs-var">ksig</span></a><span>
</span><a name="line-609"></a><span>                </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456036"><span class="hs-identifier hs-var">res_k</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-610"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#mkTcTyConEnv"><span class="hs-identifier hs-var">mkTcTyConEnv</span></a><span> </span><a href="#local-6989586621680456037"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-611"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-612"></a><span>    </span><span class="hs-comment">-- Keep this synchronized with 'hsDeclHasCusk'.</span><span>
</span><a name="line-613"></a><span>    </span><a name="local-6989586621680456031"><a href="#local-6989586621680456031"><span class="hs-identifier">kind_annotation</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456032"><a href="#local-6989586621680456032"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456032"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-614"></a><span>        </span><a href="HsTypes.html#HsParTy"><span class="hs-identifier hs-var">HsParTy</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456033"><a href="#local-6989586621680456033"><span class="hs-identifier">lty</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680456031"><span class="hs-identifier hs-var">kind_annotation</span></a><span> </span><a href="#local-6989586621680456033"><span class="hs-identifier hs-var">lty</span></a><span>
</span><a name="line-615"></a><span>        </span><a href="HsTypes.html#HsKindSig"><span class="hs-identifier hs-var">HsKindSig</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456034"><a href="#local-6989586621680456034"><span class="hs-identifier">k</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680456034"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-616"></a><span>        </span><span class="hs-identifier">_</span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span class="hs-comment">---------------------------------</span><span>
</span><a name="line-619"></a><span class="hs-identifier">getFamDeclInitialKinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- if assoc., CUSKness of assoc. class</span><span>
</span><a name="line-620"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LFamilyDecl"><span class="hs-identifier hs-type">LFamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>
</span><a name="line-621"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-622"></a><a name="getFamDeclInitialKinds"><a href="TcTyClsDecls.html#getFamDeclInitialKinds"><span class="hs-identifier">getFamDeclInitialKinds</span></a></a><span> </span><a name="local-6989586621680456038"><a href="#local-6989586621680456038"><span class="hs-identifier">mb_cusk</span></a></a><span> </span><a name="local-6989586621680456039"><a href="#local-6989586621680456039"><span class="hs-identifier">decls</span></a></a><span>
</span><a name="line-623"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456040"><a href="#local-6989586621680456040"><span class="hs-identifier">tc_kinds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#getFamDeclInitialKind"><span class="hs-identifier hs-var">getFamDeclInitialKind</span></a><span> </span><a href="#local-6989586621680456038"><span class="hs-identifier hs-var">mb_cusk</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456039"><span class="hs-identifier hs-var">decls</span></a><span>
</span><a name="line-624"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><a href="NameEnv.html#plusNameEnv"><span class="hs-identifier hs-var">plusNameEnv</span></a><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="#local-6989586621680456040"><span class="hs-identifier hs-var">tc_kinds</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-625"></a><span>
</span><a name="line-626"></a><span class="hs-identifier">getFamDeclInitialKind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- if assoc., CUSKness of assoc. class</span><span>
</span><a name="line-627"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-type">FamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-628"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TcRnTypes.html#TcTypeEnv"><span class="hs-identifier hs-type">TcTypeEnv</span></a><span>
</span><a name="line-629"></a><a name="getFamDeclInitialKind"><a href="TcTyClsDecls.html#getFamDeclInitialKind"><span class="hs-identifier">getFamDeclInitialKind</span></a></a><span> </span><a name="local-6989586621680456041"><a href="#local-6989586621680456041"><span class="hs-identifier">mb_cusk</span></a></a><span> </span><a name="local-6989586621680456042"><a href="#local-6989586621680456042"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-var">FamilyDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdLName</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456043"><a href="#local-6989586621680456043"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-630"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdTyVars</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456044"><a href="#local-6989586621680456044"><span class="hs-identifier">ktvs</span></a></a><span>
</span><a name="line-631"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdResultSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456045"><a href="#local-6989586621680456045"><span class="hs-identifier">resultSig</span></a></a><span>
</span><a name="line-632"></a><span>                                               </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInfo</span><span>      </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456046"><a href="#local-6989586621680456046"><span class="hs-identifier">info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456053"><a href="#local-6989586621680456053"><span class="hs-identifier">tycon</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-634"></a><span>           </span><a href="TcHsType.html#kcLHsQTyVars"><span class="hs-identifier hs-var">kcLHsQTyVars</span></a><span> </span><a href="#local-6989586621680456043"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680456048"><span class="hs-identifier hs-var">flav</span></a><span> </span><a href="#local-6989586621680456047"><span class="hs-identifier hs-var">cusk</span></a><span> </span><a href="#local-6989586621680456044"><span class="hs-identifier hs-var">ktvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-635"></a><span>           </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456052"><a href="#local-6989586621680456052"><span class="hs-identifier">res_k</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456045"><span class="hs-identifier hs-var">resultSig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-636"></a><span>                     </span><a href="HsDecls.html#KindSig"><span class="hs-identifier hs-var">KindSig</span></a><span> </span><a name="local-6989586621680456050"><a href="#local-6989586621680456050"><span class="hs-identifier">ki</span></a></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><a href="#local-6989586621680456049"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680456050"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-637"></a><span>                     </span><a href="HsDecls.html#TyVarSig"><span class="hs-identifier hs-var">TyVarSig</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsTypes.html#KindedTyVar"><span class="hs-identifier hs-var">KindedTyVar</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456051"><a href="#local-6989586621680456051"><span class="hs-identifier">ki</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><a href="#local-6989586621680456049"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680456051"><span class="hs-identifier hs-var">ki</span></a><span>
</span><a name="line-638"></a><span>                     </span><span class="hs-identifier">_</span><span> </span><span class="hs-comment">-- open type families have * return kind by default</span><span>
</span><a name="line-639"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#tcFlavourIsOpen"><span class="hs-identifier hs-var">tcFlavourIsOpen</span></a><span> </span><a href="#local-6989586621680456048"><span class="hs-identifier hs-var">flav</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-640"></a><span>                        </span><span class="hs-comment">-- closed type families have their return kind inferred</span><span>
</span><a name="line-641"></a><span>                        </span><span class="hs-comment">-- by default</span><span>
</span><a name="line-642"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcMType.html#newMetaKindVar"><span class="hs-identifier hs-var">newMetaKindVar</span></a><span>
</span><a name="line-643"></a><span>              </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456052"><span class="hs-identifier hs-var">res_k</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-644"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#mkTcTyConEnv"><span class="hs-identifier hs-var">mkTcTyConEnv</span></a><span> </span><a href="#local-6989586621680456053"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-645"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-646"></a><span>    </span><a name="local-6989586621680456047"><a href="#local-6989586621680456047"><span class="hs-identifier">cusk</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#famDeclHasCusk"><span class="hs-identifier hs-var">famDeclHasCusk</span></a><span> </span><a href="#local-6989586621680456041"><span class="hs-identifier hs-var">mb_cusk</span></a><span> </span><a href="#local-6989586621680456042"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-647"></a><span>    </span><a name="local-6989586621680456048"><a href="#local-6989586621680456048"><span class="hs-identifier">flav</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456046"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-648"></a><span>      </span><a href="HsDecls.html#DataFamily"><span class="hs-identifier hs-var">DataFamily</span></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#DataFamilyFlavour"><span class="hs-identifier hs-var">DataFamilyFlavour</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621680456041"><span class="hs-identifier hs-var">mb_cusk</span></a><span class="hs-special">)</span><span>
</span><a name="line-649"></a><span>      </span><a href="HsDecls.html#OpenTypeFamily"><span class="hs-identifier hs-var">OpenTypeFamily</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#OpenTypeFamilyFlavour"><span class="hs-identifier hs-var">OpenTypeFamilyFlavour</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621680456041"><span class="hs-identifier hs-var">mb_cusk</span></a><span class="hs-special">)</span><span>
</span><a name="line-650"></a><span>      </span><a href="HsDecls.html#ClosedTypeFamily"><span class="hs-identifier hs-var">ClosedTypeFamily</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#ClosedTypeFamilyFlavour"><span class="hs-identifier hs-var">ClosedTypeFamilyFlavour</span></a><span>
</span><a name="line-651"></a><span>    </span><a name="local-6989586621680456049"><a href="#local-6989586621680456049"><span class="hs-identifier">ctxt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#TyFamResKindCtxt"><span class="hs-identifier hs-var">TyFamResKindCtxt</span></a><span> </span><a href="#local-6989586621680456043"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-652"></a><span>
</span><a name="line-653"></a><span class="hs-comment">------------------------------------------------------------------------</span><span>
</span><a name="line-654"></a><span class="hs-identifier">kcLTyClDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-655"></a><span>  </span><span class="hs-comment">-- See Note [Kind checking for type and class decls]</span><span>
</span><a name="line-656"></a><a name="kcLTyClDecl"><a href="TcTyClsDecls.html#kcLTyClDecl"><span class="hs-identifier">kcLTyClDecl</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456054"><a href="#local-6989586621680456054"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621680456055"><a href="#local-6989586621680456055"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-657"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#hsDeclHasCusk"><span class="hs-identifier hs-var">hsDeclHasCusk</span></a><span> </span><a href="#local-6989586621680456055"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-658"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyClDecl skipped due to cusk&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456056"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-659"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-660"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456054"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-661"></a><span>    </span><a href="TcClassDcl.html#tcAddDeclCtxt"><span class="hs-identifier hs-var">tcAddDeclCtxt</span></a><span> </span><a href="#local-6989586621680456055"><span class="hs-identifier hs-var">decl</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-662"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyClDecl {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456056"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-663"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#kcTyClDecl"><span class="hs-identifier hs-var">kcTyClDecl</span></a><span> </span><a href="#local-6989586621680456055"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-664"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyClDecl done }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456056"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-665"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-666"></a><span>    </span><a name="local-6989586621680456056"><a href="#local-6989586621680456056"><span class="hs-identifier">tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#tyClDeclLName"><span class="hs-identifier hs-var">tyClDeclLName</span></a><span> </span><a href="#local-6989586621680456055"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-667"></a><span>
</span><a name="line-668"></a><span class="hs-identifier">kcTyClDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#TyClDecl"><span class="hs-identifier hs-type">TyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-669"></a><span class="hs-comment">-- This function is used solely for its side effect on kind variables</span><span>
</span><a name="line-670"></a><span class="hs-comment">-- NB kind signatures on the type variables and</span><span>
</span><a name="line-671"></a><span class="hs-comment">--    result kind signature have already been dealt with</span><span>
</span><a name="line-672"></a><span class="hs-comment">--    by getInitialKind, so we can ignore them here.</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><a name="kcTyClDecl"><a href="TcTyClsDecls.html#kcTyClDecl"><span class="hs-identifier">kcTyClDecl</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456057"><a href="#local-6989586621680456057"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456058"><a href="#local-6989586621680456058"><span class="hs-identifier">defn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-675"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456059"><a href="#local-6989586621680456059"><span class="hs-identifier">cons</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclGADT"><span class="hs-identifier hs-var">ConDeclGADT</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456058"><span class="hs-identifier hs-var">defn</span></a><span>
</span><a name="line-676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcTyClsDecls.html#kcConDecl"><span class="hs-identifier hs-var">kcConDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456059"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-677"></a><span>    </span><span class="hs-comment">-- hs_tvs and dd_kindSig already dealt with in getInitialKind</span><span>
</span><a name="line-678"></a><span>    </span><span class="hs-comment">-- This must be a GADT-style decl,</span><span>
</span><a name="line-679"></a><span>    </span><span class="hs-comment">--        (see invariants of DataDefn declaration)</span><span>
</span><a name="line-680"></a><span>    </span><span class="hs-comment">-- so (a) we don't need to bring the hs_tvs into scope, because the</span><span>
</span><a name="line-681"></a><span>    </span><span class="hs-comment">--        ConDecls bind all their own variables</span><span>
</span><a name="line-682"></a><span>    </span><span class="hs-comment">--    (b) dd_ctxt is not allowed for GADT-style decls, so we can ignore it</span><span>
</span><a name="line-683"></a><span>
</span><a name="line-684"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456060"><a href="#local-6989586621680456060"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456061"><a href="#local-6989586621680456061"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456058"><span class="hs-identifier hs-var">defn</span></a><span>
</span><a name="line-685"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcTyClTyVars"><span class="hs-identifier hs-var">kcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456057"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-686"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621680456060"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-687"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcTyClsDecls.html#kcConDecl"><span class="hs-identifier hs-var">kcConDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456061"><span class="hs-identifier hs-var">cons</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-688"></a><span>
</span><a name="line-689"></a><span class="hs-identifier">kcTyClDecl</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#SynDecl"><span class="hs-identifier hs-var">SynDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456062"><a href="#local-6989586621680456062"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456063"><a href="#local-6989586621680456063"><span class="hs-identifier">lrhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-690"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcTyClTyVars"><span class="hs-identifier hs-var">kcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456062"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-691"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456064"><a href="#local-6989586621680456064"><span class="hs-identifier">syn_tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kcLookupTcTyCon"><span class="hs-identifier hs-var">kcLookupTcTyCon</span></a><span> </span><a href="#local-6989586621680456062"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-692"></a><span>        </span><span class="hs-comment">-- NB: check against the result kind that we allocated</span><span>
</span><a name="line-693"></a><span>        </span><span class="hs-comment">-- in getInitialKinds.</span><span>
</span><a name="line-694"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621680456063"><span class="hs-identifier hs-var">lrhs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConResKind</span><span> </span><a href="#local-6989586621680456064"><span class="hs-identifier hs-var">syn_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span class="hs-identifier">kcTyClDecl</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456065"><a href="#local-6989586621680456065"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-697"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdCtxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456066"><a href="#local-6989586621680456066"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdSigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456067"><a href="#local-6989586621680456067"><span class="hs-identifier">sigs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcTyClTyVars"><span class="hs-identifier hs-var">kcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456065"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-699"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621680456066"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-700"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="#local-6989586621680456068"><span class="hs-identifier hs-var">kc_sig</span></a><span class="hs-special">)</span><span>     </span><a href="#local-6989586621680456067"><span class="hs-identifier hs-var">sigs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-701"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-702"></a><span>    </span><a name="local-6989586621680456068"><a href="#local-6989586621680456068"><span class="hs-identifier">kc_sig</span></a></a><span> </span><span class="hs-special">(</span><a href="HsBinds.html#ClassOpSig"><span class="hs-identifier hs-var">ClassOpSig</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456069"><a href="#local-6989586621680456069"><span class="hs-identifier">nms</span></a></a><span> </span><a name="local-6989586621680456070"><a href="#local-6989586621680456070"><span class="hs-identifier">op_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-703"></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#kcHsSigType"><span class="hs-identifier hs-var">kcHsSigType</span></a><span> </span><span class="hs-special">(</span><a href="TcRnTypes.html#TyConSkol"><span class="hs-identifier hs-var">TyConSkol</span></a><span> </span><a href="TyCon.html#ClassFlavour"><span class="hs-identifier hs-var">ClassFlavour</span></a><span> </span><a href="#local-6989586621680456065"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456069"><span class="hs-identifier hs-var">nms</span></a><span> </span><a href="#local-6989586621680456070"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-704"></a><span>    </span><span class="hs-identifier">kc_sig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-705"></a><span>
</span><a name="line-706"></a><span class="hs-identifier">kcTyClDecl</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamDecl"><span class="hs-identifier hs-var">FamDecl</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-var">FamilyDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdLName</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456071"><a href="#local-6989586621680456071"><span class="hs-identifier">fam_tc_name</span></a></a><span>
</span><a name="line-707"></a><span>                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInfo</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456072"><a href="#local-6989586621680456072"><span class="hs-identifier">fd_info</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span class="hs-comment">-- closed type families look at their equations, but other families don't</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- do anything here</span><span>
</span><a name="line-710"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456072"><span class="hs-identifier hs-var">fd_info</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-711"></a><span>      </span><a href="HsDecls.html#ClosedTypeFamily"><span class="hs-identifier hs-var">ClosedTypeFamily</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456073"><a href="#local-6989586621680456073"><span class="hs-identifier">eqns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-712"></a><span>        </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456074"><a href="#local-6989586621680456074"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#kcLookupTcTyCon"><span class="hs-identifier hs-var">kcLookupTcTyCon</span></a><span> </span><a href="#local-6989586621680456071"><span class="hs-identifier hs-var">fam_tc_name</span></a><span>
</span><a name="line-713"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#kcTyFamInstEqn"><span class="hs-identifier hs-var">kcTyFamInstEqn</span></a><span> </span><a href="#local-6989586621680456074"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456073"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-714"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-717"></a><span class="hs-identifier">kcConDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#ConDecl"><span class="hs-identifier hs-type">ConDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><a name="kcConDecl"><a href="TcTyClsDecls.html#kcConDecl"><span class="hs-identifier">kcConDecl</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclH98"><span class="hs-identifier hs-var">ConDeclH98</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456075"><a href="#local-6989586621680456075"><span class="hs-identifier">name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_ex_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456076"><a href="#local-6989586621680456076"><span class="hs-identifier">ex_tvs</span></a></a><span>
</span><a name="line-719"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456077"><a href="#local-6989586621680456077"><span class="hs-identifier">ex_ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456078"><a href="#local-6989586621680456078"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-720"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#dataConCtxtName"><span class="hs-identifier hs-var">dataConCtxtName</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456075"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-721"></a><span>      </span><span class="hs-comment">-- See Note [Use SigTvs in kind-checking pass]</span><span>
</span><a name="line-722"></a><span>    </span><a href="TcHsType.html#kcExplicitTKBndrs"><span class="hs-identifier hs-var">kcExplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456076"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-723"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier hs-var">tcHsMbContext</span></a><span> </span><a href="#local-6989586621680456077"><span class="hs-identifier hs-var">ex_ctxt</span></a><span>
</span><a name="line-724"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="HsTypes.html#getBangType"><span class="hs-identifier hs-var">getBangType</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#hsConDeclArgTys"><span class="hs-identifier hs-var">hsConDeclArgTys</span></a><span> </span><a href="#local-6989586621680456078"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-725"></a><span>              </span><span class="hs-comment">-- We don't need to check the telescope here, because that's</span><span>
</span><a name="line-726"></a><span>              </span><span class="hs-comment">-- done in tcConDecl</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">kcConDecl</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclGADT"><span class="hs-identifier hs-var">ConDeclGADT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_names</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456079"><a href="#local-6989586621680456079"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-729"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_qvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456080"><a href="#local-6989586621680456080"><span class="hs-identifier">qtvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456081"><a href="#local-6989586621680456081"><span class="hs-identifier">cxt</span></a></a><span>
</span><a name="line-730"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456082"><a href="#local-6989586621680456082"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_res_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456083"><a href="#local-6989586621680456083"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-731"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsTypes.html#HsQTvs"><span class="hs-identifier hs-var">HsQTvs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456084"><a href="#local-6989586621680456084"><span class="hs-identifier">implicit_tkv_nms</span></a></a><span>
</span><a name="line-732"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456085"><a href="#local-6989586621680456085"><span class="hs-identifier">explicit_tkv_nms</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456080"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-733"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Even though the data constructor's type is closed, we</span><span>
</span><a name="line-734"></a><span>    </span><span class="hs-comment">-- must still kind-check the type, because that may influence</span><span>
</span><a name="line-735"></a><span>    </span><span class="hs-comment">-- the inferred kind of the /type/ constructor.  Example:</span><span>
</span><a name="line-736"></a><span>    </span><span class="hs-comment">--    data T f a where</span><span>
</span><a name="line-737"></a><span>    </span><span class="hs-comment">--      MkT :: f a -&gt; T f a</span><span>
</span><a name="line-738"></a><span>    </span><span class="hs-comment">-- If we don't look at MkT we won't get the correct kind</span><span>
</span><a name="line-739"></a><span>    </span><span class="hs-comment">-- for the type constructor T</span><span>
</span><a name="line-740"></a><span>    </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#dataConCtxtName"><span class="hs-identifier hs-var">dataConCtxtName</span></a><span> </span><a href="#local-6989586621680456079"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-741"></a><span>    </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-742"></a><span>    </span><a href="TcHsType.html#kcImplicitTKBndrs"><span class="hs-identifier hs-var">kcImplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456084"><span class="hs-identifier hs-var">implicit_tkv_nms</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-743"></a><span>    </span><a href="TcHsType.html#kcExplicitTKBndrs"><span class="hs-identifier hs-var">kcExplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456085"><span class="hs-identifier hs-var">explicit_tkv_nms</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-744"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier hs-var">tcHsMbContext</span></a><span> </span><a href="#local-6989586621680456081"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-745"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="HsTypes.html#getBangType"><span class="hs-identifier hs-var">getBangType</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#hsConDeclArgTys"><span class="hs-identifier hs-var">hsConDeclArgTys</span></a><span> </span><a href="#local-6989586621680456082"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-746"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><a href="#local-6989586621680456083"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-747"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span class="hs-comment">{-
Note [Recursion and promoting data constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We don't want to allow promotion in a strongly connected component
when kind checking.

Consider:
  data T f = K (f (K Any))

When kind checking the `data T' declaration the local env contains the
mappings:
  T -&gt; ATcTyCon &lt;some initial kind&gt;
  K -&gt; APromotionErr

APromotionErr is only used for DataCons, and only used during type checking
in tcTyClGroup.

Note [Use SigTvs in kind-checking pass]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  data Proxy a where
    MkProxy1 :: forall k (b :: k). Proxy b
    MkProxy2 :: forall j (c :: j). Proxy c

It seems reasonable that this should be accepted. But something very strange
is going on here: when we're kind-checking this declaration, we need to unify
the kind of `a` with k and j -- even though k and j's scopes are local to the type of
MkProxy{1,2}. The best approach we've come up with is to use SigTvs during
the kind-checking pass. First off, note that it's OK if the kind-checking pass
is too permissive: we'll snag the problems in the type-checking pass later.
(This extra permissiveness might happen with something like

  data SameKind :: k -&gt; k -&gt; Type
  data Bad a where
    MkBad :: forall k1 k2 (a :: k1) (b :: k2). Bad (SameKind a b)

which would be accepted if k1 and k2 were SigTvs. This is correctly rejected
in the second pass, though. Test case: polykinds/SigTvKinds3)
Recall that the kind-checking pass exists solely to collect constraints
on the kinds and to power unification.

To achieve the use of SigTvs, we must be careful to use specialized functions
that produce SigTvs, not ordinary skolems. This is why we need
kcExplicitTKBndrs and kcImplicitTKBndrs in TcHsType, separate from their
tc... variants.

The drawback of this approach is sometimes it will accept a definition that
a (hypothetical) declarative specification would likely reject. As a general
rule, we don't want to allow polymorphic recursion without a CUSK. Indeed,
the whole point of CUSKs is to allow polymorphic recursion. Yet, the SigTvs
approach allows a limited form of polymorphic recursion *without* a CUSK.

To wit:
  data T a = forall k (b :: k). MkT (T b) Int
  (test case: dependent/should_compile/T14066a)

Note that this is polymorphically recursive, with the recursive occurrence
of T used at a kind other than a's kind. The approach outlined here accepts
this definition, because this kind is still a kind variable (and so the
SigTvs unify). Stepping back, I (Richard) have a hard time envisioning a
way to describe exactly what declarations will be accepted and which will
be rejected (without a CUSK). However, the accepted definitions are indeed
well-kinded and any rejected definitions would be accepted with a CUSK,
and so this wrinkle need not cause anyone to lose sleep.

************************************************************************
*                                                                      *
\subsection{Type checking}
*                                                                      *
************************************************************************

Note [Type checking recursive type and class declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At this point we have completed *kind-checking* of a mutually
recursive group of type/class decls (done in kcTyClGroup). However,
we discarded the kind-checked types (eg RHSs of data type decls);
note that kcTyClDecl returns ().  There are two reasons:

  * It's convenient, because we don't have to rebuild a
    kinded HsDecl (a fairly elaborate type)

  * It's necessary, because after kind-generalisation, the
    TyCons/Classes may now be kind-polymorphic, and hence need
    to be given kind arguments.

Example:
       data T f a = MkT (f a) (T f a)
During kind-checking, we give T the kind T :: k1 -&gt; k2 -&gt; *
and figure out constraints on k1, k2 etc. Then we generalise
to get   T :: forall k. (k-&gt;*) -&gt; k -&gt; *
So now the (T f a) in the RHS must be elaborated to (T k f a).

However, during tcTyClDecl of T (above) we will be in a recursive
&quot;knot&quot;. So we aren't allowed to look at the TyCon T itself; we are only
allowed to put it (lazily) in the returned structures.  But when
kind-checking the RHS of T's decl, we *do* need to know T's kind (so
that we can correctly elaboarate (T k f a).  How can we get T's kind
without looking at T?  Delicate answer: during tcTyClDecl, we extend

  *Global* env with T -&gt; ATyCon (the (not yet built) final TyCon for T)
  *Local*  env with T -&gt; ATcTyCon (TcTyCon with the polymorphic kind of T)

Then:

  * During TcHsType.kcTyVar we look in the *local* env, to get the
    known kind for T.

  * But in TcHsType.ds_type (and ds_var_app in particular) we look in
    the *global* env to get the TyCon. But we must be careful not to
    force the TyCon or we'll get a loop.

This fancy footwork (with two bindings for T) is only necessary for the
TyCons or Classes of this recursive group.  Earlier, finished groups,
live in the global env only.

See also Note [Kind checking recursive type and class declarations]

Note [Kind checking recursive type and class declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Before we can type-check the decls, we must kind check them. This
is done by establishing an &quot;initial kind&quot;, which is a rather uninformed
guess at a tycon's kind (by counting arguments, mainly) and then
using this initial kind for recursive occurrences.

The initial kind is stored in exactly the same way during kind-checking
as it is during type-checking (Note [Type checking recursive type and class
declarations]): in the *local* environment, with ATcTyCon. But we still
must store *something* in the *global* environment. Even though we
discard the result of kind-checking, we sometimes need to produce error
messages. These error messages will want to refer to the tycons being
checked, except that they don't exist yet, and it would be Terribly
Annoying to get the error messages to refer back to HsSyn. So we
create a TcTyCon and put it in the global env. This tycon can
print out its name and knows its kind,
but any other action taken on it will panic. Note
that TcTyCons are *not* knot-tied, unlike the rather valid but
knot-tied ones that occur during type-checking.

Note [Declarations for wired-in things]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
For wired-in things we simply ignore the declaration
and take the wired-in information.  That avoids complications.
e.g. the need to make the data constructor worker name for
     a constraint tuple match the wired-in one
-}</span><span>
</span><a name="line-895"></a><span>
</span><a name="line-896"></a><span class="hs-identifier">tcTyClDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier hs-type">RolesInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#LTyClDecl"><span class="hs-identifier hs-type">LTyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-897"></a><a name="tcTyClDecl"><a href="TcTyClsDecls.html#tcTyClDecl"><span class="hs-identifier">tcTyClDecl</span></a></a><span> </span><a name="local-6989586621680456086"><a href="#local-6989586621680456086"><span class="hs-identifier">roles_info</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456087"><a href="#local-6989586621680456087"><span class="hs-identifier">loc</span></a></a><span> </span><a name="local-6989586621680456088"><a href="#local-6989586621680456088"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-898"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456089"><a href="#local-6989586621680456089"><span class="hs-identifier">thing</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Name.html#wiredInNameTyThing_maybe"><span class="hs-identifier hs-var">wiredInNameTyThing_maybe</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#tcdName"><span class="hs-identifier hs-var">tcdName</span></a><span> </span><a href="#local-6989586621680456088"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-899"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456089"><span class="hs-identifier hs-var">thing</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-comment">-- See Note [Declarations for wired-in things]</span><span>
</span><a name="line-900"></a><span>      </span><a href="TyCoRep.html#ATyCon"><span class="hs-identifier hs-var">ATyCon</span></a><span> </span><a name="local-6989586621680456090"><a href="#local-6989586621680456090"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456090"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-901"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;tcTyClDecl&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456089"><span class="hs-identifier hs-var">thing</span></a><span class="hs-special">)</span><span>
</span><a name="line-902"></a><span>
</span><a name="line-903"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-904"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456087"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcClassDcl.html#tcAddDeclCtxt"><span class="hs-identifier hs-var">tcAddDeclCtxt</span></a><span> </span><a href="#local-6989586621680456088"><span class="hs-identifier hs-var">decl</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- tcTyClDecl ---- {&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456088"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-906"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456091"><a href="#local-6989586621680456091"><span class="hs-identifier">tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcTyClDecl1"><span class="hs-identifier hs-var">tcTyClDecl1</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456086"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456088"><span class="hs-identifier hs-var">decl</span></a><span>
</span><a name="line-907"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;---- tcTyClDecl end ---- }&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456091"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-908"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456091"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span>  </span><span class="hs-comment">-- &quot;type family&quot; declarations</span><span>
</span><a name="line-911"></a><span class="hs-identifier">tcTyClDecl1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier hs-type">RolesInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#TyClDecl"><span class="hs-identifier hs-type">TyClDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-912"></a><a name="tcTyClDecl1"><a href="TcTyClsDecls.html#tcTyClDecl1"><span class="hs-identifier">tcTyClDecl1</span></a></a><span> </span><a name="local-6989586621680456092"><a href="#local-6989586621680456092"><span class="hs-identifier">parent</span></a></a><span> </span><a name="local-6989586621680456093"><a href="#local-6989586621680456093"><span class="hs-identifier">_roles_info</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamDecl"><span class="hs-identifier hs-var">FamDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdFam</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456094"><a href="#local-6989586621680456094"><span class="hs-identifier">fd</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-913"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#tcFamDecl1"><span class="hs-identifier hs-var">tcFamDecl1</span></a><span> </span><a href="#local-6989586621680456092"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="#local-6989586621680456094"><span class="hs-identifier hs-var">fd</span></a><span>
</span><a name="line-914"></a><span>
</span><a name="line-915"></a><span>  </span><span class="hs-comment">-- &quot;type&quot; synonym declaration</span><span>
</span><a name="line-916"></a><span class="hs-identifier">tcTyClDecl1</span><span> </span><a name="local-6989586621680456095"><a href="#local-6989586621680456095"><span class="hs-identifier">_parent</span></a></a><span> </span><a name="local-6989586621680456096"><a href="#local-6989586621680456096"><span class="hs-identifier">roles_info</span></a></a><span>
</span><a name="line-917"></a><span>            </span><span class="hs-special">(</span><a href="HsDecls.html#SynDecl"><span class="hs-identifier hs-var">SynDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456097"><a href="#local-6989586621680456097"><span class="hs-identifier">tc_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdRhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456098"><a href="#local-6989586621680456098"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-918"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">_parent</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-919"></a><span>    </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456097"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456099"><a href="#local-6989586621680456099"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456100"><a href="#local-6989586621680456100"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-920"></a><span>    </span><a href="TcTyClsDecls.html#tcTySynRhs"><span class="hs-identifier hs-var">tcTySynRhs</span></a><span> </span><a href="#local-6989586621680456096"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456097"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456099"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456100"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><a href="#local-6989586621680456098"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-921"></a><span>
</span><a name="line-922"></a><span>  </span><span class="hs-comment">-- &quot;data/newtype&quot; declaration</span><span>
</span><a name="line-923"></a><span class="hs-identifier">tcTyClDecl1</span><span> </span><a name="local-6989586621680456101"><a href="#local-6989586621680456101"><span class="hs-identifier">_parent</span></a></a><span> </span><a name="local-6989586621680456102"><a href="#local-6989586621680456102"><span class="hs-identifier">roles_info</span></a></a><span>
</span><a name="line-924"></a><span>            </span><span class="hs-special">(</span><a href="HsDecls.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456103"><a href="#local-6989586621680456103"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-925"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdDataDefn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456104"><a href="#local-6989586621680456104"><span class="hs-identifier">defn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">_parent</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-927"></a><span>    </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456103"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456105"><a href="#local-6989586621680456105"><span class="hs-identifier">tycon_binders</span></a></a><span> </span><a name="local-6989586621680456106"><a href="#local-6989586621680456106"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-928"></a><span>    </span><a href="TcTyClsDecls.html#tcDataDefn"><span class="hs-identifier hs-var">tcDataDefn</span></a><span> </span><a href="#local-6989586621680456102"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456103"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456105"><span class="hs-identifier hs-var">tycon_binders</span></a><span> </span><a href="#local-6989586621680456106"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><a href="#local-6989586621680456104"><span class="hs-identifier hs-var">defn</span></a><span>
</span><a name="line-929"></a><span>
</span><a name="line-930"></a><span class="hs-identifier">tcTyClDecl1</span><span> </span><a name="local-6989586621680456107"><a href="#local-6989586621680456107"><span class="hs-identifier">_parent</span></a></a><span> </span><a name="local-6989586621680456108"><a href="#local-6989586621680456108"><span class="hs-identifier">roles_info</span></a></a><span>
</span><a name="line-931"></a><span>            </span><span class="hs-special">(</span><a href="HsDecls.html#ClassDecl"><span class="hs-identifier hs-var">ClassDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">tcdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456109"><a href="#local-6989586621680456109"><span class="hs-identifier">class_name</span></a></a><span>
</span><a name="line-932"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdCtxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456110"><a href="#local-6989586621680456110"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdMeths</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456111"><a href="#local-6989586621680456111"><span class="hs-identifier">meths</span></a></a><span>
</span><a name="line-933"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdFDs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456112"><a href="#local-6989586621680456112"><span class="hs-identifier">fundeps</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdSigs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456113"><a href="#local-6989586621680456113"><span class="hs-identifier">sigs</span></a></a><span>
</span><a name="line-934"></a><span>            </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456114"><a href="#local-6989586621680456114"><span class="hs-identifier">ats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">tcdATDefs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456115"><a href="#local-6989586621680456115"><span class="hs-identifier">at_defs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-935"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNothing</span><span> </span><span class="hs-identifier">_parent</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456135"><a href="#local-6989586621680456135"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOEnv.html#fixM"><span class="hs-identifier hs-var">fixM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456121"><a href="#local-6989586621680456121"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-937"></a><span>            </span><span class="hs-comment">-- We need the knot because 'clas' is passed into tcClassATs</span><span>
</span><a name="line-938"></a><span>            </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456122"><a href="#local-6989586621680456122"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456123"><a href="#local-6989586621680456123"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-939"></a><span>            </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isConstraintKind</span><span> </span><a href="Kind.html#isConstraintKind"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcClassDecl 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456122"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">)</span><span>
</span><a name="line-941"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456124"><a href="#local-6989586621680456124"><span class="hs-identifier">tycon_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span>        </span><span class="hs-comment">-- We use the same name</span><span>
</span><a name="line-942"></a><span>                     </span><a name="local-6989586621680456125"><a href="#local-6989586621680456125"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456108"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456124"><span class="hs-identifier hs-var">tycon_name</span></a><span>  </span><span class="hs-comment">-- for TyCon and Class</span><span>
</span><a name="line-943"></a><span>
</span><a name="line-944"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456126"><a href="#local-6989586621680456126"><span class="hs-identifier">ctxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621680456110"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-945"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456127"><a href="#local-6989586621680456127"><span class="hs-identifier">ctxt'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456126"><span class="hs-identifier hs-var">ctxt'</span></a><span>
</span><a name="line-946"></a><span>                       </span><span class="hs-comment">-- Squeeze out any kind unification variables</span><span>
</span><a name="line-947"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456128"><a href="#local-6989586621680456128"><span class="hs-identifier">fds'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="#local-6989586621680456116"><span class="hs-identifier hs-var">tc_fundep</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456112"><span class="hs-identifier hs-var">fundeps</span></a><span>
</span><a name="line-948"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456129"><a href="#local-6989586621680456129"><span class="hs-identifier">sig_stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcClassDcl.html#tcClassSigs"><span class="hs-identifier hs-var">tcClassSigs</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="#local-6989586621680456113"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-6989586621680456111"><span class="hs-identifier hs-var">meths</span></a><span>
</span><a name="line-949"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456130"><a href="#local-6989586621680456130"><span class="hs-identifier">at_stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcClassATs"><span class="hs-identifier hs-var">tcClassATs</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="#local-6989586621680456121"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="#local-6989586621680456114"><span class="hs-identifier hs-var">ats</span></a><span> </span><a href="#local-6989586621680456115"><span class="hs-identifier hs-var">at_defs</span></a><span>
</span><a name="line-950"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456131"><a href="#local-6989586621680456131"><span class="hs-identifier">mindef</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcClassDcl.html#tcClassMinimalDef"><span class="hs-identifier hs-var">tcClassMinimalDef</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="#local-6989586621680456113"><span class="hs-identifier hs-var">sigs</span></a><span> </span><a href="#local-6989586621680456129"><span class="hs-identifier hs-var">sig_stuff</span></a><span>
</span><a name="line-951"></a><span>               </span><span class="hs-comment">-- TODO: Allow us to distinguish between abstract class,</span><span>
</span><a name="line-952"></a><span>               </span><span class="hs-comment">-- and concrete class with no methods (maybe by</span><span>
</span><a name="line-953"></a><span>               </span><span class="hs-comment">-- specifying a trailing where or not</span><span>
</span><a name="line-954"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456132"><a href="#local-6989586621680456132"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>
</span><a name="line-955"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456133"><a href="#local-6989586621680456133"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680456132"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456127"><span class="hs-identifier hs-var">ctxt'</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456130"><span class="hs-identifier hs-var">at_stuff</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456129"><span class="hs-identifier hs-var">sig_stuff</span></a><span>
</span><a name="line-956"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-957"></a><span>                          </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-958"></a><span>                          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456127"><span class="hs-identifier hs-var">ctxt'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456130"><span class="hs-identifier hs-var">at_stuff</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456129"><span class="hs-identifier hs-var">sig_stuff</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456131"><span class="hs-identifier hs-var">mindef</span></a><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456134"><a href="#local-6989586621680456134"><span class="hs-identifier">clas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BuildTyCl.html#buildClass"><span class="hs-identifier hs-var">buildClass</span></a><span> </span><a href="#local-6989586621680456109"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="#local-6989586621680456122"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456125"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621680456128"><span class="hs-identifier hs-var">fds'</span></a><span> </span><a href="#local-6989586621680456133"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-960"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcClassDecl&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456112"><span class="hs-identifier hs-var">fundeps</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456122"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-961"></a><span>                                        </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456128"><span class="hs-identifier hs-var">fds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-962"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456134"><span class="hs-identifier hs-var">clas</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-963"></a><span>
</span><a name="line-964"></a><span>         </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680456135"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-965"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-966"></a><span>    </span><a name="local-6989586621680456116"><a href="#local-6989586621680456116"><span class="hs-identifier">tc_fundep</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456117"><a href="#local-6989586621680456117"><span class="hs-identifier">tvs1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456118"><a href="#local-6989586621680456118"><span class="hs-identifier">tvs2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456119"><a href="#local-6989586621680456119"><span class="hs-identifier">tvs1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookupTyVar"><span class="hs-identifier hs-var">tcLookupTyVar</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456117"><span class="hs-identifier hs-var">tvs1</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-967"></a><span>                                </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456120"><a href="#local-6989586621680456120"><span class="hs-identifier">tvs2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookupTyVar"><span class="hs-identifier hs-var">tcLookupTyVar</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456118"><span class="hs-identifier hs-var">tvs2</span></a><span> </span><span class="hs-special">;</span><span>
</span><a name="line-968"></a><span>                                </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456119"><span class="hs-identifier hs-var">tvs1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456120"><span class="hs-identifier hs-var">tvs2'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-969"></a><span>
</span><a name="line-970"></a><span class="hs-identifier">tcFamDecl1</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-type">FamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-971"></a><a name="tcFamDecl1"><a href="TcTyClsDecls.html#tcFamDecl1"><span class="hs-identifier">tcFamDecl1</span></a></a><span> </span><a name="local-6989586621680456136"><a href="#local-6989586621680456136"><span class="hs-identifier">parent</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamilyDecl"><span class="hs-identifier hs-var">FamilyDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fdInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456137"><a href="#local-6989586621680456137"><span class="hs-identifier">fam_info</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdLName</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456138"><a href="#local-6989586621680456138"><span class="hs-identifier">tc_lname</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456139"><a href="#local-6989586621680456139"><span class="hs-identifier">tc_name</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-972"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdResultSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456140"><a href="#local-6989586621680456140"><span class="hs-identifier">sig</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdTyVars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456141"><a href="#local-6989586621680456141"><span class="hs-identifier">user_tyvars</span></a></a><span>
</span><a name="line-973"></a><span>                              </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fdInjectivityAnn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456142"><a href="#local-6989586621680456142"><span class="hs-identifier">inj</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#DataFamily"><span class="hs-identifier hs-var">DataFamily</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456137"><span class="hs-identifier hs-var">fam_info</span></a><span>
</span><a name="line-975"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456143"><a href="#local-6989586621680456143"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456144"><a href="#local-6989586621680456144"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-976"></a><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;data family:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkFamFlag"><span class="hs-identifier hs-var">checkFamFlag</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-978"></a><span>
</span><a name="line-979"></a><span>  </span><span class="hs-comment">-- Check the kind signature, if any.</span><span>
</span><a name="line-980"></a><span>  </span><span class="hs-comment">-- Data families might have a variable return kind.</span><span>
</span><a name="line-981"></a><span>  </span><span class="hs-comment">-- See See Note [Arity of data families] in FamInstEnv.</span><span>
</span><a name="line-982"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456145"><a href="#local-6989586621680456145"><span class="hs-identifier">extra_binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456146"><a href="#local-6989586621680456146"><span class="hs-identifier">final_res_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcDataKindSig"><span class="hs-identifier hs-var">tcDataKindSig</span></a><span> </span><a href="#local-6989586621680456143"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456144"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-983"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Kind.html#tcIsStarKind"><span class="hs-identifier hs-var">tcIsStarKind</span></a><span> </span><a href="#local-6989586621680456146"><span class="hs-identifier hs-var">final_res_kind</span></a><span>
</span><a name="line-984"></a><span>             </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#tcGetCastedTyVar_maybe"><span class="hs-identifier hs-var">tcGetCastedTyVar_maybe</span></a><span> </span><a href="#local-6989586621680456146"><span class="hs-identifier hs-var">final_res_kind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-985"></a><span>            </span><span class="hs-special">(</span><a href="TcHsType.html#badKindSig"><span class="hs-identifier hs-var">badKindSig</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621680456144"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span>
</span><a name="line-987"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456147"><a href="#local-6989586621680456147"><span class="hs-identifier">tc_rep_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BuildTyCl.html#newTyConRepName"><span class="hs-identifier hs-var">newTyConRepName</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-988"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456148"><a href="#local-6989586621680456148"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#mkFamilyTyCon"><span class="hs-identifier hs-var">mkFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456143"><span class="hs-identifier hs-var">binders</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456145"><span class="hs-identifier hs-var">extra_binders</span></a><span class="hs-special">)</span><span>
</span><a name="line-989"></a><span>                              </span><a href="#local-6989586621680456146"><span class="hs-identifier hs-var">final_res_kind</span></a><span>
</span><a name="line-990"></a><span>                              </span><span class="hs-special">(</span><a href="HsDecls.html#resultVariableName"><span class="hs-identifier hs-var">resultVariableName</span></a><span> </span><a href="#local-6989586621680456140"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>                              </span><span class="hs-special">(</span><a href="TyCon.html#DataFamilyTyCon"><span class="hs-identifier hs-var">DataFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456147"><span class="hs-identifier hs-var">tc_rep_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>                              </span><a href="#local-6989586621680456136"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="TyCon.html#NotInjective"><span class="hs-identifier hs-var">NotInjective</span></a><span>
</span><a name="line-993"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456148"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#OpenTypeFamily"><span class="hs-identifier hs-var">OpenTypeFamily</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456137"><span class="hs-identifier hs-var">fam_info</span></a><span>
</span><a name="line-996"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456149"><a href="#local-6989586621680456149"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456150"><a href="#local-6989586621680456150"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-997"></a><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;open type family:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkFamFlag"><span class="hs-identifier hs-var">checkFamFlag</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-999"></a><span>  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456151"><a href="#local-6989586621680456151"><span class="hs-identifier">inj'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcInjectivity"><span class="hs-identifier hs-var">tcInjectivity</span></a><span> </span><a href="#local-6989586621680456149"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456142"><span class="hs-identifier hs-var">inj</span></a><span>
</span><a name="line-1000"></a><span>  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456152"><a href="#local-6989586621680456152"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#mkFamilyTyCon"><span class="hs-identifier hs-var">mkFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456149"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456150"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1001"></a><span>                               </span><span class="hs-special">(</span><a href="HsDecls.html#resultVariableName"><span class="hs-identifier hs-var">resultVariableName</span></a><span> </span><a href="#local-6989586621680456140"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span> </span><a href="TyCon.html#OpenSynFamilyTyCon"><span class="hs-identifier hs-var">OpenSynFamilyTyCon</span></a><span>
</span><a name="line-1002"></a><span>                               </span><a href="#local-6989586621680456136"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="#local-6989586621680456151"><span class="hs-identifier hs-var">inj'</span></a><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456152"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsDecls.html#ClosedTypeFamily"><span class="hs-identifier hs-var">ClosedTypeFamily</span></a><span> </span><a name="local-6989586621680456153"><a href="#local-6989586621680456153"><span class="hs-identifier">mb_eqns</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456137"><span class="hs-identifier hs-var">fam_info</span></a><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Closed type families are a little tricky, because they contain the definition</span><span>
</span><a name="line-1007"></a><span>    </span><span class="hs-comment">-- of both the type family and the equations for a CoAxiom.</span><span>
</span><a name="line-1008"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Closed type family:&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>         </span><span class="hs-comment">-- the variables in the header scope only over the injectivity</span><span>
</span><a name="line-1010"></a><span>         </span><span class="hs-comment">-- declaration but this is not involved here</span><span>
</span><a name="line-1011"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456157"><a href="#local-6989586621680456157"><span class="hs-identifier">inj'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456158"><a href="#local-6989586621680456158"><span class="hs-identifier">binders</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456159"><a href="#local-6989586621680456159"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcTyClTyVars"><span class="hs-identifier hs-var">tcTyClTyVars</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-1013"></a><span>               </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456154"><a href="#local-6989586621680456154"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456155"><a href="#local-6989586621680456155"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1014"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456156"><a href="#local-6989586621680456156"><span class="hs-identifier">inj'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcInjectivity"><span class="hs-identifier hs-var">tcInjectivity</span></a><span> </span><a href="#local-6989586621680456154"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456142"><span class="hs-identifier hs-var">inj</span></a><span>
</span><a name="line-1015"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456156"><span class="hs-identifier hs-var">inj'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456154"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456155"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkFamFlag"><span class="hs-identifier hs-var">checkFamFlag</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-comment">-- make sure we have -XTypeFamilies</span><span>
</span><a name="line-1018"></a><span>
</span><a name="line-1019"></a><span>         </span><span class="hs-comment">-- If Nothing, this is an abstract family in a hs-boot file;</span><span>
</span><a name="line-1020"></a><span>         </span><span class="hs-comment">-- but eqns might be empty in the Just case as well</span><span>
</span><a name="line-1021"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456153"><span class="hs-identifier hs-var">mb_eqns</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1022"></a><span>           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1023"></a><span>               </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCon.html#mkFamilyTyCon"><span class="hs-identifier hs-var">mkFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456158"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456159"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1024"></a><span>                                      </span><span class="hs-special">(</span><a href="HsDecls.html#resultVariableName"><span class="hs-identifier hs-var">resultVariableName</span></a><span> </span><a href="#local-6989586621680456140"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1025"></a><span>                                      </span><a href="TyCon.html#AbstractClosedSynFamilyTyCon"><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456136"><span class="hs-identifier hs-var">parent</span></a><span>
</span><a name="line-1026"></a><span>                                      </span><a href="#local-6989586621680456157"><span class="hs-identifier hs-var">inj'</span></a><span>
</span><a name="line-1027"></a><span>           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456160"><a href="#local-6989586621680456160"><span class="hs-identifier">eqns</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1028"></a><span>
</span><a name="line-1029"></a><span>         </span><span class="hs-comment">-- Process the equations, creating CoAxBranches</span><span>
</span><a name="line-1030"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456161"><a href="#local-6989586621680456161"><span class="hs-identifier">tc_fam_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#mkTcTyCon"><span class="hs-identifier hs-var">mkTcTyCon</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456141"><span class="hs-identifier hs-var">user_tyvars</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456158"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456159"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1031"></a><span>                                   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="TyCon.html#ClosedTypeFamilyFlavour"><span class="hs-identifier hs-var">ClosedTypeFamilyFlavour</span></a><span>
</span><a name="line-1032"></a><span>
</span><a name="line-1033"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456162"><a href="#local-6989586621680456162"><span class="hs-identifier">branches</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#mapAndReportM"><span class="hs-identifier hs-var">mapAndReportM</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#tcTyFamInstEqn"><span class="hs-identifier hs-var">tcTyFamInstEqn</span></a><span> </span><a href="#local-6989586621680456161"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456160"><span class="hs-identifier hs-var">eqns</span></a><span>
</span><a name="line-1034"></a><span>         </span><span class="hs-comment">-- Do not attempt to drop equations dominated by earlier</span><span>
</span><a name="line-1035"></a><span>         </span><span class="hs-comment">-- ones here; in the case of mutual recursion with a data</span><span>
</span><a name="line-1036"></a><span>         </span><span class="hs-comment">-- type, we get a knot-tying failure.  Instead we check</span><span>
</span><a name="line-1037"></a><span>         </span><span class="hs-comment">-- for this afterwards, in TcValidity.checkValidCoAxiom</span><span>
</span><a name="line-1038"></a><span>         </span><span class="hs-comment">-- Example: tc265</span><span>
</span><a name="line-1039"></a><span>
</span><a name="line-1040"></a><span>         </span><span class="hs-comment">-- Create a CoAxiom, with the correct src location. It is Vitally</span><span>
</span><a name="line-1041"></a><span>         </span><span class="hs-comment">-- Important that we do not pass the branches into</span><span>
</span><a name="line-1042"></a><span>         </span><span class="hs-comment">-- newFamInstAxiomName. They have types that have been zonked inside</span><span>
</span><a name="line-1043"></a><span>         </span><span class="hs-comment">-- the knot and we will die if we look at them. This is OK here</span><span>
</span><a name="line-1044"></a><span>         </span><span class="hs-comment">-- because there will only be one axiom, so we don't need to</span><span>
</span><a name="line-1045"></a><span>         </span><span class="hs-comment">-- differentiate names.</span><span>
</span><a name="line-1046"></a><span>         </span><span class="hs-comment">-- See [Zonking inside the knot] in TcHsType</span><span>
</span><a name="line-1047"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456163"><a href="#local-6989586621680456163"><span class="hs-identifier">co_ax_name</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcEnv.html#newFamInstAxiomName"><span class="hs-identifier hs-var">newFamInstAxiomName</span></a><span> </span><a href="#local-6989586621680456138"><span class="hs-identifier hs-var">tc_lname</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1048"></a><span>
</span><a name="line-1049"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456164"><a href="#local-6989586621680456164"><span class="hs-identifier">mb_co_ax</span></a></a><span>
</span><a name="line-1050"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456160"><span class="hs-identifier hs-var">eqns</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-comment">-- mkBranchedCoAxiom fails on empty list</span><span>
</span><a name="line-1051"></a><span>              </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#mkBranchedCoAxiom"><span class="hs-identifier hs-var">mkBranchedCoAxiom</span></a><span> </span><a href="#local-6989586621680456163"><span class="hs-identifier hs-var">co_ax_name</span></a><span> </span><a href="#local-6989586621680456165"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680456162"><span class="hs-identifier hs-var">branches</span></a><span class="hs-special">)</span><span>
</span><a name="line-1052"></a><span>
</span><a name="line-1053"></a><span>             </span><a name="local-6989586621680456165"><a href="#local-6989586621680456165"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#mkFamilyTyCon"><span class="hs-identifier hs-var">mkFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456139"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456158"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456159"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#resultVariableName"><span class="hs-identifier hs-var">resultVariableName</span></a><span> </span><a href="#local-6989586621680456140"><span class="hs-identifier hs-var">sig</span></a><span class="hs-special">)</span><span>
</span><a name="line-1054"></a><span>                      </span><span class="hs-special">(</span><a href="TyCon.html#ClosedSynFamilyTyCon"><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456164"><span class="hs-identifier hs-var">mb_co_ax</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456136"><span class="hs-identifier hs-var">parent</span></a><span> </span><a href="#local-6989586621680456157"><span class="hs-identifier hs-var">inj'</span></a><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span>         </span><span class="hs-comment">-- We check for instance validity later, when doing validity</span><span>
</span><a name="line-1057"></a><span>         </span><span class="hs-comment">-- checking for the tycon. Exception: checking equations</span><span>
</span><a name="line-1058"></a><span>         </span><span class="hs-comment">-- overlap done by dropDominatedAxioms</span><span>
</span><a name="line-1059"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456165"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1060"></a><span>
</span><a name="line-1061"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;tcFamInst1&quot;</span><span>  </span><span class="hs-comment">-- Silence pattern-exhaustiveness checker</span><span>
</span><a name="line-1062"></a><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span class="hs-comment">-- | Maybe return a list of Bools that say whether a type family was declared</span><span>
</span><a name="line-1065"></a><span class="hs-comment">-- injective in the corresponding type arguments. Length of the list is equal to</span><span>
</span><a name="line-1066"></a><span class="hs-comment">-- the number of arguments (including implicit kind/coercion arguments).</span><span>
</span><a name="line-1067"></a><span class="hs-comment">-- True on position</span><span>
</span><a name="line-1068"></a><span class="hs-comment">-- N means that a function is injective in its Nth argument. False means it is</span><span>
</span><a name="line-1069"></a><span class="hs-comment">-- not.</span><span>
</span><a name="line-1070"></a><span class="hs-identifier">tcInjectivity</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#LInjectivityAnn"><span class="hs-identifier hs-type">LInjectivityAnn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#Injectivity"><span class="hs-identifier hs-type">Injectivity</span></a><span>
</span><a name="line-1072"></a><a name="tcInjectivity"><a href="TcTyClsDecls.html#tcInjectivity"><span class="hs-identifier">tcInjectivity</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>
</span><a name="line-1073"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TyCon.html#NotInjective"><span class="hs-identifier hs-var">NotInjective</span></a><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span>  </span><span class="hs-comment">-- User provided an injectivity annotation, so for each tyvar argument we</span><span>
</span><a name="line-1076"></a><span>  </span><span class="hs-comment">-- check whether a type family was declared injective in that argument. We</span><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-comment">-- return a list of Bools, where True means that corresponding type variable</span><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-comment">-- was mentioned in lInjNames (type family is injective in that argument) and</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-comment">-- False means that it was not mentioned in lInjNames (type family is not</span><span>
</span><a name="line-1080"></a><span>  </span><span class="hs-comment">-- injective in that type variable). We also extend injectivity information to</span><span>
</span><a name="line-1081"></a><span>  </span><span class="hs-comment">-- kind variables, so if a user declares:</span><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1083"></a><span>  </span><span class="hs-comment">--   type family F (a :: k1) (b :: k2) = (r :: k3) | r -&gt; a</span><span>
</span><a name="line-1084"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1085"></a><span>  </span><span class="hs-comment">-- then we mark both `a` and `k1` as injective.</span><span>
</span><a name="line-1086"></a><span>  </span><span class="hs-comment">-- NB: the return kind is considered to be *input* argument to a type family.</span><span>
</span><a name="line-1087"></a><span>  </span><span class="hs-comment">-- Since injectivity allows to infer input arguments from the result in theory</span><span>
</span><a name="line-1088"></a><span>  </span><span class="hs-comment">-- we should always mark the result kind variable (`k3` in this example) as</span><span>
</span><a name="line-1089"></a><span>  </span><span class="hs-comment">-- injective.  The reason is that result type has always an assigned kind and</span><span>
</span><a name="line-1090"></a><span>  </span><span class="hs-comment">-- therefore we can always infer the result kind if we know the result type.</span><span>
</span><a name="line-1091"></a><span>  </span><span class="hs-comment">-- But this does not seem to be useful in any way so we don't do it.  (Another</span><span>
</span><a name="line-1092"></a><span>  </span><span class="hs-comment">-- reason is that the implementation would not be straightforward.)</span><span>
</span><a name="line-1093"></a><span class="hs-identifier">tcInjectivity</span><span> </span><a name="local-6989586621680456166"><a href="#local-6989586621680456166"><span class="hs-identifier">tcbs</span></a></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456167"><a href="#local-6989586621680456167"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#InjectivityAnn"><span class="hs-identifier hs-var">InjectivityAnn</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456168"><a href="#local-6989586621680456168"><span class="hs-identifier">lInjNames</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1094"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456167"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1095"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456169"><a href="#local-6989586621680456169"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><a href="#local-6989586621680456166"><span class="hs-identifier hs-var">tcbs</span></a><span>
</span><a name="line-1096"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456170"><a href="#local-6989586621680456170"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-1097"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#TypeFamilyDependencies"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TypeFamilyDependencies</span></a><span> </span><a href="#local-6989586621680456170"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1098"></a><span>                 </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal injectivity annotation&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1099"></a><span>                  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use TypeFamilyDependencies to allow this&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1100"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456171"><a href="#local-6989586621680456171"><span class="hs-identifier">inj_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><span class="hs-special">(</span><a href="TcEnv.html#tcLookupTyVar"><span class="hs-identifier hs-var">tcLookupTyVar</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456168"><span class="hs-identifier hs-var">lInjNames</span></a><span>
</span><a name="line-1101"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456172"><a href="#local-6989586621680456172"><span class="hs-identifier">inj_tvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#zonkTcTyVarToTyVar"><span class="hs-identifier hs-var">zonkTcTyVarToTyVar</span></a><span> </span><a href="#local-6989586621680456171"><span class="hs-identifier hs-var">inj_tvs</span></a><span> </span><span class="hs-comment">-- zonk the kinds</span><span>
</span><a name="line-1102"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456173"><a href="#local-6989586621680456173"><span class="hs-identifier">inj_ktvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#filterVarSet"><span class="hs-identifier hs-var">filterVarSet</span></a><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- no injective coercion vars</span><span>
</span><a name="line-1103"></a><span>                        </span><a href="TyCoRep.html#closeOverKinds"><span class="hs-identifier hs-var">closeOverKinds</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621680456172"><span class="hs-identifier hs-var">inj_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1104"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456174"><a href="#local-6989586621680456174"><span class="hs-identifier">inj_bools</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456173"><span class="hs-identifier hs-var">inj_ktvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456169"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1105"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcInjectivity&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456169"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456168"><span class="hs-identifier hs-var">lInjNames</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456172"><span class="hs-identifier hs-var">inj_tvs</span></a><span>
</span><a name="line-1106"></a><span>                                       </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456173"><span class="hs-identifier hs-var">inj_ktvs</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456174"><span class="hs-identifier hs-var">inj_bools</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1107"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCon.html#Injective"><span class="hs-identifier hs-var">Injective</span></a><span> </span><a href="#local-6989586621680456174"><span class="hs-identifier hs-var">inj_bools</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1108"></a><span>
</span><a name="line-1109"></a><span class="hs-identifier">tcTySynRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier hs-type">RolesInfo</span></a><span>
</span><a name="line-1110"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1111"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-1112"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-1113"></a><a name="tcTySynRhs"><a href="TcTyClsDecls.html#tcTySynRhs"><span class="hs-identifier">tcTySynRhs</span></a></a><span> </span><a name="local-6989586621680456175"><a href="#local-6989586621680456175"><span class="hs-identifier">roles_info</span></a></a><span> </span><a name="local-6989586621680456176"><a href="#local-6989586621680456176"><span class="hs-identifier">tc_name</span></a></a><span> </span><a name="local-6989586621680456177"><a href="#local-6989586621680456177"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456178"><a href="#local-6989586621680456178"><span class="hs-identifier">res_kind</span></a></a><span> </span><a name="local-6989586621680456179"><a href="#local-6989586621680456179"><span class="hs-identifier">hs_ty</span></a></a><span>
</span><a name="line-1114"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456180"><a href="#local-6989586621680456180"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getLclEnv"><span class="hs-identifier hs-var">getLclEnv</span></a><span>
</span><a name="line-1115"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tc-syn&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456176"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tcl_env</span><span> </span><a href="#local-6989586621680456180"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1116"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456181"><a href="#local-6989586621680456181"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621680456179"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621680456178"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1117"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456182"><a href="#local-6989586621680456182"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456181"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1118"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456183"><a href="#local-6989586621680456183"><span class="hs-identifier">roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456175"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456176"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-1119"></a><span>             </span><a name="local-6989586621680456184"><a href="#local-6989586621680456184"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#buildSynTyCon"><span class="hs-identifier hs-var">buildSynTyCon</span></a><span> </span><a href="#local-6989586621680456176"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456177"><span class="hs-identifier hs-var">binders</span></a><span> </span><a href="#local-6989586621680456178"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><a href="#local-6989586621680456183"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621680456182"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1120"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456184"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1121"></a><span>
</span><a name="line-1122"></a><span class="hs-identifier">tcDataDefn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcTyDecls.html#RolesInfo"><span class="hs-identifier hs-type">RolesInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1123"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-1124"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-type">HsDataDefn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-1125"></a><span>  </span><span class="hs-comment">-- NB: not used for newtype/data instances (whether associated or not)</span><span>
</span><a name="line-1126"></a><a name="tcDataDefn"><a href="TcTyClsDecls.html#tcDataDefn"><span class="hs-identifier">tcDataDefn</span></a></a><span> </span><a name="local-6989586621680456185"><a href="#local-6989586621680456185"><span class="hs-identifier">roles_info</span></a></a><span>
</span><a name="line-1127"></a><span>           </span><a name="local-6989586621680456186"><a href="#local-6989586621680456186"><span class="hs-identifier">tc_name</span></a></a><span> </span><a name="local-6989586621680456187"><a href="#local-6989586621680456187"><span class="hs-identifier">tycon_binders</span></a></a><span> </span><a name="local-6989586621680456188"><a href="#local-6989586621680456188"><span class="hs-identifier">res_kind</span></a></a><span>
</span><a name="line-1128"></a><span>         </span><span class="hs-special">(</span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_ND</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456189"><a href="#local-6989586621680456189"><span class="hs-identifier">new_or_data</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cType</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456190"><a href="#local-6989586621680456190"><span class="hs-identifier">cType</span></a></a><span>
</span><a name="line-1129"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456191"><a href="#local-6989586621680456191"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_kindSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456192"><a href="#local-6989586621680456192"><span class="hs-identifier">mb_ksig</span></a></a><span>
</span><a name="line-1130"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456193"><a href="#local-6989586621680456193"><span class="hs-identifier">cons</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1131"></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456198"><a href="#local-6989586621680456198"><span class="hs-identifier">tcg_env</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getGblEnv"><span class="hs-identifier hs-var">getGblEnv</span></a><span>
</span><a name="line-1132"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456199"><a href="#local-6989586621680456199"><span class="hs-identifier">hsc_src</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tcg_src</span><span> </span><a href="#local-6989586621680456198"><span class="hs-identifier hs-var">tcg_env</span></a><span>
</span><a name="line-1133"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456200"><a href="#local-6989586621680456200"><span class="hs-identifier">extra_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456201"><a href="#local-6989586621680456201"><span class="hs-identifier">final_res_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcDataKindSig"><span class="hs-identifier hs-var">tcDataKindSig</span></a><span> </span><a href="#local-6989586621680456187"><span class="hs-identifier hs-var">tycon_binders</span></a><span> </span><a href="#local-6989586621680456188"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1134"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456194"><span class="hs-identifier hs-var">mk_permissive_kind</span></a><span> </span><a href="#local-6989586621680456199"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621680456193"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1135"></a><span>         </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Kind.html#tcIsStarKind"><span class="hs-identifier hs-var">tcIsStarKind</span></a><span> </span><a href="#local-6989586621680456201"><span class="hs-identifier hs-var">final_res_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcHsType.html#badKindSig"><span class="hs-identifier hs-var">badKindSig</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a href="#local-6989586621680456188"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1136"></a><span>
</span><a name="line-1137"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456202"><a href="#local-6989586621680456202"><span class="hs-identifier">final_bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456187"><span class="hs-identifier hs-var">tycon_binders</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456200"><span class="hs-identifier hs-var">extra_bndrs</span></a><span>
</span><a name="line-1138"></a><span>             </span><a name="local-6989586621680456203"><a href="#local-6989586621680456203"><span class="hs-identifier">roles</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456185"><span class="hs-identifier hs-var">roles_info</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-1139"></a><span>
</span><a name="line-1140"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456204"><a href="#local-6989586621680456204"><span class="hs-identifier">stupid_tc_theta</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621680456191"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1141"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456205"><a href="#local-6989586621680456205"><span class="hs-identifier">stupid_theta</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span>
</span><a name="line-1142"></a><span>                                              </span><a href="#local-6989586621680456204"><span class="hs-identifier hs-var">stupid_tc_theta</span></a><span>
</span><a name="line-1143"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456206"><a href="#local-6989586621680456206"><span class="hs-identifier">kind_signatures</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#KindSignatures"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">KindSignatures</span></a><span>
</span><a name="line-1144"></a><span>
</span><a name="line-1145"></a><span>             </span><span class="hs-comment">-- Check that we don't use kind signatures without Glasgow extensions</span><span>
</span><a name="line-1146"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621680456192"><span class="hs-identifier hs-var">mb_ksig</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1147"></a><span>         </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456206"><span class="hs-identifier hs-var">kind_signatures</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badSigTyDecl"><span class="hs-identifier hs-var">badSigTyDecl</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456207"><a href="#local-6989586621680456207"><span class="hs-identifier">gadt_syntax</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#dataDeclChecks"><span class="hs-identifier hs-var">dataDeclChecks</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456189"><span class="hs-identifier hs-var">new_or_data</span></a><span> </span><a href="#local-6989586621680456205"><span class="hs-identifier hs-var">stupid_theta</span></a><span> </span><a href="#local-6989586621680456193"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-1150"></a><span>
</span><a name="line-1151"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456213"><a href="#local-6989586621680456213"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOEnv.html#fixM"><span class="hs-identifier hs-var">fixM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456208"><a href="#local-6989586621680456208"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1152"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456209"><a href="#local-6989586621680456209"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680456208"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><a href="#local-6989586621680456202"><span class="hs-identifier hs-var">final_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456210"><a href="#local-6989586621680456210"><span class="hs-identifier">data_cons</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConDecls"><span class="hs-identifier hs-var">tcConDecls</span></a><span> </span><a href="#local-6989586621680456208"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456202"><span class="hs-identifier hs-var">final_bndrs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456209"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456193"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-1154"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456211"><a href="#local-6989586621680456211"><span class="hs-identifier">tc_rhs</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456195"><span class="hs-identifier hs-var">mk_tc_rhs</span></a><span> </span><a href="#local-6989586621680456199"><span class="hs-identifier hs-var">hsc_src</span></a><span> </span><a href="#local-6989586621680456208"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="#local-6989586621680456210"><span class="hs-identifier hs-var">data_cons</span></a><span>
</span><a name="line-1155"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456212"><a href="#local-6989586621680456212"><span class="hs-identifier">tc_rep_nm</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BuildTyCl.html#newTyConRepName"><span class="hs-identifier hs-var">newTyConRepName</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-1156"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkAlgTyCon"><span class="hs-identifier hs-var">mkAlgTyCon</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span>
</span><a name="line-1157"></a><span>                                  </span><a href="#local-6989586621680456202"><span class="hs-identifier hs-var">final_bndrs</span></a><span>
</span><a name="line-1158"></a><span>                                  </span><a href="#local-6989586621680456201"><span class="hs-identifier hs-var">final_res_kind</span></a><span>
</span><a name="line-1159"></a><span>                                  </span><a href="#local-6989586621680456203"><span class="hs-identifier hs-var">roles</span></a><span>
</span><a name="line-1160"></a><span>                                  </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456190"><span class="hs-identifier hs-var">cType</span></a><span class="hs-special">)</span><span>
</span><a name="line-1161"></a><span>                                  </span><a href="#local-6989586621680456205"><span class="hs-identifier hs-var">stupid_theta</span></a><span> </span><a href="#local-6989586621680456211"><span class="hs-identifier hs-var">tc_rhs</span></a><span>
</span><a name="line-1162"></a><span>                                  </span><span class="hs-special">(</span><a href="TyCon.html#VanillaAlgTyCon"><span class="hs-identifier hs-var">VanillaAlgTyCon</span></a><span> </span><a href="#local-6989586621680456212"><span class="hs-identifier hs-var">tc_rep_nm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>                                  </span><a href="#local-6989586621680456207"><span class="hs-identifier hs-var">gadt_syntax</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1164"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcDataDefn&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456187"><span class="hs-identifier hs-var">tycon_binders</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456200"><span class="hs-identifier hs-var">extra_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1165"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456213"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1166"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1167"></a><span>    </span><span class="hs-comment">-- Abstract data types in hsig files can have arbitrary kinds,</span><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-comment">-- because they may be implemented by type synonyms</span><span>
</span><a name="line-1169"></a><span>    </span><span class="hs-comment">-- (which themselves can have arbitrary kinds, not just *)</span><span>
</span><a name="line-1170"></a><span>    </span><a name="local-6989586621680456194"><a href="#local-6989586621680456194"><span class="hs-identifier">mk_permissive_kind</span></a></a><span> </span><a href="DriverPhases.html#HsigFile"><span class="hs-identifier hs-var">HsigFile</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1171"></a><span>    </span><span class="hs-identifier">mk_permissive_kind</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1172"></a><span>
</span><a name="line-1173"></a><span>    </span><span class="hs-comment">-- In hs-boot, a 'data' declaration with no constructors</span><span>
</span><a name="line-1174"></a><span>    </span><span class="hs-comment">-- indicates a nominally distinct abstract data type.</span><span>
</span><a name="line-1175"></a><span>    </span><a name="local-6989586621680456195"><a href="#local-6989586621680456195"><span class="hs-identifier">mk_tc_rhs</span></a></a><span> </span><a href="DriverPhases.html#HsBootFile"><span class="hs-identifier hs-var">HsBootFile</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1176"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TyCon.html#AbstractTyCon"><span class="hs-identifier hs-var">AbstractTyCon</span></a><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span>    </span><span class="hs-identifier">mk_tc_rhs</span><span> </span><a href="DriverPhases.html#HsigFile"><span class="hs-identifier hs-var">HsigFile</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ditto</span><span>
</span><a name="line-1179"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TyCon.html#AbstractTyCon"><span class="hs-identifier hs-var">AbstractTyCon</span></a><span>
</span><a name="line-1180"></a><span>
</span><a name="line-1181"></a><span>    </span><span class="hs-identifier">mk_tc_rhs</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456196"><a href="#local-6989586621680456196"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621680456197"><a href="#local-6989586621680456197"><span class="hs-identifier">data_cons</span></a></a><span>
</span><a name="line-1182"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456189"><span class="hs-identifier hs-var">new_or_data</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1183"></a><span>          </span><a href="HsDecls.html#DataType"><span class="hs-identifier hs-var">DataType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkDataTyConRhs"><span class="hs-identifier hs-var">mkDataTyConRhs</span></a><span> </span><a href="#local-6989586621680456197"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1184"></a><span>          </span><a href="HsDecls.html#NewType"><span class="hs-identifier hs-var">NewType</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">data_cons</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1185"></a><span>                      </span><a href="BuildTyCl.html#mkNewTyConRhs"><span class="hs-identifier hs-var">mkNewTyConRhs</span></a><span> </span><a href="#local-6989586621680456186"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="#local-6989586621680456196"><span class="hs-identifier hs-var">tycon</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#head"><span class="hs-identifier hs-var">head</span></a><span> </span><a href="#local-6989586621680456197"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
               Typechecking associated types (in class decls)
               (including the associated-type defaults)
*                                                                      *
************************************************************************

Note [Associated type defaults]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The following is an example of associated type defaults:
             class C a where
               data D a

               type F a b :: *
               type F a b = [a]        -- Default

Note that we can get default definitions only for type families, not data
families.
-}</span><span>
</span><a name="line-1208"></a><span>
</span><a name="line-1209"></a><span class="hs-identifier">tcClassATs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>                   </span><span class="hs-comment">-- The class name (not knot-tied)</span><span>
</span><a name="line-1210"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span>                  </span><span class="hs-comment">-- The class parent of this associated type</span><span>
</span><a name="line-1211"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LFamilyDecl"><span class="hs-identifier hs-type">LFamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Associated types.</span><span>
</span><a name="line-1212"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyFamDefltEqn"><span class="hs-identifier hs-type">LTyFamDefltEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- Associated type defaults.</span><span>
</span><a name="line-1213"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="Class.html#ClassATItem"><span class="hs-identifier hs-type">ClassATItem</span></a><span class="hs-special">]</span><span>
</span><a name="line-1214"></a><a name="tcClassATs"><a href="TcTyClsDecls.html#tcClassATs"><span class="hs-identifier">tcClassATs</span></a></a><span> </span><a name="local-6989586621680456214"><a href="#local-6989586621680456214"><span class="hs-identifier">class_name</span></a></a><span> </span><a name="local-6989586621680456215"><a href="#local-6989586621680456215"><span class="hs-identifier">cls</span></a></a><span> </span><a name="local-6989586621680456216"><a href="#local-6989586621680456216"><span class="hs-identifier">ats</span></a></a><span> </span><a name="local-6989586621680456217"><a href="#local-6989586621680456217"><span class="hs-identifier">at_defs</span></a></a><span>
</span><a name="line-1215"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>  </span><span class="hs-comment">-- Complain about associated type defaults for non associated-types</span><span>
</span><a name="line-1216"></a><span>         </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcValidity.html#badATErr"><span class="hs-identifier hs-var">badATErr</span></a><span> </span><a href="#local-6989586621680456214"><span class="hs-identifier hs-var">class_name</span></a><span> </span><a href="#local-6989586621680456231"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1217"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621680456231"><a href="#local-6989586621680456231"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680456218"><span class="hs-identifier hs-var">at_def_tycon</span></a><span> </span><a href="#local-6989586621680456217"><span class="hs-identifier hs-var">at_defs</span></a><span>
</span><a name="line-1218"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456231"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">`</span><a href="NameSet.html#elemNameSet"><span class="hs-identifier hs-var">elemNameSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456220"><span class="hs-identifier hs-var">at_names</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1219"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621680456222"><span class="hs-identifier hs-var">tc_at</span></a><span> </span><a href="#local-6989586621680456216"><span class="hs-identifier hs-var">ats</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1220"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1221"></a><span>    </span><span class="hs-identifier">at_def_tycon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LTyFamDefltEqn"><span class="hs-identifier hs-type">LTyFamDefltEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1222"></a><span>    </span><a name="local-6989586621680456218"><a href="#local-6989586621680456218"><span class="hs-identifier">at_def_tycon</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456223"><a href="#local-6989586621680456223"><span class="hs-identifier">eqn</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">feqn_tycon</span><span> </span><a href="#local-6989586621680456223"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span>
</span><a name="line-1223"></a><span>
</span><a name="line-1224"></a><span>    </span><span class="hs-identifier">at_fam_name</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LFamilyDecl"><span class="hs-identifier hs-type">LFamilyDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1225"></a><span>    </span><a name="local-6989586621680456219"><a href="#local-6989586621680456219"><span class="hs-identifier">at_fam_name</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456224"><a href="#local-6989586621680456224"><span class="hs-identifier">decl</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdLName</span><span> </span><a href="#local-6989586621680456224"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>
</span><a name="line-1227"></a><span>    </span><a name="local-6989586621680456220"><a href="#local-6989586621680456220"><span class="hs-identifier">at_names</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameSet.html#mkNameSet"><span class="hs-identifier hs-var">mkNameSet</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680456219"><span class="hs-identifier hs-var">at_fam_name</span></a><span> </span><a href="#local-6989586621680456216"><span class="hs-identifier hs-var">ats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span>    </span><span class="hs-identifier">at_defs_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyFamDefltEqn"><span class="hs-identifier hs-type">LTyFamDefltEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>
</span><a name="line-1230"></a><span>    </span><span class="hs-comment">-- Maps an AT in 'ats' to a list of all its default defs in 'at_defs'</span><span>
</span><a name="line-1231"></a><span>    </span><a name="local-6989586621680456221"><a href="#local-6989586621680456221"><span class="hs-identifier">at_defs_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621680456225"><a href="#local-6989586621680456225"><span class="hs-identifier">at_def</span></a></a><span> </span><a name="local-6989586621680456226"><a href="#local-6989586621680456226"><span class="hs-identifier">nenv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#extendNameEnv_C"><span class="hs-identifier hs-var">extendNameEnv_C</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456226"><span class="hs-identifier hs-var">nenv</span></a><span>
</span><a name="line-1232"></a><span>                                          </span><span class="hs-special">(</span><a href="#local-6989586621680456218"><span class="hs-identifier hs-var">at_def_tycon</span></a><span> </span><a href="#local-6989586621680456225"><span class="hs-identifier hs-var">at_def</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456225"><span class="hs-identifier hs-var">at_def</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1233"></a><span>                        </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="#local-6989586621680456217"><span class="hs-identifier hs-var">at_defs</span></a><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span>    </span><a name="local-6989586621680456222"><a href="#local-6989586621680456222"><span class="hs-identifier">tc_at</span></a></a><span> </span><a name="local-6989586621680456227"><a href="#local-6989586621680456227"><span class="hs-identifier">at</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456228"><a href="#local-6989586621680456228"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#tcFamDecl1"><span class="hs-identifier hs-var">tcFamDecl1</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a href="#local-6989586621680456215"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456227"><span class="hs-identifier hs-var">at</span></a><span>
</span><a name="line-1236"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456229"><a href="#local-6989586621680456229"><span class="hs-identifier">at_defs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a><span> </span><a href="#local-6989586621680456221"><span class="hs-identifier hs-var">at_defs_map</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456219"><span class="hs-identifier hs-var">at_fam_name</span></a><span> </span><a href="#local-6989586621680456227"><span class="hs-identifier hs-var">at</span></a><span class="hs-special">)</span><span>
</span><a name="line-1237"></a><span>                                  </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1238"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456230"><a href="#local-6989586621680456230"><span class="hs-identifier">atd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcDefaultAssocDecl"><span class="hs-identifier hs-var">tcDefaultAssocDecl</span></a><span> </span><a href="#local-6989586621680456228"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680456229"><span class="hs-identifier hs-var">at_defs</span></a><span>
</span><a name="line-1239"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="Class.html#ATI"><span class="hs-identifier hs-var">ATI</span></a><span> </span><a href="#local-6989586621680456228"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680456230"><span class="hs-identifier hs-var">atd</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1240"></a><span>
</span><a name="line-1241"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-1242"></a><span class="hs-identifier">tcDefaultAssocDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>                    </span><span class="hs-comment">-- ^ Family TyCon (not knot-tied)</span><span>
</span><a name="line-1243"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LTyFamDefltEqn"><span class="hs-identifier hs-type">LTyFamDefltEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- ^ Defaults</span><span>
</span><a name="line-1244"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- ^ Type checked RHS</span><span>
</span><a name="line-1245"></a><a name="tcDefaultAssocDecl"><a href="TcTyClsDecls.html#tcDefaultAssocDecl"><span class="hs-identifier">tcDefaultAssocDecl</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1246"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-comment">-- No default declaration</span><span>
</span><a name="line-1247"></a><span>
</span><a name="line-1248"></a><span class="hs-identifier">tcDefaultAssocDecl</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456232"><a href="#local-6989586621680456232"><span class="hs-identifier">d1</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-1249"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;More than one default declaration for&quot;</span><span>
</span><a name="line-1250"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">feqn_tycon</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456232"><span class="hs-identifier hs-var">d1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1251"></a><span>
</span><a name="line-1252"></a><span class="hs-identifier">tcDefaultAssocDecl</span><span> </span><a name="local-6989586621680456233"><a href="#local-6989586621680456233"><span class="hs-identifier">fam_tc</span></a></a><span> </span><span class="hs-special">[</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456234"><a href="#local-6989586621680456234"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#FamEqn"><span class="hs-identifier hs-var">FamEqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456235"><a href="#local-6989586621680456235"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-1253"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456236"><a href="#local-6989586621680456236"><span class="hs-identifier">hs_tvs</span></a></a><span>
</span><a name="line-1254"></a><span>                                         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456237"><a href="#local-6989586621680456237"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1255"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsTypes.html#HsQTvs"><span class="hs-identifier hs-var">HsQTvs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456238"><a href="#local-6989586621680456238"><span class="hs-identifier">imp_vars</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456239"><a href="#local-6989586621680456239"><span class="hs-identifier">exp_vars</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456236"><span class="hs-identifier hs-var">hs_tvs</span></a><span>
</span><a name="line-1256"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See Note [Type-checking default assoc decls]</span><span>
</span><a name="line-1257"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456234"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1258"></a><span>    </span><a href="TcTyClsDecls.html#tcAddFamInstCtxt"><span class="hs-identifier hs-var">tcAddFamInstCtxt</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;default type instance&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456235"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1259"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcDefaultAssocDecl&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456235"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456240"><a href="#local-6989586621680456240"><span class="hs-identifier">fam_tc_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1261"></a><span>             </span><a name="local-6989586621680456241"><a href="#local-6989586621680456241"><span class="hs-identifier">fam_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1262"></a><span>
</span><a name="line-1263"></a><span>       </span><span class="hs-comment">-- Kind of family check</span><span>
</span><a name="line-1264"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">fam_tc_name</span><span> </span><span class="hs-operator">==</span><span> </span><a href="#local-6989586621680456240"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1265"></a><span>         </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#wrongKindOfFamily"><span class="hs-identifier hs-var">wrongKindOfFamily</span></a><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1266"></a><span>
</span><a name="line-1267"></a><span>       </span><span class="hs-comment">-- Arity check</span><span>
</span><a name="line-1268"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456239"><span class="hs-identifier hs-var">exp_vars</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456241"><span class="hs-identifier hs-var">fam_arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-1269"></a><span>                 </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#wrongNumberOfParmsErr"><span class="hs-identifier hs-var">wrongNumberOfParmsErr</span></a><span> </span><a href="#local-6989586621680456241"><span class="hs-identifier hs-var">fam_arity</span></a><span class="hs-special">)</span><span>
</span><a name="line-1270"></a><span>
</span><a name="line-1271"></a><span>       </span><span class="hs-comment">-- Typecheck RHS</span><span>
</span><a name="line-1272"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456242"><a href="#local-6989586621680456242"><span class="hs-identifier">all_vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456238"><span class="hs-identifier hs-var">imp_vars</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="HsTypes.html#hsLTyVarName"><span class="hs-identifier hs-var">hsLTyVarName</span></a><span> </span><a href="#local-6989586621680456239"><span class="hs-identifier hs-var">exp_vars</span></a><span>
</span><a name="line-1273"></a><span>             </span><a name="local-6989586621680456243"><a href="#local-6989586621680456243"><span class="hs-identifier">pats</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="HsTypes.html#hsLTyVarBndrToType"><span class="hs-identifier hs-var">hsLTyVarBndrToType</span></a><span> </span><a href="#local-6989586621680456239"><span class="hs-identifier hs-var">exp_vars</span></a><span>
</span><a name="line-1274"></a><span>
</span><a name="line-1275"></a><span>          </span><span class="hs-comment">-- NB: Use tcFamTyPats, not tcTyClTyVars. The latter expects to get</span><span>
</span><a name="line-1276"></a><span>          </span><span class="hs-comment">-- the LHsQTyVars used for declaring a tycon, but the names here</span><span>
</span><a name="line-1277"></a><span>          </span><span class="hs-comment">-- are different.</span><span>
</span><a name="line-1278"></a><span>
</span><a name="line-1279"></a><span>          </span><span class="hs-comment">-- You might think we should pass in some ClsInstInfo, as we're looking</span><span>
</span><a name="line-1280"></a><span>          </span><span class="hs-comment">-- at an associated type. But this would be wrong, because an associated</span><span>
</span><a name="line-1281"></a><span>          </span><span class="hs-comment">-- type default LHS can mention *different* type variables than the</span><span>
</span><a name="line-1282"></a><span>          </span><span class="hs-comment">-- enclosing class. So it's treated more as a freestanding beast.</span><span>
</span><a name="line-1283"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456251"><a href="#local-6989586621680456251"><span class="hs-identifier">pats'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456252"><a href="#local-6989586621680456252"><span class="hs-identifier">rhs_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1284"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcFamTyPats"><span class="hs-identifier hs-var">tcFamTyPats</span></a><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456242"><span class="hs-identifier hs-var">all_vars</span></a><span> </span><a href="#local-6989586621680456243"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-1285"></a><span>              </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#kcTyFamEqnRhs"><span class="hs-identifier hs-var">kcTyFamEqnRhs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456237"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1286"></a><span>              </span><span class="hs-glyph">\</span><a name="local-6989586621680456244"><a href="#local-6989586621680456244"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680456245"><a href="#local-6989586621680456245"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621680456246"><a href="#local-6989586621680456246"><span class="hs-identifier">rhs_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1287"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456247"><a href="#local-6989586621680456247"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1288"></a><span>                             </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621680456237"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680456246"><span class="hs-identifier hs-var">rhs_kind</span></a><span>
</span><a name="line-1289"></a><span>
</span><a name="line-1290"></a><span>                     </span><span class="hs-comment">-- Zonk the patterns etc into the Type world</span><span>
</span><a name="line-1291"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456248"><a href="#local-6989586621680456248"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456244"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1292"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456249"><a href="#local-6989586621680456249"><span class="hs-identifier">pats'</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456248"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456245"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-1293"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456250"><a href="#local-6989586621680456250"><span class="hs-identifier">rhs_ty'</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621680456248"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456247"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1294"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456249"><span class="hs-identifier hs-var">pats'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456250"><span class="hs-identifier hs-var">rhs_ty'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1295"></a><span>
</span><a name="line-1296"></a><span>         </span><span class="hs-comment">-- See Note [Type-checking default assoc decls]</span><span>
</span><a name="line-1297"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a><span> </span><a href="#local-6989586621680456251"><span class="hs-identifier hs-var">pats'</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1298"></a><span>           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456253"><a href="#local-6989586621680456253"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">substTyUnchecked</span></a><span> </span><a href="#local-6989586621680456253"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680456252"><span class="hs-identifier hs-var">rhs_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456234"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1299"></a><span>           </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#failWithTc"><span class="hs-identifier hs-var">failWithTc</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#defaultAssocKindErr"><span class="hs-identifier hs-var">defaultAssocKindErr</span></a><span> </span><a href="#local-6989586621680456233"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1300"></a><span>           </span><span class="hs-comment">-- We check for well-formedness and validity later,</span><span>
</span><a name="line-1301"></a><span>           </span><span class="hs-comment">-- in checkValidClass</span><span>
</span><a name="line-1302"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span class="hs-comment">{- Note [Type-checking default assoc decls]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this default declaration for an associated type

   class C a where
      type F (a :: k) b :: *
      type F x y = Proxy x -&gt; y

Note that the class variable 'a' doesn't scope over the default assoc
decl (rather oddly I think), and (less oddly) neither does the second
argument 'b' of the associated type 'F', or the kind variable 'k'.
Instead, the default decl is treated more like a top-level type
instance.

However we store the default rhs (Proxy x -&gt; y) in F's TyCon, using
F's own type variables, so we need to convert it to (Proxy a -&gt; b).
We do this by calling tcMatchTys to match them up.  This also ensures
that x's kind matches a's and similarly for y and b.  The error
message isn't great, mind you.  (Trac #11361 was caused by not doing a
proper tcMatchTys here.)  -}</span><span>
</span><a name="line-1324"></a><span>
</span><a name="line-1325"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-1326"></a><span class="hs-identifier">kcTyFamInstEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#LTyFamInstEqn"><span class="hs-identifier hs-type">LTyFamInstEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1327"></a><a name="kcTyFamInstEqn"><a href="TcTyClsDecls.html#kcTyFamInstEqn"><span class="hs-identifier">kcTyFamInstEqn</span></a></a><span> </span><a name="local-6989586621680456254"><a href="#local-6989586621680456254"><span class="hs-identifier">tc_fam_tc</span></a></a><span>
</span><a name="line-1328"></a><span>    </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456255"><a href="#local-6989586621680456255"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#HsIB"><span class="hs-identifier hs-var">HsIB</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456256"><a href="#local-6989586621680456256"><span class="hs-identifier">tv_names</span></a></a><span>
</span><a name="line-1329"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#FamEqn"><span class="hs-identifier hs-var">FamEqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456257"><a href="#local-6989586621680456257"><span class="hs-identifier">eqn_tc_name</span></a></a><span>
</span><a name="line-1330"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456258"><a href="#local-6989586621680456258"><span class="hs-identifier">pats</span></a></a><span>
</span><a name="line-1331"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456259"><a href="#local-6989586621680456259"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1332"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456255"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1333"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyFamInstEqn&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-1334"></a><span>           </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;tc_name =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456257"><span class="hs-identifier hs-var">eqn_tc_name</span></a><span>
</span><a name="line-1335"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;fam_tc =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456254"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621680456254"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1336"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;hsib_vars =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456256"><span class="hs-identifier hs-var">tv_names</span></a><span>
</span><a name="line-1337"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;feqn_pats =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456258"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456260"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680456257"><span class="hs-identifier hs-var">eqn_tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>                 </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#wrongTyFamName"><span class="hs-identifier hs-var">wrongTyFamName</span></a><span> </span><a href="#local-6989586621680456260"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><a href="#local-6989586621680456257"><span class="hs-identifier hs-var">eqn_tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1340"></a><span>          </span><span class="hs-comment">-- this check reports an arity error instead of a kind error; easier for user</span><span>
</span><a name="line-1341"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456258"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456261"><span class="hs-identifier hs-var">vis_arity</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1342"></a><span>                  </span><a href="TcTyClsDecls.html#wrongNumberOfParmsErr"><span class="hs-identifier hs-var">wrongNumberOfParmsErr</span></a><span> </span><a href="#local-6989586621680456261"><span class="hs-identifier hs-var">vis_arity</span></a><span>
</span><a name="line-1343"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#kcFamTyPats"><span class="hs-identifier hs-var">kcFamTyPats</span></a><span> </span><a href="#local-6989586621680456254"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span> </span><a href="#local-6989586621680456256"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><a href="#local-6989586621680456258"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621680456262"><a href="#local-6989586621680456262"><span class="hs-identifier">rhs_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1344"></a><span>         </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcTyClsDecls.html#kcTyFamEqnRhs"><span class="hs-identifier hs-var">kcTyFamEqnRhs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456259"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621680456262"><span class="hs-identifier hs-var">rhs_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1345"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1346"></a><span>    </span><a name="local-6989586621680456260"><a href="#local-6989586621680456260"><span class="hs-identifier">fam_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456254"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span>
</span><a name="line-1347"></a><span>    </span><a name="local-6989586621680456261"><a href="#local-6989586621680456261"><span class="hs-identifier">vis_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a><span> </span><a href="#local-6989586621680456254"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1348"></a><span>
</span><a name="line-1349"></a><span class="hs-comment">-- Infer the kind of the type on the RHS of a type family eqn. Then use</span><span>
</span><a name="line-1350"></a><span class="hs-comment">-- this kind to check the kind of the LHS of the equation. This is useful</span><span>
</span><a name="line-1351"></a><span class="hs-comment">-- as the callback to tcFamTyPats.</span><span>
</span><a name="line-1352"></a><span class="hs-identifier">kcTyFamEqnRhs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span>
</span><a name="line-1353"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>        </span><span class="hs-comment">-- ^ Eqn RHS</span><span>
</span><a name="line-1354"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span>               </span><span class="hs-comment">-- ^ Inferred kind of left-hand side</span><span>
</span><a name="line-1355"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ New pats, inst'ed kind of left-hand side</span><span>
</span><a name="line-1356"></a><a name="kcTyFamEqnRhs"><a href="TcTyClsDecls.html#kcTyFamEqnRhs"><span class="hs-identifier">kcTyFamEqnRhs</span></a></a><span> </span><a name="local-6989586621680456263"><a href="#local-6989586621680456263"><span class="hs-identifier">mb_clsinfo</span></a></a><span> </span><a name="local-6989586621680456264"><a href="#local-6989586621680456264"><span class="hs-identifier">rhs_hs_ty</span></a></a><span> </span><a name="local-6989586621680456265"><a href="#local-6989586621680456265"><span class="hs-identifier">lhs_ki</span></a></a><span>
</span><a name="line-1357"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- It's still possible the lhs_ki has some foralls. Instantiate these away.</span><span>
</span><a name="line-1358"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621680456267"><a href="#local-6989586621680456267"><span class="hs-identifier">new_pats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456268"><a href="#local-6989586621680456268"><span class="hs-identifier">insted_lhs_ki</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1359"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#instantiateTyUntilN"><span class="hs-identifier hs-var">instantiateTyUntilN</span></a><span> </span><a href="#local-6989586621680456266"><span class="hs-identifier hs-var">mb_kind_env</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680456265"><span class="hs-identifier hs-var">lhs_ki</span></a><span>
</span><a name="line-1360"></a><span>
</span><a name="line-1361"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;kcTyFamEqnRhs&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-1362"></a><span>           </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rhs_hs_ty =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456264"><span class="hs-identifier hs-var">rhs_hs_ty</span></a><span>
</span><a name="line-1363"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;lhs_ki =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456265"><span class="hs-identifier hs-var">lhs_ki</span></a><span>
</span><a name="line-1364"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;insted_lhs_ki =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456268"><span class="hs-identifier hs-var">insted_lhs_ki</span></a><span>
</span><a name="line-1365"></a><span>           </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;new_pats =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456267"><span class="hs-identifier hs-var">new_pats</span></a><span>
</span><a name="line-1366"></a><span>           </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1367"></a><span>
</span><a name="line-1368"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621680456264"><span class="hs-identifier hs-var">rhs_hs_ty</span></a><span> </span><a href="#local-6989586621680456268"><span class="hs-identifier hs-var">insted_lhs_ki</span></a><span>
</span><a name="line-1369"></a><span>
</span><a name="line-1370"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456267"><span class="hs-identifier hs-var">new_pats</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456268"><span class="hs-identifier hs-var">insted_lhs_ki</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1371"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1372"></a><span>    </span><a name="local-6989586621680456266"><a href="#local-6989586621680456266"><span class="hs-identifier">mb_kind_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#thdOf3"><span class="hs-identifier hs-var">thdOf3</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-6989586621680456263"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span>
</span><a name="line-1373"></a><span>
</span><a name="line-1374"></a><span class="hs-identifier">tcTyFamInstEqn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#LTyFamInstEqn"><span class="hs-identifier hs-type">LTyFamInstEqn</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-1375"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="CoAxiom.html#CoAxBranch"><span class="hs-identifier hs-type">CoAxBranch</span></a><span>
</span><a name="line-1376"></a><span class="hs-comment">-- Needs to be here, not in TcInstDcls, because closed families</span><span>
</span><a name="line-1377"></a><span class="hs-comment">-- (typechecked here) have TyFamInstEqns</span><span>
</span><a name="line-1378"></a><a name="tcTyFamInstEqn"><a href="TcTyClsDecls.html#tcTyFamInstEqn"><span class="hs-identifier">tcTyFamInstEqn</span></a></a><span> </span><a name="local-6989586621680456269"><a href="#local-6989586621680456269"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680456270"><a href="#local-6989586621680456270"><span class="hs-identifier">mb_clsinfo</span></a></a><span>
</span><a name="line-1379"></a><span>    </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456271"><a href="#local-6989586621680456271"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#HsIB"><span class="hs-identifier hs-var">HsIB</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_vars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456272"><a href="#local-6989586621680456272"><span class="hs-identifier">tv_names</span></a></a><span>
</span><a name="line-1380"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#FamEqn"><span class="hs-identifier hs-var">FamEqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456273"><a href="#local-6989586621680456273"><span class="hs-identifier">eqn_tc_name</span></a></a><span>
</span><a name="line-1381"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456274"><a href="#local-6989586621680456274"><span class="hs-identifier">pats</span></a></a><span>
</span><a name="line-1382"></a><span>                                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456275"><a href="#local-6989586621680456275"><span class="hs-identifier">hs_ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1383"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">getName</span><span> </span><span class="hs-identifier">fam_tc</span><span> </span><a href="Name.html#getName"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">eqn_tc_name</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1384"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456271"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1385"></a><span>    </span><a href="TcTyClsDecls.html#tcFamTyPats"><span class="hs-identifier hs-var">tcFamTyPats</span></a><span> </span><a href="#local-6989586621680456269"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="#local-6989586621680456270"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span> </span><a href="#local-6989586621680456272"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><a href="#local-6989586621680456274"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-1386"></a><span>                </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#kcTyFamEqnRhs"><span class="hs-identifier hs-var">kcTyFamEqnRhs</span></a><span> </span><a href="#local-6989586621680456270"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span> </span><a href="#local-6989586621680456275"><span class="hs-identifier hs-var">hs_ty</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1387"></a><span>                    </span><span class="hs-glyph">\</span><a name="local-6989586621680456276"><a href="#local-6989586621680456276"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621680456277"><a href="#local-6989586621680456277"><span class="hs-identifier">pats</span></a></a><span> </span><a name="local-6989586621680456278"><a href="#local-6989586621680456278"><span class="hs-identifier">res_kind</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1388"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456279"><a href="#local-6989586621680456279"><span class="hs-identifier">rhs_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#tcCheckLHsType"><span class="hs-identifier hs-var">tcCheckLHsType</span></a><span> </span><a href="#local-6989586621680456275"><span class="hs-identifier hs-var">hs_ty</span></a><span> </span><a href="#local-6989586621680456278"><span class="hs-identifier hs-var">res_kind</span></a><span>
</span><a name="line-1389"></a><span>
</span><a name="line-1390"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456280"><a href="#local-6989586621680456280"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456281"><a href="#local-6989586621680456281"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456276"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-1391"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456282"><a href="#local-6989586621680456282"><span class="hs-identifier">pats'</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456280"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456277"><span class="hs-identifier hs-var">pats</span></a><span>
</span><a name="line-1392"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456283"><a href="#local-6989586621680456283"><span class="hs-identifier">rhs_ty'</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621680456280"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456279"><span class="hs-identifier hs-var">rhs_ty</span></a><span>
</span><a name="line-1393"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcTyFamInstEqn&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456269"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="TyCoRep.html#pprTyVars"><span class="hs-identifier hs-var">pprTyVars</span></a><span> </span><a href="#local-6989586621680456281"><span class="hs-identifier hs-var">tvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1394"></a><span>          </span><span class="hs-comment">-- don't print out the pats here, as they might be zonked inside the knot</span><span>
</span><a name="line-1395"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="FamInstEnv.html#mkCoAxBranch"><span class="hs-identifier hs-var">mkCoAxBranch</span></a><span> </span><a href="#local-6989586621680456281"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680456282"><span class="hs-identifier hs-var">pats'</span></a><span> </span><a href="#local-6989586621680456283"><span class="hs-identifier hs-var">rhs_ty'</span></a><span>
</span><a name="line-1396"></a><span>                              </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456281"><span class="hs-identifier hs-var">tvs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1397"></a><span>                              </span><a href="#local-6989586621680456271"><span class="hs-identifier hs-var">loc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1398"></a><span>
</span><a name="line-1399"></a><span class="hs-identifier">kcDataDefn</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Possibly, instantiations for vars</span><span>
</span><a name="line-1400"></a><span>                                  </span><span class="hs-comment">-- (associated types only)</span><span>
</span><a name="line-1401"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#DataFamInstDecl"><span class="hs-identifier hs-type">DataFamInstDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-1402"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span>              </span><span class="hs-comment">-- ^ the kind of the tycon applied to pats</span><span>
</span><a name="line-1403"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span class="hs-special">)</span><span>
</span><a name="line-1404"></a><span>             </span><span class="hs-comment">-- ^ the kind signature might force instantiation</span><span>
</span><a name="line-1405"></a><span>             </span><span class="hs-comment">-- of the tycon; this returns any extra args and the inst'ed kind</span><span>
</span><a name="line-1406"></a><span>             </span><span class="hs-comment">-- See Note [Instantiating a family tycon]</span><span>
</span><a name="line-1407"></a><span class="hs-comment">-- Used for 'data instance' only</span><span>
</span><a name="line-1408"></a><span class="hs-comment">-- Ordinary 'data' is handled by kcTyClDec</span><span>
</span><a name="line-1409"></a><a name="kcDataDefn"><a href="TcTyClsDecls.html#kcDataDefn"><span class="hs-identifier">kcDataDefn</span></a></a><span> </span><a name="local-6989586621680456284"><a href="#local-6989586621680456284"><span class="hs-identifier">mb_kind_env</span></a></a><span>
</span><a name="line-1410"></a><span>           </span><span class="hs-special">(</span><a href="HsDecls.html#DataFamInstDecl"><span class="hs-identifier hs-var">DataFamInstDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsTypes.html#HsIB"><span class="hs-identifier hs-var">HsIB</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1411"></a><span>              </span><a href="HsDecls.html#FamEqn"><span class="hs-identifier hs-var">FamEqn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">feqn_tycon</span><span>  </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456285"><a href="#local-6989586621680456285"><span class="hs-identifier">fam_name</span></a></a><span>
</span><a name="line-1412"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_pats</span><span>   </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456286"><a href="#local-6989586621680456286"><span class="hs-identifier">pats</span></a></a><span>
</span><a name="line-1413"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_fixity</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456287"><a href="#local-6989586621680456287"><span class="hs-identifier">fixity</span></a></a><span>
</span><a name="line-1414"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">feqn_rhs</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#HsDataDefn"><span class="hs-identifier hs-var">HsDataDefn</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dd_ctxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456288"><a href="#local-6989586621680456288"><span class="hs-identifier">ctxt</span></a></a><span>
</span><a name="line-1415"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_cons</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456289"><a href="#local-6989586621680456289"><span class="hs-identifier">cons</span></a></a><span>
</span><a name="line-1416"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dd_kindSig</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456290"><a href="#local-6989586621680456290"><span class="hs-identifier">mb_kind</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1417"></a><span>           </span><a name="local-6989586621680456291"><a href="#local-6989586621680456291"><span class="hs-identifier">res_k</span></a></a><span>
</span><a name="line-1418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsContext"><span class="hs-identifier hs-var">tcHsContext</span></a><span> </span><a href="#local-6989586621680456288"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1419"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcRnMonad.html#wrapLocM"><span class="hs-identifier hs-var">wrapLocM</span></a><span> </span><a href="TcTyClsDecls.html#kcConDecl"><span class="hs-identifier hs-var">kcConDecl</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456289"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-1420"></a><span>          </span><span class="hs-comment">-- See Note [Failing early in kcDataDefn]</span><span>
</span><a name="line-1421"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456295"><a href="#local-6989586621680456295"><span class="hs-identifier">exp_res_kind</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456290"><span class="hs-identifier hs-var">mb_kind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1422"></a><span>            </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="TysWiredIn.html#liftedTypeKind"><span class="hs-identifier hs-var">liftedTypeKind</span></a><span>
</span><a name="line-1423"></a><span>            </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456294"><a href="#local-6989586621680456294"><span class="hs-identifier">k</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcHsType.html#tcLHsKindSig"><span class="hs-identifier hs-var">tcLHsKindSig</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#DataKindCtxt"><span class="hs-identifier hs-var">DataKindCtxt</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456285"><span class="hs-identifier hs-var">fam_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456294"><span class="hs-identifier hs-var">k</span></a><span>
</span><a name="line-1424"></a><span>
</span><a name="line-1425"></a><span>          </span><span class="hs-comment">-- The expected type might have a forall at the type. Normally, we</span><span>
</span><a name="line-1426"></a><span>          </span><span class="hs-comment">-- can't skolemise in kinds because we don't have type-level lambda.</span><span>
</span><a name="line-1427"></a><span>          </span><span class="hs-comment">-- But here, we're at the top-level of an instance declaration, so</span><span>
</span><a name="line-1428"></a><span>          </span><span class="hs-comment">-- we actually have a place to put the regeneralised variables.</span><span>
</span><a name="line-1429"></a><span>          </span><span class="hs-comment">-- Thus: skolemise away. cf. Inst.deeplySkolemise and TcUnify.tcSkolemise</span><span>
</span><a name="line-1430"></a><span>          </span><span class="hs-comment">-- Examples in indexed-types/should_compile/T12369</span><span>
</span><a name="line-1431"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456296"><a href="#local-6989586621680456296"><span class="hs-identifier">tvs_to_skolemise</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456297"><a href="#local-6989586621680456297"><span class="hs-identifier">inner_res_kind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitForAllTys"><span class="hs-identifier hs-var">tcSplitForAllTys</span></a><span> </span><a href="#local-6989586621680456295"><span class="hs-identifier hs-var">exp_res_kind</span></a><span>
</span><a name="line-1432"></a><span>
</span><a name="line-1433"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456298"><a href="#local-6989586621680456298"><span class="hs-identifier">skol_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456299"><a href="#local-6989586621680456299"><span class="hs-identifier">tvs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#tcInstSkolTyVars"><span class="hs-identifier hs-var">tcInstSkolTyVars</span></a><span> </span><a href="#local-6989586621680456296"><span class="hs-identifier hs-var">tvs_to_skolemise</span></a><span>
</span><a name="line-1434"></a><span>            </span><span class="hs-comment">-- we don't need to do anything substantive with the tvs' because the</span><span>
</span><a name="line-1435"></a><span>            </span><span class="hs-comment">-- quantifyTyVars in tcFamTyPats will catch them.</span><span>
</span><a name="line-1436"></a><span>
</span><a name="line-1437"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456300"><a href="#local-6989586621680456300"><span class="hs-identifier">inner_res_kind'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyAddInScope"><span class="hs-identifier hs-var">substTyAddInScope</span></a><span> </span><a href="#local-6989586621680456298"><span class="hs-identifier hs-var">skol_subst</span></a><span> </span><a href="#local-6989586621680456297"><span class="hs-identifier hs-var">inner_res_kind</span></a><span>
</span><a name="line-1438"></a><span>              </span><a name="local-6989586621680456301"><a href="#local-6989586621680456301"><span class="hs-identifier">tv_prs</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a><span> </span><a href="#local-6989586621680456296"><span class="hs-identifier hs-var">tvs_to_skolemise</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456299"><span class="hs-identifier hs-var">tvs'</span></a><span>
</span><a name="line-1439"></a><span>              </span><a name="local-6989586621680456302"><a href="#local-6989586621680456302"><span class="hs-identifier">skol_info</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#SigSkol"><span class="hs-identifier hs-var">SigSkol</span></a><span> </span><a href="TcType.html#InstDeclCtxt"><span class="hs-identifier hs-var">InstDeclCtxt</span></a><span> </span><a href="#local-6989586621680456295"><span class="hs-identifier hs-var">exp_res_kind</span></a><span> </span><a href="#local-6989586621680456301"><span class="hs-identifier hs-var">tv_prs</span></a><span>
</span><a name="line-1440"></a><span>
</span><a name="line-1441"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456303"><a href="#local-6989586621680456303"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456304"><a href="#local-6989586621680456304"><span class="hs-identifier">new_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456305"><a href="#local-6989586621680456305"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1442"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1443"></a><span>               </span><a href="TcUnify.html#checkConstraints"><span class="hs-identifier hs-var">checkConstraints</span></a><span> </span><a href="#local-6989586621680456302"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621680456299"><span class="hs-identifier hs-var">tvs'</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1444"></a><span>               </span><a href="TcHsType.html#checkExpectedKindX"><span class="hs-identifier hs-var">checkExpectedKindX</span></a><span> </span><a href="#local-6989586621680456284"><span class="hs-identifier hs-var">mb_kind_env</span></a><span> </span><a href="#local-6989586621680456293"><span class="hs-identifier hs-var">pp_fam_app</span></a><span>
</span><a name="line-1445"></a><span>                                  </span><a href="#local-6989586621680456292"><span class="hs-identifier hs-var">bogus_ty</span></a><span> </span><a href="#local-6989586621680456291"><span class="hs-identifier hs-var">res_k</span></a><span> </span><a href="#local-6989586621680456300"><span class="hs-identifier hs-var">inner_res_kind'</span></a><span>
</span><a name="line-1446"></a><span>
</span><a name="line-1447"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621680456306"><a href="#local-6989586621680456306"><span class="hs-identifier">lhs_ki</span></a></a><span> </span><a name="local-6989586621680456307"><a href="#local-6989586621680456307"><span class="hs-identifier">rhs_ki</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcEvidence.html#tcCoercionKind"><span class="hs-identifier hs-var">tcCoercionKind</span></a><span> </span><a href="#local-6989586621680456305"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1448"></a><span>
</span><a name="line-1449"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1450"></a><span>          </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456308"><a href="#local-6989586621680456308"><span class="hs-identifier">ev_binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcEvBinds"><span class="hs-identifier hs-var">zonkTcEvBinds</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456303"><span class="hs-identifier hs-var">ev_binds</span></a><span>
</span><a name="line-1451"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isEmptyTcEvBinds</span><span> </span><a href="TcEvidence.html#isEmptyTcEvBinds"><span class="hs-identifier hs-var">ev_binds</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1452"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456309"><a href="#local-6989586621680456309"><span class="hs-identifier">lhs_ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621680456306"><span class="hs-identifier hs-var">lhs_ki</span></a><span>
</span><a name="line-1453"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456310"><a href="#local-6989586621680456310"><span class="hs-identifier">rhs_ki</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcType"><span class="hs-identifier hs-var">zonkTcType</span></a><span> </span><a href="#local-6989586621680456307"><span class="hs-identifier hs-var">rhs_ki</span></a><span>
</span><a name="line-1454"></a><span>             </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">lhs_ki</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">tcEqType</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">rhs_ki</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1455"></a><span>
</span><a name="line-1456"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456304"><span class="hs-identifier hs-var">new_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456306"><span class="hs-identifier hs-var">lhs_ki</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1457"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1458"></a><span>    </span><a name="local-6989586621680456292"><a href="#local-6989586621680456292"><span class="hs-identifier">bogus_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;kcDataDefn&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456285"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456286"><span class="hs-identifier hs-var">pats</span></a><span class="hs-special">)</span><span>
</span><a name="line-1459"></a><span>    </span><a name="local-6989586621680456293"><a href="#local-6989586621680456293"><span class="hs-identifier">pp_fam_app</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HsDecls.html#pprFamInstLHS"><span class="hs-identifier hs-var">pprFamInstLHS</span></a><span> </span><a href="#local-6989586621680456285"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><a href="#local-6989586621680456286"><span class="hs-identifier hs-var">pats</span></a><span> </span><a href="#local-6989586621680456287"><span class="hs-identifier hs-var">fixity</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456288"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456290"><span class="hs-identifier hs-var">mb_kind</span></a><span>
</span><a name="line-1460"></a><span>
</span><a name="line-1461"></a><span class="hs-comment">{-
Kind check type patterns and kind annotate the embedded type variables.
     type instance F [a] = rhs

 * Here we check that a type instance matches its kind signature, but we do
   not check whether there is a pattern for each type index; the latter
   check is only required for type synonym instances.

Note [Instantiating a family tycon]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's possible that kind-checking the result of a family tycon applied to
its patterns will instantiate the tycon further. For example, we might
have

  type family F :: k where
    F = Int
    F = Maybe

After checking (F :: forall k. k) (with no visible patterns), we still need
to instantiate the k. With data family instances, this problem can be even
more intricate, due to Note [Arity of data families] in FamInstEnv. See
indexed-types/should_compile/T12369 for an example.

So, the kind-checker must return both the new args (that is, Type
(Type -&gt; Type) for the equations above) and the instantiated kind.

Because we don't need this information in the kind-checking phase of
checking closed type families, we don't require these extra pieces of
information in tc_fam_ty_pats.

Note [Failing early in kcDataDefn]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to use checkNoErrs when calling kcConDecl. This is because kcConDecl
calls tcConDecl, which checks that the return type of a GADT-like constructor
is actually an instance of the type head. Without the checkNoErrs, potentially
two bad things could happen:

 1) Duplicate error messages, because tcConDecl will be called again during
    *type* checking (as opposed to kind checking)
 2) If we just keep blindly forging forward after both kind checking and type
    checking, we can get a panic in rejigConRes. See Trac #8368.
-}</span><span>
</span><a name="line-1503"></a><span>
</span><a name="line-1504"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-1505"></a><span class="hs-identifier">kcFamTyPats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCon"><span class="hs-identifier hs-type">TcTyCon</span></a><span>
</span><a name="line-1506"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>
</span><a name="line-1507"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#HsTyPats"><span class="hs-identifier hs-type">HsTyPats</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-1508"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1509"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1510"></a><a name="kcFamTyPats"><a href="TcTyClsDecls.html#kcFamTyPats"><span class="hs-identifier">kcFamTyPats</span></a></a><span> </span><a name="local-6989586621680456311"><a href="#local-6989586621680456311"><span class="hs-identifier">tc_fam_tc</span></a></a><span> </span><a name="local-6989586621680456312"><a href="#local-6989586621680456312"><span class="hs-identifier">tv_names</span></a></a><span> </span><a name="local-6989586621680456313"><a href="#local-6989586621680456313"><span class="hs-identifier">arg_pats</span></a></a><span> </span><a name="local-6989586621680456314"><a href="#local-6989586621680456314"><span class="hs-identifier">kind_checker</span></a></a><span>
</span><a name="line-1511"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#discardResult"><span class="hs-identifier hs-var">discardResult</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1512"></a><span>    </span><a href="TcHsType.html#kcImplicitTKBndrs"><span class="hs-identifier hs-var">kcImplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456312"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1513"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456316"><a href="#local-6989586621680456316"><span class="hs-identifier">loc</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a><span> </span><a href="#local-6989586621680456315"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1514"></a><span>             </span><a name="local-6989586621680456317"><a href="#local-6989586621680456317"><span class="hs-identifier">lhs_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-6989586621680456316"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#HsTyVar"><span class="hs-identifier hs-var">HsTyVar</span></a><span> </span><a href="HsExtension.html#noExt"><span class="hs-identifier hs-var">noExt</span></a><span> </span><a href="HsTypes.html#NotPromoted"><span class="hs-identifier hs-var">NotPromoted</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-6989586621680456316"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621680456315"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1515"></a><span>               </span><span class="hs-comment">-- lhs_fun is for error messages only</span><span>
</span><a name="line-1516"></a><span>             </span><a name="local-6989586621680456318"><a href="#local-6989586621680456318"><span class="hs-identifier">no_fun</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;kcFamTyPats&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456315"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1517"></a><span>             </span><a name="local-6989586621680456319"><a href="#local-6989586621680456319"><span class="hs-identifier">fun_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621680456311"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span>
</span><a name="line-1518"></a><span>
</span><a name="line-1519"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456320"><a href="#local-6989586621680456320"><span class="hs-identifier">res_kind_out</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcInferApps"><span class="hs-identifier hs-var">tcInferApps</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456317"><span class="hs-identifier hs-var">lhs_fun</span></a><span> </span><a href="#local-6989586621680456318"><span class="hs-identifier hs-var">no_fun</span></a><span>
</span><a name="line-1520"></a><span>                                             </span><a href="#local-6989586621680456319"><span class="hs-identifier hs-var">fun_kind</span></a><span> </span><a href="#local-6989586621680456313"><span class="hs-identifier hs-var">arg_pats</span></a><span>
</span><a name="line-1521"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456314"><span class="hs-identifier hs-var">kind_checker</span></a><span> </span><a href="#local-6989586621680456320"><span class="hs-identifier hs-var">res_kind_out</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1522"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1523"></a><span>    </span><a name="local-6989586621680456315"><a href="#local-6989586621680456315"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456311"><span class="hs-identifier hs-var">tc_fam_tc</span></a><span>
</span><a name="line-1524"></a><span>
</span><a name="line-1525"></a><span class="hs-identifier">tcFamTyPats</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-1526"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="TcValidity.html#ClsInstInfo"><span class="hs-identifier hs-type">ClsInstInfo</span></a><span>
</span><a name="line-1527"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Implicitly bound kind/type variable names</span><span>
</span><a name="line-1528"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#HsTyPats"><span class="hs-identifier hs-type">HsTyPats</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>  </span><span class="hs-comment">-- Type patterns</span><span>
</span><a name="line-1529"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1530"></a><span>                </span><span class="hs-comment">-- kind-checker for RHS</span><span>
</span><a name="line-1531"></a><span>                </span><span class="hs-comment">-- See Note [Instantiating a family tycon]</span><span>
</span><a name="line-1532"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-special">[</span><a href="Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- Kind and type variables</span><span>
</span><a name="line-1533"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- Kind and type arguments</span><span>
</span><a name="line-1534"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span>
</span><a name="line-1535"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455913"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>            </span><span class="hs-comment">-- NB: You can use solveEqualities here.</span><span>
</span><a name="line-1536"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455913"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-1537"></a><span class="hs-comment">-- Check the type patterns of a type or data family instance</span><span>
</span><a name="line-1538"></a><span class="hs-comment">--     type instance F &lt;pat1&gt; &lt;pat2&gt; = &lt;type&gt;</span><span>
</span><a name="line-1539"></a><span class="hs-comment">-- The 'tyvars' are the free type variables of pats</span><span>
</span><a name="line-1540"></a><span class="hs-comment">--</span><span>
</span><a name="line-1541"></a><span class="hs-comment">-- NB: The family instance declaration may be an associated one,</span><span>
</span><a name="line-1542"></a><span class="hs-comment">-- nested inside an instance decl, thus</span><span>
</span><a name="line-1543"></a><span class="hs-comment">--        instance C [a] where</span><span>
</span><a name="line-1544"></a><span class="hs-comment">--          type F [a] = ...</span><span>
</span><a name="line-1545"></a><span class="hs-comment">-- In that case, the type variable 'a' will *already be in scope*</span><span>
</span><a name="line-1546"></a><span class="hs-comment">-- (and, if C is poly-kinded, so will its kind parameter).</span><span>
</span><a name="line-1547"></a><a name="tcFamTyPats"><a href="TcTyClsDecls.html#tcFamTyPats"><span class="hs-identifier">tcFamTyPats</span></a></a><span> </span><a name="local-6989586621680456321"><a href="#local-6989586621680456321"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680456322"><a href="#local-6989586621680456322"><span class="hs-identifier">mb_clsinfo</span></a></a><span>
</span><a name="line-1548"></a><span>            </span><a name="local-6989586621680456323"><a href="#local-6989586621680456323"><span class="hs-identifier">tv_names</span></a></a><span> </span><a name="local-6989586621680456324"><a href="#local-6989586621680456324"><span class="hs-identifier">arg_pats</span></a></a><span> </span><a name="local-6989586621680456325"><a href="#local-6989586621680456325"><span class="hs-identifier">kind_checker</span></a></a><span> </span><a name="local-6989586621680456326"><a href="#local-6989586621680456326"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-1549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First, check the arity.</span><span>
</span><a name="line-1550"></a><span>         </span><span class="hs-comment">-- If we wait until validity checking, we'll get kind</span><span>
</span><a name="line-1551"></a><span>         </span><span class="hs-comment">-- errors below when an arity error will be much easier to</span><span>
</span><a name="line-1552"></a><span>         </span><span class="hs-comment">-- understand.</span><span>
</span><a name="line-1553"></a><span>         </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456330"><a href="#local-6989586621680456330"><span class="hs-identifier">should_check_arity</span></a></a><span>
</span><a name="line-1554"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#DataFamilyFlavour"><span class="hs-identifier hs-var">DataFamilyFlavour</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456328"><span class="hs-identifier hs-var">flav</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1555"></a><span>                  </span><span class="hs-comment">-- why not check data families? See [Arity of data families] in FamInstEnv</span><span>
</span><a name="line-1556"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1557"></a><span>
</span><a name="line-1558"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621680456330"><span class="hs-identifier hs-var">should_check_arity</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1559"></a><span>         </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456324"><span class="hs-identifier hs-var">arg_pats</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#lengthIs"><span class="hs-identifier hs-var">lengthIs</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456329"><span class="hs-identifier hs-var">vis_arity</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1560"></a><span>         </span><a href="TcTyClsDecls.html#wrongNumberOfParmsErr"><span class="hs-identifier hs-var">wrongNumberOfParmsErr</span></a><span> </span><a href="#local-6989586621680456329"><span class="hs-identifier hs-var">vis_arity</span></a><span>
</span><a name="line-1561"></a><span>                      </span><span class="hs-comment">-- report only explicit arguments</span><span>
</span><a name="line-1562"></a><span>
</span><a name="line-1563"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456339"><a href="#local-6989586621680456339"><span class="hs-identifier">fam_used_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456340"><a href="#local-6989586621680456340"><span class="hs-identifier">typats</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456341"><a href="#local-6989586621680456341"><span class="hs-identifier">more_typats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456342"><a href="#local-6989586621680456342"><span class="hs-identifier">res_kind</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1564"></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>  </span><span class="hs-comment">-- See Note [Constraints in patterns]</span><span>
</span><a name="line-1565"></a><span>               </span><a href="TcHsType.html#tcImplicitTKBndrs"><span class="hs-identifier hs-var">tcImplicitTKBndrs</span></a><span> </span><a href="TcRnTypes.html#FamInstSkol"><span class="hs-identifier hs-var">FamInstSkol</span></a><span> </span><a href="#local-6989586621680456323"><span class="hs-identifier hs-var">tv_names</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1566"></a><span>               </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456331"><a href="#local-6989586621680456331"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a><span> </span><a href="#local-6989586621680456327"><span class="hs-identifier hs-var">fam_name</span></a><span>
</span><a name="line-1567"></a><span>                        </span><a name="local-6989586621680456332"><a href="#local-6989586621680456332"><span class="hs-identifier">lhs_fun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-6989586621680456331"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#HsTyVar"><span class="hs-identifier hs-var">HsTyVar</span></a><span> </span><a href="HsExtension.html#noExt"><span class="hs-identifier hs-var">noExt</span></a><span> </span><a href="HsTypes.html#NotPromoted"><span class="hs-identifier hs-var">NotPromoted</span></a><span>
</span><a name="line-1568"></a><span>                                                               </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a href="#local-6989586621680456331"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="#local-6989586621680456327"><span class="hs-identifier hs-var">fam_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1569"></a><span>                        </span><a name="local-6989586621680456333"><a href="#local-6989586621680456333"><span class="hs-identifier">fun_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1570"></a><span>                        </span><a name="local-6989586621680456334"><a href="#local-6989586621680456334"><span class="hs-identifier">fun_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConKind</span><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1571"></a><span>                        </span><a name="local-6989586621680456335"><a href="#local-6989586621680456335"><span class="hs-identifier">mb_kind_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#thdOf3"><span class="hs-identifier hs-var">thdOf3</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a><span> </span><a href="#local-6989586621680456322"><span class="hs-identifier hs-var">mb_clsinfo</span></a><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span>                  </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456336"><a href="#local-6989586621680456336"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456337"><a href="#local-6989586621680456337"><span class="hs-identifier">res_kind_out</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1574"></a><span>                      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcInferApps"><span class="hs-identifier hs-var">tcInferApps</span></a><span> </span><a href="TcHsType.html#typeLevelMode"><span class="hs-identifier hs-var">typeLevelMode</span></a><span> </span><a href="#local-6989586621680456335"><span class="hs-identifier hs-var">mb_kind_env</span></a><span>
</span><a name="line-1575"></a><span>                                     </span><a href="#local-6989586621680456332"><span class="hs-identifier hs-var">lhs_fun</span></a><span> </span><a href="#local-6989586621680456333"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><a href="#local-6989586621680456334"><span class="hs-identifier hs-var">fun_kind</span></a><span> </span><a href="#local-6989586621680456324"><span class="hs-identifier hs-var">arg_pats</span></a><span>
</span><a name="line-1576"></a><span>
</span><a name="line-1577"></a><span>                  </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456338"><a href="#local-6989586621680456338"><span class="hs-identifier">stuff</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456325"><span class="hs-identifier hs-var">kind_checker</span></a><span> </span><a href="#local-6989586621680456337"><span class="hs-identifier hs-var">res_kind_out</span></a><span>
</span><a name="line-1578"></a><span>                  </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456336"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456338"><span class="hs-identifier hs-var">stuff</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span>          </span><span class="hs-comment">{- TODO (RAE): This should be cleverer. Consider this:

                 type family F a

                 data G a where
                   MkG :: F a ~ Bool =&gt; G a

                 type family Foo (x :: G a) :: F a
                 type instance Foo MkG = False

             This should probably be accepted. Yet the solveEqualities
             will fail, unable to solve (F a ~ Bool)
             We want to quantify over that proof.
             But see Note [Constraints in patterns]
             below, which is missing this piece. -}</span><span>
</span><a name="line-1595"></a><span>
</span><a name="line-1596"></a><span>
</span><a name="line-1597"></a><span>            </span><span class="hs-comment">-- Find free variables (after zonking) and turn</span><span>
</span><a name="line-1598"></a><span>            </span><span class="hs-comment">-- them into skolems, so that we don't subsequently</span><span>
</span><a name="line-1599"></a><span>            </span><span class="hs-comment">-- replace a meta kind var with (Any *)</span><span>
</span><a name="line-1600"></a><span>            </span><span class="hs-comment">-- Very like kindGeneralize</span><span>
</span><a name="line-1601"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456343"><a href="#local-6989586621680456343"><span class="hs-identifier">all_pats</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456340"><span class="hs-identifier hs-var">typats</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#chkAppend"><span class="hs-identifier hs-var">chkAppend</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456341"><span class="hs-identifier hs-var">more_typats</span></a><span>
</span><a name="line-1602"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456344"><a href="#local-6989586621680456344"><span class="hs-identifier">vars</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypesAndSplitDepVars"><span class="hs-identifier hs-var">zonkTcTypesAndSplitDepVars</span></a><span> </span><a href="#local-6989586621680456343"><span class="hs-identifier hs-var">all_pats</span></a><span>
</span><a name="line-1603"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456345"><a href="#local-6989586621680456345"><span class="hs-identifier">qtkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><a href="#local-6989586621680456344"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-1604"></a><span>
</span><a name="line-1605"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">debugIsOn</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1606"></a><span>         </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456346"><a href="#local-6989586621680456346"><span class="hs-identifier">all_pats</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcMType.html#zonkTcTypeInKnot"><span class="hs-identifier hs-var">zonkTcTypeInKnot</span></a><span> </span><a href="#local-6989586621680456343"><span class="hs-identifier hs-var">all_pats</span></a><span>
</span><a name="line-1607"></a><span>            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">MASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isEmptyVarSet</span><span> </span><a href="VarSet.html#isEmptyVarSet"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">coVarsOfTypes</span><span> </span><a href="TyCoRep.html#coVarsOfTypes"><span class="hs-identifier hs-var">all_pats</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">all_pats</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1608"></a><span>           </span><span class="hs-comment">-- This should be the case, because otherwise the solveEqualities</span><span>
</span><a name="line-1609"></a><span>           </span><span class="hs-comment">-- above would fail. TODO (RAE): Update once the solveEqualities</span><span>
</span><a name="line-1610"></a><span>           </span><span class="hs-comment">-- bit is cleverer.</span><span>
</span><a name="line-1611"></a><span>
</span><a name="line-1612"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcFamTyPats&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1613"></a><span>                                </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456343"><span class="hs-identifier hs-var">all_pats</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456345"><span class="hs-identifier hs-var">qtkvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1614"></a><span>           </span><span class="hs-comment">-- Don't print out too much, as we might be in the knot</span><span>
</span><a name="line-1615"></a><span>
</span><a name="line-1616"></a><span>           </span><span class="hs-comment">-- See Note [Free-floating kind vars] in TcHsType</span><span>
</span><a name="line-1617"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456347"><a href="#local-6989586621680456347"><span class="hs-identifier">all_mentioned_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621680456345"><span class="hs-identifier hs-var">qtkvs</span></a><span>
</span><a name="line-1618"></a><span>                                   </span><span class="hs-comment">-- qtkvs has all the tyvars bound by LHS</span><span>
</span><a name="line-1619"></a><span>                                   </span><span class="hs-comment">-- type patterns</span><span>
</span><a name="line-1620"></a><span>             </span><a name="local-6989586621680456348"><a href="#local-6989586621680456348"><span class="hs-identifier">unmentioned_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#filterOut"><span class="hs-identifier hs-var">filterOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456347"><span class="hs-identifier hs-var">all_mentioned_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>                                           </span><a href="#local-6989586621680456339"><span class="hs-identifier hs-var">fam_used_tvs</span></a><span>
</span><a name="line-1622"></a><span>                                   </span><span class="hs-comment">-- If there are tyvars left over, we can</span><span>
</span><a name="line-1623"></a><span>                                   </span><span class="hs-comment">-- assume they're free-floating, since they</span><span>
</span><a name="line-1624"></a><span>                                   </span><span class="hs-comment">-- aren't bound by a type pattern</span><span>
</span><a name="line-1625"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkNoErrs"><span class="hs-identifier hs-var">checkNoErrs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcHsType.html#reportFloatingKvs"><span class="hs-identifier hs-var">reportFloatingKvs</span></a><span> </span><a href="#local-6989586621680456327"><span class="hs-identifier hs-var">fam_name</span></a><span> </span><a href="#local-6989586621680456328"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-1626"></a><span>                                         </span><a href="#local-6989586621680456345"><span class="hs-identifier hs-var">qtkvs</span></a><span> </span><a href="#local-6989586621680456348"><span class="hs-identifier hs-var">unmentioned_tvs</span></a><span>
</span><a name="line-1627"></a><span>
</span><a name="line-1628"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcHsType.html#scopeTyVars"><span class="hs-identifier hs-var">scopeTyVars</span></a><span> </span><a href="TcRnTypes.html#FamInstSkol"><span class="hs-identifier hs-var">FamInstSkol</span></a><span> </span><a href="#local-6989586621680456345"><span class="hs-identifier hs-var">qtkvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1629"></a><span>            </span><span class="hs-comment">-- Extend envt with TcTyVars not TyVars, because the</span><span>
</span><a name="line-1630"></a><span>            </span><span class="hs-comment">-- kind checking etc done by thing_inside does not expect</span><span>
</span><a name="line-1631"></a><span>            </span><span class="hs-comment">-- to encounter TyVars; it expects TcTyVars</span><span>
</span><a name="line-1632"></a><span>         </span><a href="#local-6989586621680456326"><span class="hs-identifier hs-var">thing_inside</span></a><span> </span><a href="#local-6989586621680456345"><span class="hs-identifier hs-var">qtkvs</span></a><span> </span><a href="#local-6989586621680456343"><span class="hs-identifier hs-var">all_pats</span></a><span> </span><a href="#local-6989586621680456342"><span class="hs-identifier hs-var">res_kind</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1633"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1634"></a><span>    </span><a name="local-6989586621680456327"><a href="#local-6989586621680456327"><span class="hs-identifier">fam_name</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1635"></a><span>    </span><a name="local-6989586621680456328"><a href="#local-6989586621680456328"><span class="hs-identifier">flav</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConFlavour"><span class="hs-identifier hs-var">tyConFlavour</span></a><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-1636"></a><span>    </span><a name="local-6989586621680456329"><a href="#local-6989586621680456329"><span class="hs-identifier">vis_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a><span> </span><a href="#local-6989586621680456321"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1637"></a><span>
</span><a name="line-1638"></a><span>
</span><a name="line-1639"></a><span class="hs-comment">{-
Note [Constraints in patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
NB: This isn't the whole story. See comment in tcFamTyPats.

At first glance, it seems there is a complicated story to tell in tcFamTyPats
around constraint solving. After all, type family patterns can now do
GADT pattern-matching, which is jolly complicated. But, there's a key fact
which makes this all simple: everything is at top level! There cannot
be untouchable type variables. There can't be weird interaction between
case branches. There can't be global skolems.

This means that the semantics of type-level GADT matching is a little
different than term level. If we have

  data G a where
    MkGBool :: G Bool

And then

  type family F (a :: G k) :: k
  type instance F MkGBool = True

we get

  axF : F Bool (MkGBool &lt;Bool&gt;) ~ True

Simple! No casting on the RHS, because we can affect the kind parameter
to F.

If we ever introduce local type families, this all gets a lot more
complicated, and will end up looking awfully like term-level GADT
pattern-matching.


** The new story **

Here is really what we want:

The matcher really can't deal with covars in arbitrary spots in coercions.
But it can deal with covars that are arguments to GADT data constructors.
So we somehow want to allow covars only in precisely those spots, then use
them as givens when checking the RHS. TODO (RAE): Implement plan.


Note [Quantifying over family patterns]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We need to quantify over two different lots of kind variables:

First, the ones that come from the kinds of the tyvar args of
tcTyVarBndrsKindGen, as usual
  data family Dist a

  -- Proxy :: forall k. k -&gt; *
  data instance Dist (Proxy a) = DP
  -- Generates  data DistProxy = DP
  --            ax8 k (a::k) :: Dist * (Proxy k a) ~ DistProxy k a
  -- The 'k' comes from the tcTyVarBndrsKindGen (a::k)

Second, the ones that come from the kind argument of the type family
which we pick up using the (tyCoVarsOfTypes typats) in the result of
the thing_inside of tcHsTyvarBndrsGen.
  -- Any :: forall k. k
  data instance Dist Any = DA
  -- Generates  data DistAny k = DA
  --            ax7 k :: Dist k (Any k) ~ DistAny k
  -- The 'k' comes from kindGeneralizeKinds (Any k)

Note [Quantified kind variables of a family pattern]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider   type family KindFam (p :: k1) (q :: k1)
           data T :: Maybe k1 -&gt; k2 -&gt; *
           type instance KindFam (a :: Maybe k) b = T a b -&gt; Int
The HsBSig for the family patterns will be ([k], [a])

Then in the family instance we want to
  * Bring into scope [ &quot;k&quot; -&gt; k:*, &quot;a&quot; -&gt; a:k ]
  * Kind-check the RHS
  * Quantify the type instance over k and k', as well as a,b, thus
       type instance [k, k', a:Maybe k, b:k']
                     KindFam (Maybe k) k' a b = T k k' a b -&gt; Int

Notice that in the third step we quantify over all the visibly-mentioned
type variables (a,b), but also over the implicitly mentioned kind variables
(k, k').  In this case one is bound explicitly but often there will be
none. The role of the kind signature (a :: Maybe k) is to add a constraint
that 'a' must have that kind, and to bring 'k' into scope.



************************************************************************
*                                                                      *
               Data types
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1735"></a><span>
</span><a name="line-1736"></a><span class="hs-identifier">dataDeclChecks</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#NewOrData"><span class="hs-identifier hs-type">NewOrData</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#ThetaType"><span class="hs-identifier hs-type">ThetaType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LConDecl"><span class="hs-identifier hs-type">LConDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1737"></a><a name="dataDeclChecks"><a href="TcTyClsDecls.html#dataDeclChecks"><span class="hs-identifier">dataDeclChecks</span></a></a><span> </span><a name="local-6989586621680456349"><a href="#local-6989586621680456349"><span class="hs-identifier">tc_name</span></a></a><span> </span><a name="local-6989586621680456350"><a href="#local-6989586621680456350"><span class="hs-identifier">new_or_data</span></a></a><span> </span><a name="local-6989586621680456351"><a href="#local-6989586621680456351"><span class="hs-identifier">stupid_theta</span></a></a><span> </span><a name="local-6989586621680456352"><a href="#local-6989586621680456352"><span class="hs-identifier">cons</span></a></a><span>
</span><a name="line-1738"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Check that we don't use GADT syntax in H98 world</span><span>
</span><a name="line-1739"></a><span>         </span><a name="local-6989586621680456353"><a href="#local-6989586621680456353"><span class="hs-identifier">gadtSyntax_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#GADTSyntax"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">GADTSyntax</span></a><span>
</span><a name="line-1740"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456354"><a href="#local-6989586621680456354"><span class="hs-identifier">gadt_syntax</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#consUseGadtSyntax"><span class="hs-identifier hs-var">consUseGadtSyntax</span></a><span> </span><a href="#local-6989586621680456352"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-1741"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456353"><span class="hs-identifier hs-var">gadtSyntax_ok</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680456354"><span class="hs-identifier hs-var">gadt_syntax</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badGadtDecl"><span class="hs-identifier hs-var">badGadtDecl</span></a><span> </span><a href="#local-6989586621680456349"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1742"></a><span>
</span><a name="line-1743"></a><span>           </span><span class="hs-comment">-- Check that the stupid theta is empty for a GADT-style declaration</span><span>
</span><a name="line-1744"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456351"><span class="hs-identifier hs-var">stupid_theta</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680456354"><span class="hs-identifier hs-var">gadt_syntax</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badStupidTheta"><span class="hs-identifier hs-var">badStupidTheta</span></a><span> </span><a href="#local-6989586621680456349"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1745"></a><span>
</span><a name="line-1746"></a><span>         </span><span class="hs-comment">-- Check that a newtype has exactly one constructor</span><span>
</span><a name="line-1747"></a><span>         </span><span class="hs-comment">-- Do this before checking for empty data decls, so that</span><span>
</span><a name="line-1748"></a><span>         </span><span class="hs-comment">-- we don't suggest -XEmptyDataDecls for newtypes</span><span>
</span><a name="line-1749"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456350"><span class="hs-identifier hs-var">new_or_data</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="HsDecls.html#DataType"><span class="hs-identifier hs-var">DataType</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="Util.html#isSingleton"><span class="hs-identifier hs-var">isSingleton</span></a><span> </span><a href="#local-6989586621680456352"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-1750"></a><span>                </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#newtypeConError"><span class="hs-identifier hs-var">newtypeConError</span></a><span> </span><a href="#local-6989586621680456349"><span class="hs-identifier hs-var">tc_name</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680456352"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1751"></a><span>
</span><a name="line-1752"></a><span>                </span><span class="hs-comment">-- Check that there's at least one condecl,</span><span>
</span><a name="line-1753"></a><span>         </span><span class="hs-comment">-- or else we're reading an hs-boot file, or -XEmptyDataDecls</span><span>
</span><a name="line-1754"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456355"><a href="#local-6989586621680456355"><span class="hs-identifier">empty_data_decls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#EmptyDataDecls"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">EmptyDataDecls</span></a><span>
</span><a name="line-1755"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456356"><a href="#local-6989586621680456356"><span class="hs-identifier">is_boot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>  </span><span class="hs-comment">-- Are we compiling an hs-boot file?</span><span>
</span><a name="line-1756"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456352"><span class="hs-identifier hs-var">cons</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456355"><span class="hs-identifier hs-var">empty_data_decls</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456356"><span class="hs-identifier hs-var">is_boot</span></a><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>                 </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#emptyConDeclsErr"><span class="hs-identifier hs-var">emptyConDeclsErr</span></a><span> </span><a href="#local-6989586621680456349"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1758"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456354"><span class="hs-identifier hs-var">gadt_syntax</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1759"></a><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-1762"></a><span class="hs-identifier">consUseGadtSyntax</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LConDecl"><span class="hs-identifier hs-type">LConDecl</span></a><span> </span><a href="#local-6989586621680455912"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1763"></a><a name="consUseGadtSyntax"><a href="TcTyClsDecls.html#consUseGadtSyntax"><span class="hs-identifier">consUseGadtSyntax</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclGADT"><span class="hs-identifier hs-var">ConDeclGADT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1764"></a><span class="hs-identifier">consUseGadtSyntax</span><span> </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1765"></a><span>                 </span><span class="hs-comment">-- All constructors have same shape</span><span>
</span><a name="line-1766"></a><span>
</span><a name="line-1767"></a><span class="hs-comment">-----------------------------------</span><span>
</span><a name="line-1768"></a><span class="hs-identifier">tcConDecls</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span>
</span><a name="line-1769"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="HsDecls.html#LConDecl"><span class="hs-identifier hs-type">LConDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-1770"></a><span>  </span><span class="hs-comment">-- Why both the tycon tyvars and binders? Because the tyvars</span><span>
</span><a name="line-1771"></a><span>  </span><span class="hs-comment">-- have all the names and the binders have the visibilities.</span><span>
</span><a name="line-1772"></a><a name="tcConDecls"><a href="TcTyClsDecls.html#tcConDecls"><span class="hs-identifier">tcConDecls</span></a></a><span> </span><a name="local-6989586621680456357"><a href="#local-6989586621680456357"><span class="hs-identifier">rep_tycon</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456358"><a href="#local-6989586621680456358"><span class="hs-identifier">tmpl_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456359"><a href="#local-6989586621680456359"><span class="hs-identifier">res_tmpl</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1773"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="MonadUtils.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addLocM"><span class="hs-identifier hs-var">addLocM</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1774"></a><span>    </span><a href="TcTyClsDecls.html#tcConDecl"><span class="hs-identifier hs-var">tcConDecl</span></a><span> </span><a href="#local-6989586621680456357"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#mkTyConTagMap"><span class="hs-identifier hs-var">mkTyConTagMap</span></a><span> </span><a href="#local-6989586621680456357"><span class="hs-identifier hs-var">rep_tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456358"><span class="hs-identifier hs-var">tmpl_bndrs</span></a><span> </span><a href="#local-6989586621680456359"><span class="hs-identifier hs-var">res_tmpl</span></a><span>
</span><a name="line-1775"></a><span>    </span><span class="hs-comment">-- It's important that we pay for tag allocation here, once per TyCon,</span><span>
</span><a name="line-1776"></a><span>    </span><span class="hs-comment">-- See Note [Constructor tag allocation], fixes #14657</span><span>
</span><a name="line-1777"></a><span>
</span><a name="line-1778"></a><span class="hs-identifier">tcConDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>             </span><span class="hs-comment">-- Representation tycon. Knot-tied!</span><span>
</span><a name="line-1779"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><a href="BasicTypes.html#ConTag"><span class="hs-identifier hs-type">ConTag</span></a><span>
</span><a name="line-1780"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1781"></a><span>                 </span><span class="hs-comment">-- Return type template (with its template tyvars)</span><span>
</span><a name="line-1782"></a><span>                 </span><span class="hs-comment">--    (tvs, T tys), where T is the family TyCon</span><span>
</span><a name="line-1783"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#ConDecl"><span class="hs-identifier hs-type">ConDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-1784"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-1785"></a><span>
</span><a name="line-1786"></a><a name="tcConDecl"><a href="TcTyClsDecls.html#tcConDecl"><span class="hs-identifier">tcConDecl</span></a></a><span> </span><a name="local-6989586621680456360"><a href="#local-6989586621680456360"><span class="hs-identifier">rep_tycon</span></a></a><span> </span><a name="local-6989586621680456361"><a href="#local-6989586621680456361"><span class="hs-identifier">tag_map</span></a></a><span> </span><a name="local-6989586621680456362"><a href="#local-6989586621680456362"><span class="hs-identifier">tmpl_bndrs</span></a></a><span> </span><a name="local-6989586621680456363"><a href="#local-6989586621680456363"><span class="hs-identifier">res_tmpl</span></a></a><span>
</span><a name="line-1787"></a><span>          </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclH98"><span class="hs-identifier hs-var">ConDeclH98</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_name</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456364"><a href="#local-6989586621680456364"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-1788"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_ex_tvs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456365"><a href="#local-6989586621680456365"><span class="hs-identifier">explicit_tkv_nms</span></a></a><span>
</span><a name="line-1789"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456366"><a href="#local-6989586621680456366"><span class="hs-identifier">hs_ctxt</span></a></a><span>
</span><a name="line-1790"></a><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456367"><a href="#local-6989586621680456367"><span class="hs-identifier">hs_args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1791"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#dataConCtxtName"><span class="hs-identifier hs-var">dataConCtxtName</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1792"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Get hold of the existential type variables</span><span>
</span><a name="line-1793"></a><span>         </span><span class="hs-comment">-- e.g. data T a = forall k (b::k) f. MkT a (f b)</span><span>
</span><a name="line-1794"></a><span>         </span><span class="hs-comment">-- Here tmpl_bndrs = {a}</span><span>
</span><a name="line-1795"></a><span>         </span><span class="hs-comment">--      hs_qvars = HsQTvs { hsq_implicit = {k}</span><span>
</span><a name="line-1796"></a><span>         </span><span class="hs-comment">--                        , hsq_explicit = {f,b} }</span><span>
</span><a name="line-1797"></a><span>
</span><a name="line-1798"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456365"><span class="hs-identifier hs-var">explicit_tkv_nms</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span>
</span><a name="line-1800"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456374"><a href="#local-6989586621680456374"><span class="hs-identifier">exp_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456375"><a href="#local-6989586621680456375"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456376"><a href="#local-6989586621680456376"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456377"><a href="#local-6989586621680456377"><span class="hs-identifier">field_lbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456378"><a href="#local-6989586621680456378"><span class="hs-identifier">stricts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1801"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1802"></a><span>              </span><a href="TcHsType.html#tcExplicitTKBndrs"><span class="hs-identifier hs-var">tcExplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456368"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621680456365"><span class="hs-identifier hs-var">explicit_tkv_nms</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1803"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456369"><a href="#local-6989586621680456369"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier hs-var">tcHsMbContext</span></a><span> </span><a href="#local-6989586621680456366"><span class="hs-identifier hs-var">hs_ctxt</span></a><span>
</span><a name="line-1804"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456370"><a href="#local-6989586621680456370"><span class="hs-identifier">btys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConArgs"><span class="hs-identifier hs-var">tcConArgs</span></a><span> </span><a href="#local-6989586621680456367"><span class="hs-identifier hs-var">hs_args</span></a><span>
</span><a name="line-1805"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456371"><a href="#local-6989586621680456371"><span class="hs-identifier">field_lbls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupConstructorFields"><span class="hs-identifier hs-var">lookupConstructorFields</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1806"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456372"><a href="#local-6989586621680456372"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456373"><a href="#local-6989586621680456373"><span class="hs-identifier">stricts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-6989586621680456370"><span class="hs-identifier hs-var">btys</span></a><span>
</span><a name="line-1807"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456369"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456372"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456371"><span class="hs-identifier hs-var">field_lbls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456373"><span class="hs-identifier hs-var">stricts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1808"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-1809"></a><span>
</span><a name="line-1810"></a><span>         </span><span class="hs-comment">-- exp_tvs have explicit, user-written binding sites</span><span>
</span><a name="line-1811"></a><span>         </span><span class="hs-comment">-- the kvs below are those kind variables entirely unmentioned by the user</span><span>
</span><a name="line-1812"></a><span>         </span><span class="hs-comment">--   and discovered only by generalization</span><span>
</span><a name="line-1813"></a><span>
</span><a name="line-1814"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456379"><a href="#local-6989586621680456379"><span class="hs-identifier">kvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#quantifyConDecl"><span class="hs-identifier hs-var">quantifyConDecl</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><a href="#local-6989586621680456362"><span class="hs-identifier hs-var">tmpl_bndrs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1815"></a><span>                                </span><span class="hs-special">(</span><a href="Type.html#mkSpecForAllTys"><span class="hs-identifier hs-var">mkSpecForAllTys</span></a><span> </span><a href="#local-6989586621680456374"><span class="hs-identifier hs-var">exp_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1816"></a><span>                                 </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-6989586621680456375"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1817"></a><span>                                 </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-6989586621680456376"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1818"></a><span>                                 </span><a href="TysWiredIn.html#unitTy"><span class="hs-identifier hs-var">unitTy</span></a><span class="hs-special">)</span><span>
</span><a name="line-1819"></a><span>                 </span><span class="hs-comment">-- That type is a lie, of course. (It shouldn't end in ()!)</span><span>
</span><a name="line-1820"></a><span>                 </span><span class="hs-comment">-- And we could construct a proper result type from the info</span><span>
</span><a name="line-1821"></a><span>                 </span><span class="hs-comment">-- at hand. But the result would mention only the tmpl_tvs,</span><span>
</span><a name="line-1822"></a><span>                 </span><span class="hs-comment">-- and so it just creates more work to do it right. Really,</span><span>
</span><a name="line-1823"></a><span>                 </span><span class="hs-comment">-- we're doing this to get the right behavior around removing</span><span>
</span><a name="line-1824"></a><span>                 </span><span class="hs-comment">-- any vars bound in exp_binders.</span><span>
</span><a name="line-1825"></a><span>
</span><a name="line-1826"></a><span>             </span><span class="hs-comment">-- Zonk to Types</span><span>
</span><a name="line-1827"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456380"><a href="#local-6989586621680456380"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456381"><a href="#local-6989586621680456381"><span class="hs-identifier">qkvs</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456379"><span class="hs-identifier hs-var">kvs</span></a><span>
</span><a name="line-1828"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456382"><a href="#local-6989586621680456382"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456383"><a href="#local-6989586621680456383"><span class="hs-identifier">user_qtvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="#local-6989586621680456380"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456374"><span class="hs-identifier hs-var">exp_tvs</span></a><span>
</span><a name="line-1829"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456384"><a href="#local-6989586621680456384"><span class="hs-identifier">arg_tys</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456382"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456376"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1830"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456385"><a href="#local-6989586621680456385"><span class="hs-identifier">ctxt</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456382"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456375"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1831"></a><span>
</span><a name="line-1832"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456386"><a href="#local-6989586621680456386"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1833"></a><span>
</span><a name="line-1834"></a><span>       </span><span class="hs-comment">-- Can't print univ_tvs, arg_tys etc, because we are inside the knot here</span><span>
</span><a name="line-1835"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456377"><span class="hs-identifier hs-var">field_lbls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1836"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1837"></a><span>           </span><a name="local-6989586621680456387"><a href="#local-6989586621680456387"><span class="hs-identifier">univ_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConTyVarBinders"><span class="hs-identifier hs-var">tyConTyVarBinders</span></a><span> </span><a href="#local-6989586621680456362"><span class="hs-identifier hs-var">tmpl_bndrs</span></a><span>
</span><a name="line-1838"></a><span>           </span><a name="local-6989586621680456388"><a href="#local-6989586621680456388"><span class="hs-identifier">univ_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><a href="#local-6989586621680456387"><span class="hs-identifier hs-var">univ_tvbs</span></a><span>
</span><a name="line-1839"></a><span>           </span><a name="local-6989586621680456389"><a href="#local-6989586621680456389"><span class="hs-identifier">ex_tvbs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#mkTyVarBinders"><span class="hs-identifier hs-var">mkTyVarBinders</span></a><span> </span><a href="Var.html#Inferred"><span class="hs-identifier hs-var">Inferred</span></a><span> </span><a href="#local-6989586621680456381"><span class="hs-identifier hs-var">qkvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span>
</span><a name="line-1840"></a><span>                       </span><a href="Var.html#mkTyVarBinders"><span class="hs-identifier hs-var">mkTyVarBinders</span></a><span> </span><a href="Var.html#Specified"><span class="hs-identifier hs-var">Specified</span></a><span> </span><a href="#local-6989586621680456383"><span class="hs-identifier hs-var">user_qtvs</span></a><span>
</span><a name="line-1841"></a><span>           </span><a name="local-6989586621680456390"><a href="#local-6989586621680456390"><span class="hs-identifier">ex_tvs</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456381"><span class="hs-identifier hs-var">qkvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456383"><span class="hs-identifier hs-var">user_qtvs</span></a><span>
</span><a name="line-1842"></a><span>           </span><span class="hs-comment">-- For H98 datatypes, the user-written tyvar binders are precisely</span><span>
</span><a name="line-1843"></a><span>           </span><span class="hs-comment">-- the universals followed by the existentials.</span><span>
</span><a name="line-1844"></a><span>           </span><span class="hs-comment">-- See Note [DataCon user type variable binders] in DataCon.</span><span>
</span><a name="line-1845"></a><span>           </span><a name="local-6989586621680456391"><a href="#local-6989586621680456391"><span class="hs-identifier">user_tvbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456387"><span class="hs-identifier hs-var">univ_tvbs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456389"><span class="hs-identifier hs-var">ex_tvbs</span></a><span>
</span><a name="line-1846"></a><span>           </span><a name="local-6989586621680456392"><a href="#local-6989586621680456392"><span class="hs-identifier">buildOneDataCon</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456393"><a href="#local-6989586621680456393"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1847"></a><span>             </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456394"><a href="#local-6989586621680456394"><span class="hs-identifier">is_infix</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConIsInfixH98"><span class="hs-identifier hs-var">tcConIsInfixH98</span></a><span> </span><a href="#local-6989586621680456393"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680456367"><span class="hs-identifier hs-var">hs_args</span></a><span>
</span><a name="line-1848"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456395"><a href="#local-6989586621680456395"><span class="hs-identifier">rep_nm</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BuildTyCl.html#newTyConRepName"><span class="hs-identifier hs-var">newTyConRepName</span></a><span> </span><a href="#local-6989586621680456393"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1849"></a><span>
</span><a name="line-1850"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="BuildTyCl.html#buildDataCon"><span class="hs-identifier hs-var">buildDataCon</span></a><span> </span><a href="#local-6989586621680456386"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621680456393"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680456394"><span class="hs-identifier hs-var">is_infix</span></a><span> </span><a href="#local-6989586621680456395"><span class="hs-identifier hs-var">rep_nm</span></a><span>
</span><a name="line-1851"></a><span>                            </span><a href="#local-6989586621680456378"><span class="hs-identifier hs-var">stricts</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456377"><span class="hs-identifier hs-var">field_lbls</span></a><span>
</span><a name="line-1852"></a><span>                            </span><a href="#local-6989586621680456388"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621680456390"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-6989586621680456391"><span class="hs-identifier hs-var">user_tvbs</span></a><span>
</span><a name="line-1853"></a><span>                            </span><span class="hs-special">[</span><span class="hs-comment">{- no eq_preds -}</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680456385"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680456384"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1854"></a><span>                            </span><a href="#local-6989586621680456363"><span class="hs-identifier hs-var">res_tmpl</span></a><span> </span><a href="#local-6989586621680456360"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><a href="#local-6989586621680456361"><span class="hs-identifier hs-var">tag_map</span></a><span>
</span><a name="line-1855"></a><span>                  </span><span class="hs-comment">-- NB:  we put data_tc, the type constructor gotten from the</span><span>
</span><a name="line-1856"></a><span>                  </span><span class="hs-comment">--      constructor type signature into the data constructor;</span><span>
</span><a name="line-1857"></a><span>                  </span><span class="hs-comment">--      that way checkValidDataCon can complain if it's wrong.</span><span>
</span><a name="line-1858"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-1859"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-1860"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621680456392"><span class="hs-identifier hs-var">buildOneDataCon</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">]</span><span>
</span><a name="line-1861"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1862"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1863"></a><span>    </span><a name="local-6989586621680456368"><a href="#local-6989586621680456368"><span class="hs-identifier">skol_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#SigTypeSkol"><span class="hs-identifier hs-var">SigTypeSkol</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#ConArgCtxt"><span class="hs-identifier hs-var">ConArgCtxt</span></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456364"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1864"></a><span>
</span><a name="line-1865"></a><span class="hs-identifier">tcConDecl</span><span> </span><a name="local-6989586621680456396"><a href="#local-6989586621680456396"><span class="hs-identifier">rep_tycon</span></a></a><span> </span><a name="local-6989586621680456397"><a href="#local-6989586621680456397"><span class="hs-identifier">tag_map</span></a></a><span> </span><a name="local-6989586621680456398"><a href="#local-6989586621680456398"><span class="hs-identifier">tmpl_bndrs</span></a></a><span> </span><a name="local-6989586621680456399"><a href="#local-6989586621680456399"><span class="hs-identifier">res_tmpl</span></a></a><span>
</span><a name="line-1866"></a><span>          </span><span class="hs-special">(</span><a href="HsDecls.html#ConDeclGADT"><span class="hs-identifier hs-var">ConDeclGADT</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">con_names</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456400"><a href="#local-6989586621680456400"><span class="hs-identifier">names</span></a></a><span>
</span><a name="line-1867"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_qvars</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456401"><a href="#local-6989586621680456401"><span class="hs-identifier">qtvs</span></a></a><span>
</span><a name="line-1868"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_mb_cxt</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456402"><a href="#local-6989586621680456402"><span class="hs-identifier">cxt</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456403"><a href="#local-6989586621680456403"><span class="hs-identifier">hs_args</span></a></a><span>
</span><a name="line-1869"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">con_res_ty</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456404"><a href="#local-6989586621680456404"><span class="hs-identifier">res_ty</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1870"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="HsTypes.html#HsQTvs"><span class="hs-identifier hs-var">HsQTvs</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsq_implicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456405"><a href="#local-6989586621680456405"><span class="hs-identifier">implicit_tkv_nms</span></a></a><span>
</span><a name="line-1871"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">hsq_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456406"><a href="#local-6989586621680456406"><span class="hs-identifier">explicit_tkv_nms</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456401"><span class="hs-identifier hs-var">qtvs</span></a><span>
</span><a name="line-1872"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#dataConCtxtName"><span class="hs-identifier hs-var">dataConCtxtName</span></a><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1873"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1874"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456407"><a href="#local-6989586621680456407"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-1875"></a><span>             </span><a name="local-6989586621680456408"><a href="#local-6989586621680456408"><span class="hs-identifier">skol_info</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#DataConSkol"><span class="hs-identifier hs-var">DataConSkol</span></a><span> </span><a href="#local-6989586621680456407"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1876"></a><span>
</span><a name="line-1877"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456415"><a href="#local-6989586621680456415"><span class="hs-identifier">imp_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456416"><a href="#local-6989586621680456416"><span class="hs-identifier">exp_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456417"><a href="#local-6989586621680456417"><span class="hs-identifier">ctxt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456418"><a href="#local-6989586621680456418"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456419"><a href="#local-6989586621680456419"><span class="hs-identifier">res_ty</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456420"><a href="#local-6989586621680456420"><span class="hs-identifier">field_lbls</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456421"><a href="#local-6989586621680456421"><span class="hs-identifier">stricts</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1878"></a><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcSimplify.html#solveEqualities"><span class="hs-identifier hs-var">solveEqualities</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1879"></a><span>              </span><a href="TcHsType.html#tcImplicitTKBndrs"><span class="hs-identifier hs-var">tcImplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456408"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621680456405"><span class="hs-identifier hs-var">implicit_tkv_nms</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1880"></a><span>              </span><a href="TcHsType.html#tcExplicitTKBndrs"><span class="hs-identifier hs-var">tcExplicitTKBndrs</span></a><span> </span><a href="#local-6989586621680456408"><span class="hs-identifier hs-var">skol_info</span></a><span> </span><a href="#local-6989586621680456406"><span class="hs-identifier hs-var">explicit_tkv_nms</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1881"></a><span>              </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456409"><a href="#local-6989586621680456409"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsMbContext"><span class="hs-identifier hs-var">tcHsMbContext</span></a><span> </span><a href="#local-6989586621680456402"><span class="hs-identifier hs-var">cxt</span></a><span>
</span><a name="line-1882"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456410"><a href="#local-6989586621680456410"><span class="hs-identifier">btys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConArgs"><span class="hs-identifier hs-var">tcConArgs</span></a><span> </span><a href="#local-6989586621680456403"><span class="hs-identifier hs-var">hs_args</span></a><span>
</span><a name="line-1883"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456411"><a href="#local-6989586621680456411"><span class="hs-identifier">res_ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsLiftedType"><span class="hs-identifier hs-var">tcHsLiftedType</span></a><span> </span><a href="#local-6989586621680456404"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1884"></a><span>                 </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456412"><a href="#local-6989586621680456412"><span class="hs-identifier">field_lbls</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="RnEnv.html#lookupConstructorFields"><span class="hs-identifier hs-var">lookupConstructorFields</span></a><span> </span><a href="#local-6989586621680456407"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1885"></a><span>                 </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456413"><a href="#local-6989586621680456413"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456414"><a href="#local-6989586621680456414"><span class="hs-identifier">stricts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-6989586621680456410"><span class="hs-identifier hs-var">btys</span></a><span>
</span><a name="line-1886"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456409"><span class="hs-identifier hs-var">ctxt</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456413"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456411"><span class="hs-identifier hs-var">res_ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456412"><span class="hs-identifier hs-var">field_lbls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456414"><span class="hs-identifier hs-var">stricts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1887"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-1888"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456422"><a href="#local-6989586621680456422"><span class="hs-identifier">user_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456415"><span class="hs-identifier hs-var">imp_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456416"><span class="hs-identifier hs-var">exp_tvs</span></a><span>
</span><a name="line-1889"></a><span>
</span><a name="line-1890"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456423"><a href="#local-6989586621680456423"><span class="hs-identifier">tkvs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#quantifyConDecl"><span class="hs-identifier hs-var">quantifyConDecl</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkSpecForAllTys"><span class="hs-identifier hs-var">mkSpecForAllTys</span></a><span> </span><a href="#local-6989586621680456422"><span class="hs-identifier hs-var">user_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1891"></a><span>                                              </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-6989586621680456417"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1892"></a><span>                                              </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><a href="#local-6989586621680456418"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-1893"></a><span>                                              </span><a href="#local-6989586621680456419"><span class="hs-identifier hs-var">res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1894"></a><span>
</span><a name="line-1895"></a><span>             </span><span class="hs-comment">-- Zonk to Types</span><span>
</span><a name="line-1896"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456424"><a href="#local-6989586621680456424"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456425"><a href="#local-6989586621680456425"><span class="hs-identifier">tkvs</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="TcHsSyn.html#emptyZonkEnv"><span class="hs-identifier hs-var">emptyZonkEnv</span></a><span> </span><a href="#local-6989586621680456423"><span class="hs-identifier hs-var">tkvs</span></a><span>
</span><a name="line-1897"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456426"><a href="#local-6989586621680456426"><span class="hs-identifier">ze</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456427"><a href="#local-6989586621680456427"><span class="hs-identifier">user_tvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTyBndrsX"><span class="hs-identifier hs-var">zonkTyBndrsX</span></a><span> </span><a href="#local-6989586621680456424"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456422"><span class="hs-identifier hs-var">user_tvs</span></a><span>
</span><a name="line-1898"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456428"><a href="#local-6989586621680456428"><span class="hs-identifier">arg_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456426"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456418"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1899"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456429"><a href="#local-6989586621680456429"><span class="hs-identifier">ctxt</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToTypes"><span class="hs-identifier hs-var">zonkTcTypeToTypes</span></a><span> </span><a href="#local-6989586621680456426"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456417"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1900"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456430"><a href="#local-6989586621680456430"><span class="hs-identifier">res_ty</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsSyn.html#zonkTcTypeToType"><span class="hs-identifier hs-var">zonkTcTypeToType</span></a><span> </span><a href="#local-6989586621680456426"><span class="hs-identifier hs-var">ze</span></a><span> </span><a href="#local-6989586621680456419"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1901"></a><span>
</span><a name="line-1902"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456431"><a href="#local-6989586621680456431"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456432"><a href="#local-6989586621680456432"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456433"><a href="#local-6989586621680456433"><span class="hs-identifier">tkvs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456434"><a href="#local-6989586621680456434"><span class="hs-identifier">user_tvs'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456435"><a href="#local-6989586621680456435"><span class="hs-identifier">eq_preds</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456436"><a href="#local-6989586621680456436"><span class="hs-identifier">arg_subst</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1903"></a><span>               </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#rejigConRes"><span class="hs-identifier hs-var">rejigConRes</span></a><span> </span><a href="#local-6989586621680456398"><span class="hs-identifier hs-var">tmpl_bndrs</span></a><span> </span><a href="#local-6989586621680456399"><span class="hs-identifier hs-var">res_tmpl</span></a><span> </span><a href="#local-6989586621680456425"><span class="hs-identifier hs-var">tkvs</span></a><span> </span><a href="#local-6989586621680456427"><span class="hs-identifier hs-var">user_tvs</span></a><span> </span><a href="#local-6989586621680456430"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1904"></a><span>             </span><span class="hs-comment">-- NB: this is a /lazy/ binding, so we pass six thunks to</span><span>
</span><a name="line-1905"></a><span>             </span><span class="hs-comment">--     buildDataCon without yet forcing the guards in rejigConRes</span><span>
</span><a name="line-1906"></a><span>             </span><span class="hs-comment">-- See Note [Checking GADT return types]</span><span>
</span><a name="line-1907"></a><span>
</span><a name="line-1908"></a><span>             </span><span class="hs-comment">-- Compute the user-written tyvar binders. These have the same</span><span>
</span><a name="line-1909"></a><span>             </span><span class="hs-comment">-- tyvars as univ_tvs/ex_tvs, but perhaps in a different order.</span><span>
</span><a name="line-1910"></a><span>             </span><span class="hs-comment">-- See Note [DataCon user type variable binders] in DataCon.</span><span>
</span><a name="line-1911"></a><span>             </span><a name="local-6989586621680456437"><a href="#local-6989586621680456437"><span class="hs-identifier">tkv_bndrs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#mkTyVarBinders"><span class="hs-identifier hs-var">mkTyVarBinders</span></a><span> </span><a href="Var.html#Inferred"><span class="hs-identifier hs-var">Inferred</span></a><span>  </span><a href="#local-6989586621680456433"><span class="hs-identifier hs-var">tkvs'</span></a><span>
</span><a name="line-1912"></a><span>             </span><a name="local-6989586621680456438"><a href="#local-6989586621680456438"><span class="hs-identifier">user_tv_bndrs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#mkTyVarBinders"><span class="hs-identifier hs-var">mkTyVarBinders</span></a><span> </span><a href="Var.html#Specified"><span class="hs-identifier hs-var">Specified</span></a><span> </span><a href="#local-6989586621680456434"><span class="hs-identifier hs-var">user_tvs'</span></a><span>
</span><a name="line-1913"></a><span>             </span><a name="local-6989586621680456439"><a href="#local-6989586621680456439"><span class="hs-identifier">all_user_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456437"><span class="hs-identifier hs-var">tkv_bndrs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456438"><span class="hs-identifier hs-var">user_tv_bndrs</span></a><span>
</span><a name="line-1914"></a><span>
</span><a name="line-1915"></a><span>             </span><a name="local-6989586621680456440"><a href="#local-6989586621680456440"><span class="hs-identifier">ctxt'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-6989586621680456436"><span class="hs-identifier hs-var">arg_subst</span></a><span> </span><a href="#local-6989586621680456429"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-1916"></a><span>             </span><a name="local-6989586621680456441"><a href="#local-6989586621680456441"><span class="hs-identifier">arg_tys'</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTys"><span class="hs-identifier hs-var">substTys</span></a><span> </span><a href="#local-6989586621680456436"><span class="hs-identifier hs-var">arg_subst</span></a><span> </span><a href="#local-6989586621680456428"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1917"></a><span>             </span><a name="local-6989586621680456442"><a href="#local-6989586621680456442"><span class="hs-identifier">res_ty'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span>  </span><a href="#local-6989586621680456436"><span class="hs-identifier hs-var">arg_subst</span></a><span> </span><a href="#local-6989586621680456430"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-1918"></a><span>
</span><a name="line-1919"></a><span>
</span><a name="line-1920"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456443"><a href="#local-6989586621680456443"><span class="hs-identifier">fam_envs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FamInst.html#tcGetFamInstEnvs"><span class="hs-identifier hs-var">tcGetFamInstEnvs</span></a><span>
</span><a name="line-1921"></a><span>
</span><a name="line-1922"></a><span>       </span><span class="hs-comment">-- Can't print univ_tvs, arg_tys etc, because we are inside the knot here</span><span>
</span><a name="line-1923"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456420"><span class="hs-identifier hs-var">field_lbls</span></a><span class="hs-special">)</span><span>
</span><a name="line-1924"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1925"></a><span>           </span><a name="local-6989586621680456444"><a href="#local-6989586621680456444"><span class="hs-identifier">buildOneDataCon</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456445"><a href="#local-6989586621680456445"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1926"></a><span>             </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456446"><a href="#local-6989586621680456446"><span class="hs-identifier">is_infix</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConIsInfixGADT"><span class="hs-identifier hs-var">tcConIsInfixGADT</span></a><span> </span><a href="#local-6989586621680456445"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680456403"><span class="hs-identifier hs-var">hs_args</span></a><span>
</span><a name="line-1927"></a><span>             </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456447"><a href="#local-6989586621680456447"><span class="hs-identifier">rep_nm</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BuildTyCl.html#newTyConRepName"><span class="hs-identifier hs-var">newTyConRepName</span></a><span> </span><a href="#local-6989586621680456445"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-1928"></a><span>
</span><a name="line-1929"></a><span>             </span><span class="hs-special">;</span><span> </span><a href="BuildTyCl.html#buildDataCon"><span class="hs-identifier hs-var">buildDataCon</span></a><span> </span><a href="#local-6989586621680456443"><span class="hs-identifier hs-var">fam_envs</span></a><span> </span><a href="#local-6989586621680456445"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621680456446"><span class="hs-identifier hs-var">is_infix</span></a><span>
</span><a name="line-1930"></a><span>                            </span><a href="#local-6989586621680456447"><span class="hs-identifier hs-var">rep_nm</span></a><span>
</span><a name="line-1931"></a><span>                            </span><a href="#local-6989586621680456421"><span class="hs-identifier hs-var">stricts</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><a href="#local-6989586621680456420"><span class="hs-identifier hs-var">field_lbls</span></a><span>
</span><a name="line-1932"></a><span>                            </span><a href="#local-6989586621680456431"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><a href="#local-6989586621680456432"><span class="hs-identifier hs-var">ex_tvs</span></a><span> </span><a href="#local-6989586621680456439"><span class="hs-identifier hs-var">all_user_bndrs</span></a><span> </span><a href="#local-6989586621680456435"><span class="hs-identifier hs-var">eq_preds</span></a><span>
</span><a name="line-1933"></a><span>                            </span><a href="#local-6989586621680456440"><span class="hs-identifier hs-var">ctxt'</span></a><span> </span><a href="#local-6989586621680456441"><span class="hs-identifier hs-var">arg_tys'</span></a><span> </span><a href="#local-6989586621680456442"><span class="hs-identifier hs-var">res_ty'</span></a><span> </span><a href="#local-6989586621680456396"><span class="hs-identifier hs-var">rep_tycon</span></a><span> </span><a href="#local-6989586621680456397"><span class="hs-identifier hs-var">tag_map</span></a><span>
</span><a name="line-1934"></a><span>                  </span><span class="hs-comment">-- NB:  we put data_tc, the type constructor gotten from the</span><span>
</span><a name="line-1935"></a><span>                  </span><span class="hs-comment">--      constructor type signature into the data constructor;</span><span>
</span><a name="line-1936"></a><span>                  </span><span class="hs-comment">--      that way checkValidDataCon can complain if it's wrong.</span><span>
</span><a name="line-1937"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-1938"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConDecl 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span class="hs-special">)</span><span>
</span><a name="line-1939"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="#local-6989586621680456444"><span class="hs-identifier hs-var">buildOneDataCon</span></a><span> </span><a href="#local-6989586621680456400"><span class="hs-identifier hs-var">names</span></a><span>
</span><a name="line-1940"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-1941"></a><span>
</span><a name="line-1942"></a><span class="hs-comment">-- | Produce the telescope of kind variables that this datacon is</span><span>
</span><a name="line-1943"></a><span class="hs-comment">-- implicitly quantified over. Incoming type need not be zonked.</span><span>
</span><a name="line-1944"></a><span class="hs-identifier">quantifyConDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcTyCoVarSet"><span class="hs-identifier hs-type">TcTyCoVarSet</span></a><span>  </span><span class="hs-comment">-- outer tvs, not to be quantified over; zonked</span><span>
</span><a name="line-1945"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><a href="Var.html#TcTyVar"><span class="hs-identifier hs-type">TcTyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1946"></a><a name="quantifyConDecl"><a href="TcTyClsDecls.html#quantifyConDecl"><span class="hs-identifier">quantifyConDecl</span></a></a><span> </span><a name="local-6989586621680456448"><a href="#local-6989586621680456448"><span class="hs-identifier">gbl_tvs</span></a></a><span> </span><a name="local-6989586621680456449"><a href="#local-6989586621680456449"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1947"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456450"><a href="#local-6989586621680456450"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcMType.html#zonkTcTypeInKnot"><span class="hs-identifier hs-var">zonkTcTypeInKnot</span></a><span> </span><a href="#local-6989586621680456449"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1948"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456451"><a href="#local-6989586621680456451"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#candidateQTyVarsOfType"><span class="hs-identifier hs-var">candidateQTyVarsOfType</span></a><span> </span><a href="#local-6989586621680456450"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1949"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#quantifyTyVars"><span class="hs-identifier hs-var">quantifyTyVars</span></a><span> </span><a href="#local-6989586621680456448"><span class="hs-identifier hs-var">gbl_tvs</span></a><span> </span><a href="#local-6989586621680456451"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1950"></a><span>
</span><a name="line-1951"></a><span class="hs-identifier">tcConIsInfixH98</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1952"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#HsConDetails"><span class="hs-identifier hs-type">HsConDetails</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#Located"><span class="hs-identifier hs-type">Located</span></a><span> </span><span class="hs-special">[</span><a href="HsTypes.html#LConDeclField"><span class="hs-identifier hs-type">LConDeclField</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1953"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1954"></a><a name="tcConIsInfixH98"><a href="TcTyClsDecls.html#tcConIsInfixH98"><span class="hs-identifier">tcConIsInfixH98</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621680456452"><a href="#local-6989586621680456452"><span class="hs-identifier">details</span></a></a><span>
</span><a name="line-1955"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456452"><span class="hs-identifier hs-var">details</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1956"></a><span>           </span><a href="HsTypes.html#InfixCon"><span class="hs-identifier hs-var">InfixCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1957"></a><span>           </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1958"></a><span>
</span><a name="line-1959"></a><span class="hs-identifier">tcConIsInfixGADT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1960"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsTypes.html#HsConDetails"><span class="hs-identifier hs-type">HsConDetails</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#Located"><span class="hs-identifier hs-type">Located</span></a><span> </span><span class="hs-special">[</span><a href="HsTypes.html#LConDeclField"><span class="hs-identifier hs-type">LConDeclField</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1961"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1962"></a><a name="tcConIsInfixGADT"><a href="TcTyClsDecls.html#tcConIsInfixGADT"><span class="hs-identifier">tcConIsInfixGADT</span></a></a><span> </span><a name="local-6989586621680456453"><a href="#local-6989586621680456453"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621680456454"><a href="#local-6989586621680456454"><span class="hs-identifier">details</span></a></a><span>
</span><a name="line-1963"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456454"><span class="hs-identifier hs-var">details</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1964"></a><span>           </span><a href="HsTypes.html#InfixCon"><span class="hs-identifier hs-var">InfixCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1965"></a><span>           </span><a href="HsTypes.html#RecCon"><span class="hs-identifier hs-var">RecCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1966"></a><span>           </span><a href="HsTypes.html#PrefixCon"><span class="hs-identifier hs-var">PrefixCon</span></a><span> </span><a name="local-6989586621680456455"><a href="#local-6989586621680456455"><span class="hs-identifier">arg_tys</span></a></a><span>           </span><span class="hs-comment">-- See Note [Infix GADT constructors]</span><span>
</span><a name="line-1967"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="OccName.html#isSymOcc"><span class="hs-identifier hs-var">isSymOcc</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a><span> </span><a href="#local-6989586621680456453"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1968"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621680456456"><a href="#local-6989586621680456456"><span class="hs-identifier">_ty1</span></a></a><span class="hs-special">,</span><a name="local-6989586621680456457"><a href="#local-6989586621680456457"><span class="hs-identifier">_ty2</span></a></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621680456455"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-1969"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456458"><a href="#local-6989586621680456458"><span class="hs-identifier">fix_env</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#getFixityEnv"><span class="hs-identifier hs-var">getFixityEnv</span></a><span>
</span><a name="line-1970"></a><span>                        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456453"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><a href="NameEnv.html#elemNameEnv"><span class="hs-identifier hs-var">elemNameEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456458"><span class="hs-identifier hs-var">fix_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1971"></a><span>               </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1972"></a><span>
</span><a name="line-1973"></a><span class="hs-identifier">tcConArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#HsConDeclDetails"><span class="hs-identifier hs-type">HsConDeclDetails</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span>
</span><a name="line-1974"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">,</span><span> </span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-type">HsSrcBang</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1975"></a><a name="tcConArgs"><a href="TcTyClsDecls.html#tcConArgs"><span class="hs-identifier">tcConArgs</span></a></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#PrefixCon"><span class="hs-identifier hs-var">PrefixCon</span></a><span> </span><a name="local-6989586621680456459"><a href="#local-6989586621680456459"><span class="hs-identifier">btys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1976"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcTyClsDecls.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><a href="#local-6989586621680456459"><span class="hs-identifier hs-var">btys</span></a><span>
</span><a name="line-1977"></a><span class="hs-identifier">tcConArgs</span><span> </span><span class="hs-special">(</span><a href="HsTypes.html#InfixCon"><span class="hs-identifier hs-var">InfixCon</span></a><span> </span><a name="local-6989586621680456460"><a href="#local-6989586621680456460"><span class="hs-identifier">bty1</span></a></a><span> </span><a name="local-6989586621680456461"><a href="#local-6989586621680456461"><span class="hs-identifier">bty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1978"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456462"><a href="#local-6989586621680456462"><span class="hs-identifier">bty1'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><a href="#local-6989586621680456460"><span class="hs-identifier hs-var">bty1</span></a><span>
</span><a name="line-1979"></a><span>       </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456463"><a href="#local-6989586621680456463"><span class="hs-identifier">bty2'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcTyClsDecls.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><a href="#local-6989586621680456461"><span class="hs-identifier hs-var">bty2</span></a><span>
</span><a name="line-1980"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456462"><span class="hs-identifier hs-var">bty1'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456463"><span class="hs-identifier hs-var">bty2'</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1981"></a><span class="hs-identifier">tcConArgs</span><span> </span><span class="hs-special">(</span><a href="HsTypes.html#RecCon"><span class="hs-identifier hs-var">RecCon</span></a><span> </span><a name="local-6989586621680456464"><a href="#local-6989586621680456464"><span class="hs-identifier">fields</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1982"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a><span> </span><a href="TcTyClsDecls.html#tcConArg"><span class="hs-identifier hs-var">tcConArg</span></a><span> </span><a href="#local-6989586621680456468"><span class="hs-identifier hs-var">btys</span></a><span>
</span><a name="line-1983"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1984"></a><span>    </span><span class="hs-comment">-- We need a one-to-one mapping from field_names to btys</span><span>
</span><a name="line-1985"></a><span>    </span><a name="local-6989586621680456465"><a href="#local-6989586621680456465"><span class="hs-identifier">combined</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456469"><a href="#local-6989586621680456469"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">cd_fld_names</span><span> </span><a href="#local-6989586621680456469"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span class="hs-identifier">cd_fld_type</span><span> </span><a href="#local-6989586621680456469"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><a href="#local-6989586621680456464"><span class="hs-identifier hs-var">fields</span></a><span class="hs-special">)</span><span>
</span><a name="line-1986"></a><span>    </span><a name="local-6989586621680456466"><a href="#local-6989586621680456466"><span class="hs-identifier">explode</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456470"><a href="#local-6989586621680456470"><span class="hs-identifier">ns</span></a></a><span class="hs-special">,</span><a name="local-6989586621680456471"><a href="#local-6989586621680456471"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621680456470"><span class="hs-identifier hs-var">ns</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="#local-6989586621680456471"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1987"></a><span>    </span><a name="local-6989586621680456467"><a href="#local-6989586621680456467"><span class="hs-identifier">exploded</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="#local-6989586621680456466"><span class="hs-identifier hs-var">explode</span></a><span> </span><a href="#local-6989586621680456465"><span class="hs-identifier hs-var">combined</span></a><span>
</span><a name="line-1988"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680456468"><a href="#local-6989586621680456468"><span class="hs-identifier">btys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="#local-6989586621680456467"><span class="hs-identifier hs-var">exploded</span></a><span>
</span><a name="line-1989"></a><span>
</span><a name="line-1990"></a><span>
</span><a name="line-1991"></a><span class="hs-identifier">tcConArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsTypes.html#LHsType"><span class="hs-identifier hs-type">LHsType</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#TcType"><span class="hs-identifier hs-type">TcType</span></a><span class="hs-special">,</span><span> </span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-type">HsSrcBang</span></a><span class="hs-special">)</span><span>
</span><a name="line-1992"></a><a name="tcConArg"><a href="TcTyClsDecls.html#tcConArg"><span class="hs-identifier">tcConArg</span></a></a><span> </span><a name="local-6989586621680456472"><a href="#local-6989586621680456472"><span class="hs-identifier">bty</span></a></a><span>
</span><a name="line-1993"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConArg 1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456472"><span class="hs-identifier hs-var">bty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1994"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456473"><a href="#local-6989586621680456473"><span class="hs-identifier">arg_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcHsType.html#tcHsOpenType"><span class="hs-identifier hs-var">tcHsOpenType</span></a><span> </span><span class="hs-special">(</span><a href="HsTypes.html#getBangType"><span class="hs-identifier hs-var">getBangType</span></a><span> </span><a href="#local-6989586621680456472"><span class="hs-identifier hs-var">bty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1995"></a><span>             </span><span class="hs-comment">-- Newtypes can't have unboxed types, but we check</span><span>
</span><a name="line-1996"></a><span>             </span><span class="hs-comment">-- that in checkValidDataCon; this tcConArg stuff</span><span>
</span><a name="line-1997"></a><span>             </span><span class="hs-comment">-- doesn't happen for GADT-style declarations</span><span>
</span><a name="line-1998"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;tcConArg 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456472"><span class="hs-identifier hs-var">bty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1999"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456473"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">,</span><span> </span><a href="HsTypes.html#getBangStrictness"><span class="hs-identifier hs-var">getBangStrictness</span></a><span> </span><a href="#local-6989586621680456472"><span class="hs-identifier hs-var">bty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2000"></a><span>
</span><a name="line-2001"></a><span class="hs-comment">{-
Note [Infix GADT constructors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We do not currently have syntax to declare an infix constructor in GADT syntax,
but it makes a (small) difference to the Show instance.  So as a slightly
ad-hoc solution, we regard a GADT data constructor as infix if
  a) it is an operator symbol
  b) it has two arguments
  c) there is a fixity declaration for it
For example:
   infix 6 (:--:)
   data T a where
     (:--:) :: t1 -&gt; t2 -&gt; T Int


Note [Checking GADT return types]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
There is a delicacy around checking the return types of a datacon. The
central problem is dealing with a declaration like

  data T a where
    MkT :: T a -&gt; Q a

Note that the return type of MkT is totally bogus. When creating the T
tycon, we also need to create the MkT datacon, which must have a &quot;rejigged&quot;
return type. That is, the MkT datacon's type must be transformed to have
a uniform return type with explicit coercions for GADT-like type parameters.
This rejigging is what rejigConRes does. The problem is, though, that checking
that the return type is appropriate is much easier when done over *Type*,
not *HsType*, and doing a call to tcMatchTy will loop because T isn't fully
defined yet.

So, we want to make rejigConRes lazy and then check the validity of
the return type in checkValidDataCon.  To do this we /always/ return a
6-tuple from rejigConRes (so that we can compute the return type from it, which
checkValidDataCon needs), but the first three fields may be bogus if
the return type isn't valid (the last equation for rejigConRes).

This is better than an earlier solution which reduced the number of
errors reported in one pass.  See Trac #7175, and #10836.
-}</span><span>
</span><a name="line-2042"></a><span>
</span><a name="line-2043"></a><span class="hs-comment">-- Example</span><span>
</span><a name="line-2044"></a><span class="hs-comment">--   data instance T (b,c) where</span><span>
</span><a name="line-2045"></a><span class="hs-comment">--      TI :: forall e. e -&gt; T (e,e)</span><span>
</span><a name="line-2046"></a><span class="hs-comment">--</span><span>
</span><a name="line-2047"></a><span class="hs-comment">-- The representation tycon looks like this:</span><span>
</span><a name="line-2048"></a><span class="hs-comment">--   data :R7T b c where</span><span>
</span><a name="line-2049"></a><span class="hs-comment">--      TI :: forall b1 c1. (b1 ~ c1) =&gt; b1 -&gt; :R7T b1 c1</span><span>
</span><a name="line-2050"></a><span class="hs-comment">-- In this case orig_res_ty = T (e,e)</span><span>
</span><a name="line-2051"></a><span>
</span><a name="line-2052"></a><span class="hs-identifier">rejigConRes</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>    </span><span class="hs-comment">-- Template for result type; e.g.</span><span>
</span><a name="line-2053"></a><span>                                  </span><span class="hs-comment">-- data instance T [a] b c ...</span><span>
</span><a name="line-2054"></a><span>                                  </span><span class="hs-comment">--      gives template ([a,b,c], T [a] b c)</span><span>
</span><a name="line-2055"></a><span>                                  </span><span class="hs-comment">-- Type must be of kind *!</span><span>
</span><a name="line-2056"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- The constructor's user-written, inferred</span><span>
</span><a name="line-2057"></a><span>                                  </span><span class="hs-comment">-- type variables</span><span>
</span><a name="line-2058"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>            </span><span class="hs-comment">-- The constructor's user-written, specified</span><span>
</span><a name="line-2059"></a><span>                                  </span><span class="hs-comment">-- type variables</span><span>
</span><a name="line-2060"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>               </span><span class="hs-comment">-- res_ty type must be of kind *</span><span>
</span><a name="line-2061"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Universal</span><span>
</span><a name="line-2062"></a><span>                </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- Existential (distinct OccNames from univs)</span><span>
</span><a name="line-2063"></a><span>                </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- The constructor's rejigged, user-written,</span><span>
</span><a name="line-2064"></a><span>                                  </span><span class="hs-comment">-- inferred type variables</span><span>
</span><a name="line-2065"></a><span>                </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- The constructor's rejigged, user-written,</span><span>
</span><a name="line-2066"></a><span>                                  </span><span class="hs-comment">-- specified type variables</span><span>
</span><a name="line-2067"></a><span>                </span><span class="hs-special">[</span><a href="DataCon.html#EqSpec"><span class="hs-identifier hs-type">EqSpec</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- Equality predicates</span><span>
</span><a name="line-2068"></a><span>                </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- Substitution to apply to argument types</span><span>
</span><a name="line-2069"></a><span>        </span><span class="hs-comment">-- We don't check that the TyCon given in the ResTy is</span><span>
</span><a name="line-2070"></a><span>        </span><span class="hs-comment">-- the same as the parent tycon, because checkValidDataCon will do it</span><span>
</span><a name="line-2071"></a><span>
</span><a name="line-2072"></a><a name="rejigConRes"><a href="TcTyClsDecls.html#rejigConRes"><span class="hs-identifier">rejigConRes</span></a></a><span> </span><a name="local-6989586621680456474"><a href="#local-6989586621680456474"><span class="hs-identifier">tmpl_bndrs</span></a></a><span> </span><a name="local-6989586621680456475"><a href="#local-6989586621680456475"><span class="hs-identifier">res_tmpl</span></a></a><span> </span><a name="local-6989586621680456476"><a href="#local-6989586621680456476"><span class="hs-identifier">dc_inferred_tvs</span></a></a><span> </span><a name="local-6989586621680456477"><a href="#local-6989586621680456477"><span class="hs-identifier">dc_specified_tvs</span></a></a><span> </span><a name="local-6989586621680456478"><a href="#local-6989586621680456478"><span class="hs-identifier">res_ty</span></a></a><span>
</span><a name="line-2073"></a><span>        </span><span class="hs-comment">-- E.g.  data T [a] b c where</span><span>
</span><a name="line-2074"></a><span>        </span><span class="hs-comment">--         MkT :: forall x y z. T [(x,y)] z z</span><span>
</span><a name="line-2075"></a><span>        </span><span class="hs-comment">-- The {a,b,c} are the tmpl_tvs, and the {x,y,z} are the dc_tvs</span><span>
</span><a name="line-2076"></a><span>        </span><span class="hs-comment">--     (NB: unlike the H98 case, the dc_tvs are not all existential)</span><span>
</span><a name="line-2077"></a><span>        </span><span class="hs-comment">-- Then we generate</span><span>
</span><a name="line-2078"></a><span>        </span><span class="hs-comment">--      Univ tyvars     Eq-spec</span><span>
</span><a name="line-2079"></a><span>        </span><span class="hs-comment">--          a              a~(x,y)</span><span>
</span><a name="line-2080"></a><span>        </span><span class="hs-comment">--          b              b~z</span><span>
</span><a name="line-2081"></a><span>        </span><span class="hs-comment">--          z</span><span>
</span><a name="line-2082"></a><span>        </span><span class="hs-comment">-- Existentials are the leftover type vars: [x,y]</span><span>
</span><a name="line-2083"></a><span>        </span><span class="hs-comment">-- The user-written type variables are what is listed in the forall:</span><span>
</span><a name="line-2084"></a><span>        </span><span class="hs-comment">--   [x, y, z] (all specified). We must rejig these as well.</span><span>
</span><a name="line-2085"></a><span>        </span><span class="hs-comment">--   See Note [DataCon user type variable binders] in DataCon.</span><span>
</span><a name="line-2086"></a><span>        </span><span class="hs-comment">-- So we return ( [a,b,z], [x,y]</span><span>
</span><a name="line-2087"></a><span>        </span><span class="hs-comment">--              , [], [x,y,z]</span><span>
</span><a name="line-2088"></a><span>        </span><span class="hs-comment">--              , [a~(x,y),b~z], &lt;arg-subst&gt; )</span><span>
</span><a name="line-2089"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456481"><a href="#local-6989586621680456481"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isLiftedTypeKind</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isLiftedTypeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><span class="hs-identifier">res_ty</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2090"></a><span>                  </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isLiftedTypeKind</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#isLiftedTypeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><span class="hs-identifier">res_tmpl</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-2091"></a><span>                  </span><a href="Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a><span> </span><a href="#local-6989586621680456475"><span class="hs-identifier hs-var">res_tmpl</span></a><span> </span><a href="#local-6989586621680456478"><span class="hs-identifier hs-var">res_ty</span></a><span>
</span><a name="line-2092"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456482"><a href="#local-6989586621680456482"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456483"><a href="#local-6989586621680456483"><span class="hs-identifier">raw_eqs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456484"><a href="#local-6989586621680456484"><span class="hs-identifier">kind_subst</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#mkGADTVars"><span class="hs-identifier hs-var">mkGADTVars</span></a><span> </span><a href="#local-6989586621680456480"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span> </span><a href="#local-6989586621680456479"><span class="hs-identifier hs-var">dc_tvs</span></a><span> </span><a href="#local-6989586621680456481"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-2093"></a><span>        </span><a name="local-6989586621680456485"><a href="#local-6989586621680456485"><span class="hs-identifier">raw_ex_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456479"><span class="hs-identifier hs-var">dc_tvs</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#minusList"><span class="hs-identifier hs-var">minusList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456482"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-2094"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680456486"><a href="#local-6989586621680456486"><span class="hs-identifier">arg_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456487"><a href="#local-6989586621680456487"><span class="hs-identifier">substed_ex_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2095"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-6989586621680456484"><span class="hs-identifier hs-var">kind_subst</span></a><span> </span><a href="#local-6989586621680456485"><span class="hs-identifier hs-var">raw_ex_tvs</span></a><span>
</span><a name="line-2096"></a><span>
</span><a name="line-2097"></a><span>        </span><span class="hs-comment">-- After rejigging the existential tyvars, the resulting substitution</span><span>
</span><a name="line-2098"></a><span>        </span><span class="hs-comment">-- gives us exactly what we need to rejig the user-written tyvars,</span><span>
</span><a name="line-2099"></a><span>        </span><span class="hs-comment">-- since the dcUserTyVarBinders invariant guarantees that the</span><span>
</span><a name="line-2100"></a><span>        </span><span class="hs-comment">-- substitution has *all* the tyvars in its domain.</span><span>
</span><a name="line-2101"></a><span>        </span><span class="hs-comment">-- See Note [DataCon user type variable binders] in DataCon.</span><span>
</span><a name="line-2102"></a><span>        </span><a name="local-6989586621680456488"><a href="#local-6989586621680456488"><span class="hs-identifier">subst_user_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#getTyVar"><span class="hs-identifier hs-var">getTyVar</span></a><span> </span><span class="hs-string">&quot;rejigConRes&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="TyCoRep.html#substTyVar"><span class="hs-identifier hs-var">substTyVar</span></a><span> </span><a href="#local-6989586621680456486"><span class="hs-identifier hs-var">arg_subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-2103"></a><span>        </span><a name="local-6989586621680456489"><a href="#local-6989586621680456489"><span class="hs-identifier">substed_inferred_tvs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456488"><span class="hs-identifier hs-var">subst_user_tvs</span></a><span> </span><a href="#local-6989586621680456476"><span class="hs-identifier hs-var">dc_inferred_tvs</span></a><span>
</span><a name="line-2104"></a><span>        </span><a name="local-6989586621680456490"><a href="#local-6989586621680456490"><span class="hs-identifier">substed_specified_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456488"><span class="hs-identifier hs-var">subst_user_tvs</span></a><span> </span><a href="#local-6989586621680456477"><span class="hs-identifier hs-var">dc_specified_tvs</span></a><span>
</span><a name="line-2105"></a><span>
</span><a name="line-2106"></a><span>        </span><a name="local-6989586621680456491"><a href="#local-6989586621680456491"><span class="hs-identifier">substed_eqs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#substEqSpec"><span class="hs-identifier hs-var">substEqSpec</span></a><span> </span><a href="#local-6989586621680456486"><span class="hs-identifier hs-var">arg_subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456483"><span class="hs-identifier hs-var">raw_eqs</span></a><span>
</span><a name="line-2107"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-2108"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621680456482"><span class="hs-identifier hs-var">univ_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456487"><span class="hs-identifier hs-var">substed_ex_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456489"><span class="hs-identifier hs-var">substed_inferred_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456490"><span class="hs-identifier hs-var">substed_specified_tvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2109"></a><span>     </span><a href="#local-6989586621680456491"><span class="hs-identifier hs-var">substed_eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456486"><span class="hs-identifier hs-var">arg_subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-2110"></a><span>
</span><a name="line-2111"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2112"></a><span>        </span><span class="hs-comment">-- If the return type of the data constructor doesn't match the parent</span><span>
</span><a name="line-2113"></a><span>        </span><span class="hs-comment">-- type constructor, or the arity is wrong, the tcMatchTy will fail</span><span>
</span><a name="line-2114"></a><span>        </span><span class="hs-comment">--    e.g   data T a b where</span><span>
</span><a name="line-2115"></a><span>        </span><span class="hs-comment">--            T1 :: Maybe a   -- Wrong tycon</span><span>
</span><a name="line-2116"></a><span>        </span><span class="hs-comment">--            T2 :: T [a]     -- Wrong arity</span><span>
</span><a name="line-2117"></a><span>        </span><span class="hs-comment">-- We are detect that later, in checkValidDataCon, but meanwhile</span><span>
</span><a name="line-2118"></a><span>        </span><span class="hs-comment">-- we must do *something*, not just crash.  So we do something simple</span><span>
</span><a name="line-2119"></a><span>        </span><span class="hs-comment">-- albeit bogus, relying on checkValidDataCon to check the</span><span>
</span><a name="line-2120"></a><span>        </span><span class="hs-comment">--  bad-result-type error before seeing that the other fields look odd</span><span>
</span><a name="line-2121"></a><span>        </span><span class="hs-comment">-- See Note [Checking GADT return types]</span><span>
</span><a name="line-2122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456480"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456479"><span class="hs-identifier hs-var">dc_tvs</span></a><span> </span><span class="hs-special">`</span><a href="ListSetOps.html#minusList"><span class="hs-identifier hs-var">minusList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456480"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456476"><span class="hs-identifier hs-var">dc_inferred_tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456477"><span class="hs-identifier hs-var">dc_specified_tvs</span></a><span class="hs-special">,</span><span>
</span><a name="line-2123"></a><span>     </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#emptyTCvSubst"><span class="hs-identifier hs-var">emptyTCvSubst</span></a><span class="hs-special">)</span><span>
</span><a name="line-2124"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2125"></a><span>    </span><a name="local-6989586621680456479"><a href="#local-6989586621680456479"><span class="hs-identifier">dc_tvs</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456476"><span class="hs-identifier hs-var">dc_inferred_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456477"><span class="hs-identifier hs-var">dc_specified_tvs</span></a><span>
</span><a name="line-2126"></a><span>    </span><a name="local-6989586621680456480"><a href="#local-6989586621680456480"><span class="hs-identifier">tmpl_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#binderVars"><span class="hs-identifier hs-var">binderVars</span></a><span> </span><a href="#local-6989586621680456474"><span class="hs-identifier hs-var">tmpl_bndrs</span></a><span>
</span><a name="line-2127"></a><span>
</span><a name="line-2128"></a><span class="hs-comment">{- Note [mkGADTVars]
~~~~~~~~~~~~~~~~~~~~
Running example:

data T (k1 :: *) (k2 :: *) (a :: k2) (b :: k2) where
  MkT :: forall (x1 : *) (y :: x1) (z :: *).
         T x1 * (Proxy (y :: x1), z) z

We need the rejigged type to be

  MkT :: forall (x1 :: *) (k2 :: *) (a :: k2) (b :: k2).
         forall (y :: x1) (z :: *).
         (k2 ~ *, a ~ (Proxy x1 y, z), b ~ z)
      =&gt; T x1 k2 a b

You might naively expect that z should become a universal tyvar,
not an existential. (After all, x1 becomes a universal tyvar.)
But z has kind * while b has kind k2, so the return type
   T x1 k2 a z
is ill-kinded.  Another way to say it is this: the universal
tyvars must have exactly the same kinds as the tyConTyVars.

So we need an existential tyvar and a heterogeneous equality
constraint. (The b ~ z is a bit redundant with the k2 ~ * that
comes before in that b ~ z implies k2 ~ *. I'm sure we could do
some analysis that could eliminate k2 ~ *. But we don't do this
yet.)

The data con signature has already been fully kind-checked.
The return type

  T x1 * (Proxy (y :: x1), z) z
becomes
  qtkvs    = [x1 :: *, y :: x1, z :: *]
  res_tmpl = T x1 * (Proxy x1 y, z) z

We start off by matching (T k1 k2 a b) with (T x1 * (Proxy x1 y, z) z). We
know this match will succeed because of the validity check (actually done
later, but laziness saves us -- see Note [Checking GADT return types]).
Thus, we get

  subst := { k1 |-&gt; x1, k2 |-&gt; *, a |-&gt; (Proxy x1 y, z), b |-&gt; z }

Now, we need to figure out what the GADT equalities should be. In this case,
we *don't* want (k1 ~ x1) to be a GADT equality: it should just be a
renaming. The others should be GADT equalities. We also need to make
sure that the universally-quantified variables of the datacon match up
with the tyvars of the tycon, as required for Core context well-formedness.
(This last bit is why we have to rejig at all!)

`choose` walks down the tycon tyvars, figuring out what to do with each one.
It carries two substitutions:
  - t_sub's domain is *template* or *tycon* tyvars, mapping them to variables
    mentioned in the datacon signature.
  - r_sub's domain is *result* tyvars, names written by the programmer in
    the datacon signature. The final rejigged type will use these names, but
    the subst is still needed because sometimes the printed name of these variables
    is different. (See choose_tv_name, below.)

Before explaining the details of `choose`, let's just look at its operation
on our example:

  choose [] [] {} {} [k1, k2, a, b]
  --&gt;          -- first branch of `case` statement
  choose
    univs:    [x1 :: *]
    eq_spec:  []
    t_sub:    {k1 |-&gt; x1}
    r_sub:    {x1 |-&gt; x1}
    t_tvs:    [k2, a, b]
  --&gt;          -- second branch of `case` statement
  choose
    univs:    [k2 :: *, x1 :: *]
    eq_spec:  [k2 ~ *]
    t_sub:    {k1 |-&gt; x1, k2 |-&gt; k2}
    r_sub:    {x1 |-&gt; x1}
    t_tvs:    [a, b]
  --&gt;          -- second branch of `case` statement
  choose
    univs:    [a :: k2, k2 :: *, x1 :: *]
    eq_spec:  [ a ~ (Proxy x1 y, z)
              , k2 ~ * ]
    t_sub:    {k1 |-&gt; x1, k2 |-&gt; k2, a |-&gt; a}
    r_sub:    {x1 |-&gt; x1}
    t_tvs:    [b]
  --&gt;          -- second branch of `case` statement
  choose
    univs:    [b :: k2, a :: k2, k2 :: *, x1 :: *]
    eq_spec:  [ b ~ z
              , a ~ (Proxy x1 y, z)
              , k2 ~ * ]
    t_sub:    {k1 |-&gt; x1, k2 |-&gt; k2, a |-&gt; a, b |-&gt; z}
    r_sub:    {x1 |-&gt; x1}
    t_tvs:    []
  --&gt;          -- end of recursion
  ( [x1 :: *, k2 :: *, a :: k2, b :: k2]
  , [k2 ~ *, a ~ (Proxy x1 y, z), b ~ z]
  , {x1 |-&gt; x1} )

`choose` looks up each tycon tyvar in the matching (it *must* be matched!).

* If it finds a bare result tyvar (the first branch of the `case`
  statement), it checks to make sure that the result tyvar isn't yet
  in the list of univ_tvs.  If it is in that list, then we have a
  repeated variable in the return type, and we in fact need a GADT
  equality.

* It then checks to make sure that the kind of the result tyvar
  matches the kind of the template tyvar. This check is what forces
  `z` to be existential, as it should be, explained above.

* Assuming no repeated variables or kind-changing, we wish to use the
  variable name given in the datacon signature (that is, `x1` not
  `k1`), not the tycon signature (which may have been made up by
  GHC). So, we add a mapping from the tycon tyvar to the result tyvar
  to t_sub.

* If we discover that a mapping in `subst` gives us a non-tyvar (the
  second branch of the `case` statement), then we have a GADT equality
  to create.  We create a fresh equality, but we don't extend any
  substitutions. The template variable substitution is meant for use
  in universal tyvar kinds, and these shouldn't be affected by any
  GADT equalities.

This whole algorithm is quite delicate, indeed. I (Richard E.) see two ways
of simplifying it:

1) The first branch of the `case` statement is really an optimization, used
in order to get fewer GADT equalities. It might be possible to make a GADT
equality for *every* univ. tyvar, even if the equality is trivial, and then
either deal with the bigger type or somehow reduce it later.

2) This algorithm strives to use the names for type variables as specified
by the user in the datacon signature. If we always used the tycon tyvar
names, for example, this would be simplified. This change would almost
certainly degrade error messages a bit, though.
-}</span><span>
</span><a name="line-2265"></a><span>
</span><a name="line-2266"></a><span class="hs-comment">-- ^ From information about a source datacon definition, extract out</span><span>
</span><a name="line-2267"></a><span class="hs-comment">-- what the universal variables and the GADT equalities should be.</span><span>
</span><a name="line-2268"></a><span class="hs-comment">-- See Note [mkGADTVars].</span><span>
</span><a name="line-2269"></a><span class="hs-identifier">mkGADTVars</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ The tycon vars</span><span>
</span><a name="line-2270"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- ^ The datacon vars</span><span>
</span><a name="line-2271"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>   </span><span class="hs-comment">-- ^ The matching between the template result type</span><span>
</span><a name="line-2272"></a><span>                         </span><span class="hs-comment">-- and the actual result type</span><span>
</span><a name="line-2273"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-2274"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="DataCon.html#EqSpec"><span class="hs-identifier hs-type">EqSpec</span></a><span class="hs-special">]</span><span>
</span><a name="line-2275"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The univ. variables, the GADT equalities,</span><span>
</span><a name="line-2276"></a><span>                           </span><span class="hs-comment">-- and a subst to apply to the GADT equalities</span><span>
</span><a name="line-2277"></a><span>                           </span><span class="hs-comment">-- and existentials.</span><span>
</span><a name="line-2278"></a><a name="mkGADTVars"><a href="TcTyClsDecls.html#mkGADTVars"><span class="hs-identifier">mkGADTVars</span></a></a><span> </span><a name="local-6989586621680456492"><a href="#local-6989586621680456492"><span class="hs-identifier">tmpl_tvs</span></a></a><span> </span><a name="local-6989586621680456493"><a href="#local-6989586621680456493"><span class="hs-identifier">dc_tvs</span></a></a><span> </span><a name="local-6989586621680456494"><a href="#local-6989586621680456494"><span class="hs-identifier">subst</span></a></a><span>
</span><a name="line-2279"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456497"><span class="hs-identifier hs-var">choose</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621680456496"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621680456496"><span class="hs-identifier hs-var">empty_subst</span></a><span> </span><a href="#local-6989586621680456492"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span>
</span><a name="line-2280"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2281"></a><span>    </span><a name="local-6989586621680456495"><a href="#local-6989586621680456495"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621680456492"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621680456493"><span class="hs-identifier hs-var">dc_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2282"></a><span>               </span><span class="hs-special">`</span><a href="VarEnv.html#unionInScope"><span class="hs-identifier hs-var">unionInScope</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#getTCvInScope"><span class="hs-identifier hs-var">getTCvInScope</span></a><span> </span><a href="#local-6989586621680456494"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-2283"></a><span>    </span><a name="local-6989586621680456496"><a href="#local-6989586621680456496"><span class="hs-identifier">empty_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkEmptyTCvSubst"><span class="hs-identifier hs-var">mkEmptyTCvSubst</span></a><span> </span><a href="#local-6989586621680456495"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-2284"></a><span>
</span><a name="line-2285"></a><span>    </span><span class="hs-identifier">choose</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- accumulator of univ tvs, reversed</span><span>
</span><a name="line-2286"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DataCon.html#EqSpec"><span class="hs-identifier hs-type">EqSpec</span></a><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- accumulator of GADT equalities, reversed</span><span>
</span><a name="line-2287"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>          </span><span class="hs-comment">-- template substitution</span><span>
</span><a name="line-2288"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>          </span><span class="hs-comment">-- res. substitution</span><span>
</span><a name="line-2289"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- template tvs (the univ tvs passed in)</span><span>
</span><a name="line-2290"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- the univ_tvs</span><span>
</span><a name="line-2291"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="DataCon.html#EqSpec"><span class="hs-identifier hs-type">EqSpec</span></a><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- GADT equalities</span><span>
</span><a name="line-2292"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span> </span><span class="hs-special">)</span><span>       </span><span class="hs-comment">-- a substitution to fix kinds in ex_tvs</span><span>
</span><a name="line-2293"></a><span>
</span><a name="line-2294"></a><span>    </span><a name="local-6989586621680456497"><a href="#local-6989586621680456497"><span class="hs-identifier">choose</span></a></a><span> </span><a name="local-6989586621680456499"><a href="#local-6989586621680456499"><span class="hs-identifier">univs</span></a></a><span> </span><a name="local-6989586621680456500"><a href="#local-6989586621680456500"><span class="hs-identifier">eqs</span></a></a><span> </span><a name="local-6989586621680456501"><a href="#local-6989586621680456501"><span class="hs-identifier">_t_sub</span></a></a><span> </span><a name="local-6989586621680456502"><a href="#local-6989586621680456502"><span class="hs-identifier">r_sub</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2295"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-6989586621680456499"><span class="hs-identifier hs-var">univs</span></a><span class="hs-special">,</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-6989586621680456500"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456502"><span class="hs-identifier hs-var">r_sub</span></a><span class="hs-special">)</span><span>
</span><a name="line-2296"></a><span>    </span><span class="hs-identifier">choose</span><span> </span><a name="local-6989586621680456503"><a href="#local-6989586621680456503"><span class="hs-identifier">univs</span></a></a><span> </span><a name="local-6989586621680456504"><a href="#local-6989586621680456504"><span class="hs-identifier">eqs</span></a></a><span> </span><a name="local-6989586621680456505"><a href="#local-6989586621680456505"><span class="hs-identifier">t_sub</span></a></a><span> </span><a name="local-6989586621680456506"><a href="#local-6989586621680456506"><span class="hs-identifier">r_sub</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456507"><a href="#local-6989586621680456507"><span class="hs-identifier">t_tv</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680456508"><a href="#local-6989586621680456508"><span class="hs-identifier">t_tvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2297"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456509"><a href="#local-6989586621680456509"><span class="hs-identifier">r_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCoRep.html#lookupTyVar"><span class="hs-identifier hs-var">lookupTyVar</span></a><span> </span><a href="#local-6989586621680456494"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span>
</span><a name="line-2298"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Type.html#getTyVar_maybe"><span class="hs-identifier hs-var">getTyVar_maybe</span></a><span> </span><a href="#local-6989586621680456509"><span class="hs-identifier hs-var">r_ty</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2299"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456510"><a href="#local-6989586621680456510"><span class="hs-identifier">r_tv</span></a></a><span>
</span><a name="line-2300"></a><span>            </span><span class="hs-glyph">|</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456503"><span class="hs-identifier hs-var">univs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2301"></a><span>            </span><span class="hs-special">,</span><span>  </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680456505"><span class="hs-identifier hs-var">t_sub</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2302"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- simple, well-kinded variable substitution.</span><span>
</span><a name="line-2303"></a><span>               </span><a href="#local-6989586621680456497"><span class="hs-identifier hs-var">choose</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680456503"><span class="hs-identifier hs-var">univs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456504"><span class="hs-identifier hs-var">eqs</span></a><span>
</span><a name="line-2304"></a><span>                      </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621680456505"><span class="hs-identifier hs-var">t_sub</span></a><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span> </span><a href="#local-6989586621680456512"><span class="hs-identifier hs-var">r_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2305"></a><span>                      </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621680456506"><span class="hs-identifier hs-var">r_sub</span></a><span> </span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span> </span><a href="#local-6989586621680456512"><span class="hs-identifier hs-var">r_ty'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2306"></a><span>                      </span><a href="#local-6989586621680456508"><span class="hs-identifier hs-var">t_tvs</span></a><span>
</span><a name="line-2307"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2308"></a><span>              </span><a name="local-6989586621680456511"><a href="#local-6989586621680456511"><span class="hs-identifier">r_tv1</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setTyVarName"><span class="hs-identifier hs-var">setTyVarName</span></a><span> </span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456498"><span class="hs-identifier hs-var">choose_tv_name</span></a><span> </span><a href="#local-6989586621680456510"><span class="hs-identifier hs-var">r_tv</span></a><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-2309"></a><span>              </span><a name="local-6989586621680456512"><a href="#local-6989586621680456512"><span class="hs-identifier">r_ty'</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621680456511"><span class="hs-identifier hs-var">r_tv1</span></a><span>
</span><a name="line-2310"></a><span>
</span><a name="line-2311"></a><span>               </span><span class="hs-comment">-- Not a simple substitution: make an equality predicate</span><span>
</span><a name="line-2312"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680456497"><span class="hs-identifier hs-var">choose</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456513"><span class="hs-identifier hs-var">t_tv'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680456503"><span class="hs-identifier hs-var">univs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#mkEqSpec"><span class="hs-identifier hs-var">mkEqSpec</span></a><span> </span><a href="#local-6989586621680456513"><span class="hs-identifier hs-var">t_tv'</span></a><span> </span><a href="#local-6989586621680456509"><span class="hs-identifier hs-var">r_ty</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621680456504"><span class="hs-identifier hs-var">eqs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2313"></a><span>                      </span><span class="hs-special">(</span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621680456505"><span class="hs-identifier hs-var">t_sub</span></a><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621680456513"><span class="hs-identifier hs-var">t_tv'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2314"></a><span>                         </span><span class="hs-comment">-- We've updated the kind of t_tv,</span><span>
</span><a name="line-2315"></a><span>                         </span><span class="hs-comment">-- so add it to t_sub (Trac #14162)</span><span>
</span><a name="line-2316"></a><span>                      </span><a href="#local-6989586621680456506"><span class="hs-identifier hs-var">r_sub</span></a><span> </span><a href="#local-6989586621680456508"><span class="hs-identifier hs-var">t_tvs</span></a><span>
</span><a name="line-2317"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2318"></a><span>              </span><a name="local-6989586621680456513"><a href="#local-6989586621680456513"><span class="hs-identifier">t_tv'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#updateTyVarKind"><span class="hs-identifier hs-var">updateTyVarKind</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621680456505"><span class="hs-identifier hs-var">t_sub</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456507"><span class="hs-identifier hs-var">t_tv</span></a><span>
</span><a name="line-2319"></a><span>
</span><a name="line-2320"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2321"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;mkGADTVars&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456492"><span class="hs-identifier hs-var">tmpl_tvs</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456494"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-2322"></a><span>
</span><a name="line-2323"></a><span>      </span><span class="hs-comment">-- choose an appropriate name for a univ tyvar.</span><span>
</span><a name="line-2324"></a><span>      </span><span class="hs-comment">-- This *must* preserve the Unique of the result tv, so that we</span><span>
</span><a name="line-2325"></a><span>      </span><span class="hs-comment">-- can detect repeated variables. It prefers user-specified names</span><span>
</span><a name="line-2326"></a><span>      </span><span class="hs-comment">-- over system names. A result variable with a system name can</span><span>
</span><a name="line-2327"></a><span>      </span><span class="hs-comment">-- happen with GHC-generated implicit kind variables.</span><span>
</span><a name="line-2328"></a><span>    </span><span class="hs-identifier">choose_tv_name</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-2329"></a><span>    </span><a name="local-6989586621680456498"><a href="#local-6989586621680456498"><span class="hs-identifier">choose_tv_name</span></a></a><span> </span><a name="local-6989586621680456514"><a href="#local-6989586621680456514"><span class="hs-identifier">r_tv</span></a></a><span> </span><a name="local-6989586621680456515"><a href="#local-6989586621680456515"><span class="hs-identifier">t_tv</span></a></a><span>
</span><a name="line-2330"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Name.html#isSystemName"><span class="hs-identifier hs-var">isSystemName</span></a><span> </span><a href="#local-6989586621680456516"><span class="hs-identifier hs-var">r_tv_name</span></a><span>
</span><a name="line-2331"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#setNameUnique"><span class="hs-identifier hs-var">setNameUnique</span></a><span> </span><a href="#local-6989586621680456517"><span class="hs-identifier hs-var">t_tv_name</span></a><span> </span><span class="hs-special">(</span><a href="Unique.html#getUnique"><span class="hs-identifier hs-var">getUnique</span></a><span> </span><a href="#local-6989586621680456516"><span class="hs-identifier hs-var">r_tv_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-2332"></a><span>
</span><a name="line-2333"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2334"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456516"><span class="hs-identifier hs-var">r_tv_name</span></a><span>
</span><a name="line-2335"></a><span>
</span><a name="line-2336"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2337"></a><span>        </span><a name="local-6989586621680456516"><a href="#local-6989586621680456516"><span class="hs-identifier">r_tv_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680456514"><span class="hs-identifier hs-var">r_tv</span></a><span>
</span><a name="line-2338"></a><span>        </span><a name="local-6989586621680456517"><a href="#local-6989586621680456517"><span class="hs-identifier">t_tv_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680456515"><span class="hs-identifier hs-var">t_tv</span></a><span>
</span><a name="line-2339"></a><span>
</span><a name="line-2340"></a><span class="hs-comment">{-
Note [Substitution in template variables kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

data G (a :: Maybe k) where
  MkG :: G Nothing

With explicit kind variables

data G k (a :: Maybe k) where
  MkG :: G k1 (Nothing k1)

Note how k1 is distinct from k. So, when we match the template
`G k a` against `G k1 (Nothing k1)`, we get a subst
[ k |-&gt; k1, a |-&gt; Nothing k1 ]. Even though this subst has two
mappings, we surely don't want to add (k, k1) to the list of
GADT equalities -- that would be overly complex and would create
more untouchable variables than we need. So, when figuring out
which tyvars are GADT-like and which aren't (the fundamental
job of `choose`), we want to treat `k` as *not* GADT-like.
Instead, we wish to substitute in `a`'s kind, to get (a :: Maybe k1)
instead of (a :: Maybe k). This is the reason for dealing
with a substitution in here.

However, we do not *always* want to substitute. Consider

data H (a :: k) where
  MkH :: H Int

With explicit kind variables:

data H k (a :: k) where
  MkH :: H * Int

Here, we have a kind-indexed GADT. The subst in question is
[ k |-&gt; *, a |-&gt; Int ]. Now, we *don't* want to substitute in `a`'s
kind, because that would give a constructor with the type

MkH :: forall (k :: *) (a :: *). (k ~ *) -&gt; (a ~ Int) -&gt; H k a

The problem here is that a's kind is wrong -- it needs to be k, not *!
So, if the matching for a variable is anything but another bare variable,
we drop the mapping from the substitution before proceeding. This
was not an issue before kind-indexed GADTs because this case could
never happen.

************************************************************************
*                                                                      *
                Validity checking
*                                                                      *
************************************************************************

Validity checking is done once the mutually-recursive knot has been
tied, so we can look at things freely.
-}</span><span>
</span><a name="line-2395"></a><span>
</span><a name="line-2396"></a><span class="hs-identifier">checkValidTyCl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span>
</span><a name="line-2397"></a><a name="checkValidTyCl"><a href="TcTyClsDecls.html#checkValidTyCl"><span class="hs-identifier">checkValidTyCl</span></a></a><span> </span><a name="local-6989586621680456518"><a href="#local-6989586621680456518"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2398"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2399"></a><span>    </span><a href="TcTyClsDecls.html#addTyConCtxt"><span class="hs-identifier hs-var">addTyConCtxt</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2400"></a><span>    </span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><a href="#local-6989586621680456519"><span class="hs-identifier hs-var">recovery_code</span></a><span>
</span><a name="line-2401"></a><span>             </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Starting validity for tycon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2402"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkValidTyCon"><span class="hs-identifier hs-var">checkValidTyCon</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2403"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Done validity for tycon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2404"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-2405"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2406"></a><span>    </span><a name="local-6989586621680456519"><a href="#local-6989586621680456519"><span class="hs-identifier">recovery_code</span></a></a><span> </span><span class="hs-comment">-- See Note [Recover from validity error]</span><span>
</span><a name="line-2407"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Aborted validity for tycon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2408"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><a href="#local-6989586621680456520"><span class="hs-identifier hs-var">fake_tc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2409"></a><span>    </span><a name="local-6989586621680456520"><a href="#local-6989586621680456520"><span class="hs-identifier">fake_tc</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2410"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#makeRecoveryTyCon"><span class="hs-identifier hs-var">makeRecoveryTyCon</span></a><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2411"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2412"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456518"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2413"></a><span>
</span><a name="line-2414"></a><span class="hs-comment">{- Note [Recover from validity error]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We recover from a validity error in a type or class, which allows us
to report multiple validity errors. In the failure case we return a
TyCon of the right kind, but with no interesting behaviour
(makeRecoveryTyCon). Why?  Suppose we have
   type T a = Fun
where Fun is a type family of arity 1.  The RHS is invalid, but we
want to go on checking validity of subsequent type declarations.
So we replace T with an abstract TyCon which will do no harm.
See indexed-types/should_fail/BadSock and Trac #10896

Painfully, though, we *don't* want to do this for classes.
Consider tcfail041:
   class (?x::Int) =&gt; C a where ...
   instance C Int
The class is invalid because of the superclass constraint.  But
we still want it to look like a /class/, else the instance bleats
that the instance is mal-formed because it hasn't got a class in
the head.
-}</span><span>
</span><a name="line-2435"></a><span>
</span><a name="line-2436"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-2437"></a><span class="hs-comment">-- For data types declared with record syntax, we require</span><span>
</span><a name="line-2438"></a><span class="hs-comment">-- that each constructor that has a field 'f'</span><span>
</span><a name="line-2439"></a><span class="hs-comment">--      (a) has the same result type</span><span>
</span><a name="line-2440"></a><span class="hs-comment">--      (b) has the same type for 'f'</span><span>
</span><a name="line-2441"></a><span class="hs-comment">-- module alpha conversion of the quantified type variables</span><span>
</span><a name="line-2442"></a><span class="hs-comment">-- of the constructor.</span><span>
</span><a name="line-2443"></a><span class="hs-comment">--</span><span>
</span><a name="line-2444"></a><span class="hs-comment">-- Note that we allow existentials to match because the</span><span>
</span><a name="line-2445"></a><span class="hs-comment">-- fields can never meet. E.g</span><span>
</span><a name="line-2446"></a><span class="hs-comment">--      data T where</span><span>
</span><a name="line-2447"></a><span class="hs-comment">--        T1 { f1 :: b, f2 :: a, f3 ::Int } :: T</span><span>
</span><a name="line-2448"></a><span class="hs-comment">--        T2 { f1 :: c, f2 :: c, f3 ::Int } :: T</span><span>
</span><a name="line-2449"></a><span class="hs-comment">-- Here we do not complain about f1,f2 because they are existential</span><span>
</span><a name="line-2450"></a><span>
</span><a name="line-2451"></a><span class="hs-identifier">checkValidTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2452"></a><a name="checkValidTyCon"><a href="TcTyClsDecls.html#checkValidTyCon"><span class="hs-identifier">checkValidTyCon</span></a></a><span> </span><a name="local-6989586621680456521"><a href="#local-6989586621680456521"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-2453"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isPrimTyCon"><span class="hs-identifier hs-var">isPrimTyCon</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>   </span><span class="hs-comment">-- Happens when Haddock'ing GHC.Prim</span><span>
</span><a name="line-2454"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2455"></a><span>
</span><a name="line-2456"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-2457"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidTyCon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2458"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456542"><a href="#local-6989586621680456542"><span class="hs-identifier">cl</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#tyConClass_maybe"><span class="hs-identifier hs-var">tyConClass_maybe</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2459"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyClsDecls.html#checkValidClass"><span class="hs-identifier hs-var">checkValidClass</span></a><span> </span><a href="#local-6989586621680456542"><span class="hs-identifier hs-var">cl</span></a><span>
</span><a name="line-2460"></a><span>
</span><a name="line-2461"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456543"><a href="#local-6989586621680456543"><span class="hs-identifier">syn_rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#synTyConRhs_maybe"><span class="hs-identifier hs-var">synTyConRhs_maybe</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2462"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621680456522"><span class="hs-identifier hs-var">syn_ctxt</span></a><span> </span><a href="#local-6989586621680456543"><span class="hs-identifier hs-var">syn_rhs</span></a><span>
</span><a name="line-2463"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkTySynRhs"><span class="hs-identifier hs-var">checkTySynRhs</span></a><span> </span><a href="#local-6989586621680456522"><span class="hs-identifier hs-var">syn_ctxt</span></a><span> </span><a href="#local-6989586621680456543"><span class="hs-identifier hs-var">syn_rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2464"></a><span>
</span><a name="line-2465"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456544"><a href="#local-6989586621680456544"><span class="hs-identifier">fam_flav</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#famTyConFlav_maybe"><span class="hs-identifier hs-var">famTyConFlav_maybe</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2466"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456544"><span class="hs-identifier hs-var">fam_flav</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2467"></a><span>               </span><span class="hs-special">{</span><span> </span><a href="TyCon.html#ClosedSynFamilyTyCon"><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456545"><a href="#local-6989586621680456545"><span class="hs-identifier">ax</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2468"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcTyClsDecls.html#tcAddClosedTypeFamilyDeclCtxt"><span class="hs-identifier hs-var">tcAddClosedTypeFamilyDeclCtxt</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2469"></a><span>                      </span><a href="TcValidity.html#checkValidCoAxiom"><span class="hs-identifier hs-var">checkValidCoAxiom</span></a><span> </span><a href="#local-6989586621680456545"><span class="hs-identifier hs-var">ax</span></a><span>
</span><a name="line-2470"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TyCon.html#ClosedSynFamilyTyCon"><span class="hs-identifier hs-var">ClosedSynFamilyTyCon</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2471"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TyCon.html#AbstractClosedSynFamilyTyCon"><span class="hs-identifier hs-var">AbstractClosedSynFamilyTyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2472"></a><span>                 </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456546"><a href="#local-6989586621680456546"><span class="hs-identifier">hsBoot</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#tcIsHsBootOrSig"><span class="hs-identifier hs-var">tcIsHsBootOrSig</span></a><span>
</span><a name="line-2473"></a><span>                    </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><a href="#local-6989586621680456546"><span class="hs-identifier hs-var">hsBoot</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2474"></a><span>                      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;You may define an abstract closed type family&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-2475"></a><span>                      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;only in a .hs-boot file&quot;</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2476"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TyCon.html#DataFamilyTyCon"><span class="hs-identifier hs-var">DataFamilyTyCon</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2477"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TyCon.html#OpenSynFamilyTyCon"><span class="hs-identifier hs-var">OpenSynFamilyTyCon</span></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2478"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TyCon.html#BuiltInSynFamTyCon"><span class="hs-identifier hs-var">BuiltInSynFamTyCon</span></a><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2479"></a><span>
</span><a name="line-2480"></a><span>             </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2481"></a><span>               </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check the context on the data decl</span><span>
</span><a name="line-2482"></a><span>                 </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;cvtc1&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2483"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTheta"><span class="hs-identifier hs-var">checkValidTheta</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#DataTyCtxt"><span class="hs-identifier hs-var">DataTyCtxt</span></a><span> </span><a href="#local-6989586621680456523"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConStupidTheta"><span class="hs-identifier hs-var">tyConStupidTheta</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2484"></a><span>
</span><a name="line-2485"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;cvtc2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2486"></a><span>
</span><a name="line-2487"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456547"><a href="#local-6989586621680456547"><span class="hs-identifier">dflags</span></a></a><span>          </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a><span>
</span><a name="line-2488"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456548"><a href="#local-6989586621680456548"><span class="hs-identifier">existential_ok</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ExistentialQuantification"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ExistentialQuantification</span></a><span>
</span><a name="line-2489"></a><span>               </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456549"><a href="#local-6989586621680456549"><span class="hs-identifier">gadt_ok</span></a></a><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#GADTs"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">GADTs</span></a><span>
</span><a name="line-2490"></a><span>               </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456550"><a href="#local-6989586621680456550"><span class="hs-identifier">ex_ok</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456548"><span class="hs-identifier hs-var">existential_ok</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456549"><span class="hs-identifier hs-var">gadt_ok</span></a><span>
</span><a name="line-2491"></a><span>                     </span><span class="hs-comment">-- Data cons can have existential context</span><span>
</span><a name="line-2492"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#checkValidDataCon"><span class="hs-identifier hs-var">checkValidDataCon</span></a><span> </span><a href="#local-6989586621680456547"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621680456550"><span class="hs-identifier hs-var">ex_ok</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456524"><span class="hs-identifier hs-var">data_cons</span></a><span>
</span><a name="line-2493"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#checkPartialRecordField"><span class="hs-identifier hs-var">checkPartialRecordField</span></a><span> </span><a href="#local-6989586621680456524"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConFieldLabels"><span class="hs-identifier hs-var">tyConFieldLabels</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2494"></a><span>
</span><a name="line-2495"></a><span>                </span><span class="hs-comment">-- Check that fields with the same name share a type</span><span>
</span><a name="line-2496"></a><span>               </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680456528"><span class="hs-identifier hs-var">check_fields</span></a><span> </span><a href="#local-6989586621680456525"><span class="hs-identifier hs-var">groups</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span>
</span><a name="line-2497"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2498"></a><span>    </span><a name="local-6989586621680456522"><a href="#local-6989586621680456522"><span class="hs-identifier">syn_ctxt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#TySynCtxt"><span class="hs-identifier hs-var">TySynCtxt</span></a><span> </span><a href="#local-6989586621680456523"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2499"></a><span>    </span><a name="local-6989586621680456523"><a href="#local-6989586621680456523"><span class="hs-identifier">name</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2500"></a><span>    </span><a name="local-6989586621680456524"><a href="#local-6989586621680456524"><span class="hs-identifier">data_cons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680456521"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2501"></a><span>
</span><a name="line-2502"></a><span>    </span><a name="local-6989586621680456525"><a href="#local-6989586621680456525"><span class="hs-identifier">groups</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="ListSetOps.html#equivClasses"><span class="hs-identifier hs-var">equivClasses</span></a><span> </span><a href="#local-6989586621680456526"><span class="hs-identifier hs-var">cmp_fld</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a><span> </span><a href="#local-6989586621680456527"><span class="hs-identifier hs-var">get_fields</span></a><span> </span><a href="#local-6989586621680456524"><span class="hs-identifier hs-var">data_cons</span></a><span class="hs-special">)</span><span>
</span><a name="line-2503"></a><span>    </span><a name="local-6989586621680456526"><a href="#local-6989586621680456526"><span class="hs-identifier">cmp_fld</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456529"><a href="#local-6989586621680456529"><span class="hs-identifier">f1</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456530"><a href="#local-6989586621680456530"><span class="hs-identifier">f2</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621680456529"><span class="hs-identifier hs-var">f1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621680456530"><span class="hs-identifier hs-var">f2</span></a><span>
</span><a name="line-2504"></a><span>    </span><a name="local-6989586621680456527"><a href="#local-6989586621680456527"><span class="hs-identifier">get_fields</span></a></a><span> </span><a name="local-6989586621680456531"><a href="#local-6989586621680456531"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFieldLabels"><span class="hs-identifier hs-var">dataConFieldLabels</span></a><span> </span><a href="#local-6989586621680456531"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span class="hs-special">`</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#repeat"><span class="hs-identifier hs-var">repeat</span></a><span> </span><a href="#local-6989586621680456531"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2505"></a><span>        </span><span class="hs-comment">-- dataConFieldLabels may return the empty list, which is fine</span><span>
</span><a name="line-2506"></a><span>
</span><a name="line-2507"></a><span>    </span><span class="hs-comment">-- See Note [GADT record selectors] in TcTyDecls</span><span>
</span><a name="line-2508"></a><span>    </span><span class="hs-comment">-- We must check (a) that the named field has the same</span><span>
</span><a name="line-2509"></a><span>    </span><span class="hs-comment">--                   type in each constructor</span><span>
</span><a name="line-2510"></a><span>    </span><span class="hs-comment">--               (b) that those constructors have the same result type</span><span>
</span><a name="line-2511"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2512"></a><span>    </span><span class="hs-comment">-- However, the constructors may have differently named type variable</span><span>
</span><a name="line-2513"></a><span>    </span><span class="hs-comment">-- and (worse) we don't know how the correspond to each other.  E.g.</span><span>
</span><a name="line-2514"></a><span>    </span><span class="hs-comment">--     C1 :: forall a b. { f :: a, g :: b } -&gt; T a b</span><span>
</span><a name="line-2515"></a><span>    </span><span class="hs-comment">--     C2 :: forall d c. { f :: c, g :: c } -&gt; T c d</span><span>
</span><a name="line-2516"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2517"></a><span>    </span><span class="hs-comment">-- So what we do is to ust Unify.tcMatchTys to compare the first candidate's</span><span>
</span><a name="line-2518"></a><span>    </span><span class="hs-comment">-- result type against other candidates' types BOTH WAYS ROUND.</span><span>
</span><a name="line-2519"></a><span>    </span><span class="hs-comment">-- If they magically agrees, take the substitution and</span><span>
</span><a name="line-2520"></a><span>    </span><span class="hs-comment">-- apply them to the latter ones, and see if they match perfectly.</span><span>
</span><a name="line-2521"></a><span>    </span><a name="local-6989586621680456528"><a href="#local-6989586621680456528"><span class="hs-identifier">check_fields</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621680456532"><a href="#local-6989586621680456532"><span class="hs-identifier">label</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456533"><a href="#local-6989586621680456533"><span class="hs-identifier">con1</span></a></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">:|</span></a><span> </span><a name="local-6989586621680456534"><a href="#local-6989586621680456534"><span class="hs-identifier">other_fields</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2522"></a><span>        </span><span class="hs-comment">-- These fields all have the same name, but are from</span><span>
</span><a name="line-2523"></a><span>        </span><span class="hs-comment">-- different constructors in the data type</span><span>
</span><a name="line-2524"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#recoverM"><span class="hs-identifier hs-var">recoverM</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680456538"><span class="hs-identifier hs-var">checkOne</span></a><span> </span><a href="#local-6989586621680456534"><span class="hs-identifier hs-var">other_fields</span></a><span>
</span><a name="line-2525"></a><span>                </span><span class="hs-comment">-- Check that all the fields in the group have the same type</span><span>
</span><a name="line-2526"></a><span>                </span><span class="hs-comment">-- NB: this check assumes that all the constructors of a given</span><span>
</span><a name="line-2527"></a><span>                </span><span class="hs-comment">-- data type use the same type variables</span><span>
</span><a name="line-2528"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-2529"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456535"><a href="#local-6989586621680456535"><span class="hs-identifier">res1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConSig"><span class="hs-identifier hs-var">dataConSig</span></a><span> </span><a href="#local-6989586621680456533"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-2530"></a><span>        </span><a name="local-6989586621680456536"><a href="#local-6989586621680456536"><span class="hs-identifier">fty1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFieldType"><span class="hs-identifier hs-var">dataConFieldType</span></a><span> </span><a href="#local-6989586621680456533"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621680456537"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-2531"></a><span>        </span><a name="local-6989586621680456537"><a href="#local-6989586621680456537"><span class="hs-identifier">lbl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flLabel</span><span> </span><a href="#local-6989586621680456532"><span class="hs-identifier hs-var">label</span></a><span>
</span><a name="line-2532"></a><span>
</span><a name="line-2533"></a><span>        </span><a name="local-6989586621680456538"><a href="#local-6989586621680456538"><span class="hs-identifier">checkOne</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456539"><a href="#local-6989586621680456539"><span class="hs-identifier">con2</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Do it both ways to ensure they are structurally identical</span><span>
</span><a name="line-2534"></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcTyClsDecls.html#checkFieldCompat"><span class="hs-identifier hs-var">checkFieldCompat</span></a><span> </span><a href="#local-6989586621680456537"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680456533"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621680456539"><span class="hs-identifier hs-var">con2</span></a><span> </span><a href="#local-6989586621680456535"><span class="hs-identifier hs-var">res1</span></a><span> </span><a href="#local-6989586621680456540"><span class="hs-identifier hs-var">res2</span></a><span> </span><a href="#local-6989586621680456536"><span class="hs-identifier hs-var">fty1</span></a><span> </span><a href="#local-6989586621680456541"><span class="hs-identifier hs-var">fty2</span></a><span>
</span><a name="line-2535"></a><span>                 </span><span class="hs-special">;</span><span> </span><a href="TcTyClsDecls.html#checkFieldCompat"><span class="hs-identifier hs-var">checkFieldCompat</span></a><span> </span><a href="#local-6989586621680456537"><span class="hs-identifier hs-var">lbl</span></a><span> </span><a href="#local-6989586621680456539"><span class="hs-identifier hs-var">con2</span></a><span> </span><a href="#local-6989586621680456533"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621680456540"><span class="hs-identifier hs-var">res2</span></a><span> </span><a href="#local-6989586621680456535"><span class="hs-identifier hs-var">res1</span></a><span> </span><a href="#local-6989586621680456541"><span class="hs-identifier hs-var">fty2</span></a><span> </span><a href="#local-6989586621680456536"><span class="hs-identifier hs-var">fty1</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2536"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2537"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456540"><a href="#local-6989586621680456540"><span class="hs-identifier">res2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConSig"><span class="hs-identifier hs-var">dataConSig</span></a><span> </span><a href="#local-6989586621680456539"><span class="hs-identifier hs-var">con2</span></a><span>
</span><a name="line-2538"></a><span>                </span><a name="local-6989586621680456541"><a href="#local-6989586621680456541"><span class="hs-identifier">fty2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFieldType"><span class="hs-identifier hs-var">dataConFieldType</span></a><span> </span><a href="#local-6989586621680456539"><span class="hs-identifier hs-var">con2</span></a><span> </span><a href="#local-6989586621680456537"><span class="hs-identifier hs-var">lbl</span></a><span>
</span><a name="line-2539"></a><span>
</span><a name="line-2540"></a><span class="hs-identifier">checkPartialRecordField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FieldLabel.html#FieldLabel"><span class="hs-identifier hs-type">FieldLabel</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2541"></a><span class="hs-comment">-- Checks the partial record field selector, and warns.</span><span>
</span><a name="line-2542"></a><span class="hs-comment">-- See Note [Checking partial record field]</span><span>
</span><a name="line-2543"></a><a name="checkPartialRecordField"><a href="TcTyClsDecls.html#checkPartialRecordField"><span class="hs-identifier">checkPartialRecordField</span></a></a><span> </span><a name="local-6989586621680456551"><a href="#local-6989586621680456551"><span class="hs-identifier">all_cons</span></a></a><span> </span><a name="local-6989586621680456552"><a href="#local-6989586621680456552"><span class="hs-identifier">fld</span></a></a><span>
</span><a name="line-2544"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456554"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2545"></a><span>      </span><a href="TcRnMonad.html#warnIfFlag"><span class="hs-identifier hs-var">warnIfFlag</span></a><span> </span><a href="DynFlags.html#Opt_WarnPartialFields"><span class="hs-identifier hs-var">Opt_WarnPartialFields</span></a><span>
</span><a name="line-2546"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680456559"><span class="hs-identifier hs-var">is_exhaustive</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="OccName.html#startsWithUnderscore"><span class="hs-identifier hs-var">startsWithUnderscore</span></a><span> </span><a href="#local-6989586621680456555"><span class="hs-identifier hs-var">occ_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2547"></a><span>        </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use of partial record field selector&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">,</span><span>
</span><a name="line-2548"></a><span>              </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456555"><span class="hs-identifier hs-var">occ_name</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2549"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2550"></a><span>    </span><a name="local-6989586621680456553"><a href="#local-6989586621680456553"><span class="hs-identifier">sel_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">flSelector</span><span> </span><a href="#local-6989586621680456552"><span class="hs-identifier hs-var">fld</span></a><span>
</span><a name="line-2551"></a><span>    </span><a name="local-6989586621680456554"><a href="#local-6989586621680456554"><span class="hs-identifier">loc</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456553"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-2552"></a><span>    </span><a name="local-6989586621680456555"><a href="#local-6989586621680456555"><span class="hs-identifier">occ_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a><span> </span><a href="#local-6989586621680456553"><span class="hs-identifier hs-var">sel_name</span></a><span>
</span><a name="line-2553"></a><span>
</span><a name="line-2554"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456556"><a href="#local-6989586621680456556"><span class="hs-identifier">cons_with_field</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456557"><a href="#local-6989586621680456557"><span class="hs-identifier">cons_without_field</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a><span> </span><a href="#local-6989586621680456558"><span class="hs-identifier hs-var">has_field</span></a><span> </span><a href="#local-6989586621680456551"><span class="hs-identifier hs-var">all_cons</span></a><span>
</span><a name="line-2555"></a><span>    </span><a name="local-6989586621680456558"><a href="#local-6989586621680456558"><span class="hs-identifier">has_field</span></a></a><span> </span><a name="local-6989586621680456565"><a href="#local-6989586621680456565"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456552"><span class="hs-identifier hs-var">fld</span></a><span> </span><span class="hs-special">`</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConFieldLabels"><span class="hs-identifier hs-var">dataConFieldLabels</span></a><span> </span><a href="#local-6989586621680456565"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2556"></a><span>    </span><a name="local-6989586621680456559"><a href="#local-6989586621680456559"><span class="hs-identifier">is_exhaustive</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConCannotMatch"><span class="hs-identifier hs-var">dataConCannotMatch</span></a><span> </span><a href="#local-6989586621680456564"><span class="hs-identifier hs-var">inst_tys</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456557"><span class="hs-identifier hs-var">cons_without_field</span></a><span>
</span><a name="line-2557"></a><span>
</span><a name="line-2558"></a><span>    </span><a name="local-6989586621680456560"><a href="#local-6989586621680456560"><span class="hs-identifier">con1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">null</span><span> </span><span class="hs-identifier">cons_with_field</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456556"><span class="hs-identifier hs-var">head</span></a><span> </span><span class="hs-identifier">cons_with_field</span><span>
</span><a name="line-2559"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456561"><a href="#local-6989586621680456561"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456562"><a href="#local-6989586621680456562"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFullSig"><span class="hs-identifier hs-var">dataConFullSig</span></a><span> </span><a href="#local-6989586621680456560"><span class="hs-identifier hs-var">con1</span></a><span>
</span><a name="line-2560"></a><span>    </span><a name="local-6989586621680456563"><a href="#local-6989586621680456563"><span class="hs-identifier">eq_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#mkTvSubstPrs"><span class="hs-identifier hs-var">mkTvSubstPrs</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="DataCon.html#eqSpecPair"><span class="hs-identifier hs-var">eqSpecPair</span></a><span> </span><a href="#local-6989586621680456562"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-2561"></a><span>    </span><a name="local-6989586621680456564"><a href="#local-6989586621680456564"><span class="hs-identifier">inst_tys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyVars"><span class="hs-identifier hs-var">substTyVars</span></a><span> </span><a href="#local-6989586621680456563"><span class="hs-identifier hs-var">eq_subst</span></a><span> </span><a href="#local-6989586621680456561"><span class="hs-identifier hs-var">univ_tvs</span></a><span>
</span><a name="line-2562"></a><span>
</span><a name="line-2563"></a><span class="hs-identifier">checkFieldCompat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FieldLabel.html#FieldLabelString"><span class="hs-identifier hs-type">FieldLabelString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span>
</span><a name="line-2564"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2565"></a><a name="checkFieldCompat"><a href="TcTyClsDecls.html#checkFieldCompat"><span class="hs-identifier">checkFieldCompat</span></a></a><span> </span><a name="local-6989586621680456566"><a href="#local-6989586621680456566"><span class="hs-identifier">fld</span></a></a><span> </span><a name="local-6989586621680456567"><a href="#local-6989586621680456567"><span class="hs-identifier">con1</span></a></a><span> </span><a name="local-6989586621680456568"><a href="#local-6989586621680456568"><span class="hs-identifier">con2</span></a></a><span> </span><a name="local-6989586621680456569"><a href="#local-6989586621680456569"><span class="hs-identifier">res1</span></a></a><span> </span><a name="local-6989586621680456570"><a href="#local-6989586621680456570"><span class="hs-identifier">res2</span></a></a><span> </span><a name="local-6989586621680456571"><a href="#local-6989586621680456571"><span class="hs-identifier">fty1</span></a></a><span> </span><a name="local-6989586621680456572"><a href="#local-6989586621680456572"><span class="hs-identifier">fty2</span></a></a><span>
</span><a name="line-2566"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621680456573"><span class="hs-identifier hs-var">mb_subst1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#resultTypeMisMatch"><span class="hs-identifier hs-var">resultTypeMisMatch</span></a><span> </span><a href="#local-6989586621680456566"><span class="hs-identifier hs-var">fld</span></a><span> </span><a href="#local-6989586621680456567"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621680456568"><span class="hs-identifier hs-var">con2</span></a><span class="hs-special">)</span><span>
</span><a name="line-2567"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="#local-6989586621680456574"><span class="hs-identifier hs-var">mb_subst2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#fieldTypeMisMatch"><span class="hs-identifier hs-var">fieldTypeMisMatch</span></a><span> </span><a href="#local-6989586621680456566"><span class="hs-identifier hs-var">fld</span></a><span> </span><a href="#local-6989586621680456567"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="#local-6989586621680456568"><span class="hs-identifier hs-var">con2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2568"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2569"></a><span>    </span><a name="local-6989586621680456573"><a href="#local-6989586621680456573"><span class="hs-identifier">mb_subst1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a><span> </span><a href="#local-6989586621680456569"><span class="hs-identifier hs-var">res1</span></a><span> </span><a href="#local-6989586621680456570"><span class="hs-identifier hs-var">res2</span></a><span>
</span><a name="line-2570"></a><span>    </span><a name="local-6989586621680456574"><a href="#local-6989586621680456574"><span class="hs-identifier">mb_subst2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Unify.html#tcMatchTyX"><span class="hs-identifier hs-var">tcMatchTyX</span></a><span> </span><span class="hs-special">(</span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;checkFieldCompat&quot;</span><span> </span><a href="#local-6989586621680456573"><span class="hs-identifier hs-var">mb_subst1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456571"><span class="hs-identifier hs-var">fty1</span></a><span> </span><a href="#local-6989586621680456572"><span class="hs-identifier hs-var">fty2</span></a><span>
</span><a name="line-2571"></a><span>
</span><a name="line-2572"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-2573"></a><span class="hs-identifier">checkValidDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2574"></a><a name="checkValidDataCon"><a href="TcTyClsDecls.html#checkValidDataCon"><span class="hs-identifier">checkValidDataCon</span></a></a><span> </span><a name="local-6989586621680456575"><a href="#local-6989586621680456575"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621680456576"><a href="#local-6989586621680456576"><span class="hs-identifier">existential_ok</span></a></a><span> </span><a name="local-6989586621680456577"><a href="#local-6989586621680456577"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680456578"><a href="#local-6989586621680456578"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-2575"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>  </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2576"></a><span>    </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#dataConCtxt"><span class="hs-identifier hs-var">dataConCtxt</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2577"></a><span>    </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Check that the return type of the data constructor</span><span>
</span><a name="line-2578"></a><span>          </span><span class="hs-comment">-- matches the type constructor; eg reject this:</span><span>
</span><a name="line-2579"></a><span>          </span><span class="hs-comment">--   data T a where { MkT :: Bogus a }</span><span>
</span><a name="line-2580"></a><span>          </span><span class="hs-comment">-- It's important to do this first:</span><span>
</span><a name="line-2581"></a><span>          </span><span class="hs-comment">--  see Note [Checking GADT return types]</span><span>
</span><a name="line-2582"></a><span>          </span><span class="hs-comment">--  and c.f. Note [Check role annotations in a second pass]</span><span>
</span><a name="line-2583"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456591"><a href="#local-6989586621680456591"><span class="hs-identifier">tc_tvs</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680456577"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2584"></a><span>              </span><a name="local-6989586621680456592"><a href="#local-6989586621680456592"><span class="hs-identifier">res_ty_tmpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkFamilyTyConApp"><span class="hs-identifier hs-var">mkFamilyTyConApp</span></a><span> </span><a href="#local-6989586621680456577"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621680456591"><span class="hs-identifier hs-var">tc_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2585"></a><span>              </span><a name="local-6989586621680456593"><a href="#local-6989586621680456593"><span class="hs-identifier">orig_res_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConOrigResTy"><span class="hs-identifier hs-var">dataConOrigResTy</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2586"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidDataCon&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-2587"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456577"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456591"><span class="hs-identifier hs-var">tc_tvs</span></a><span>
</span><a name="line-2588"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456592"><span class="hs-identifier hs-var">res_ty_tmpl</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680456592"><span class="hs-identifier hs-var">res_ty_tmpl</span></a><span class="hs-special">)</span><span>
</span><a name="line-2589"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456593"><span class="hs-identifier hs-var">orig_res_ty</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#typeKind"><span class="hs-identifier hs-var">typeKind</span></a><span> </span><a href="#local-6989586621680456593"><span class="hs-identifier hs-var">orig_res_ty</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2590"></a><span>
</span><a name="line-2591"></a><span>
</span><a name="line-2592"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="Unify.html#tcMatchTy"><span class="hs-identifier hs-var">tcMatchTy</span></a><span> </span><a href="#local-6989586621680456592"><span class="hs-identifier hs-var">res_ty_tmpl</span></a><span>
</span><a name="line-2593"></a><span>                                     </span><a href="#local-6989586621680456593"><span class="hs-identifier hs-var">orig_res_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2594"></a><span>                  </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badDataConTyCon"><span class="hs-identifier hs-var">badDataConTyCon</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680456592"><span class="hs-identifier hs-var">res_ty_tmpl</span></a><span> </span><a href="#local-6989586621680456593"><span class="hs-identifier hs-var">orig_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2595"></a><span>            </span><span class="hs-comment">-- Note that checkTc aborts if it finds an error. This is</span><span>
</span><a name="line-2596"></a><span>            </span><span class="hs-comment">-- critical to avoid panicking when we call dataConUserType</span><span>
</span><a name="line-2597"></a><span>            </span><span class="hs-comment">-- on an un-rejiggable datacon!</span><span>
</span><a name="line-2598"></a><span>
</span><a name="line-2599"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;checkValidDataCon 2&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUserType"><span class="hs-identifier hs-var">dataConUserType</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2600"></a><span>
</span><a name="line-2601"></a><span>          </span><span class="hs-comment">-- Check that the result type is a *monotype*</span><span>
</span><a name="line-2602"></a><span>          </span><span class="hs-comment">--  e.g. reject this:   MkT :: T (forall a. a-&gt;a)</span><span>
</span><a name="line-2603"></a><span>          </span><span class="hs-comment">-- Reason: it's really the argument of an equality constraint</span><span>
</span><a name="line-2604"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidMonoType"><span class="hs-identifier hs-var">checkValidMonoType</span></a><span> </span><a href="#local-6989586621680456593"><span class="hs-identifier hs-var">orig_res_ty</span></a><span>
</span><a name="line-2605"></a><span>
</span><a name="line-2606"></a><span>          </span><span class="hs-comment">-- Check all argument types for validity</span><span>
</span><a name="line-2607"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621680456579"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUserType"><span class="hs-identifier hs-var">dataConUserType</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2608"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="TcMType.html#checkForLevPoly"><span class="hs-identifier hs-var">checkForLevPoly</span></a><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2609"></a><span>                </span><span class="hs-special">(</span><a href="DataCon.html#dataConOrigArgTys"><span class="hs-identifier hs-var">dataConOrigArgTys</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2610"></a><span>
</span><a name="line-2611"></a><span>          </span><span class="hs-comment">-- Extra checks for newtype data constructors</span><span>
</span><a name="line-2612"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#isNewTyCon"><span class="hs-identifier hs-var">isNewTyCon</span></a><span> </span><a href="#local-6989586621680456577"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#checkNewDataCon"><span class="hs-identifier hs-var">checkNewDataCon</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2613"></a><span>
</span><a name="line-2614"></a><span>          </span><span class="hs-comment">-- Check that existentials are allowed if they are used</span><span>
</span><a name="line-2615"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456576"><span class="hs-identifier hs-var">existential_ok</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="DataCon.html#isVanillaDataCon"><span class="hs-identifier hs-var">isVanillaDataCon</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2616"></a><span>                  </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badExistential"><span class="hs-identifier hs-var">badExistential</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2617"></a><span>
</span><a name="line-2618"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456594"><a href="#local-6989586621680456594"><span class="hs-identifier">typeintype</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#TypeInType"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TypeInType</span></a><span>
</span><a name="line-2619"></a><span>        </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456595"><a href="#local-6989586621680456595"><span class="hs-identifier">eq_specs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFullSig"><span class="hs-identifier hs-var">dataConFullSig</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2620"></a><span>                </span><span class="hs-comment">-- dataConEqSpec retrieves both the real GADT equalities</span><span>
</span><a name="line-2621"></a><span>                </span><span class="hs-comment">-- plus any user-written GADT-like equalities. But we don't</span><span>
</span><a name="line-2622"></a><span>                </span><span class="hs-comment">-- want anything user-written. If we don't exclude user-written</span><span>
</span><a name="line-2623"></a><span>                </span><span class="hs-comment">-- ones, test case polykinds/T13391a fails.</span><span>
</span><a name="line-2624"></a><span>
</span><a name="line-2625"></a><span>              </span><a name="local-6989586621680456596"><a href="#local-6989586621680456596"><span class="hs-identifier">invisible_gadt_eq_specs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a><span> </span><a href="#local-6989586621680456600"><span class="hs-identifier hs-var">is_invisible_eq_spec</span></a><span> </span><a href="#local-6989586621680456595"><span class="hs-identifier hs-var">eq_specs</span></a><span>
</span><a name="line-2626"></a><span>              </span><a name="local-6989586621680456597"><a href="#local-6989586621680456597"><span class="hs-identifier">univ_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2627"></a><span>              </span><a name="local-6989586621680456598"><a href="#local-6989586621680456598"><span class="hs-identifier">tc_bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621680456577"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-2628"></a><span>
</span><a name="line-2629"></a><span>              </span><span class="hs-identifier">vis_map</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#VarEnv"><span class="hs-identifier hs-type">VarEnv</span></a><span> </span><a href="Var.html#ArgFlag"><span class="hs-identifier hs-type">ArgFlag</span></a><span>
</span><a name="line-2630"></a><span>              </span><a name="local-6989586621680456599"><a href="#local-6989586621680456599"><span class="hs-identifier">vis_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#zipVarEnv"><span class="hs-identifier hs-var">zipVarEnv</span></a><span> </span><a href="#local-6989586621680456597"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="TyCon.html#tyConBinderArgFlag"><span class="hs-identifier hs-var">tyConBinderArgFlag</span></a><span> </span><a href="#local-6989586621680456598"><span class="hs-identifier hs-var">tc_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2631"></a><span>
</span><a name="line-2632"></a><span>                </span><span class="hs-comment">-- See Note [Wrong visibility for GADTs] for why we have to build the map</span><span>
</span><a name="line-2633"></a><span>                </span><span class="hs-comment">-- above instead of just looking at the datacon tyvar binder</span><span>
</span><a name="line-2634"></a><span>              </span><a name="local-6989586621680456600"><a href="#local-6989586621680456600"><span class="hs-identifier">is_invisible_eq_spec</span></a></a><span> </span><a name="local-6989586621680456601"><a href="#local-6989586621680456601"><span class="hs-identifier">eq_spec</span></a></a><span>
</span><a name="line-2635"></a><span>                </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isInvisibleArgFlag"><span class="hs-identifier hs-var">isInvisibleArgFlag</span></a><span> </span><a href="#local-6989586621680456603"><span class="hs-identifier hs-var">arg_flag</span></a><span>
</span><a name="line-2636"></a><span>                </span><span class="hs-keyword">where</span><span>
</span><a name="line-2637"></a><span>                  </span><a name="local-6989586621680456602"><a href="#local-6989586621680456602"><span class="hs-identifier">eq_tv</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#eqSpecTyVar"><span class="hs-identifier hs-var">eqSpecTyVar</span></a><span> </span><a href="#local-6989586621680456601"><span class="hs-identifier hs-var">eq_spec</span></a><span>
</span><a name="line-2638"></a><span>                  </span><a name="local-6989586621680456603"><a href="#local-6989586621680456603"><span class="hs-identifier">arg_flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;checkValidDataCon&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2639"></a><span>                             </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621680456599"><span class="hs-identifier hs-var">vis_map</span></a><span> </span><a href="#local-6989586621680456602"><span class="hs-identifier hs-var">eq_tv</span></a><span>
</span><a name="line-2640"></a><span>
</span><a name="line-2641"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456594"><span class="hs-identifier hs-var">typeintype</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456596"><span class="hs-identifier hs-var">invisible_gadt_eq_specs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2642"></a><span>                  </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badGADT"><span class="hs-identifier hs-var">badGADT</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621680456596"><span class="hs-identifier hs-var">invisible_gadt_eq_specs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2643"></a><span>
</span><a name="line-2644"></a><span>          </span><span class="hs-comment">-- Check that UNPACK pragmas and bangs work out</span><span>
</span><a name="line-2645"></a><span>          </span><span class="hs-comment">-- E.g.  reject   data T = MkT {-# UNPACK #-} Int     -- No &quot;!&quot;</span><span>
</span><a name="line-2646"></a><span>          </span><span class="hs-comment">--                data T = MkT {-# UNPACK #-} !a      -- Can't unpack</span><span>
</span><a name="line-2647"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="MonadUtils.html#zipWith3M_"><span class="hs-identifier hs-var">zipWith3M_</span></a><span> </span><a href="#local-6989586621680456580"><span class="hs-identifier hs-var">check_bang</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConSrcBangs"><span class="hs-identifier hs-var">dataConSrcBangs</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConImplBangs"><span class="hs-identifier hs-var">dataConImplBangs</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-2648"></a><span>
</span><a name="line-2649"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;Done validity of data con&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2650"></a><span>          </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2651"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Datacon user type:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUserType"><span class="hs-identifier hs-var">dataConUserType</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2652"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Datacon rep type:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConRepType"><span class="hs-identifier hs-var">dataConRepType</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2653"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Rep typcon binders:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2654"></a><span>               </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCon.html#tyConFamInst_maybe"><span class="hs-identifier hs-var">tyConFamInst_maybe</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2655"></a><span>                   </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;not family&quot;</span><span>
</span><a name="line-2656"></a><span>                   </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456604"><a href="#local-6989586621680456604"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConBinders</span><span> </span><a href="#local-6989586621680456604"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2657"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2658"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2659"></a><span>    </span><a name="local-6989586621680456579"><a href="#local-6989586621680456579"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#ConArgCtxt"><span class="hs-identifier hs-var">ConArgCtxt</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2660"></a><span>
</span><a name="line-2661"></a><span>    </span><span class="hs-identifier">check_bang</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-type">HsSrcBang</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#HsImplBang"><span class="hs-identifier hs-type">HsImplBang</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2662"></a><span>    </span><a name="local-6989586621680456580"><a href="#local-6989586621680456580"><span class="hs-identifier">check_bang</span></a></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-var">HsSrcBang</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="DataCon.html#SrcLazy"><span class="hs-identifier hs-var">SrcLazy</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456582"><a href="#local-6989586621680456582"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-2663"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#StrictData"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">StrictData</span></a><span> </span><a href="#local-6989586621680456575"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2664"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span>
</span><a name="line-2665"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621680456581"><span class="hs-identifier hs-var">bad_bang</span></a><span> </span><a href="#local-6989586621680456582"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Lazy annotation (~) without StrictData&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2666"></a><span>    </span><span class="hs-identifier">check_bang</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-var">HsSrcBang</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456583"><a href="#local-6989586621680456583"><span class="hs-identifier">want_unpack</span></a></a><span> </span><a name="local-6989586621680456584"><a href="#local-6989586621680456584"><span class="hs-identifier">strict_mark</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680456585"><a href="#local-6989586621680456585"><span class="hs-identifier">rep_bang</span></a></a><span> </span><a name="local-6989586621680456586"><a href="#local-6989586621680456586"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-2667"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DataCon.html#isSrcUnpacked"><span class="hs-identifier hs-var">isSrcUnpacked</span></a><span> </span><a href="#local-6989586621680456583"><span class="hs-identifier hs-var">want_unpack</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621680456587"><span class="hs-identifier hs-var">is_strict</span></a><span>
</span><a name="line-2668"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><a href="DynFlags.html#NoReason"><span class="hs-identifier hs-var">NoReason</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456581"><span class="hs-identifier hs-var">bad_bang</span></a><span> </span><a href="#local-6989586621680456586"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;UNPACK pragma lacks '!'&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2669"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DataCon.html#isSrcUnpacked"><span class="hs-identifier hs-var">isSrcUnpacked</span></a><span> </span><a href="#local-6989586621680456583"><span class="hs-identifier hs-var">want_unpack</span></a><span>
</span><a name="line-2670"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456585"><span class="hs-identifier hs-var">rep_bang</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><a href="DataCon.html#HsUnpack"><span class="hs-identifier hs-var">HsUnpack</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2671"></a><span>      </span><span class="hs-comment">-- If not optimising, we don't unpack (rep_bang is never</span><span>
</span><a name="line-2672"></a><span>      </span><span class="hs-comment">-- HsUnpack), so don't complain!  This happens, e.g., in Haddock.</span><span>
</span><a name="line-2673"></a><span>      </span><span class="hs-comment">-- See dataConSrcToImplBang.</span><span>
</span><a name="line-2674"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_OmitInterfacePragmas"><span class="hs-identifier hs-var">Opt_OmitInterfacePragmas</span></a><span> </span><a href="#local-6989586621680456575"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2675"></a><span>      </span><span class="hs-comment">-- When typechecking an indefinite package in Backpack, we</span><span>
</span><a name="line-2676"></a><span>      </span><span class="hs-comment">-- may attempt to UNPACK an abstract type.  The test here will</span><span>
</span><a name="line-2677"></a><span>      </span><span class="hs-comment">-- conclude that this is unusable, but it might become usable</span><span>
</span><a name="line-2678"></a><span>      </span><span class="hs-comment">-- when we actually fill in the abstract type.  As such, don't</span><span>
</span><a name="line-2679"></a><span>      </span><span class="hs-comment">-- warn in this case (it gives users the wrong idea about whether</span><span>
</span><a name="line-2680"></a><span>      </span><span class="hs-comment">-- or not UNPACK on abstract types is supported; it is!)</span><span>
</span><a name="line-2681"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Module.html#unitIdIsDefinite"><span class="hs-identifier hs-var">unitIdIsDefinite</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#thisPackage"><span class="hs-identifier hs-var">thisPackage</span></a><span> </span><a href="#local-6989586621680456575"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2682"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addWarnTc"><span class="hs-identifier hs-var">addWarnTc</span></a><span> </span><a href="DynFlags.html#NoReason"><span class="hs-identifier hs-var">NoReason</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456581"><span class="hs-identifier hs-var">bad_bang</span></a><span> </span><a href="#local-6989586621680456586"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Ignoring unusable UNPACK pragma&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2683"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-2684"></a><span>        </span><a name="local-6989586621680456587"><a href="#local-6989586621680456587"><span class="hs-identifier">is_strict</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680456584"><span class="hs-identifier hs-var">strict_mark</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2685"></a><span>                      </span><a href="DataCon.html#NoSrcStrict"><span class="hs-identifier hs-var">NoSrcStrict</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#xopt"><span class="hs-identifier hs-var">xopt</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#StrictData"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">StrictData</span></a><span> </span><a href="#local-6989586621680456575"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2686"></a><span>                      </span><a name="local-6989586621680456588"><a href="#local-6989586621680456588"><span class="hs-identifier">bang</span></a></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#isSrcStrict"><span class="hs-identifier hs-var">isSrcStrict</span></a><span> </span><a href="#local-6989586621680456588"><span class="hs-identifier hs-var">bang</span></a><span>
</span><a name="line-2687"></a><span>
</span><a name="line-2688"></a><span>    </span><span class="hs-identifier">check_bang</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-2689"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2690"></a><span>
</span><a name="line-2691"></a><span>    </span><a name="local-6989586621680456581"><a href="#local-6989586621680456581"><span class="hs-identifier">bad_bang</span></a></a><span> </span><a name="local-6989586621680456589"><a href="#local-6989586621680456589"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680456590"><a href="#local-6989586621680456590"><span class="hs-identifier">herald</span></a></a><span>
</span><a name="line-2692"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><a href="#local-6989586621680456590"><span class="hs-identifier hs-var">herald</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;on the&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#speakNth"><span class="hs-identifier hs-var">speakNth</span></a><span> </span><a href="#local-6989586621680456589"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-2693"></a><span>                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;argument of&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456578"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2694"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-2695"></a><span class="hs-identifier">checkNewDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2696"></a><span class="hs-comment">-- Further checks for the data constructor of a newtype</span><span>
</span><a name="line-2697"></a><a name="checkNewDataCon"><a href="TcTyClsDecls.html#checkNewDataCon"><span class="hs-identifier">checkNewDataCon</span></a></a><span> </span><a name="local-6989586621680456605"><a href="#local-6989586621680456605"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-2698"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="Util.html#isSingleton"><span class="hs-identifier hs-var">isSingleton</span></a><span> </span><a href="#local-6989586621680456610"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#newtypeFieldErr"><span class="hs-identifier hs-var">newtypeFieldErr</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680456610"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2699"></a><span>              </span><span class="hs-comment">-- One argument</span><span>
</span><a name="line-2700"></a><span>
</span><a name="line-2701"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Type.html#isUnliftedType"><span class="hs-identifier hs-var">isUnliftedType</span></a><span> </span><a href="#local-6989586621680456613"><span class="hs-identifier hs-var">arg_ty1</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2702"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype cannot have an unlifted argument type&quot;</span><span>
</span><a name="line-2703"></a><span>
</span><a name="line-2704"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456612"><span class="hs-identifier hs-var">check_con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456608"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2705"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype constructor must have a return type of form T a1 ... an&quot;</span><span>
</span><a name="line-2706"></a><span>                </span><span class="hs-comment">-- Return type is (T a b c)</span><span>
</span><a name="line-2707"></a><span>
</span><a name="line-2708"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456612"><span class="hs-identifier hs-var">check_con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456609"><span class="hs-identifier hs-var">theta</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2709"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype constructor cannot have a context in its type&quot;</span><span>
</span><a name="line-2710"></a><span>
</span><a name="line-2711"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456612"><span class="hs-identifier hs-var">check_con</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456607"><span class="hs-identifier hs-var">ex_tvs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2712"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype constructor cannot have existential type variables&quot;</span><span>
</span><a name="line-2713"></a><span>                </span><span class="hs-comment">-- No existentials</span><span>
</span><a name="line-2714"></a><span>
</span><a name="line-2715"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><a href="#local-6989586621680456614"><span class="hs-identifier hs-var">ok_bang</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConSrcBangs"><span class="hs-identifier hs-var">dataConSrcBangs</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2716"></a><span>                  </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#newtypeStrictError"><span class="hs-identifier hs-var">newtypeStrictError</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-2717"></a><span>                </span><span class="hs-comment">-- No strictness annotations</span><span>
</span><a name="line-2718"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-2719"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2720"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456606"><a href="#local-6989586621680456606"><span class="hs-identifier">_univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456607"><a href="#local-6989586621680456607"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456608"><a href="#local-6989586621680456608"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456609"><a href="#local-6989586621680456609"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456610"><a href="#local-6989586621680456610"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456611"><a href="#local-6989586621680456611"><span class="hs-identifier">_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2721"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFullSig"><span class="hs-identifier hs-var">dataConFullSig</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-2722"></a><span>    </span><a name="local-6989586621680456612"><a href="#local-6989586621680456612"><span class="hs-identifier">check_con</span></a></a><span> </span><a name="local-6989586621680456615"><a href="#local-6989586621680456615"><span class="hs-identifier">what</span></a></a><span> </span><a name="local-6989586621680456616"><a href="#local-6989586621680456616"><span class="hs-identifier">msg</span></a></a><span>
</span><a name="line-2723"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><a href="#local-6989586621680456615"><span class="hs-identifier hs-var">what</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456616"><span class="hs-identifier hs-var">msg</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUserType"><span class="hs-identifier hs-var">dataConUserType</span></a><span> </span><a href="#local-6989586621680456605"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2724"></a><span>
</span><a name="line-2725"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456613"><a href="#local-6989586621680456613"><span class="hs-identifier">arg_ty1</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456610"><span class="hs-identifier hs-var">arg_tys</span></a><span>
</span><a name="line-2726"></a><span>
</span><a name="line-2727"></a><span>    </span><a name="local-6989586621680456614"><a href="#local-6989586621680456614"><span class="hs-identifier">ok_bang</span></a></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-var">HsSrcBang</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="DataCon.html#SrcStrict"><span class="hs-identifier hs-var">SrcStrict</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2728"></a><span>    </span><span class="hs-identifier">ok_bang</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#HsSrcBang"><span class="hs-identifier hs-var">HsSrcBang</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a href="DataCon.html#SrcLazy"><span class="hs-identifier hs-var">SrcLazy</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2729"></a><span>    </span><span class="hs-identifier">ok_bang</span><span> </span><span class="hs-identifier">_</span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2730"></a><span>
</span><a name="line-2731"></a><span class="hs-comment">-------------------------------</span><span>
</span><a name="line-2732"></a><span class="hs-identifier">checkValidClass</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2733"></a><a name="checkValidClass"><a href="TcTyClsDecls.html#checkValidClass"><span class="hs-identifier">checkValidClass</span></a></a><span> </span><a name="local-6989586621680456617"><a href="#local-6989586621680456617"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-2734"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>  </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456660"><a href="#local-6989586621680456660"><span class="hs-identifier">constrained_class_methods</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#ConstrainedClassMethods"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ConstrainedClassMethods</span></a><span>
</span><a name="line-2735"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456661"><a href="#local-6989586621680456661"><span class="hs-identifier">multi_param_type_classes</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#MultiParamTypeClasses"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">MultiParamTypeClasses</span></a><span>
</span><a name="line-2736"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456662"><a href="#local-6989586621680456662"><span class="hs-identifier">nullary_type_classes</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#NullaryTypeClasses"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NullaryTypeClasses</span></a><span>
</span><a name="line-2737"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456663"><a href="#local-6989586621680456663"><span class="hs-identifier">fundep_classes</span></a></a><span>            </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#FunctionalDependencies"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">FunctionalDependencies</span></a><span>
</span><a name="line-2738"></a><span>        </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456664"><a href="#local-6989586621680456664"><span class="hs-identifier">undecidable_super_classes</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#UndecidableSuperClasses"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">UndecidableSuperClasses</span></a><span>
</span><a name="line-2739"></a><span>
</span><a name="line-2740"></a><span>        </span><span class="hs-comment">-- Check that the class is unary, unless multiparameter type classes</span><span>
</span><a name="line-2741"></a><span>        </span><span class="hs-comment">-- are enabled; also recognize deprecated nullary type classes</span><span>
</span><a name="line-2742"></a><span>        </span><span class="hs-comment">-- extension (subsumed by multiparameter type classes, Trac #8993)</span><span>
</span><a name="line-2743"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456661"><span class="hs-identifier hs-var">multi_param_type_classes</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456623"><span class="hs-identifier hs-var">cls_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-2744"></a><span>                    </span><span class="hs-special">(</span><a href="#local-6989586621680456662"><span class="hs-identifier hs-var">nullary_type_classes</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680456623"><span class="hs-identifier hs-var">cls_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2745"></a><span>                  </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#classArityErr"><span class="hs-identifier hs-var">classArityErr</span></a><span> </span><a href="#local-6989586621680456623"><span class="hs-identifier hs-var">cls_arity</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-2746"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456663"><span class="hs-identifier hs-var">fundep_classes</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a><span> </span><a href="#local-6989586621680456619"><span class="hs-identifier hs-var">fundeps</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#classFunDepsErr"><span class="hs-identifier hs-var">classFunDepsErr</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span>
</span><a name="line-2747"></a><span>
</span><a name="line-2748"></a><span>        </span><span class="hs-comment">-- Check the super-classes</span><span>
</span><a name="line-2749"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidTheta"><span class="hs-identifier hs-var">checkValidTheta</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#ClassSCCtxt"><span class="hs-identifier hs-var">ClassSCCtxt</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">className</span><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456620"><span class="hs-identifier hs-var">theta</span></a><span>
</span><a name="line-2750"></a><span>
</span><a name="line-2751"></a><span>          </span><span class="hs-comment">-- Now check for cyclic superclasses</span><span>
</span><a name="line-2752"></a><span>          </span><span class="hs-comment">-- If there are superclass cycles, checkClassCycleErrs bails.</span><span>
</span><a name="line-2753"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-6989586621680456664"><span class="hs-identifier hs-var">undecidable_super_classes</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2754"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="TcTyDecls.html#checkClassCycles"><span class="hs-identifier hs-var">checkClassCycles</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2755"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456665"><a href="#local-6989586621680456665"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2756"></a><span>                         </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="#local-6989586621680456665"><span class="hs-identifier hs-var">err</span></a><span>
</span><a name="line-2757"></a><span>             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2758"></a><span>
</span><a name="line-2759"></a><span>        </span><span class="hs-comment">-- Check the class operations.</span><span>
</span><a name="line-2760"></a><span>        </span><span class="hs-comment">-- But only if there have been no earlier errors</span><span>
</span><a name="line-2761"></a><span>        </span><span class="hs-comment">-- See Note [Abort when superclass cycle is detected]</span><span>
</span><a name="line-2762"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#whenNoErrs"><span class="hs-identifier hs-var">whenNoErrs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2763"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456627"><span class="hs-identifier hs-var">check_op</span></a><span> </span><a href="#local-6989586621680456660"><span class="hs-identifier hs-var">constrained_class_methods</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456622"><span class="hs-identifier hs-var">op_stuff</span></a><span>
</span><a name="line-2764"></a><span>
</span><a name="line-2765"></a><span>        </span><span class="hs-comment">-- Check the associated type defaults are well-formed and instantiated</span><span>
</span><a name="line-2766"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680456628"><span class="hs-identifier hs-var">check_at</span></a><span> </span><a href="#local-6989586621680456621"><span class="hs-identifier hs-var">at_stuff</span></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-2767"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2768"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456618"><a href="#local-6989586621680456618"><span class="hs-identifier">tyvars</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456619"><a href="#local-6989586621680456619"><span class="hs-identifier">fundeps</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456620"><a href="#local-6989586621680456620"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456621"><a href="#local-6989586621680456621"><span class="hs-identifier">at_stuff</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456622"><a href="#local-6989586621680456622"><span class="hs-identifier">op_stuff</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Class.html#classExtraBigSig"><span class="hs-identifier hs-var">classExtraBigSig</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2769"></a><span>    </span><a name="local-6989586621680456623"><a href="#local-6989586621680456623"><span class="hs-identifier">cls_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConVisibleTyVars"><span class="hs-identifier hs-var">tyConVisibleTyVars</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyCon</span><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2770"></a><span>       </span><span class="hs-comment">-- Ignore invisible variables</span><span>
</span><a name="line-2771"></a><span>    </span><a name="local-6989586621680456624"><a href="#local-6989586621680456624"><span class="hs-identifier">cls_tv_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkVarSet"><span class="hs-identifier hs-var">mkVarSet</span></a><span> </span><a href="#local-6989586621680456618"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-2772"></a><span>    </span><a name="local-6989586621680456625"><a href="#local-6989586621680456625"><span class="hs-identifier">mini_env</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#zipVarEnv"><span class="hs-identifier hs-var">zipVarEnv</span></a><span> </span><a href="#local-6989586621680456618"><span class="hs-identifier hs-var">tyvars</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621680456618"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">)</span><span>
</span><a name="line-2773"></a><span>    </span><a name="local-6989586621680456626"><a href="#local-6989586621680456626"><span class="hs-identifier">mb_cls</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456618"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456625"><span class="hs-identifier hs-var">mini_env</span></a><span class="hs-special">)</span><span>
</span><a name="line-2774"></a><span>
</span><a name="line-2775"></a><span>    </span><a name="local-6989586621680456627"><a href="#local-6989586621680456627"><span class="hs-identifier">check_op</span></a></a><span> </span><a name="local-6989586621680456630"><a href="#local-6989586621680456630"><span class="hs-identifier">constrained_class_methods</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456631"><a href="#local-6989586621680456631"><span class="hs-identifier">sel_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456632"><a href="#local-6989586621680456632"><span class="hs-identifier">dm</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2776"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2777"></a><span>        </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#classOpCtxt"><span class="hs-identifier hs-var">classOpCtxt</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621680456635"><span class="hs-identifier hs-var">op_ty</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2778"></a><span>        </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;class op type&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456635"><span class="hs-identifier hs-var">op_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2779"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621680456633"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680456635"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-2780"></a><span>                </span><span class="hs-comment">-- This implements the ambiguity check, among other things</span><span>
</span><a name="line-2781"></a><span>                </span><span class="hs-comment">-- Example: tc223</span><span>
</span><a name="line-2782"></a><span>                </span><span class="hs-comment">--   class Error e =&gt; Game b mv e | b -&gt; mv e where</span><span>
</span><a name="line-2783"></a><span>                </span><span class="hs-comment">--      newBoard :: MonadState b m =&gt; m ()</span><span>
</span><a name="line-2784"></a><span>                </span><span class="hs-comment">-- Here, MonadState has a fundep m-&gt;b, so newBoard is fine</span><span>
</span><a name="line-2785"></a><span>
</span><a name="line-2786"></a><span>           </span><span class="hs-comment">-- a method cannot be levity polymorphic, as we have to store the</span><span>
</span><a name="line-2787"></a><span>           </span><span class="hs-comment">-- method in a dictionary</span><span>
</span><a name="line-2788"></a><span>           </span><span class="hs-comment">-- example of what this prevents:</span><span>
</span><a name="line-2789"></a><span>           </span><span class="hs-comment">--   class BoundedX (a :: TYPE r) where minBound :: a</span><span>
</span><a name="line-2790"></a><span>           </span><span class="hs-comment">-- See Note [Levity polymorphism checking] in DsMonad</span><span>
</span><a name="line-2791"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="TcMType.html#checkForLevPoly"><span class="hs-identifier hs-var">checkForLevPoly</span></a><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span> </span><a href="#local-6989586621680456637"><span class="hs-identifier hs-var">tau1</span></a><span>
</span><a name="line-2792"></a><span>
</span><a name="line-2793"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><a href="#local-6989586621680456630"><span class="hs-identifier hs-var">constrained_class_methods</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2794"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680456640"><span class="hs-identifier hs-var">check_constraint</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#tail"><span class="hs-identifier hs-var">tail</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456636"><span class="hs-identifier hs-var">cls_pred</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680456638"><span class="hs-identifier hs-var">op_theta</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2795"></a><span>
</span><a name="line-2796"></a><span>        </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456629"><span class="hs-identifier hs-var">check_dm</span></a><span> </span><a href="#local-6989586621680456633"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621680456636"><span class="hs-identifier hs-var">cls_pred</span></a><span> </span><a href="#local-6989586621680456639"><span class="hs-identifier hs-var">tau2</span></a><span> </span><a href="#local-6989586621680456632"><span class="hs-identifier hs-var">dm</span></a><span>
</span><a name="line-2797"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-2798"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-2799"></a><span>          </span><a name="local-6989586621680456633"><a href="#local-6989586621680456633"><span class="hs-identifier">ctxt</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#FunSigCtxt"><span class="hs-identifier hs-var">FunSigCtxt</span></a><span> </span><a href="#local-6989586621680456634"><span class="hs-identifier hs-var">op_name</span></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-comment">-- Report redundant class constraints</span><span>
</span><a name="line-2800"></a><span>          </span><a name="local-6989586621680456634"><a href="#local-6989586621680456634"><span class="hs-identifier">op_name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span>
</span><a name="line-2801"></a><span>          </span><a name="local-6989586621680456635"><a href="#local-6989586621680456635"><span class="hs-identifier">op_ty</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span>
</span><a name="line-2802"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680456636"><a href="#local-6989586621680456636"><span class="hs-identifier">cls_pred</span></a></a><span class="hs-special">,</span><a name="local-6989586621680456637"><a href="#local-6989586621680456637"><span class="hs-identifier">tau1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitMethodTy"><span class="hs-identifier hs-var">tcSplitMethodTy</span></a><span> </span><a href="#local-6989586621680456635"><span class="hs-identifier hs-var">op_ty</span></a><span>
</span><a name="line-2803"></a><span>          </span><span class="hs-comment">-- See Note [Splitting nested sigma types in class type signatures]</span><span>
</span><a name="line-2804"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621680456638"><a href="#local-6989586621680456638"><span class="hs-identifier">op_theta</span></a></a><span class="hs-special">,</span><a name="local-6989586621680456639"><a href="#local-6989586621680456639"><span class="hs-identifier">tau2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitNestedSigmaTys"><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span></a><span> </span><a href="#local-6989586621680456637"><span class="hs-identifier hs-var">tau1</span></a><span>
</span><a name="line-2805"></a><span>
</span><a name="line-2806"></a><span>          </span><span class="hs-identifier">check_constraint</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2807"></a><span>          </span><a name="local-6989586621680456640"><a href="#local-6989586621680456640"><span class="hs-identifier">check_constraint</span></a></a><span> </span><a name="local-6989586621680456641"><a href="#local-6989586621680456641"><span class="hs-identifier">pred</span></a></a><span> </span><span class="hs-comment">-- See Note [Class method constraints]</span><span>
</span><a name="line-2808"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="VarSet.html#isEmptyVarSet"><span class="hs-identifier hs-var">isEmptyVarSet</span></a><span> </span><a href="#local-6989586621680456642"><span class="hs-identifier hs-var">pred_tvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-2809"></a><span>                    </span><a href="#local-6989586621680456642"><span class="hs-identifier hs-var">pred_tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#subVarSet"><span class="hs-identifier hs-var">subVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456624"><span class="hs-identifier hs-var">cls_tv_set</span></a><span class="hs-special">)</span><span>
</span><a name="line-2810"></a><span>                   </span><span class="hs-special">(</span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#badMethPred"><span class="hs-identifier hs-var">badMethPred</span></a><span> </span><a href="#local-6989586621680456631"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621680456641"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2811"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-2812"></a><span>              </span><a name="local-6989586621680456642"><a href="#local-6989586621680456642"><span class="hs-identifier">pred_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621680456641"><span class="hs-identifier hs-var">pred</span></a><span>
</span><a name="line-2813"></a><span>
</span><a name="line-2814"></a><span>    </span><a name="local-6989586621680456628"><a href="#local-6989586621680456628"><span class="hs-identifier">check_at</span></a></a><span> </span><span class="hs-special">(</span><a href="Class.html#ATI"><span class="hs-identifier hs-var">ATI</span></a><span> </span><a name="local-6989586621680456643"><a href="#local-6989586621680456643"><span class="hs-identifier">fam_tc</span></a></a><span> </span><a name="local-6989586621680456644"><a href="#local-6989586621680456644"><span class="hs-identifier">m_dflt_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2815"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456623"><span class="hs-identifier hs-var">cls_arity</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#any"><span class="hs-identifier hs-var">any</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456624"><span class="hs-identifier hs-var">cls_tv_set</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456645"><span class="hs-identifier hs-var">fam_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2816"></a><span>                     </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#noClassTyVarErr"><span class="hs-identifier hs-var">noClassTyVarErr</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680456643"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-2817"></a><span>                        </span><span class="hs-comment">-- Check that the associated type mentions at least</span><span>
</span><a name="line-2818"></a><span>                        </span><span class="hs-comment">-- one of the class type variables</span><span>
</span><a name="line-2819"></a><span>                        </span><span class="hs-comment">-- The check is disabled for nullary type classes,</span><span>
</span><a name="line-2820"></a><span>                        </span><span class="hs-comment">-- since there is no possible ambiguity (Trac #10020)</span><span>
</span><a name="line-2821"></a><span>
</span><a name="line-2822"></a><span>             </span><span class="hs-comment">-- Check that any default declarations for associated types are valid</span><span>
</span><a name="line-2823"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="Maybes.html#whenIsJust"><span class="hs-identifier hs-var">whenIsJust</span></a><span> </span><a href="#local-6989586621680456644"><span class="hs-identifier hs-var">m_dflt_rhs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680456647"><a href="#local-6989586621680456647"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456648"><a href="#local-6989586621680456648"><span class="hs-identifier">loc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2824"></a><span>             </span><a href="TcValidity.html#checkValidTyFamEqn"><span class="hs-identifier hs-var">checkValidTyFamEqn</span></a><span> </span><a href="#local-6989586621680456626"><span class="hs-identifier hs-var">mb_cls</span></a><span> </span><a href="#local-6989586621680456643"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-2825"></a><span>                                </span><a href="#local-6989586621680456645"><span class="hs-identifier hs-var">fam_tvs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621680456645"><span class="hs-identifier hs-var">fam_tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456647"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621680456646"><span class="hs-identifier hs-var">pp_lhs</span></a><span> </span><a href="#local-6989586621680456648"><span class="hs-identifier hs-var">loc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2826"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-2827"></a><span>          </span><a name="local-6989586621680456645"><a href="#local-6989586621680456645"><span class="hs-identifier">fam_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680456643"><span class="hs-identifier hs-var">fam_tc</span></a><span>
</span><a name="line-2828"></a><span>          </span><a name="local-6989586621680456646"><a href="#local-6989586621680456646"><span class="hs-identifier">pp_lhs</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">mkTyConApp</span></a><span> </span><a href="#local-6989586621680456643"><span class="hs-identifier hs-var">fam_tc</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="#local-6989586621680456645"><span class="hs-identifier hs-var">fam_tvs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2829"></a><span>
</span><a name="line-2830"></a><span>    </span><span class="hs-identifier">check_dm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcType.html#UserTypeCtxt"><span class="hs-identifier hs-type">UserTypeCtxt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#PredType"><span class="hs-identifier hs-type">PredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#DefMethInfo"><span class="hs-identifier hs-type">DefMethInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2831"></a><span>    </span><span class="hs-comment">-- Check validity of the /top-level/ generic-default type</span><span>
</span><a name="line-2832"></a><span>    </span><span class="hs-comment">-- E.g for   class C a where</span><span>
</span><a name="line-2833"></a><span>    </span><span class="hs-comment">--             default op :: forall b. (a~b) =&gt; blah</span><span>
</span><a name="line-2834"></a><span>    </span><span class="hs-comment">-- we do not want to do an ambiguity check on a type with</span><span>
</span><a name="line-2835"></a><span>    </span><span class="hs-comment">-- a free TyVar 'a' (Trac #11608).  See TcType</span><span>
</span><a name="line-2836"></a><span>    </span><span class="hs-comment">-- Note [TyVars and TcTyVars during type checking] in TcType</span><span>
</span><a name="line-2837"></a><span>    </span><span class="hs-comment">-- Hence the mkDefaultMethodType to close the type.</span><span>
</span><a name="line-2838"></a><span>    </span><a name="local-6989586621680456629"><a href="#local-6989586621680456629"><span class="hs-identifier">check_dm</span></a></a><span> </span><a name="local-6989586621680456649"><a href="#local-6989586621680456649"><span class="hs-identifier">ctxt</span></a></a><span> </span><a name="local-6989586621680456650"><a href="#local-6989586621680456650"><span class="hs-identifier">sel_id</span></a></a><span> </span><a name="local-6989586621680456651"><a href="#local-6989586621680456651"><span class="hs-identifier">vanilla_cls_pred</span></a></a><span> </span><a name="local-6989586621680456652"><a href="#local-6989586621680456652"><span class="hs-identifier">vanilla_tau</span></a></a><span>
</span><a name="line-2839"></a><span>             </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456653"><a href="#local-6989586621680456653"><span class="hs-identifier">dm_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456654"><a href="#local-6989586621680456654"><span class="hs-identifier">dm_spec</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="BasicTypes.html#GenericDM"><span class="hs-identifier hs-var">GenericDM</span></a><span> </span><a name="local-6989586621680456655"><a href="#local-6989586621680456655"><span class="hs-identifier">dm_ty</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2840"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456653"><span class="hs-identifier hs-var">dm_name</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2841"></a><span>            </span><span class="hs-comment">-- We have carefully set the SrcSpan on the generic</span><span>
</span><a name="line-2842"></a><span>            </span><span class="hs-comment">-- default-method Name to be that of the generic</span><span>
</span><a name="line-2843"></a><span>            </span><span class="hs-comment">-- default type signature</span><span>
</span><a name="line-2844"></a><span>
</span><a name="line-2845"></a><span>          </span><span class="hs-comment">-- First, we check that that the method's default type signature</span><span>
</span><a name="line-2846"></a><span>          </span><span class="hs-comment">-- aligns with the non-default type signature.</span><span>
</span><a name="line-2847"></a><span>          </span><span class="hs-comment">-- See Note [Default method type signatures must align]</span><span>
</span><a name="line-2848"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456656"><a href="#local-6989586621680456656"><span class="hs-identifier">cls_pred</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkClassPred"><span class="hs-identifier hs-var">mkClassPred</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCoRep.html#mkTyVarTys"><span class="hs-identifier hs-var">mkTyVarTys</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span>
</span><a name="line-2849"></a><span>              </span><span class="hs-comment">-- Note that the second field of this tuple contains the context</span><span>
</span><a name="line-2850"></a><span>              </span><span class="hs-comment">-- of the default type signature, making it apparent that we</span><span>
</span><a name="line-2851"></a><span>              </span><span class="hs-comment">-- ignore method contexts completely when validity-checking</span><span>
</span><a name="line-2852"></a><span>              </span><span class="hs-comment">-- default type signatures. See the end of</span><span>
</span><a name="line-2853"></a><span>              </span><span class="hs-comment">-- Note [Default method type signatures must align]</span><span>
</span><a name="line-2854"></a><span>              </span><span class="hs-comment">-- to learn why this is OK.</span><span>
</span><a name="line-2855"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-2856"></a><span>              </span><span class="hs-comment">-- See also</span><span>
</span><a name="line-2857"></a><span>              </span><span class="hs-comment">-- Note [Splitting nested sigma types in class type signatures]</span><span>
</span><a name="line-2858"></a><span>              </span><span class="hs-comment">-- for an explanation of why we don't use tcSplitSigmaTy here.</span><span>
</span><a name="line-2859"></a><span>              </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621680456657"><a href="#local-6989586621680456657"><span class="hs-identifier">dm_tau</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitNestedSigmaTys"><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span></a><span> </span><a href="#local-6989586621680456655"><span class="hs-identifier hs-var">dm_ty</span></a><span>
</span><a name="line-2860"></a><span>
</span><a name="line-2861"></a><span>              </span><span class="hs-comment">-- Given this class definition:</span><span>
</span><a name="line-2862"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-2863"></a><span>              </span><span class="hs-comment">--  class C a b where</span><span>
</span><a name="line-2864"></a><span>              </span><span class="hs-comment">--    op         :: forall p q. (Ord a, D p q)</span><span>
</span><a name="line-2865"></a><span>              </span><span class="hs-comment">--               =&gt; a -&gt; b -&gt; p -&gt; (a, b)</span><span>
</span><a name="line-2866"></a><span>              </span><span class="hs-comment">--    default op :: forall r s. E r</span><span>
</span><a name="line-2867"></a><span>              </span><span class="hs-comment">--               =&gt; a -&gt; b -&gt; s -&gt; (a, b)</span><span>
</span><a name="line-2868"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-2869"></a><span>              </span><span class="hs-comment">-- We want to match up two types of the form:</span><span>
</span><a name="line-2870"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-2871"></a><span>              </span><span class="hs-comment">--   Vanilla type sig: C aa bb =&gt; aa -&gt; bb -&gt; p -&gt; (aa, bb)</span><span>
</span><a name="line-2872"></a><span>              </span><span class="hs-comment">--   Default type sig: C a  b  =&gt; a  -&gt; b  -&gt; s -&gt; (a,  b)</span><span>
</span><a name="line-2873"></a><span>              </span><span class="hs-comment">--</span><span>
</span><a name="line-2874"></a><span>              </span><span class="hs-comment">-- Notice that the two type signatures can be quantified over</span><span>
</span><a name="line-2875"></a><span>              </span><span class="hs-comment">-- different class type variables! Therefore, it's important that</span><span>
</span><a name="line-2876"></a><span>              </span><span class="hs-comment">-- we include the class predicate parts to match up a with aa and</span><span>
</span><a name="line-2877"></a><span>              </span><span class="hs-comment">-- b with bb.</span><span>
</span><a name="line-2878"></a><span>              </span><a name="local-6989586621680456658"><a href="#local-6989586621680456658"><span class="hs-identifier">vanilla_phi_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkPhiTy"><span class="hs-identifier hs-var">mkPhiTy</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456651"><span class="hs-identifier hs-var">vanilla_cls_pred</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621680456652"><span class="hs-identifier hs-var">vanilla_tau</span></a><span>
</span><a name="line-2879"></a><span>              </span><a name="local-6989586621680456659"><a href="#local-6989586621680456659"><span class="hs-identifier">dm_phi_ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#mkPhiTy"><span class="hs-identifier hs-var">mkPhiTy</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456656"><span class="hs-identifier hs-var">cls_pred</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621680456657"><span class="hs-identifier hs-var">dm_tau</span></a><span>
</span><a name="line-2880"></a><span>
</span><a name="line-2881"></a><span>          </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;check_dm&quot;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span>
</span><a name="line-2882"></a><span>              </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;vanilla_phi_ty&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456658"><span class="hs-identifier hs-var">vanilla_phi_ty</span></a><span>
</span><a name="line-2883"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;dm_phi_ty&quot;</span><span>      </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456659"><span class="hs-identifier hs-var">dm_phi_ty</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-2884"></a><span>
</span><a name="line-2885"></a><span>          </span><span class="hs-comment">-- Actually checking that the types align is done with a call to</span><span>
</span><a name="line-2886"></a><span>          </span><span class="hs-comment">-- tcMatchTys. We need to get a match in both directions to rule</span><span>
</span><a name="line-2887"></a><span>          </span><span class="hs-comment">-- out degenerate cases like these:</span><span>
</span><a name="line-2888"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-2889"></a><span>          </span><span class="hs-comment">--  class Foo a where</span><span>
</span><a name="line-2890"></a><span>          </span><span class="hs-comment">--    foo1         :: a -&gt; b</span><span>
</span><a name="line-2891"></a><span>          </span><span class="hs-comment">--    default foo1 :: a -&gt; Int</span><span>
</span><a name="line-2892"></a><span>          </span><span class="hs-comment">--</span><span>
</span><a name="line-2893"></a><span>          </span><span class="hs-comment">--    foo2         :: a -&gt; Int</span><span>
</span><a name="line-2894"></a><span>          </span><span class="hs-comment">--    default foo2 :: a -&gt; b</span><span>
</span><a name="line-2895"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Unify.html#tcMatchTys"><span class="hs-identifier hs-var">tcMatchTys</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621680456659"><span class="hs-identifier hs-var">dm_phi_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456658"><span class="hs-identifier hs-var">vanilla_phi_ty</span></a><span class="hs-special">]</span><span>
</span><a name="line-2896"></a><span>                                      </span><span class="hs-special">[</span><a href="#local-6989586621680456658"><span class="hs-identifier hs-var">vanilla_phi_ty</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456659"><span class="hs-identifier hs-var">dm_phi_ty</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-2897"></a><span>               </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The default type signature for&quot;</span><span>
</span><a name="line-2898"></a><span>                     </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456650"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">)</span><span>
</span><a name="line-2899"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456655"><span class="hs-identifier hs-var">dm_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-2900"></a><span>            </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;does not match its corresponding&quot;</span><span>
</span><a name="line-2901"></a><span>                </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;non-default type signature&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2902"></a><span>
</span><a name="line-2903"></a><span>          </span><span class="hs-comment">-- Now do an ambiguity check on the default type signature.</span><span>
</span><a name="line-2904"></a><span>          </span><a href="TcValidity.html#checkValidType"><span class="hs-identifier hs-var">checkValidType</span></a><span> </span><a href="#local-6989586621680456649"><span class="hs-identifier hs-var">ctxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyDecls.html#mkDefaultMethodType"><span class="hs-identifier hs-var">mkDefaultMethodType</span></a><span> </span><a href="#local-6989586621680456617"><span class="hs-identifier hs-var">cls</span></a><span> </span><a href="#local-6989586621680456650"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="#local-6989586621680456654"><span class="hs-identifier hs-var">dm_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-2905"></a><span>    </span><span class="hs-identifier">check_dm</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2906"></a><span>
</span><a name="line-2907"></a><span class="hs-identifier">checkFamFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-2908"></a><span class="hs-comment">-- Check that we don't use families without -XTypeFamilies</span><span>
</span><a name="line-2909"></a><span class="hs-comment">-- The parser won't even parse them, but I suppose a GHC API</span><span>
</span><a name="line-2910"></a><span class="hs-comment">-- client might have a go!</span><span>
</span><a name="line-2911"></a><a name="checkFamFlag"><a href="TcTyClsDecls.html#checkFamFlag"><span class="hs-identifier">checkFamFlag</span></a></a><span> </span><a name="local-6989586621680456666"><a href="#local-6989586621680456666"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-2912"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456668"><a href="#local-6989586621680456668"><span class="hs-identifier">idx_tys</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#TypeFamilies"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TypeFamilies</span></a><span>
</span><a name="line-2913"></a><span>       </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><a href="#local-6989586621680456668"><span class="hs-identifier hs-var">idx_tys</span></a><span> </span><a href="#local-6989586621680456667"><span class="hs-identifier hs-var">err_msg</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-2914"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2915"></a><span>    </span><a name="local-6989586621680456667"><a href="#local-6989586621680456667"><span class="hs-identifier">err_msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal family declaration for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456666"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2916"></a><span>                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Enable TypeFamilies to allow indexed type families&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-2917"></a><span>
</span><a name="line-2918"></a><span class="hs-comment">{- Note [Class method constraints]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Haskell 2010 is supposed to reject
  class C a where
    op :: Eq a =&gt; a -&gt; a
where the method type constrains only the class variable(s).  (The extension
-XConstrainedClassMethods switches off this check.)  But regardless
we should not reject
  class C a where
    op :: (?x::Int) =&gt; a -&gt; a
as pointed out in Trac #11793. So the test here rejects the program if
  * -XConstrainedClassMethods is off
  * the tyvars of the constraint are non-empty
  * all the tyvars are class tyvars, none are locally quantified

Note [Abort when superclass cycle is detected]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We must avoid doing the ambiguity check for the methods (in
checkValidClass.check_op) when there are already errors accumulated.
This is because one of the errors may be a superclass cycle, and
superclass cycles cause canonicalization to loop. Here is a
representative example:

  class D a =&gt; C a where
    meth :: D a =&gt; ()
  class C a =&gt; D a

This fixes Trac #9415, #9739

Note [Default method type signatures must align]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GHC enforces the invariant that a class method's default type signature
must &quot;align&quot; with that of the method's non-default type signature, as per
GHC Trac #12918. For instance, if you have:

  class Foo a where
    bar :: forall b. Context =&gt; a -&gt; b

Then a default type signature for bar must be alpha equivalent to
(forall b. a -&gt; b). That is, the types must be the same modulo differences in
contexts. So the following would be acceptable default type signatures:

    default bar :: forall b. Context1 =&gt; a -&gt; b
    default bar :: forall x. Context2 =&gt; a -&gt; x

But the following are NOT acceptable default type signatures:

    default bar :: forall b. b -&gt; a
    default bar :: forall x. x
    default bar :: a -&gt; Int

Note that a is bound by the class declaration for Foo itself, so it is
not allowed to differ in the default type signature.

The default type signature (default bar :: a -&gt; Int) deserves special mention,
since (a -&gt; Int) is a straightforward instantiation of (forall b. a -&gt; b). To
write this, you need to declare the default type signature like so:

    default bar :: forall b. (b ~ Int). a -&gt; b

As noted in #12918, there are several reasons to do this:

1. It would make no sense to have a type that was flat-out incompatible with
   the non-default type signature. For instance, if you had:

     class Foo a where
       bar :: a -&gt; Int
       default bar :: a -&gt; Bool

   Then that would always fail in an instance declaration. So this check
   nips such cases in the bud before they have the chance to produce
   confusing error messages.

2. Internally, GHC uses TypeApplications to instantiate the default method in
   an instance. See Note [Default methods in instances] in TcInstDcls.
   Thus, GHC needs to know exactly what the universally quantified type
   variables are, and when instantiated that way, the default method's type
   must match the expected type.

3. Aesthetically, by only allowing the default type signature to differ in its
   context, we are making it more explicit the ways in which the default type
   signature is less polymorphic than the non-default type signature.

You might be wondering: why are the contexts allowed to be different, but not
the rest of the type signature? That's because default implementations often
rely on assumptions that the more general, non-default type signatures do not.
For instance, in the Enum class declaration:

    class Enum a where
      enum :: [a]
      default enum :: (Generic a, GEnum (Rep a)) =&gt; [a]
      enum = map to genum

    class GEnum f where
      genum :: [f a]

The default implementation for enum only works for types that are instances of
Generic, and for which their generic Rep type is an instance of GEnum. But
clearly enum doesn't _have_ to use this implementation, so naturally, the
context for enum is allowed to be different to accomodate this. As a result,
when we validity-check default type signatures, we ignore contexts completely.

Note that when checking whether two type signatures match, we must take care to
split as many foralls as it takes to retrieve the tau types we which to check.
See Note [Splitting nested sigma types in class type signatures].

Note [Splitting nested sigma types in class type signatures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this type synonym and class definition:

  type Traversal s t a b = forall f. Applicative f =&gt; (a -&gt; f b) -&gt; s -&gt; f t

  class Each s t a b where
    each         ::                                      Traversal s t a b
    default each :: (Traversable g, s ~ g a, t ~ g b) =&gt; Traversal s t a b

It might seem obvious that the tau types in both type signatures for `each`
are the same, but actually getting GHC to conclude this is surprisingly tricky.
That is because in general, the form of a class method's non-default type
signature is:

  forall a. C a =&gt; forall d. D d =&gt; E a b

And the general form of a default type signature is:

  forall f. F f =&gt; E a f -- The variable `a` comes from the class

So it you want to get the tau types in each type signature, you might find it
reasonable to call tcSplitSigmaTy twice on the non-default type signature, and
call it once on the default type signature. For most classes and methods, this
will work, but Each is a bit of an exceptional case. The way `each` is written,
it doesn't quantify any additional type variables besides those of the Each
class itself, so the non-default type signature for `each` is actually this:

  forall s t a b. Each s t a b =&gt; Traversal s t a b

Notice that there _appears_ to only be one forall. But there's actually another
forall lurking in the Traversal type synonym, so if you call tcSplitSigmaTy
twice, you'll also go under the forall in Traversal! That is, you'll end up
with:

  (a -&gt; f b) -&gt; s -&gt; f t

A problem arises because you only call tcSplitSigmaTy once on the default type
signature for `each`, which gives you

  Traversal s t a b

Or, equivalently:

  forall f. Applicative f =&gt; (a -&gt; f b) -&gt; s -&gt; f t

This is _not_ the same thing as (a -&gt; f b) -&gt; s -&gt; f t! So now tcMatchTy will
say that the tau types for `each` are not equal.

A solution to this problem is to use tcSplitNestedSigmaTys instead of
tcSplitSigmaTy. tcSplitNestedSigmaTys will always split any foralls that it
sees until it can't go any further, so if you called it on the default type
signature for `each`, it would return (a -&gt; f b) -&gt; s -&gt; f t like we desired.

Note [Checking partial record field]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
This check checks the partial record field selector, and warns (Trac #7169).

For example:

  data T a = A { m1 :: a, m2 :: a } | B { m1 :: a }

The function 'm2' is partial record field, and will fail when it is applied to
'B'. The warning identifies such partial fields. The check is performed at the
declaration of T, not at the call-sites of m2.

The warning can be suppressed by prefixing the field-name with an underscore.
For example:

  data T a = A { m1 :: a, _m2 :: a } | B { m1 :: a }

Note [checkValidDependency]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider

  data Proxy k (a :: k)
  data Proxy2 k a = P (Proxy k a)

(This is test dependent/should_fail/InferDependency.) While it seems GHC can
figure out the dependency between the arguments to Proxy2, this case errors.
The problem is that when we build the initial kind (getInitialKind) for
a tycon, we need to decide whether an argument is dependent or not. At first,
I thought we could just assume that *all* arguments are dependent, and then
patch it up later. However, this causes problems in error messages (where
tycon's have mysterious kinds &quot;forall (a :: k) -&gt; blah&quot;) and in unification
(where we try to unify kappa ~ forall (a :: k) -&gt; blah, failing because the
RHS is not a tau-type). Perhaps a cleverer algorithm could sort this out
(say, by storing the dependency flag in a mutable cell and by avoiding
these fancy kinds in error messages depending on the extension in effect)
but it doesn't seem worth it.

So: we choose the dependency for each argument variable once and for all
in getInitialKind. This means that any dependency must be lexically manifest.

checkValidDependency checks to make sure that no lexically non-dependent
argument actually appears in a kind. Note the example above, where the k
in Proxy2 is a dependent argument, but this fact is not lexically
manifest. checkValidDependency will reject. This function must be called
*before* kind generalization, because kind generalization works with
the result of mkTyConKind, which will think that Proxy2's kind is
Type -&gt; k -&gt; Type, where k is unbound. (It won't use a forall for a
&quot;non-dependent&quot; argument k.)
-}</span><span>
</span><a name="line-3127"></a><span>
</span><a name="line-3128"></a><span class="hs-comment">-- | See Note [checkValidDependency]</span><span>
</span><a name="line-3129"></a><span class="hs-identifier">checkValidDependency</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- zonked</span><span>
</span><a name="line-3130"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcKind"><span class="hs-identifier hs-type">TcKind</span></a><span>         </span><span class="hs-comment">-- zonked (result kind)</span><span>
</span><a name="line-3131"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3132"></a><a name="checkValidDependency"><a href="TcTyClsDecls.html#checkValidDependency"><span class="hs-identifier">checkValidDependency</span></a></a><span> </span><a name="local-6989586621680456669"><a href="#local-6989586621680456669"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621680456670"><a href="#local-6989586621680456670"><span class="hs-identifier">res_kind</span></a></a><span>
</span><a name="line-3133"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456671"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621680456670"><span class="hs-identifier hs-var">res_kind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a><span> </span><a href="#local-6989586621680456669"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">)</span><span>
</span><a name="line-3134"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3135"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarSet.html#TyCoVarSet"><span class="hs-identifier hs-type">TyCoVarSet</span></a><span>     </span><span class="hs-comment">-- fvs from scope</span><span>
</span><a name="line-3136"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCon.html#TyConBinder"><span class="hs-identifier hs-type">TyConBinder</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- binders, in reverse order</span><span>
</span><a name="line-3137"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3138"></a><span>    </span><a name="local-6989586621680456671"><a href="#local-6989586621680456671"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- all set</span><span>
</span><a name="line-3139"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621680456672"><a href="#local-6989586621680456672"><span class="hs-identifier">fvs</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621680456673"><a href="#local-6989586621680456673"><span class="hs-identifier">tcb</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621680456674"><a href="#local-6989586621680456674"><span class="hs-identifier">tcbs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3140"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#isNamedTyConBinder"><span class="hs-identifier hs-var">isNamedTyConBinder</span></a><span> </span><a href="#local-6989586621680456673"><span class="hs-identifier hs-var">tcb</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#elemVarSet"><span class="hs-identifier hs-var">elemVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456672"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-3141"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getSrcSpan"><span class="hs-identifier hs-var">getSrcSpan</span></a><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3142"></a><span>             </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Type constructor argument&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3143"></a><span>                              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is used dependently.&quot;</span><span>
</span><a name="line-3144"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Any dependent arguments must be obviously so, not inferred&quot;</span><span>
</span><a name="line-3145"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;by the type-checker.&quot;</span><span>
</span><a name="line-3146"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Inferred argument kinds:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3147"></a><span>                                 </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680456678"><span class="hs-identifier hs-var">pp_binder</span></a><span> </span><a href="#local-6989586621680456669"><span class="hs-identifier hs-var">binders</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3148"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Suggestion: use&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3149"></a><span>                              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in a kind to make the dependency clearer.&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-3150"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="#local-6989586621680456671"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680456675"><span class="hs-identifier hs-var">new_fvs</span></a><span> </span><a href="#local-6989586621680456674"><span class="hs-identifier hs-var">tcbs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3151"></a><span>
</span><a name="line-3152"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-3153"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456671"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621680456675"><span class="hs-identifier hs-var">new_fvs</span></a><span> </span><a href="#local-6989586621680456674"><span class="hs-identifier hs-var">tcbs</span></a><span>
</span><a name="line-3154"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-3155"></a><span>        </span><a name="local-6989586621680456675"><a href="#local-6989586621680456675"><span class="hs-identifier">new_fvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456672"><span class="hs-identifier hs-var">fvs</span></a><span> </span><span class="hs-special">`</span><a href="VarSet.html#delVarSet"><span class="hs-identifier hs-var">delVarSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span>
</span><a name="line-3156"></a><span>                      </span><span class="hs-special">`</span><a href="VarSet.html#unionVarSet"><span class="hs-identifier hs-var">unionVarSet</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#tyCoVarsOfType"><span class="hs-identifier hs-var">tyCoVarsOfType</span></a><span> </span><a href="#local-6989586621680456677"><span class="hs-identifier hs-var">tcb_kind</span></a><span>
</span><a name="line-3157"></a><span>
</span><a name="line-3158"></a><span>        </span><a name="local-6989586621680456676"><a href="#local-6989586621680456676"><span class="hs-identifier">tcb_var</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a><span> </span><a href="#local-6989586621680456673"><span class="hs-identifier hs-var">tcb</span></a><span>
</span><a name="line-3159"></a><span>        </span><a name="local-6989586621680456677"><a href="#local-6989586621680456677"><span class="hs-identifier">tcb_kind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680456676"><span class="hs-identifier hs-var">tcb_var</span></a><span>
</span><a name="line-3160"></a><span>
</span><a name="line-3161"></a><span>        </span><a name="local-6989586621680456678"><a href="#local-6989586621680456678"><span class="hs-identifier">pp_binder</span></a></a><span> </span><a name="local-6989586621680456679"><a href="#local-6989586621680456679"><span class="hs-identifier">binder</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#binderVar"><span class="hs-identifier hs-var">binderVar</span></a><span> </span><a href="#local-6989586621680456679"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#binderKind"><span class="hs-identifier hs-var">binderKind</span></a><span> </span><a href="#local-6989586621680456679"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">)</span><span>
</span><a name="line-3162"></a><span>
</span><a name="line-3163"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Checking role validity
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-3170"></a><span>
</span><a name="line-3171"></a><span class="hs-identifier">checkValidRoleAnnots</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TcRnTypes.html#RoleAnnotEnv"><span class="hs-identifier hs-type">RoleAnnotEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3172"></a><a name="checkValidRoleAnnots"><a href="TcTyClsDecls.html#checkValidRoleAnnots"><span class="hs-identifier">checkValidRoleAnnots</span></a></a><span> </span><a name="local-6989586621680456680"><a href="#local-6989586621680456680"><span class="hs-identifier">role_annots</span></a></a><span> </span><a name="local-6989586621680456681"><a href="#local-6989586621680456681"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-3173"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeSynonymTyCon"><span class="hs-identifier hs-var">isTypeSynonymTyCon</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456689"><span class="hs-identifier hs-var">check_no_roles</span></a><span>
</span><a name="line-3174"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isFamilyTyCon"><span class="hs-identifier hs-var">isFamilyTyCon</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456689"><span class="hs-identifier hs-var">check_no_roles</span></a><span>
</span><a name="line-3175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456688"><span class="hs-identifier hs-var">check_roles</span></a><span>
</span><a name="line-3176"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>             </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3177"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3178"></a><span>    </span><span class="hs-comment">-- Role annotations are given only on *explicit* variables,</span><span>
</span><a name="line-3179"></a><span>    </span><span class="hs-comment">-- but a tycon stores roles for all variables.</span><span>
</span><a name="line-3180"></a><span>    </span><span class="hs-comment">-- So, we drop the implicit roles (which are all Nominal, anyway).</span><span>
</span><a name="line-3181"></a><span>    </span><a name="local-6989586621680456682"><a href="#local-6989586621680456682"><span class="hs-identifier">name</span></a></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConName</span><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3182"></a><span>    </span><a name="local-6989586621680456683"><a href="#local-6989586621680456683"><span class="hs-identifier">tyvars</span></a></a><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3183"></a><span>    </span><a name="local-6989586621680456684"><a href="#local-6989586621680456684"><span class="hs-identifier">roles</span></a></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3184"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456685"><a href="#local-6989586621680456685"><span class="hs-identifier">vis_roles</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456686"><a href="#local-6989586621680456686"><span class="hs-identifier">vis_vars</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3185"></a><span>                             </span><a href="Type.html#partitionInvisibles"><span class="hs-identifier hs-var">partitionInvisibles</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3186"></a><span>                             </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.List.html#zip"><span class="hs-identifier hs-var">zip</span></a><span> </span><a href="#local-6989586621680456684"><span class="hs-identifier hs-var">roles</span></a><span> </span><a href="#local-6989586621680456683"><span class="hs-identifier hs-var">tyvars</span></a><span>
</span><a name="line-3187"></a><span>    </span><a name="local-6989586621680456687"><a href="#local-6989586621680456687"><span class="hs-identifier">role_annot_decl_maybe</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnTypes.html#lookupRoleAnnot"><span class="hs-identifier hs-var">lookupRoleAnnot</span></a><span> </span><a href="#local-6989586621680456680"><span class="hs-identifier hs-var">role_annots</span></a><span> </span><a href="#local-6989586621680456682"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-3188"></a><span>
</span><a name="line-3189"></a><span>    </span><a name="local-6989586621680456688"><a href="#local-6989586621680456688"><span class="hs-identifier">check_roles</span></a></a><span>
</span><a name="line-3190"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#whenIsJust"><span class="hs-identifier hs-var">whenIsJust</span></a><span> </span><a href="#local-6989586621680456687"><span class="hs-identifier hs-var">role_annot_decl_maybe</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3191"></a><span>          </span><span class="hs-glyph">\</span><a name="local-6989586621680456690"><a href="#local-6989586621680456690"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456691"><a href="#local-6989586621680456691"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RoleAnnotDecl"><span class="hs-identifier hs-var">RoleAnnotDecl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456692"><a href="#local-6989586621680456692"><span class="hs-identifier">the_role_annots</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-3192"></a><span>          </span><a href="TcTyClsDecls.html#addRoleAnnotCtxt"><span class="hs-identifier hs-var">addRoleAnnotCtxt</span></a><span> </span><a href="#local-6989586621680456682"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3193"></a><span>          </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456691"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-3194"></a><span>          </span><span class="hs-special">{</span><span> </span><a name="local-6989586621680456693"><a href="#local-6989586621680456693"><span class="hs-identifier">role_annots_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#RoleAnnotations"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">RoleAnnotations</span></a><span>
</span><a name="line-3195"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><a href="#local-6989586621680456693"><span class="hs-identifier hs-var">role_annots_ok</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcTyClsDecls.html#needXRoleAnnotations"><span class="hs-identifier hs-var">needXRoleAnnotations</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3196"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456686"><span class="hs-identifier hs-var">vis_vars</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456692"><span class="hs-identifier hs-var">the_role_annots</span></a><span class="hs-special">)</span><span>
</span><a name="line-3197"></a><span>                    </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#wrongNumberOfRoles"><span class="hs-identifier hs-var">wrongNumberOfRoles</span></a><span> </span><a href="#local-6989586621680456686"><span class="hs-identifier hs-var">vis_vars</span></a><span> </span><a href="#local-6989586621680456690"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-3198"></a><span>          </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="MonadUtils.html#zipWith3M"><span class="hs-identifier hs-var">zipWith3M</span></a><span> </span><a href="TcTyClsDecls.html#checkRoleAnnot"><span class="hs-identifier hs-var">checkRoleAnnot</span></a><span> </span><a href="#local-6989586621680456686"><span class="hs-identifier hs-var">vis_vars</span></a><span> </span><a href="#local-6989586621680456692"><span class="hs-identifier hs-var">the_role_annots</span></a><span> </span><a href="#local-6989586621680456685"><span class="hs-identifier hs-var">vis_roles</span></a><span>
</span><a name="line-3199"></a><span>          </span><span class="hs-comment">-- Representational or phantom roles for class parameters</span><span>
</span><a name="line-3200"></a><span>          </span><span class="hs-comment">-- quickly lead to incoherence. So, we require</span><span>
</span><a name="line-3201"></a><span>          </span><span class="hs-comment">-- IncoherentInstances to have them. See #8773, #14292</span><span>
</span><a name="line-3202"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456694"><a href="#local-6989586621680456694"><span class="hs-identifier">incoherent_roles_ok</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#xoptM"><span class="hs-identifier hs-var">xoptM</span></a><span> </span><a href="../ghc-boot-th-8.5/src/%{MODULE/./-}.html#%{NAME}/GHC.LanguageExtensions.Type.html#IncoherentInstances"><span class="hs-identifier hs-var">LangExt</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IncoherentInstances</span></a><span>
</span><a name="line-3203"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="TcRnMonad.html#checkTc"><span class="hs-identifier hs-var">checkTc</span></a><span> </span><span class="hs-special">(</span><span>  </span><a href="#local-6989586621680456694"><span class="hs-identifier hs-var">incoherent_roles_ok</span></a><span>
</span><a name="line-3204"></a><span>                    </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TyCon.html#isClassTyCon"><span class="hs-identifier hs-var">isClassTyCon</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3205"></a><span>                    </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456685"><span class="hs-identifier hs-var">vis_roles</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3206"></a><span>                    </span><a href="TcTyClsDecls.html#incoherentRoles"><span class="hs-identifier hs-var">incoherentRoles</span></a><span>
</span><a name="line-3207"></a><span>
</span><a name="line-3208"></a><span>          </span><span class="hs-special">;</span><span> </span><a name="local-6989586621680456695"><a href="#local-6989586621680456695"><span class="hs-identifier">lint</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TcRnMonad.html#goptM"><span class="hs-identifier hs-var">goptM</span></a><span> </span><a href="DynFlags.html#Opt_DoCoreLinting"><span class="hs-identifier hs-var">Opt_DoCoreLinting</span></a><span>
</span><a name="line-3209"></a><span>          </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><a href="#local-6989586621680456695"><span class="hs-identifier hs-var">lint</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcTyClsDecls.html#checkValidRoles"><span class="hs-identifier hs-var">checkValidRoles</span></a><span> </span><a href="#local-6989586621680456681"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3210"></a><span>
</span><a name="line-3211"></a><span>    </span><a name="local-6989586621680456689"><a href="#local-6989586621680456689"><span class="hs-identifier">check_no_roles</span></a></a><span>
</span><a name="line-3212"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Maybes.html#whenIsJust"><span class="hs-identifier hs-var">whenIsJust</span></a><span> </span><a href="#local-6989586621680456687"><span class="hs-identifier hs-var">role_annot_decl_maybe</span></a><span> </span><a href="TcTyClsDecls.html#illegalRoleAnnotDecl"><span class="hs-identifier hs-var">illegalRoleAnnotDecl</span></a><span>
</span><a name="line-3213"></a><span>
</span><a name="line-3214"></a><span class="hs-identifier">checkRoleAnnot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="SrcLoc.html#Located"><span class="hs-identifier hs-type">Located</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3215"></a><a name="checkRoleAnnot"><a href="TcTyClsDecls.html#checkRoleAnnot"><span class="hs-identifier">checkRoleAnnot</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span class="hs-special">)</span><span>   </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3216"></a><span class="hs-identifier">checkRoleAnnot</span><span> </span><a name="local-6989586621680456696"><a href="#local-6989586621680456696"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456697"><a href="#local-6989586621680456697"><span class="hs-identifier">r1</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680456698"><a href="#local-6989586621680456698"><span class="hs-identifier">r2</span></a></a><span>
</span><a name="line-3217"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456697"><span class="hs-identifier hs-var">r1</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621680456698"><span class="hs-identifier hs-var">r2</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3218"></a><span>    </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="TcTyClsDecls.html#badRoleAnnot"><span class="hs-identifier hs-var">badRoleAnnot</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarName"><span class="hs-identifier hs-var">tyVarName</span></a><span> </span><a href="#local-6989586621680456696"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456697"><span class="hs-identifier hs-var">r1</span></a><span> </span><a href="#local-6989586621680456698"><span class="hs-identifier hs-var">r2</span></a><span>
</span><a name="line-3219"></a><span>
</span><a name="line-3220"></a><span class="hs-comment">-- This is a double-check on the role inference algorithm. It is only run when</span><span>
</span><a name="line-3221"></a><span class="hs-comment">-- -dcore-lint is enabled. See Note [Role inference] in TcTyDecls</span><span>
</span><a name="line-3222"></a><span class="hs-identifier">checkValidRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3223"></a><span class="hs-comment">-- If you edit this function, you may need to update the GHC formalism</span><span>
</span><a name="line-3224"></a><span class="hs-comment">-- See Note [GHC Formalism] in CoreLint</span><span>
</span><a name="line-3225"></a><a name="checkValidRoles"><a href="TcTyClsDecls.html#checkValidRoles"><span class="hs-identifier">checkValidRoles</span></a></a><span> </span><a name="local-6989586621680456699"><a href="#local-6989586621680456699"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-3226"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isAlgTyCon"><span class="hs-identifier hs-var">isAlgTyCon</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3227"></a><span>    </span><span class="hs-comment">-- tyConDataCons returns an empty list for data families</span><span>
</span><a name="line-3228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><a href="#local-6989586621680456700"><span class="hs-identifier hs-var">check_dc_roles</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConDataCons"><span class="hs-identifier hs-var">tyConDataCons</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3229"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456750"><a href="#local-6989586621680456750"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="TyCon.html#synTyConRhs_maybe"><span class="hs-identifier hs-var">synTyConRhs_maybe</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3230"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#zipVarEnv"><span class="hs-identifier hs-var">zipVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">tyConTyVars</span><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621680456750"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-3231"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-3232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3233"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3234"></a><span>    </span><a name="local-6989586621680456700"><a href="#local-6989586621680456700"><span class="hs-identifier">check_dc_roles</span></a></a><span> </span><a name="local-6989586621680456704"><a href="#local-6989586621680456704"><span class="hs-identifier">datacon</span></a></a><span>
</span><a name="line-3235"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="TcRnMonad.html#traceTc"><span class="hs-identifier hs-var">traceTc</span></a><span> </span><span class="hs-string">&quot;check_dc_roles&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456704"><span class="hs-identifier hs-var">datacon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3236"></a><span>           </span><span class="hs-special">;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456713"><span class="hs-identifier hs-var">role_env</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3237"></a><span>                    </span><a href="DataCon.html#eqSpecPreds"><span class="hs-identifier hs-var">eqSpecPreds</span></a><span> </span><a href="#local-6989586621680456707"><span class="hs-identifier hs-var">eq_spec</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456708"><span class="hs-identifier hs-var">theta</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456709"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-3238"></a><span>                    </span><span class="hs-comment">-- See Note [Role-checking data constructor arguments] in TcTyDecls</span><span>
</span><a name="line-3239"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-3240"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680456705"><a href="#local-6989586621680456705"><span class="hs-identifier">univ_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456706"><a href="#local-6989586621680456706"><span class="hs-identifier">ex_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456707"><a href="#local-6989586621680456707"><span class="hs-identifier">eq_spec</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456708"><a href="#local-6989586621680456708"><span class="hs-identifier">theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456709"><a href="#local-6989586621680456709"><span class="hs-identifier">arg_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456710"><a href="#local-6989586621680456710"><span class="hs-identifier">_res_ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3241"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConFullSig"><span class="hs-identifier hs-var">dataConFullSig</span></a><span> </span><a href="#local-6989586621680456704"><span class="hs-identifier hs-var">datacon</span></a><span>
</span><a name="line-3242"></a><span>        </span><a name="local-6989586621680456711"><a href="#local-6989586621680456711"><span class="hs-identifier">univ_roles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#zipVarEnv"><span class="hs-identifier hs-var">zipVarEnv</span></a><span> </span><a href="#local-6989586621680456705"><span class="hs-identifier hs-var">univ_tvs</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621680456699"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3243"></a><span>              </span><span class="hs-comment">-- zipVarEnv uses zipEqual, but we don't want that for ex_tvs</span><span>
</span><a name="line-3244"></a><span>        </span><a name="local-6989586621680456712"><a href="#local-6989586621680456712"><span class="hs-identifier">ex_roles</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456706"><span class="hs-identifier hs-var">ex_tvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-3245"></a><span>        </span><a name="local-6989586621680456713"><a href="#local-6989586621680456713"><span class="hs-identifier">role_env</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456711"><span class="hs-identifier hs-var">univ_roles</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#plusVarEnv"><span class="hs-identifier hs-var">plusVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456712"><span class="hs-identifier hs-var">ex_roles</span></a><span>
</span><a name="line-3246"></a><span>
</span><a name="line-3247"></a><span>    </span><a name="local-6989586621680456701"><a href="#local-6989586621680456701"><span class="hs-identifier">check_ty_roles</span></a></a><span> </span><a name="local-6989586621680456714"><a href="#local-6989586621680456714"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456715"><a href="#local-6989586621680456715"><span class="hs-identifier">role</span></a></a><span> </span><a name="local-6989586621680456716"><a href="#local-6989586621680456716"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-3248"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456717"><a href="#local-6989586621680456717"><span class="hs-identifier">ty'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#coreView"><span class="hs-identifier hs-var">coreView</span></a><span> </span><a href="#local-6989586621680456716"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-comment">-- #14101</span><span>
</span><a name="line-3249"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456714"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456715"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456717"><span class="hs-identifier hs-var">ty'</span></a><span>
</span><a name="line-3250"></a><span>
</span><a name="line-3251"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456718"><a href="#local-6989586621680456718"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456719"><a href="#local-6989586621680456719"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyVarTy"><span class="hs-identifier hs-var">TyVarTy</span></a><span> </span><a name="local-6989586621680456720"><a href="#local-6989586621680456720"><span class="hs-identifier">tv</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3252"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621680456718"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456720"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-3253"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Just"><span class="hs-identifier hs-var">Just</span></a><span> </span><a name="local-6989586621680456721"><a href="#local-6989586621680456721"><span class="hs-identifier">role'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456721"><span class="hs-identifier hs-var">role'</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#ltRole"><span class="hs-identifier hs-var">ltRole</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621680456719"><span class="hs-identifier hs-var">role</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456721"><span class="hs-identifier hs-var">role'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621680456719"><span class="hs-identifier hs-var">role</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3254"></a><span>                        </span><a href="#local-6989586621680456703"><span class="hs-identifier hs-var">report_error</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type variable&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456720"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3255"></a><span>                                       </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cannot have role&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456719"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3256"></a><span>                                       </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;because it was assigned role&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456721"><span class="hs-identifier hs-var">role'</span></a><span>
</span><a name="line-3257"></a><span>          </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680456703"><span class="hs-identifier hs-var">report_error</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type variable&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456720"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3258"></a><span>                                       </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;missing in environment&quot;</span><span>
</span><a name="line-3259"></a><span>
</span><a name="line-3260"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456722"><a href="#local-6989586621680456722"><span class="hs-identifier">env</span></a></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><a name="local-6989586621680456723"><a href="#local-6989586621680456723"><span class="hs-identifier">tc</span></a></a><span> </span><a name="local-6989586621680456724"><a href="#local-6989586621680456724"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3261"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680456725"><a href="#local-6989586621680456725"><span class="hs-identifier">roles'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCon.html#tyConRoles"><span class="hs-identifier hs-var">tyConRoles</span></a><span> </span><a href="#local-6989586621680456723"><span class="hs-identifier hs-var">tc</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-3262"></a><span>        </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#zipWithM_"><span class="hs-identifier hs-var">zipWithM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456702"><span class="hs-identifier hs-var">maybe_check_ty_roles</span></a><span> </span><a href="#local-6989586621680456722"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456725"><span class="hs-identifier hs-var">roles'</span></a><span> </span><a href="#local-6989586621680456724"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-3263"></a><span>
</span><a name="line-3264"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456726"><a href="#local-6989586621680456726"><span class="hs-identifier">env</span></a></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456727"><a href="#local-6989586621680456727"><span class="hs-identifier">tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3265"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456726"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456727"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-3266"></a><span>
</span><a name="line-3267"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><span class="hs-identifier">_</span><span>   </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span> </span><a name="local-6989586621680456728"><a href="#local-6989586621680456728"><span class="hs-identifier">ty</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="TyCoRep.html#TyConApp"><span class="hs-identifier hs-var">TyConApp</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-3268"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;check_ty_roles&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456728"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-3269"></a><span>
</span><a name="line-3270"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456729"><a href="#local-6989586621680456729"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456730"><a href="#local-6989586621680456730"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#AppTy"><span class="hs-identifier hs-var">AppTy</span></a><span> </span><a name="local-6989586621680456731"><a href="#local-6989586621680456731"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621680456732"><a href="#local-6989586621680456732"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3271"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456729"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456730"><span class="hs-identifier hs-var">role</span></a><span>    </span><a href="#local-6989586621680456731"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-3272"></a><span>      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456729"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621680456732"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-3273"></a><span>
</span><a name="line-3274"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456733"><a href="#local-6989586621680456733"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456734"><a href="#local-6989586621680456734"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#FunTy"><span class="hs-identifier hs-var">FunTy</span></a><span> </span><a name="local-6989586621680456735"><a href="#local-6989586621680456735"><span class="hs-identifier">ty1</span></a></a><span> </span><a name="local-6989586621680456736"><a href="#local-6989586621680456736"><span class="hs-identifier">ty2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3275"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456733"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456734"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456735"><span class="hs-identifier hs-var">ty1</span></a><span>
</span><a name="line-3276"></a><span>      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456733"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456734"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456736"><span class="hs-identifier hs-var">ty2</span></a><span>
</span><a name="line-3277"></a><span>
</span><a name="line-3278"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456737"><a href="#local-6989586621680456737"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456738"><a href="#local-6989586621680456738"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#ForAllTy"><span class="hs-identifier hs-var">ForAllTy</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#TvBndr"><span class="hs-identifier hs-var">TvBndr</span></a><span> </span><a name="local-6989586621680456739"><a href="#local-6989586621680456739"><span class="hs-identifier">tv</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621680456740"><a href="#local-6989586621680456740"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3279"></a><span>      </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456737"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#tyVarKind"><span class="hs-identifier hs-var">tyVarKind</span></a><span> </span><a href="#local-6989586621680456739"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">)</span><span>
</span><a name="line-3280"></a><span>      </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621680456737"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456739"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456738"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456740"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-3281"></a><span>
</span><a name="line-3282"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>    </span><span class="hs-special">(</span><a href="TyCoRep.html#LitTy"><span class="hs-identifier hs-var">LitTy</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3283"></a><span>
</span><a name="line-3284"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><a name="local-6989586621680456741"><a href="#local-6989586621680456741"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456742"><a href="#local-6989586621680456742"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CastTy"><span class="hs-identifier hs-var">CastTy</span></a><span> </span><a name="local-6989586621680456743"><a href="#local-6989586621680456743"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>
</span><a name="line-3285"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456741"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456742"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456743"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-3286"></a><span>
</span><a name="line-3287"></a><span>    </span><span class="hs-identifier">check_ty_roles</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621680456744"><a href="#local-6989586621680456744"><span class="hs-identifier">role</span></a></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#CoercionTy"><span class="hs-identifier hs-var">CoercionTy</span></a><span> </span><a name="local-6989586621680456745"><a href="#local-6989586621680456745"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3288"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456744"><span class="hs-identifier hs-var">role</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Phantom"><span class="hs-identifier hs-var">Phantom</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3289"></a><span>        </span><a href="#local-6989586621680456703"><span class="hs-identifier hs-var">report_error</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;coercion&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456745"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has bad role&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456744"><span class="hs-identifier hs-var">role</span></a><span>
</span><a name="line-3290"></a><span>
</span><a name="line-3291"></a><span>    </span><a name="local-6989586621680456702"><a href="#local-6989586621680456702"><span class="hs-identifier">maybe_check_ty_roles</span></a></a><span> </span><a name="local-6989586621680456746"><a href="#local-6989586621680456746"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621680456747"><a href="#local-6989586621680456747"><span class="hs-identifier">role</span></a></a><span> </span><a name="local-6989586621680456748"><a href="#local-6989586621680456748"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-3292"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456747"><span class="hs-identifier hs-var">role</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621680456747"><span class="hs-identifier hs-var">role</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3293"></a><span>        </span><a href="#local-6989586621680456701"><span class="hs-identifier hs-var">check_ty_roles</span></a><span> </span><a href="#local-6989586621680456746"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621680456747"><span class="hs-identifier hs-var">role</span></a><span> </span><a href="#local-6989586621680456748"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-3294"></a><span>
</span><a name="line-3295"></a><span>    </span><a name="local-6989586621680456703"><a href="#local-6989586621680456703"><span class="hs-identifier">report_error</span></a></a><span> </span><a name="local-6989586621680456749"><a href="#local-6989586621680456749"><span class="hs-identifier">doc</span></a></a><span>
</span><a name="line-3296"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Internal error in role inference:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3297"></a><span>                         </span><a href="#local-6989586621680456749"><span class="hs-identifier hs-var">doc</span></a><span class="hs-special">,</span><span>
</span><a name="line-3298"></a><span>                         </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Please report this as a GHC bug: http://www.haskell.org/ghc/reportabug&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-3299"></a><span>
</span><a name="line-3300"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Error messages
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-3307"></a><span>
</span><a name="line-3308"></a><span class="hs-identifier">tcAddTyFamInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#TyFamInstDecl"><span class="hs-identifier hs-type">TyFamInstDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455911"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455911"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3309"></a><a name="tcAddTyFamInstCtxt"><a href="TcTyClsDecls.html#tcAddTyFamInstCtxt"><span class="hs-identifier">tcAddTyFamInstCtxt</span></a></a><span> </span><a name="local-6989586621680456751"><a href="#local-6989586621680456751"><span class="hs-identifier">decl</span></a></a><span>
</span><a name="line-3310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#tcAddFamInstCtxt"><span class="hs-identifier hs-var">tcAddFamInstCtxt</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type instance&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#tyFamInstDeclName"><span class="hs-identifier hs-var">tyFamInstDeclName</span></a><span> </span><a href="#local-6989586621680456751"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-3311"></a><span>
</span><a name="line-3312"></a><span class="hs-identifier">tcMkDataFamInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#DataFamInstDecl"><span class="hs-identifier hs-type">DataFamInstDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3313"></a><a name="tcMkDataFamInstCtxt"><a href="TcTyClsDecls.html#tcMkDataFamInstCtxt"><span class="hs-identifier">tcMkDataFamInstCtxt</span></a></a><span> </span><a name="local-6989586621680456752"><a href="#local-6989586621680456752"><span class="hs-identifier">decl</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="HsDecls.html#DataFamInstDecl"><span class="hs-identifier hs-var">DataFamInstDecl</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">dfid_eqn</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-3314"></a><span>                            </span><a href="HsTypes.html#HsIB"><span class="hs-identifier hs-var">HsIB</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">hsib_body</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621680456753"><a href="#local-6989586621680456753"><span class="hs-identifier">eqn</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-3315"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcTyClsDecls.html#tcMkFamInstCtxt"><span class="hs-identifier hs-var">tcMkFamInstCtxt</span></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#pprDataFamInstFlavour"><span class="hs-identifier hs-var">pprDataFamInstFlavour</span></a><span> </span><a href="#local-6989586621680456752"><span class="hs-identifier hs-var">decl</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;instance&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3316"></a><span>                    </span><span class="hs-special">(</span><a href="SrcLoc.html#unLoc"><span class="hs-identifier hs-var">unLoc</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">feqn_tycon</span><span> </span><a href="#local-6989586621680456753"><span class="hs-identifier hs-var">eqn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3317"></a><span>
</span><a name="line-3318"></a><span class="hs-identifier">tcAddDataFamInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#DataFamInstDecl"><span class="hs-identifier hs-type">DataFamInstDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455910"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455910"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3319"></a><a name="tcAddDataFamInstCtxt"><a href="TcTyClsDecls.html#tcAddDataFamInstCtxt"><span class="hs-identifier">tcAddDataFamInstCtxt</span></a></a><span> </span><a name="local-6989586621680456754"><a href="#local-6989586621680456754"><span class="hs-identifier">decl</span></a></a><span>
</span><a name="line-3320"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#tcMkDataFamInstCtxt"><span class="hs-identifier hs-var">tcMkDataFamInstCtxt</span></a><span> </span><a href="#local-6989586621680456754"><span class="hs-identifier hs-var">decl</span></a><span class="hs-special">)</span><span>
</span><a name="line-3321"></a><span>
</span><a name="line-3322"></a><span class="hs-identifier">tcMkFamInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3323"></a><a name="tcMkFamInstCtxt"><a href="TcTyClsDecls.html#tcMkFamInstCtxt"><span class="hs-identifier">tcMkFamInstCtxt</span></a></a><span> </span><a name="local-6989586621680456755"><a href="#local-6989586621680456755"><span class="hs-identifier">flavour</span></a></a><span> </span><a name="local-6989586621680456756"><a href="#local-6989586621680456756"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-3324"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680456755"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;declaration for&quot;</span><span>
</span><a name="line-3325"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456756"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3326"></a><span>
</span><a name="line-3327"></a><span class="hs-identifier">tcAddFamInstCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455909"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455909"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3328"></a><a name="tcAddFamInstCtxt"><a href="TcTyClsDecls.html#tcAddFamInstCtxt"><span class="hs-identifier">tcAddFamInstCtxt</span></a></a><span> </span><a name="local-6989586621680456757"><a href="#local-6989586621680456757"><span class="hs-identifier">flavour</span></a></a><span> </span><a name="local-6989586621680456758"><a href="#local-6989586621680456758"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621680456759"><a href="#local-6989586621680456759"><span class="hs-identifier">thing_inside</span></a></a><span>
</span><a name="line-3329"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><span class="hs-special">(</span><a href="TcTyClsDecls.html#tcMkFamInstCtxt"><span class="hs-identifier hs-var">tcMkFamInstCtxt</span></a><span> </span><a href="#local-6989586621680456757"><span class="hs-identifier hs-var">flavour</span></a><span> </span><a href="#local-6989586621680456758"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680456759"><span class="hs-identifier hs-var">thing_inside</span></a><span>
</span><a name="line-3330"></a><span>
</span><a name="line-3331"></a><span class="hs-identifier">tcAddClosedTypeFamilyDeclCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455908"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455908"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3332"></a><a name="tcAddClosedTypeFamilyDeclCtxt"><a href="TcTyClsDecls.html#tcAddClosedTypeFamilyDeclCtxt"><span class="hs-identifier">tcAddClosedTypeFamilyDeclCtxt</span></a></a><span> </span><a name="local-6989586621680456760"><a href="#local-6989586621680456760"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-3333"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-6989586621680456761"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-3334"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3335"></a><span>    </span><a name="local-6989586621680456761"><a href="#local-6989586621680456761"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the equations for closed type family&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3336"></a><span>           </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456760"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3337"></a><span>
</span><a name="line-3338"></a><span class="hs-identifier">resultTypeMisMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FieldLabel.html#FieldLabelString"><span class="hs-identifier hs-type">FieldLabelString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3339"></a><a name="resultTypeMisMatch"><a href="TcTyClsDecls.html#resultTypeMisMatch"><span class="hs-identifier">resultTypeMisMatch</span></a></a><span> </span><a name="local-6989586621680456762"><a href="#local-6989586621680456762"><span class="hs-identifier">field_name</span></a></a><span> </span><a name="local-6989586621680456763"><a href="#local-6989586621680456763"><span class="hs-identifier">con1</span></a></a><span> </span><a name="local-6989586621680456764"><a href="#local-6989586621680456764"><span class="hs-identifier">con2</span></a></a><span>
</span><a name="line-3340"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Constructors&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456763"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456764"><span class="hs-identifier hs-var">con2</span></a><span class="hs-special">,</span><span>
</span><a name="line-3341"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;have a common field&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456762"><span class="hs-identifier hs-var">field_name</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-3342"></a><span>          </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but have different result types&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-3343"></a><span>
</span><a name="line-3344"></a><span class="hs-identifier">fieldTypeMisMatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="FieldLabel.html#FieldLabelString"><span class="hs-identifier hs-type">FieldLabelString</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3345"></a><a name="fieldTypeMisMatch"><a href="TcTyClsDecls.html#fieldTypeMisMatch"><span class="hs-identifier">fieldTypeMisMatch</span></a></a><span> </span><a name="local-6989586621680456765"><a href="#local-6989586621680456765"><span class="hs-identifier">field_name</span></a></a><span> </span><a name="local-6989586621680456766"><a href="#local-6989586621680456766"><span class="hs-identifier">con1</span></a></a><span> </span><a name="local-6989586621680456767"><a href="#local-6989586621680456767"><span class="hs-identifier">con2</span></a></a><span>
</span><a name="line-3346"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Constructors&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456766"><span class="hs-identifier hs-var">con1</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;and&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456767"><span class="hs-identifier hs-var">con2</span></a><span class="hs-special">,</span><span>
</span><a name="line-3347"></a><span>         </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;give different types for field&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456765"><span class="hs-identifier hs-var">field_name</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-3348"></a><span>
</span><a name="line-3349"></a><span class="hs-identifier">dataConCtxtName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="SrcLoc.html#Located"><span class="hs-identifier hs-type">Located</span></a><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3350"></a><a name="dataConCtxtName"><a href="TcTyClsDecls.html#dataConCtxtName"><span class="hs-identifier">dataConCtxtName</span></a></a><span> </span><span class="hs-special">[</span><a name="local-6989586621680456768"><a href="#local-6989586621680456768"><span class="hs-identifier">con</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-3351"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the definition of data constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456768"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-3352"></a><span class="hs-identifier">dataConCtxtName</span><span> </span><a name="local-6989586621680456769"><a href="#local-6989586621680456769"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-3353"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the definition of data constructors&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#interpp%27SP"><span class="hs-identifier hs-var">interpp'SP</span></a><span> </span><a href="#local-6989586621680456769"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-3354"></a><span>
</span><a name="line-3355"></a><span class="hs-identifier">dataConCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621680455907"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680455907"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3356"></a><a name="dataConCtxt"><a href="TcTyClsDecls.html#dataConCtxt"><span class="hs-identifier">dataConCtxt</span></a></a><span> </span><a name="local-6989586621680456770"><a href="#local-6989586621680456770"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the definition of data constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456770"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-3357"></a><span>
</span><a name="line-3358"></a><span class="hs-identifier">classOpCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3359"></a><a name="classOpCtxt"><a href="TcTyClsDecls.html#classOpCtxt"><span class="hs-identifier">classOpCtxt</span></a></a><span> </span><a name="local-6989586621680456771"><a href="#local-6989586621680456771"><span class="hs-identifier">sel_id</span></a></a><span> </span><a name="local-6989586621680456772"><a href="#local-6989586621680456772"><span class="hs-identifier">tau</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;When checking the class method:&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3360"></a><span>                              </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#pprPrefixOcc"><span class="hs-identifier hs-var">pprPrefixOcc</span></a><span> </span><a href="#local-6989586621680456771"><span class="hs-identifier hs-var">sel_id</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456772"><span class="hs-identifier hs-var">tau</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-3361"></a><span>
</span><a name="line-3362"></a><span class="hs-identifier">classArityErr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3363"></a><a name="classArityErr"><a href="TcTyClsDecls.html#classArityErr"><span class="hs-identifier">classArityErr</span></a></a><span> </span><a name="local-6989586621680456773"><a href="#local-6989586621680456773"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621680456774"><a href="#local-6989586621680456774"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-3364"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680456773"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456775"><span class="hs-identifier hs-var">mkErr</span></a><span> </span><span class="hs-string">&quot;No&quot;</span><span> </span><span class="hs-string">&quot;no-parameter&quot;</span><span>
</span><a name="line-3365"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456775"><span class="hs-identifier hs-var">mkErr</span></a><span> </span><span class="hs-string">&quot;Too many&quot;</span><span> </span><span class="hs-string">&quot;multi-parameter&quot;</span><span>
</span><a name="line-3366"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3367"></a><span>    </span><a name="local-6989586621680456775"><a href="#local-6989586621680456775"><span class="hs-identifier">mkErr</span></a></a><span> </span><a name="local-6989586621680456776"><a href="#local-6989586621680456776"><span class="hs-identifier">howMany</span></a></a><span> </span><a name="local-6989586621680456777"><a href="#local-6989586621680456777"><span class="hs-identifier">allowWhat</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-3368"></a><span>        </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456776"><span class="hs-identifier hs-var">howMany</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; parameters for class&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456774"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-3369"></a><span>              </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Enable MultiParamTypeClasses to allow &quot;</span><span>
</span><a name="line-3370"></a><span>                                    </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456777"><span class="hs-identifier hs-var">allowWhat</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><span class="hs-string">&quot; classes&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-3371"></a><span>
</span><a name="line-3372"></a><span class="hs-identifier">classFunDepsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3373"></a><a name="classFunDepsErr"><a href="TcTyClsDecls.html#classFunDepsErr"><span class="hs-identifier">classFunDepsErr</span></a></a><span> </span><a name="local-6989586621680456778"><a href="#local-6989586621680456778"><span class="hs-identifier">cls</span></a></a><span>
</span><a name="line-3374"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Fundeps in class&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456778"><span class="hs-identifier hs-var">cls</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-3375"></a><span>          </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Enable FunctionalDependencies to allow fundeps&quot;</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-3376"></a><span>
</span><a name="line-3377"></a><span class="hs-identifier">badMethPred</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcType.html#TcPredType"><span class="hs-identifier hs-type">TcPredType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3378"></a><a name="badMethPred"><a href="TcTyClsDecls.html#badMethPred"><span class="hs-identifier">badMethPred</span></a></a><span> </span><a name="local-6989586621680456779"><a href="#local-6989586621680456779"><span class="hs-identifier">sel_id</span></a></a><span> </span><a name="local-6989586621680456780"><a href="#local-6989586621680456780"><span class="hs-identifier">pred</span></a></a><span>
</span><a name="line-3379"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Constraint&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456780"><span class="hs-identifier hs-var">pred</span></a><span class="hs-special">)</span><span>
</span><a name="line-3380"></a><span>                 </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in the type of&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456779"><span class="hs-identifier hs-var">sel_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3381"></a><span>              </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;constrains only the class type variables&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3382"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Enable ConstrainedClassMethods to allow it&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3383"></a><span>
</span><a name="line-3384"></a><span class="hs-identifier">noClassTyVarErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Class.html#Class"><span class="hs-identifier hs-type">Class</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3385"></a><a name="noClassTyVarErr"><a href="TcTyClsDecls.html#noClassTyVarErr"><span class="hs-identifier">noClassTyVarErr</span></a></a><span> </span><a name="local-6989586621680456781"><a href="#local-6989586621680456781"><span class="hs-identifier">clas</span></a></a><span> </span><a name="local-6989586621680456782"><a href="#local-6989586621680456782"><span class="hs-identifier">fam_tc</span></a></a><span>
</span><a name="line-3386"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The associated type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456782"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3387"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;mentions none of the type or kind variables of the class&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3388"></a><span>                </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456781"><span class="hs-identifier hs-var">clas</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">classTyVars</span><span> </span><a href="#local-6989586621680456781"><span class="hs-identifier hs-var">clas</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-3389"></a><span>
</span><a name="line-3390"></a><span class="hs-identifier">badDataConTyCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3391"></a><a name="badDataConTyCon"><a href="TcTyClsDecls.html#badDataConTyCon"><span class="hs-identifier">badDataConTyCon</span></a></a><span> </span><a name="local-6989586621680456783"><a href="#local-6989586621680456783"><span class="hs-identifier">data_con</span></a></a><span> </span><a name="local-6989586621680456784"><a href="#local-6989586621680456784"><span class="hs-identifier">res_ty_tmpl</span></a></a><span> </span><a name="local-6989586621680456785"><a href="#local-6989586621680456785"><span class="hs-identifier">actual_res_ty</span></a></a><span>
</span><a name="line-3392"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="TcType.html#tcIsForAllTy"><span class="hs-identifier hs-var">tcIsForAllTy</span></a><span> </span><a href="#local-6989586621680456785"><span class="hs-identifier hs-var">actual_res_ty</span></a><span>
</span><a name="line-3393"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456786"><span class="hs-identifier hs-var">nested_foralls_contexts_suggestion</span></a><span>
</span><a name="line-3394"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a><span> </span><span class="hs-special">(</span><a href="TcType.html#tcSplitPredFunTy_maybe"><span class="hs-identifier hs-var">tcSplitPredFunTy_maybe</span></a><span> </span><a href="#local-6989586621680456785"><span class="hs-identifier hs-var">actual_res_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-3395"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680456786"><span class="hs-identifier hs-var">nested_foralls_contexts_suggestion</span></a><span>
</span><a name="line-3396"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span>
</span><a name="line-3397"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456783"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3398"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;returns type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456785"><span class="hs-identifier hs-var">actual_res_ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3399"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;instead of an instance of its parent type&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456784"><span class="hs-identifier hs-var">res_ty_tmpl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3400"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3401"></a><span>    </span><span class="hs-comment">-- This suggestion is useful for suggesting how to correct code like what</span><span>
</span><a name="line-3402"></a><span>    </span><span class="hs-comment">-- was reported in Trac #12087:</span><span>
</span><a name="line-3403"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-3404"></a><span>    </span><span class="hs-comment">--   data F a where</span><span>
</span><a name="line-3405"></a><span>    </span><span class="hs-comment">--     MkF :: Ord a =&gt; Eq a =&gt; a -&gt; F a</span><span>
</span><a name="line-3406"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-3407"></a><span>    </span><span class="hs-comment">-- Although nested foralls or contexts are allowed in function type</span><span>
</span><a name="line-3408"></a><span>    </span><span class="hs-comment">-- signatures, it is much more difficult to engineer GADT constructor type</span><span>
</span><a name="line-3409"></a><span>    </span><span class="hs-comment">-- signatures to allow something similar, so we error in the latter case.</span><span>
</span><a name="line-3410"></a><span>    </span><span class="hs-comment">-- Nevertheless, we can at least suggest how a user might reshuffle their</span><span>
</span><a name="line-3411"></a><span>    </span><span class="hs-comment">-- exotic GADT constructor type signature so that GHC will accept.</span><span>
</span><a name="line-3412"></a><span>    </span><a name="local-6989586621680456786"><a href="#local-6989586621680456786"><span class="hs-identifier">nested_foralls_contexts_suggestion</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-3413"></a><span>      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;GADT constructor type signature cannot contain nested&quot;</span><span>
</span><a name="line-3414"></a><span>      </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><a href="Outputable.html#forAllLit"><span class="hs-identifier hs-var">forAllLit</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;s or contexts&quot;</span><span>
</span><a name="line-3415"></a><span>      </span><a href="Outputable.html#%24%2B%24"><span class="hs-operator hs-var">$+$</span></a><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Suggestion: instead use this type signature:&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3416"></a><span>             </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConName"><span class="hs-identifier hs-var">dataConName</span></a><span> </span><a href="#local-6989586621680456783"><span class="hs-identifier hs-var">data_con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456792"><span class="hs-identifier hs-var">suggested_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-3417"></a><span>
</span><a name="line-3418"></a><span>    </span><span class="hs-comment">-- To construct a type that GHC would accept (suggested_ty), we:</span><span>
</span><a name="line-3419"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-3420"></a><span>    </span><span class="hs-comment">-- 1) Find the existentially quantified type variables and the class</span><span>
</span><a name="line-3421"></a><span>    </span><span class="hs-comment">--    predicates from the datacon. (NB: We don't need the universally</span><span>
</span><a name="line-3422"></a><span>    </span><span class="hs-comment">--    quantified type variables, since rejigConRes won't substitute them in</span><span>
</span><a name="line-3423"></a><span>    </span><span class="hs-comment">--    the result type if it fails, as in this scenario.)</span><span>
</span><a name="line-3424"></a><span>    </span><span class="hs-comment">-- 2) Split apart the return type (which is headed by a forall or a</span><span>
</span><a name="line-3425"></a><span>    </span><span class="hs-comment">--    context) using tcSplitNestedSigmaTys, collecting the type variables</span><span>
</span><a name="line-3426"></a><span>    </span><span class="hs-comment">--    and class predicates we find, as well as the rho type lurking</span><span>
</span><a name="line-3427"></a><span>    </span><span class="hs-comment">--    underneath the nested foralls and contexts.</span><span>
</span><a name="line-3428"></a><span>    </span><span class="hs-comment">-- 3) Smash together the type variables and class predicates from 1) and</span><span>
</span><a name="line-3429"></a><span>    </span><span class="hs-comment">--    2), and prepend them to the rho type from 2).</span><span>
</span><a name="line-3430"></a><span>    </span><a name="local-6989586621680456787"><a href="#local-6989586621680456787"><span class="hs-identifier">actual_ex_tvs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConExTyVars"><span class="hs-identifier hs-var">dataConExTyVars</span></a><span> </span><a href="#local-6989586621680456783"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-3431"></a><span>    </span><a name="local-6989586621680456788"><a href="#local-6989586621680456788"><span class="hs-identifier">actual_theta</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConTheta"><span class="hs-identifier hs-var">dataConTheta</span></a><span> </span><a href="#local-6989586621680456783"><span class="hs-identifier hs-var">data_con</span></a><span>
</span><a name="line-3432"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680456789"><a href="#local-6989586621680456789"><span class="hs-identifier">actual_res_tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456790"><a href="#local-6989586621680456790"><span class="hs-identifier">actual_res_theta</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680456791"><a href="#local-6989586621680456791"><span class="hs-identifier">actual_res_rho</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-3433"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TcType.html#tcSplitNestedSigmaTys"><span class="hs-identifier hs-var">tcSplitNestedSigmaTys</span></a><span> </span><a href="#local-6989586621680456785"><span class="hs-identifier hs-var">actual_res_ty</span></a><span>
</span><a name="line-3434"></a><span>    </span><a name="local-6989586621680456792"><a href="#local-6989586621680456792"><span class="hs-identifier">suggested_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkSpecForAllTys"><span class="hs-identifier hs-var">mkSpecForAllTys</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456787"><span class="hs-identifier hs-var">actual_ex_tvs</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456789"><span class="hs-identifier hs-var">actual_res_tvs</span></a><span class="hs-special">)</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3435"></a><span>                   </span><a href="TyCoRep.html#mkFunTys"><span class="hs-identifier hs-var">mkFunTys</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621680456788"><span class="hs-identifier hs-var">actual_theta</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a><span> </span><a href="#local-6989586621680456790"><span class="hs-identifier hs-var">actual_res_theta</span></a><span class="hs-special">)</span><span>
</span><a name="line-3436"></a><span>                   </span><a href="#local-6989586621680456791"><span class="hs-identifier hs-var">actual_res_rho</span></a><span>
</span><a name="line-3437"></a><span>
</span><a name="line-3438"></a><span class="hs-identifier">badGadtDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3439"></a><a name="badGadtDecl"><a href="TcTyClsDecls.html#badGadtDecl"><span class="hs-identifier">badGadtDecl</span></a></a><span> </span><a name="local-6989586621680456793"><a href="#local-6989586621680456793"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-3440"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal generalised algebraic data declaration for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456793"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-3441"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Enable the GADTs extension to allow this&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3442"></a><span>
</span><a name="line-3443"></a><span class="hs-identifier">badExistential</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3444"></a><a name="badExistential"><a href="TcTyClsDecls.html#badExistential"><span class="hs-identifier">badExistential</span></a></a><span> </span><a name="local-6989586621680456794"><a href="#local-6989586621680456794"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-3445"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456794"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3446"></a><span>                </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has existential type variables, a context, or a specialised result type&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3447"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456794"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#dcolon"><span class="hs-identifier hs-var">dcolon</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUserType"><span class="hs-identifier hs-var">dataConUserType</span></a><span> </span><a href="#local-6989586621680456794"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-3448"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Enable ExistentialQuantification or GADTs to allow this&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-3449"></a><span>
</span><a name="line-3450"></a><span class="hs-identifier">badGADT</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="DataCon.html#EqSpec"><span class="hs-identifier hs-type">EqSpec</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3451"></a><a name="badGADT"><a href="TcTyClsDecls.html#badGADT"><span class="hs-identifier">badGADT</span></a></a><span> </span><a name="local-6989586621680456795"><a href="#local-6989586621680456795"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621680456796"><a href="#local-6989586621680456796"><span class="hs-identifier">eq_specs</span></a></a><span>
</span><a name="line-3452"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Data constructor&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456795"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3453"></a><span>               </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;constrains the choice of kind parameter&quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#plural"><span class="hs-identifier hs-var">plural</span></a><span> </span><a href="#local-6989586621680456796"><span class="hs-identifier hs-var">eq_specs</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">)</span><span>
</span><a name="line-3454"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a><span> </span><a href="#local-6989586621680456797"><span class="hs-identifier hs-var">ppr_eq_spec</span></a><span> </span><a href="#local-6989586621680456796"><span class="hs-identifier hs-var">eq_specs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-3455"></a><span>    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use TypeInType to allow this&quot;</span><span>
</span><a name="line-3456"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3457"></a><span>    </span><a name="local-6989586621680456797"><a href="#local-6989586621680456797"><span class="hs-identifier">ppr_eq_spec</span></a></a><span> </span><a name="local-6989586621680456798"><a href="#local-6989586621680456798"><span class="hs-identifier">eq_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#eqSpecTyVar"><span class="hs-identifier hs-var">eqSpecTyVar</span></a><span> </span><a href="#local-6989586621680456798"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'~'</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#eqSpecType"><span class="hs-identifier hs-var">eqSpecType</span></a><span> </span><a href="#local-6989586621680456798"><span class="hs-identifier hs-var">eq_spec</span></a><span class="hs-special">)</span><span>
</span><a name="line-3458"></a><span>
</span><a name="line-3459"></a><span class="hs-identifier">badStupidTheta</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3460"></a><a name="badStupidTheta"><a href="TcTyClsDecls.html#badStupidTheta"><span class="hs-identifier">badStupidTheta</span></a></a><span> </span><a name="local-6989586621680456799"><a href="#local-6989586621680456799"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-3461"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A data type declared in GADT style cannot have a context:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456799"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-3462"></a><span>
</span><a name="line-3463"></a><span class="hs-identifier">newtypeConError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3464"></a><a name="newtypeConError"><a href="TcTyClsDecls.html#newtypeConError"><span class="hs-identifier">newtypeConError</span></a></a><span> </span><a name="local-6989586621680456800"><a href="#local-6989586621680456800"><span class="hs-identifier">tycon</span></a></a><span> </span><a name="local-6989586621680456801"><a href="#local-6989586621680456801"><span class="hs-identifier">n</span></a></a><span>
</span><a name="line-3465"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype must have exactly one constructor,&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3466"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456800"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#speakN"><span class="hs-identifier hs-var">speakN</span></a><span> </span><a href="#local-6989586621680456801"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3467"></a><span>
</span><a name="line-3468"></a><span class="hs-identifier">newtypeStrictError</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3469"></a><a name="newtypeStrictError"><a href="TcTyClsDecls.html#newtypeStrictError"><span class="hs-identifier">newtypeStrictError</span></a></a><span> </span><a name="local-6989586621680456802"><a href="#local-6989586621680456802"><span class="hs-identifier">con</span></a></a><span>
</span><a name="line-3470"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;A newtype constructor cannot have a strictness annotation,&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3471"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456802"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;does&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-3472"></a><span>
</span><a name="line-3473"></a><span class="hs-identifier">newtypeFieldErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3474"></a><a name="newtypeFieldErr"><a href="TcTyClsDecls.html#newtypeFieldErr"><span class="hs-identifier">newtypeFieldErr</span></a></a><span> </span><a name="local-6989586621680456803"><a href="#local-6989586621680456803"><span class="hs-identifier">con_name</span></a></a><span> </span><a name="local-6989586621680456804"><a href="#local-6989586621680456804"><span class="hs-identifier">n_flds</span></a></a><span>
</span><a name="line-3475"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;The constructor of a newtype must have exactly one field&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3476"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456803"><span class="hs-identifier hs-var">con_name</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#speakN"><span class="hs-identifier hs-var">speakN</span></a><span> </span><a href="#local-6989586621680456804"><span class="hs-identifier hs-var">n_flds</span></a><span class="hs-special">]</span><span>
</span><a name="line-3477"></a><span>
</span><a name="line-3478"></a><span class="hs-identifier">badSigTyDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3479"></a><a name="badSigTyDecl"><a href="TcTyClsDecls.html#badSigTyDecl"><span class="hs-identifier">badSigTyDecl</span></a></a><span> </span><a name="local-6989586621680456805"><a href="#local-6989586621680456805"><span class="hs-identifier">tc_name</span></a></a><span>
</span><a name="line-3480"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal kind signature&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3481"></a><span>           </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456805"><span class="hs-identifier hs-var">tc_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-3482"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use KindSignatures to allow kind signatures&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3483"></a><span>
</span><a name="line-3484"></a><span class="hs-identifier">emptyConDeclsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3485"></a><a name="emptyConDeclsErr"><a href="TcTyClsDecls.html#emptyConDeclsErr"><span class="hs-identifier">emptyConDeclsErr</span></a></a><span> </span><a name="local-6989586621680456806"><a href="#local-6989586621680456806"><span class="hs-identifier">tycon</span></a></a><span>
</span><a name="line-3486"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456806"><span class="hs-identifier hs-var">tycon</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;has no constructors&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-3487"></a><span>         </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(EmptyDataDecls permits this)&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-3488"></a><span>
</span><a name="line-3489"></a><span class="hs-identifier">wrongKindOfFamily</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3490"></a><a name="wrongKindOfFamily"><a href="TcTyClsDecls.html#wrongKindOfFamily"><span class="hs-identifier">wrongKindOfFamily</span></a></a><span> </span><span class="hs-keyword">family</span><span>
</span><a name="line-3491"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Wrong category of family instance; declaration was for a&quot;</span><span>
</span><a name="line-3492"></a><span>    </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621680456808"><span class="hs-identifier hs-var">kindOfFamily</span></a><span>
</span><a name="line-3493"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3494"></a><span>    </span><a name="local-6989586621680456808"><a href="#local-6989586621680456808"><span class="hs-identifier">kindOfFamily</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isTypeFamilyTyCon"><span class="hs-identifier hs-var">isTypeFamilyTyCon</span></a><span> </span><span class="hs-keyword">family</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;type family&quot;</span><span>
</span><a name="line-3495"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="TyCon.html#isDataFamilyTyCon"><span class="hs-identifier hs-var">isDataFamilyTyCon</span></a><span> </span><span class="hs-keyword">family</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;data family&quot;</span><span>
</span><a name="line-3496"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;wrongKindOfFamily&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-keyword">family</span><span class="hs-special">)</span><span>
</span><a name="line-3497"></a><span>
</span><a name="line-3498"></a><span class="hs-identifier">wrongNumberOfParmsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3499"></a><a name="wrongNumberOfParmsErr"><a href="TcTyClsDecls.html#wrongNumberOfParmsErr"><span class="hs-identifier">wrongNumberOfParmsErr</span></a></a><span> </span><a name="local-6989586621680456809"><a href="#local-6989586621680456809"><span class="hs-identifier">max_args</span></a></a><span>
</span><a name="line-3500"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Number of parameters must match family declaration; expected&quot;</span><span>
</span><a name="line-3501"></a><span>    </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456809"><span class="hs-identifier hs-var">max_args</span></a><span>
</span><a name="line-3502"></a><span>
</span><a name="line-3503"></a><span class="hs-identifier">defaultAssocKindErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3504"></a><a name="defaultAssocKindErr"><a href="TcTyClsDecls.html#defaultAssocKindErr"><span class="hs-identifier">defaultAssocKindErr</span></a></a><span> </span><a name="local-6989586621680456810"><a href="#local-6989586621680456810"><span class="hs-identifier">fam_tc</span></a></a><span>
</span><a name="line-3505"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Kind mis-match on LHS of default declaration for&quot;</span><span>
</span><a name="line-3506"></a><span>    </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456810"><span class="hs-identifier hs-var">fam_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3507"></a><span>
</span><a name="line-3508"></a><span class="hs-identifier">wrongTyFamName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3509"></a><a name="wrongTyFamName"><a href="TcTyClsDecls.html#wrongTyFamName"><span class="hs-identifier">wrongTyFamName</span></a></a><span> </span><a name="local-6989586621680456811"><a href="#local-6989586621680456811"><span class="hs-identifier">fam_tc_name</span></a></a><span> </span><a name="local-6989586621680456812"><a href="#local-6989586621680456812"><span class="hs-identifier">eqn_tc_name</span></a></a><span>
</span><a name="line-3510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Mismatched type name in type family instance.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3511"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expected:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456811"><span class="hs-identifier hs-var">fam_tc_name</span></a><span>
</span><a name="line-3512"></a><span>               </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;  Actual:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456812"><span class="hs-identifier hs-var">eqn_tc_name</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-3513"></a><span>
</span><a name="line-3514"></a><span class="hs-identifier">badRoleAnnot</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoAxiom.html#Role"><span class="hs-identifier hs-type">Role</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3515"></a><a name="badRoleAnnot"><a href="TcTyClsDecls.html#badRoleAnnot"><span class="hs-identifier">badRoleAnnot</span></a></a><span> </span><a name="local-6989586621680456813"><a href="#local-6989586621680456813"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621680456814"><a href="#local-6989586621680456814"><span class="hs-identifier">annot</span></a></a><span> </span><a name="local-6989586621680456815"><a href="#local-6989586621680456815"><span class="hs-identifier">inferred</span></a></a><span>
</span><a name="line-3516"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Role mismatch on variable&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456813"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">)</span><span>
</span><a name="line-3517"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Annotation says&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456814"><span class="hs-identifier hs-var">annot</span></a><span>
</span><a name="line-3518"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;but role&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456815"><span class="hs-identifier hs-var">inferred</span></a><span>
</span><a name="line-3519"></a><span>              </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is required&quot;</span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-3520"></a><span>
</span><a name="line-3521"></a><span class="hs-identifier">wrongNumberOfRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680455906"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="HsDecls.html#LRoleAnnotDecl"><span class="hs-identifier hs-type">LRoleAnnotDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3522"></a><a name="wrongNumberOfRoles"><a href="TcTyClsDecls.html#wrongNumberOfRoles"><span class="hs-identifier">wrongNumberOfRoles</span></a></a><span> </span><a name="local-6989586621680456816"><a href="#local-6989586621680456816"><span class="hs-identifier">tyvars</span></a></a><span> </span><a name="local-6989586621680456817"><a href="#local-6989586621680456817"><span class="hs-identifier">d</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RoleAnnotDecl"><span class="hs-identifier hs-var">RoleAnnotDecl</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621680456818"><a href="#local-6989586621680456818"><span class="hs-identifier">annots</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3523"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hang"><span class="hs-identifier hs-var">hang</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Wrong number of roles listed in role annotation;&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-3524"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Expected&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680456816"><span class="hs-identifier hs-var">tyvars</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3525"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;got&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a><span> </span><a href="#local-6989586621680456818"><span class="hs-identifier hs-var">annots</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span class="hs-special">)</span><span>
</span><a name="line-3526"></a><span>       </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456817"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-3527"></a><span>
</span><a name="line-3528"></a><span class="hs-identifier">illegalRoleAnnotDecl</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="HsDecls.html#LRoleAnnotDecl"><span class="hs-identifier hs-type">LRoleAnnotDecl</span></a><span> </span><a href="HsExtension.html#GhcRn"><span class="hs-identifier hs-type">GhcRn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-3529"></a><a name="illegalRoleAnnotDecl"><a href="TcTyClsDecls.html#illegalRoleAnnotDecl"><span class="hs-identifier">illegalRoleAnnotDecl</span></a></a><span> </span><span class="hs-special">(</span><a href="SrcLoc.html#L"><span class="hs-identifier hs-var">L</span></a><span> </span><a name="local-6989586621680456819"><a href="#local-6989586621680456819"><span class="hs-identifier">loc</span></a></a><span> </span><span class="hs-special">(</span><a href="HsDecls.html#RoleAnnotDecl"><span class="hs-identifier hs-var">RoleAnnotDecl</span></a><span> </span><a name="local-6989586621680456820"><a href="#local-6989586621680456820"><span class="hs-identifier">tycon</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-3530"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#setErrCtxt"><span class="hs-identifier hs-var">setErrCtxt</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3531"></a><span>    </span><a href="TcRnMonad.html#setSrcSpan"><span class="hs-identifier hs-var">setSrcSpan</span></a><span> </span><a href="#local-6989586621680456819"><span class="hs-identifier hs-var">loc</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3532"></a><span>    </span><a href="TcRnMonad.html#addErrTc"><span class="hs-identifier hs-var">addErrTc</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal role annotation for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456820"><span class="hs-identifier hs-var">tycon</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">';'</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-3533"></a><span>              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;they are allowed only for datatypes and classes.&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3534"></a><span>
</span><a name="line-3535"></a><span class="hs-identifier">needXRoleAnnotations</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3536"></a><a name="needXRoleAnnotations"><a href="TcTyClsDecls.html#needXRoleAnnotations"><span class="hs-identifier">needXRoleAnnotations</span></a></a><span> </span><a name="local-6989586621680456821"><a href="#local-6989586621680456821"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-3537"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Illegal role annotation for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456821"><span class="hs-identifier hs-var">tc</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">';'</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-3538"></a><span>    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;did you intend to use RoleAnnotations?&quot;</span><span>
</span><a name="line-3539"></a><span>
</span><a name="line-3540"></a><span class="hs-identifier">incoherentRoles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-3541"></a><a name="incoherentRoles"><a href="TcTyClsDecls.html#incoherentRoles"><span class="hs-identifier">incoherentRoles</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Roles other than&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;nominal&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-3542"></a><span>                   </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;for class parameters can lead to incoherence.&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-3543"></a><span>                  </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Use IncoherentInstances to allow this; bad role found&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-3544"></a><span>
</span><a name="line-3545"></a><span class="hs-identifier">addTyConCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCon.html#TyCon"><span class="hs-identifier hs-type">TyCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455905"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455905"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3546"></a><a name="addTyConCtxt"><a href="TcTyClsDecls.html#addTyConCtxt"><span class="hs-identifier">addTyConCtxt</span></a></a><span> </span><a name="local-6989586621680456822"><a href="#local-6989586621680456822"><span class="hs-identifier">tc</span></a></a><span>
</span><a name="line-3547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="#local-6989586621680456825"><span class="hs-identifier hs-var">ctxt</span></a><span>
</span><a name="line-3548"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-3549"></a><span>    </span><a name="local-6989586621680456823"><a href="#local-6989586621680456823"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#getName"><span class="hs-identifier hs-var">getName</span></a><span> </span><a href="#local-6989586621680456822"><span class="hs-identifier hs-var">tc</span></a><span>
</span><a name="line-3550"></a><span>    </span><a name="local-6989586621680456824"><a href="#local-6989586621680456824"><span class="hs-identifier">flav</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="TyCon.html#tyConFlavour"><span class="hs-identifier hs-var">tyConFlavour</span></a><span> </span><a href="#local-6989586621680456822"><span class="hs-identifier hs-var">tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-3551"></a><span>    </span><a name="local-6989586621680456825"><a href="#local-6989586621680456825"><span class="hs-identifier">ctxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;In the&quot;</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680456824"><span class="hs-identifier hs-var">flav</span></a><span>
</span><a name="line-3552"></a><span>                </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;declaration for&quot;</span><span class="hs-special">,</span><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456823"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-3553"></a><span>
</span><a name="line-3554"></a><span class="hs-identifier">addRoleAnnotCtxt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455904"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TcRnTypes.html#TcM"><span class="hs-identifier hs-type">TcM</span></a><span> </span><a href="#local-6989586621680455904"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-3555"></a><a name="addRoleAnnotCtxt"><a href="TcTyClsDecls.html#addRoleAnnotCtxt"><span class="hs-identifier">addRoleAnnotCtxt</span></a></a><span> </span><a name="local-6989586621680456826"><a href="#local-6989586621680456826"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-3556"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="TcRnMonad.html#addErrCtxt"><span class="hs-identifier hs-var">addErrCtxt</span></a><span> </span><a href="../base-4.11.1.0/src/%{MODULE/./-}.html#%{NAME}/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a><span>
</span><a name="line-3557"></a><span>    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;while checking a role annotation for&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#quotes"><span class="hs-identifier hs-var">quotes</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621680456826"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-3558"></a></pre></body></html>